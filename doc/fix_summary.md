# è¿›åº¦æ¡å’Œæ—¥å¿—æ˜¾ç¤ºé—®é¢˜ä¿®å¤æ€»ç»“

## é—®é¢˜æ¦‚è¿°
ç”¨æˆ·ç‚¹å‡»"å¼€å§‹ç”Ÿæˆ"åï¼Œæµè§ˆå™¨ä¸­è¿›åº¦æ¡å§‹ç»ˆæ˜¾ç¤º0%ï¼Œæ—¥å¿—åŒºåŸŸæ˜¾ç¤º"ç­‰å¾…æ—¥å¿—è¾“å‡º..."ï¼Œç”¨æˆ·æ„Ÿè§‰ç³»ç»Ÿå¡ä½äº†ã€‚

## RCA æ ¹æœ¬åŸå› 
**æ ¸å¿ƒé—®é¢˜ï¼š** ad-back.pyï¼ˆå­è¿›ç¨‹ï¼‰å’Œ api_server.pyï¼ˆçˆ¶è¿›ç¨‹ï¼‰ä¹‹é—´ç¼ºä¹å®æ—¶é€šä¿¡æœºåˆ¶

- å­è¿›ç¨‹æ‰§è¡Œä»»åŠ¡ä½†æ— æ³•å°†è¿›åº¦ä¼ é€’å›çˆ¶è¿›ç¨‹
- TaskManager çš„ progress å­—æ®µä»æœªæ›´æ–°
- å‰ç«¯è½®è¯¢æ—¶æ°¸è¿œæ‹¿åˆ° progress=0.0

è¯¦ç»†RCAåˆ†æè¯·æŸ¥çœ‹ï¼š`doc/rca_progress_issue.md`

## ä¿®å¤æ–¹æ¡ˆ
é‡‡ç”¨**æ–¹æ¡ˆ1ï¼šè½»é‡çº§checkpointè§£æ**ï¼ˆæ¨èæ–¹æ¡ˆï¼‰

### ä¿®å¤å†…å®¹

#### 1. æ·»åŠ è¿›åº¦è¿½è¸ªè¾…åŠ©å‡½æ•°ï¼ˆpy/api_server.pyï¼‰
- `parse_checkpoint_file()` - è§£æcheckpointæ–‡ä»¶
- `calculate_progress_from_checkpoint()` - æ ¹æ®checkpointè®¡ç®—è¿›åº¦
- `generate_progress_message()` - ç”Ÿæˆç”¨æˆ·å‹å¥½çš„è¿›åº¦æ¶ˆæ¯

#### 2. ä¿®æ”¹ä»»åŠ¡æ‰§è¡Œé€»è¾‘ï¼ˆpy/api_server.py:559-623ï¼‰
**ä¹‹å‰ï¼š**
```python
process = subprocess.Popen(...)
returncode = process.wait()  # é˜»å¡ç­‰å¾…ï¼Œæ— è¿›åº¦æ›´æ–°
```

**ä¹‹åï¼š**
```python
process = subprocess.Popen(...)

# å¼‚æ­¥è½®è¯¢ï¼šç›‘æ§è¿›åº¦
while process.poll() is None:
    checkpoint = parse_checkpoint_file(checkpoint_file)
    if checkpoint:
        progress = calculate_progress_from_checkpoint(checkpoint, detailed=True)
        message = generate_progress_message(checkpoint)
        task_manager.update_progress(job_id, progress, message)
    await asyncio.sleep(2)
```

#### 3. æ·»åŠ æ—¥å¿—å®æ—¶åˆ·æ–°ï¼ˆpy/ad-back.py:411ï¼‰
```python
with open(LOG_FILE, 'a', encoding='utf-8') as f:
    f.write(plain_message + '\n')
    f.flush()  # ç«‹å³åˆ·æ–°åˆ°ç£ç›˜
```

## æµ‹è¯•éªŒè¯

### å•å…ƒæµ‹è¯•ç»“æœ âœ…
è¿è¡Œ `test/manual_test_progress.py`ï¼Œæ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼š

```
âœ… æ‰€æœ‰è¿›åº¦è®¡ç®—æµ‹è¯•é€šè¿‡ï¼
âœ… æ‰€æœ‰æ¶ˆæ¯ç”Ÿæˆæµ‹è¯•é€šè¿‡ï¼
âœ… checkpointæ–‡ä»¶è§£ææµ‹è¯•å®Œæˆï¼
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

æµ‹è¯•è¦†ç›–ï¼š
- ç©ºcheckpointè¿”å›0è¿›åº¦
- å®Œæˆ1æ­¥è¿”å›0.25è¿›åº¦
- å®Œæˆ2æ­¥è¿”å›0.5è¿›åº¦
- å®Œæˆ3æ­¥è¿”å›0.75è¿›åº¦
- å…¨éƒ¨å®Œæˆè¿”å›1.0è¿›åº¦
- è¯¦ç»†è¿›åº¦è®¡ç®—ï¼ˆåŒ…å«å­ä»»åŠ¡ï¼‰
- è¿›åº¦æ¶ˆæ¯ç”Ÿæˆ

## å¦‚ä½•éƒ¨ç½²

### æ­¥éª¤1ï¼šé‡å¯APIæœåŠ¡
```bash
# æ–¹æ³•1ï¼šä½¿ç”¨pkillï¼ˆæ¨èï¼‰
pkill -f "py/api_server.py"

# æ–¹æ³•2ï¼šæ‰‹åŠ¨æŸ¥æ‰¾å¹¶æ€æ­»è¿›ç¨‹
ps aux | grep api_server.py
kill <PID>

# å¯åŠ¨æ–°æœåŠ¡
source venv/bin/activate
nohup python py/api_server.py > api.log 2>&1 &
```

### æ­¥éª¤2ï¼šéªŒè¯æœåŠ¡å¯åŠ¨
```bash
# æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
curl http://localhost:18000/health

# é¢„æœŸè¾“å‡º
{
  "status": "ok",
  "timestamp": "2025-12-27T...",
  "running_tasks": 0,
  "max_concurrent": 1
}
```

### æ­¥éª¤3ï¼šæµ‹è¯•è¿›åº¦æ˜¾ç¤º
1. æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:18000`ï¼ˆæˆ–ä½ çš„å‰ç«¯åœ°å€ï¼‰
2. å¡«å†™å¿…å¡«å‚æ•°ï¼š
   - å¹¿å‘Šä¸»é¢˜
   - è§†è§‰é£æ ¼
   - é•œå¤´æ•°é‡ï¼ˆå»ºè®®å…ˆç”¨1ä¸ªé•œå¤´æµ‹è¯•ï¼‰
3. åœ¨é«˜çº§é€‰é¡¹ä¸­è¾“å…¥ Wavespeed API å¯†é’¥
4. ç‚¹å‡»"å¼€å§‹ç”Ÿæˆ"
5. è§‚å¯Ÿï¼š
   - âœ… è¿›åº¦æ¡åº”è¯¥ä»0%é€æ­¥å¢åŠ 
   - âœ… çŠ¶æ€æ¶ˆæ¯åº”è¯¥æ˜¾ç¤ºå…·ä½“é˜¶æ®µï¼ˆå¦‚"ğŸ“ æ­£åœ¨ç”Ÿæˆæ•…äº‹è„šæœ¬..."ï¼‰
   - âœ… æ—¥å¿—åŒºåŸŸåº”è¯¥å®æ—¶æ˜¾ç¤ºæ—¥å¿—å†…å®¹

### æ­¥éª¤4ï¼šéªŒè¯æ—¥å¿—å®æ—¶æ›´æ–°
åœ¨ä»»åŠ¡è¿è¡Œæ—¶ï¼š
```bash
# æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶å¤§å°å˜åŒ–
watch -n 2 'ls -lh output/aka-*/log.txt'

# å®æ—¶æŸ¥çœ‹æ—¥å¿—å†…å®¹
tail -f output/aka-<JOB_ID>/log.txt
```

## é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡çŠ¶æ€                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çŠ¶æ€: running                â”‚
â”‚ è¿›åº¦: 0%                     â”‚ â† ä¸€ç›´æ˜¯0%
â”‚ æ¶ˆæ¯: æ­£åœ¨ç”Ÿæˆè§†é¢‘...         â”‚
â”‚                              â”‚
â”‚ å®æ—¶æ—¥å¿—                     â”‚
â”‚ ç­‰å¾…æ—¥å¿—è¾“å‡º...               â”‚ â† çœ‹ä¸åˆ°æ—¥å¿—
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¿®å¤å
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»»åŠ¡çŠ¶æ€                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çŠ¶æ€: running                â”‚
â”‚ è¿›åº¦: 37%                    â”‚ â† å®æ—¶æ›´æ–°
â”‚ æ¶ˆæ¯: ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆå›¾åƒ (3/6)  â”‚ â† è¯¦ç»†ä¿¡æ¯
â”‚                              â”‚
â”‚ å®æ—¶æ—¥å¿—                     â”‚
â”‚ [17:01:29] å¼€å§‹ç”Ÿæˆ...       â”‚
â”‚ [17:01:54] âœ… æ•…äº‹å¤§çº²å·²ç”Ÿæˆ â”‚ â† å®æ—¶æ—¥å¿—
â”‚ [17:02:10] ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆå›¾åƒ... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è¿›åº¦æ˜ å°„å…³ç³»

| å®Œæˆæ­¥éª¤ | è¿›åº¦ | æ˜¾ç¤ºæ¶ˆæ¯ |
|---------|------|---------|
| æ—  | 0% | ğŸ“ æ­£åœ¨ç”Ÿæˆæ•…äº‹è„šæœ¬... |
| story | 25% | âœ… æ•…äº‹ç”Ÿæˆå®Œæˆï¼Œå‡†å¤‡ç”Ÿæˆå›¾åƒ |
| story + å›¾åƒ3/6 | 37.5% | ğŸ–¼ï¸ æ­£åœ¨ç”Ÿæˆå›¾åƒ (3/6) |
| story + images | 50% | âœ… å›¾åƒç”Ÿæˆå®Œæˆï¼Œå‡†å¤‡ç”Ÿæˆè§†é¢‘ |
| story + images + è§†é¢‘2/6 | 62.5% | ğŸ¥ æ­£åœ¨ç”Ÿæˆè§†é¢‘ (2/6) |
| story + images + videos | 75% | âœ… è§†é¢‘ç”Ÿæˆå®Œæˆï¼Œå‡†å¤‡åˆæˆ |
| story + images + videos + composition | 100% | âœ… è§†é¢‘åˆæˆå®Œæˆ |

## ä¿®æ”¹çš„æ–‡ä»¶æ¸…å•

### æ ¸å¿ƒä¿®æ”¹
1. **py/api_server.py**
   - æ·»åŠ ï¼š`parse_checkpoint_file()` å‡½æ•°ï¼ˆ446-463è¡Œï¼‰
   - æ·»åŠ ï¼š`calculate_progress_from_checkpoint()` å‡½æ•°ï¼ˆ466-513è¡Œï¼‰
   - æ·»åŠ ï¼š`generate_progress_message()` å‡½æ•°ï¼ˆ516-554è¡Œï¼‰
   - ä¿®æ”¹ï¼š`run_video_generation()` å‡½æ•°ï¼ˆ604-623è¡Œï¼‰

2. **py/ad-back.py**
   - ä¿®æ”¹ï¼š`log()` å‡½æ•°ï¼Œæ·»åŠ  `f.flush()`ï¼ˆ411è¡Œï¼‰

### æµ‹è¯•æ–‡ä»¶
1. **test/test_progress_tracking.py** - å®Œæ•´çš„pytestæµ‹è¯•å¥—ä»¶
2. **test/manual_test_progress.py** - æ‰‹åŠ¨æµ‹è¯•è„šæœ¬ï¼ˆå·²éªŒè¯é€šè¿‡ï¼‰

### æ–‡æ¡£
1. **doc/rca_progress_issue.md** - è¯¦ç»†çš„RCAåˆ†ææŠ¥å‘Š
2. **doc/fix_summary.md** - æœ¬æ–‡ä»¶

## é£é™©è¯„ä¼°

### ä½é£é™© âœ…
- åªä¿®æ”¹è¿›åº¦è¿½è¸ªé€»è¾‘ï¼Œä¸å½±å“æ ¸å¿ƒä¸šåŠ¡
- å‘åå…¼å®¹ï¼šå³ä½¿checkpointæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™
- å·²é€šè¿‡å•å…ƒæµ‹è¯•éªŒè¯

### æ³¨æ„äº‹é¡¹
1. checkpointæ–‡ä»¶æ ¼å¼å¿…é¡»æ­£ç¡®ï¼ˆad-back.pyä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰
2. å¦‚æœcheckpointæ–‡ä»¶æŸåï¼Œè¿›åº¦ä¼šæ˜¾ç¤º0%ï¼ˆä½†ä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼‰
3. è¿›åº¦æ›´æ–°é¢‘ç‡ï¼šæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡

## åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆå¯é€‰ï¼‰
1. æ·»åŠ WebSocketæ”¯æŒï¼Œå®ç°çœŸæ­£çš„å®æ—¶æ¨é€
2. åœ¨å‰ç«¯æ·»åŠ "é¢„è®¡å‰©ä½™æ—¶é—´"æ˜¾ç¤º

### ä¸­æœŸ
1. å®ç°æ–¹æ¡ˆ2ï¼ˆè§£ææ—¥å¿—è¿›åº¦æ ‡è®°ï¼‰ï¼Œæé«˜è¿›åº¦ç²¾åº¦
2. æ·»åŠ æ›´ç»†ç²’åº¦çš„è¿›åº¦ä¿¡æ¯ï¼ˆå¦‚"æ­£åœ¨ç”Ÿæˆç¬¬3ä¸ªé•œå¤´..."ï¼‰

### é•¿æœŸ
1. é‡æ„ä¸ºç›´æ¥APIè°ƒç”¨æ¨¡å¼ï¼ˆæ–¹æ¡ˆ4ï¼‰ï¼Œå½»åº•è§£å†³è¿›ç¨‹é€šä¿¡é—®é¢˜
2. æ·»åŠ è¿›åº¦æŒä¹…åŒ–åˆ°æ•°æ®åº“

## å›æ»šæ–¹æ¡ˆ

å¦‚æœå‡ºç°é—®é¢˜ï¼Œå¯ä»¥å¿«é€Ÿå›æ»šï¼š

```bash
# å›æ»šapi_server.py
git checkout py/api_server.py

# å›æ»šad-back.py
git checkout py/ad-back.py

# é‡å¯æœåŠ¡
pkill -f "py/api_server.py"
nohup python py/api_server.py > api.log 2>&1 &
```

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- RCAåˆ†æï¼š`doc/rca_progress_issue.md`
- æµ‹è¯•ä»£ç ï¼š`test/manual_test_progress.py`
- APIæ—¥å¿—ï¼š`output/aka-<JOB_ID>/log.txt`

---

**ä¿®å¤æ—¥æœŸï¼š** 2025-12-27
**ä¿®å¤ç‰ˆæœ¬ï¼š** v1.1.0
**éªŒè¯çŠ¶æ€ï¼š** âœ… å•å…ƒæµ‹è¯•é€šè¿‡ï¼Œç­‰å¾…é›†æˆæµ‹è¯•
