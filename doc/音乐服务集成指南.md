# éŸ³ä¹æœåŠ¡é›†æˆæŒ‡å—

> å¦‚ä½•å°†èƒŒæ™¯éŸ³ä¹åŠŸèƒ½é›†æˆåˆ°ä¸»ä»£ç  `ad-aka.py` ä¸­

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ¨¡å—å¼€å‘
- âœ… `py/services/music_service.py` - éŸ³ä¹æœåŠ¡æ ¸å¿ƒæ¨¡å—
- âœ… `py/test_music.py` - å®Œæ•´æµ‹è¯•è„šæœ¬ï¼ˆ6/6æµ‹è¯•é€šè¿‡ï¼‰
- âœ… `py/example_music_usage.py` - ä½¿ç”¨ç¤ºä¾‹

### 2. é…ç½®æ–‡ä»¶
- âœ… `config.toml` - å·²æ·»åŠ  `[audio]` é…ç½®èŠ‚

### 3. åŠŸèƒ½ç‰¹æ€§
- âœ… ä»æœ¬åœ°éŸ³ä¹åº“ï¼ˆ`./resource/songs/`ï¼‰é€‰æ‹©éŸ³ä¹
- âœ… æ ¹æ®è§†è§‰é£æ ¼æ™ºèƒ½åŒ¹é…ï¼ˆ15ç§é£æ ¼æ˜ å°„ï¼‰
- âœ… è‡ªåŠ¨å¾ªç¯/è£å‰ªéŸ³ä¹ä»¥åŒ¹é…è§†é¢‘æ—¶é•¿
- âœ… éŸ³é‡æ§åˆ¶ï¼ˆé»˜è®¤25%ï¼Œä¸ç›–è¿‡æ—ç™½ï¼‰
- âœ… æ”¯æŒä¿å­˜å¤„ç†åçš„éŸ³é¢‘æ–‡ä»¶

---

## ğŸš€ é›†æˆæ­¥éª¤

### æ­¥éª¤1ï¼šåœ¨ä¸»ä»£ç ä¸­å¯¼å…¥æ¨¡å—

åœ¨ `ad-aka.py` é¡¶éƒ¨æ·»åŠ å¯¼å…¥ï¼š

```python
from services.music_service import MusicService, get_background_music
```

### æ­¥éª¤2ï¼šè¯»å–é…ç½®

åœ¨é…ç½®åŠ è½½éƒ¨åˆ†æ·»åŠ éŸ³ä¹é…ç½®è¯»å–ï¼š

```python
def load_config():
    """åŠ è½½é…ç½®æ–‡ä»¶"""
    import toml
    config = toml.load('config.toml')

    # éŸ³é¢‘é…ç½®ï¼ˆæ–°å¢ï¼‰
    audio_config = config.get('audio', {})
    config['enable_background_music'] = audio_config.get('enable_background_music', True)
    config['music_dir'] = audio_config.get('music_dir', './resource/songs')
    config['music_volume'] = audio_config.get('music_volume', 0.25)
    config['prefer_style_match'] = audio_config.get('prefer_style_match', True)

    return config
```

### æ­¥éª¤3ï¼šåœ¨è§†é¢‘åˆæˆé˜¶æ®µé›†æˆ

åœ¨ç°æœ‰çš„ `compose_final_video()` å‡½æ•°ä¸­ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š

#### å½“å‰ä»£ç ï¼ˆå‚è€ƒï¼‰
```python
def compose_final_video(shots, config, work_dir):
    """åˆæˆæœ€ç»ˆè§†é¢‘"""
    composer = VideoComposer()

    # 1. æ‹¼æ¥æ‰€æœ‰é•œå¤´
    video_files = [f"{work_dir}/shot_{i}_with_audio.mp4" for i in range(1, len(shots)+1)]
    merged_video = f"{work_dir}/merged_video.mp4"
    composer.concatenate_videos(video_files, merged_video)

    # 2. ç”Ÿæˆæœ€ç»ˆè§†é¢‘
    final_video = f"{work_dir}/final_video.mp4"
    shutil.copy(merged_video, final_video)

    return final_video
```

#### æ–°å¢èƒŒæ™¯éŸ³ä¹å¤„ç†
```python
def compose_final_video(shots, config, work_dir):
    """åˆæˆæœ€ç»ˆè§†é¢‘ï¼ˆæ–°å¢èƒŒæ™¯éŸ³ä¹ï¼‰"""
    from services.video_composer import VideoComposer
    from services.music_service import MusicService

    composer = VideoComposer()

    # 1. æ‹¼æ¥æ‰€æœ‰é•œå¤´
    video_files = [f"{work_dir}/shot_{i}_with_audio.mp4" for i in range(1, len(shots)+1)]
    merged_video = f"{work_dir}/merged_video.mp4"
    composer.concatenate_videos(video_files, merged_video)

    # 2. æ·»åŠ èƒŒæ™¯éŸ³ä¹ï¼ˆæ–°å¢ï¼‰
    final_video = f"{work_dir}/final_video.mp4"

    if config.get('enable_background_music', True):
        logger.info("ğŸµ å‡†å¤‡æ·»åŠ èƒŒæ™¯éŸ³ä¹...")

        # åˆå§‹åŒ–éŸ³ä¹æœåŠ¡
        music_service = MusicService(music_dir=config['music_dir'])

        # é€‰æ‹©éŸ³ä¹
        music_file = music_service.select_music(
            style=config['style'],
            prefer_style=config.get('prefer_style_match', True)
        )

        if music_file:
            # æ·»åŠ èƒŒæ™¯éŸ³ä¹
            success = composer.add_background_music(
                video_file=merged_video,
                music_file=str(music_file),
                output_file=final_video,
                voice_volume=1.0,  # ä¿æŒåŸéŸ³é‡
                music_volume=config.get('music_volume', 0.25)
            )

            if success:
                logger.success(f"âœ… èƒŒæ™¯éŸ³ä¹æ·»åŠ æˆåŠŸ: {music_file.name}")
            else:
                logger.warning("âš ï¸  èƒŒæ™¯éŸ³ä¹æ·»åŠ å¤±è´¥ï¼Œä½¿ç”¨æ— èƒŒæ™¯éŸ³ä¹ç‰ˆæœ¬")
                shutil.copy(merged_video, final_video)
        else:
            logger.warning("âš ï¸  æœªæ‰¾åˆ°åˆé€‚çš„èƒŒæ™¯éŸ³ä¹ï¼Œè·³è¿‡")
            shutil.copy(merged_video, final_video)
    else:
        logger.info("â„¹ï¸  èƒŒæ™¯éŸ³ä¹åŠŸèƒ½æœªå¯ç”¨")
        shutil.copy(merged_video, final_video)

    return final_video
```

### æ­¥éª¤4ï¼šæµ‹è¯•é›†æˆ

è¿è¡Œä¸»ç¨‹åºæµ‹è¯•ï¼š

```bash
python3 py/ad-aka.py
```

æ£€æŸ¥è¾“å‡ºæ—¥å¿—ä¸­æ˜¯å¦æœ‰ï¼š
- `ğŸµ å‡†å¤‡æ·»åŠ èƒŒæ™¯éŸ³ä¹...`
- `ğŸµ æ ¹æ®é£æ ¼'xxx'é€‰æ‹©éŸ³ä¹: xxx.mp3`
- `âœ… èƒŒæ™¯éŸ³ä¹æ·»åŠ æˆåŠŸ`

---

## ğŸ“ é…ç½®ç¤ºä¾‹

### å¯ç”¨èƒŒæ™¯éŸ³ä¹ï¼ˆé»˜è®¤ï¼‰
```toml
[audio]
enable_background_music = true
music_dir = "./resource/songs"
music_volume = 0.25
prefer_style_match = true
```

### ç¦ç”¨èƒŒæ™¯éŸ³ä¹
```toml
[audio]
enable_background_music = false
```

### è°ƒæ•´éŸ³é‡
```toml
[audio]
music_volume = 0.3  # 30%éŸ³é‡
# æ¨èèŒƒå›´: 0.2-0.3ï¼ˆä¸ç›–è¿‡æ—ç™½ï¼‰
```

### å®Œå…¨éšæœºé€‰æ‹©éŸ³ä¹
```toml
[audio]
prefer_style_match = false  # ä¸æ ¹æ®é£æ ¼åŒ¹é…
```

---

## ğŸµ éŸ³ä¹åº“ç®¡ç†

### å½“å‰éŸ³ä¹åº“
ä½ç½®ï¼š`./resource/songs/`

å·²æœ‰15ä¸ªéŸ³ä¹æ–‡ä»¶ï¼š
- Epicç±»ï¼š`01_Epic_Decisions.mp3`, `02_Heroic_Intrepid.mp3`
- ç§‘æŠ€ç±»ï¼š`07_Tech_Reformat.mp3`, `23_Electronic_Pixelland.mp3`
- æ‚¬ç–‘ç±»ï¼š`04_Suspense_Killers.mp3`, `14_Uneasy_Disquiet.mp3`
- åŠ¨ä½œç±»ï¼š`05_Action_Hitman.mp3`, `10_Conflict_Chase.mp3`
- æˆå‰§ç±»ï¼š`11_Drama_Crisis.mp3`, `12_Dramatic_Angevin.mp3`
- å…¶ä»–ï¼š`06_Peaceful_Nowhere_Land.mp3`, `08_Dark_Breakdown.mp3`, ç­‰

### é£æ ¼æ˜ å°„è§„åˆ™
ç³»ç»Ÿä¼šæ ¹æ®æ–‡ä»¶åå…³é”®è¯è‡ªåŠ¨åŒ¹é…é£æ ¼ï¼š

| è§†è§‰é£æ ¼ | åŒ¹é…å…³é”®è¯ | æ¨èéŸ³ä¹ |
|---------|-----------|---------|
| technology | tech, electronic, pixelland | `07_Tech_Reformat.mp3` |
| xianxia | peaceful, nowhere | `06_Peaceful_Nowhere_Land.mp3` |
| horror | suspense, uneasy, dark | `14_Uneasy_Disquiet.mp3` |
| cinematic | epic, heroic, dramatic | `02_Heroic_Intrepid.mp3` |
| retro_80s | electronic, groovy | `16_Groovy_Wallpaper.mp3` |

### æ·»åŠ æ–°éŸ³ä¹
1. ä¸‹è½½æ— ç‰ˆæƒéŸ³ä¹ï¼ˆMP3/WAVæ ¼å¼ï¼‰
2. æ”¾å…¥ `./resource/songs/` ç›®å½•
3. é‡æ–°è¿è¡Œç¨‹åºå³å¯è‡ªåŠ¨è¯†åˆ«

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•éŸ³ä¹æœåŠ¡
```bash
# è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
python3 py/test_music.py

# æŸ¥çœ‹ä½¿ç”¨ç¤ºä¾‹
python3 py/example_music_usage.py
```

### é¢„æœŸç»“æœ
```
============================================================
ğŸ“Š æµ‹è¯•æ€»ç»“
============================================================
âœ… é€šè¿‡ - åˆ—å‡ºæ‰€æœ‰éŸ³ä¹
âœ… é€šè¿‡ - é£æ ¼åŒ¹é…é€‰æ‹©
âœ… é€šè¿‡ - éšæœºé€‰æ‹©
âœ… é€šè¿‡ - éŸ³ä¹å¤„ç†
âœ… é€šè¿‡ - ä¾¿æ·å‡½æ•°
âœ… é€šè¿‡ - ä¿å­˜éŸ³ä¹

------------------------------------------------------------
æ€»è®¡: 6/6 é€šè¿‡ (100%)
============================================================
```

---

## âš™ï¸ æŠ€æœ¯ç»†èŠ‚

### éŸ³ä¹å¤„ç†é€»è¾‘
1. **éŸ³ä¹å¤ªçŸ­**ï¼ˆ< è§†é¢‘æ—¶é•¿ï¼‰
   - è‡ªåŠ¨å¾ªç¯æ’­æ”¾è‡³è§†é¢‘ç»“æŸ
   - ä½¿ç”¨ `concatenate_audioclips()` æ‹¼æ¥å¤šæ¬¡

2. **éŸ³ä¹å¤ªé•¿**ï¼ˆ> è§†é¢‘æ—¶é•¿ï¼‰
   - è‡ªåŠ¨è£å‰ªè‡³è§†é¢‘æ—¶é•¿
   - ä½¿ç”¨ `subclipped(0, duration)` è£å‰ª

3. **éŸ³é‡æ§åˆ¶**
   - ä½¿ç”¨ `with_volume_scaled(volume)` è°ƒæ•´éŸ³é‡
   - é»˜è®¤25%ï¼Œç¡®ä¿æ—ç™½æ¸…æ™°

### ä¾èµ–å…³ç³»
- **å¿…éœ€**ï¼š`moviepy >= 2.0` ï¼ˆå·²å®‰è£…ï¼‰
- **å¯é€‰**ï¼š`ffmpeg`ï¼ˆç³»ç»Ÿçº§ï¼Œé€šå¸¸å·²å®‰è£…ï¼‰

---

## ğŸ“Š æ€§èƒ½å½±å“

### å¢åŠ çš„æ—¶é—´æˆæœ¬
- éŸ³ä¹é€‰æ‹©ï¼š< 0.1ç§’
- éŸ³ä¹å¤„ç†ï¼ˆå¾ªç¯/è£å‰ªï¼‰ï¼š< 1ç§’
- éŸ³è§†é¢‘æ··åˆï¼šçº¦5-10ç§’ï¼ˆå–å†³äºè§†é¢‘æ—¶é•¿ï¼‰
- **æ€»è®¡å¢åŠ **ï¼šçº¦5-11ç§’ï¼ˆå¯¹äº30ç§’è§†é¢‘ï¼‰

### å¢åŠ çš„èµ„æºå ç”¨
- å†…å­˜ï¼š+ 50-100MBï¼ˆä¸´æ—¶éŸ³é¢‘å¤„ç†ï¼‰
- ç£ç›˜ï¼šæ— é¢å¤–å ç”¨ï¼ˆä½¿ç”¨ç°æœ‰éŸ³ä¹åº“ï¼‰

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šæœªæ‰¾åˆ°éŸ³ä¹æ–‡ä»¶
**ç°è±¡**ï¼š
```
âš ï¸  éŸ³ä¹ç›®å½•ä¸ºç©º: ./resource/songs
```

**è§£å†³**ï¼š
- ç¡®è®¤ `./resource/songs/` ç›®å½•å­˜åœ¨
- æ£€æŸ¥ç›®å½•ä¸­æ˜¯å¦æœ‰ `.mp3` æˆ– `.wav` æ–‡ä»¶
- æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„ `music_dir` è·¯å¾„æ˜¯å¦æ­£ç¡®

### é—®é¢˜2ï¼šéŸ³ä¹å¤„ç†å¤±è´¥
**ç°è±¡**ï¼š
```
âŒ éŸ³ä¹å¤„ç†å¤±è´¥: ...
```

**è§£å†³**ï¼š
- æ£€æŸ¥éŸ³ä¹æ–‡ä»¶æ˜¯å¦æŸå
- å°è¯•ç”¨å…¶ä»–æ’­æ”¾å™¨æ’­æ”¾è¯¥æ–‡ä»¶
- åˆ é™¤æŸåçš„æ–‡ä»¶æˆ–ä½¿ç”¨å…¶ä»–éŸ³ä¹

### é—®é¢˜3ï¼šèƒŒæ™¯éŸ³ä¹å¤ªå¤§å£°
**ç°è±¡**ï¼šèƒŒæ™¯éŸ³ä¹ç›–è¿‡äº†æ—ç™½

**è§£å†³**ï¼š
- åœ¨ `config.toml` ä¸­é™ä½ `music_volume`
- æ¨èå€¼ï¼š0.2 - 0.3
- æœ€ä½å¯è®¾ä¸º 0.1ï¼ˆ10%ï¼‰

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

### ç›¸å…³æ–‡æ¡£
- `doc/éŸ³ä¹.md` - èƒŒæ™¯éŸ³ä¹æ–¹æ¡ˆå®Œæ•´æŒ‡å—
- `doc/short.md` - ShortGPTé¡¹ç›®éŸ³ä¹ç³»ç»Ÿåˆ†æ
- `doc/money.md` - WavespeedAIéŸ³ä¹ç”Ÿæˆæ–¹æ¡ˆ

### ä»£ç æ–‡ä»¶
- `py/services/music_service.py` - æ ¸å¿ƒæ¨¡å—
- `py/services/video_composer.py` - è§†é¢‘åˆæˆå™¨ï¼ˆåŒ…å«éŸ³ä¹æ··åˆåŠŸèƒ½ï¼‰
- `py/test_music.py` - æµ‹è¯•è„šæœ¬
- `py/example_music_usage.py` - ä½¿ç”¨ç¤ºä¾‹

---

## âœ… æ£€æŸ¥æ¸…å•

é›†æˆå‰æ£€æŸ¥ï¼š
- [ ] ç¡®è®¤ `./resource/songs/` ä¸­æœ‰éŸ³ä¹æ–‡ä»¶
- [ ] è¿è¡Œ `python3 py/test_music.py` ç¡®ä¿æµ‹è¯•é€šè¿‡
- [ ] æŸ¥çœ‹ `config.toml` ç¡®è®¤éŸ³é¢‘é…ç½®æ­£ç¡®

é›†æˆåæ£€æŸ¥ï¼š
- [ ] è¿è¡Œä¸»ç¨‹åºï¼Œè§‚å¯Ÿæ—¥å¿—ä¸­çš„éŸ³ä¹ç›¸å…³ä¿¡æ¯
- [ ] æ’­æ”¾ç”Ÿæˆçš„è§†é¢‘ï¼Œç¡®è®¤èƒŒæ™¯éŸ³ä¹å­˜åœ¨
- [ ] ç¡®è®¤èƒŒæ™¯éŸ³ä¹éŸ³é‡é€‚ä¸­ï¼Œä¸ç›–è¿‡æ—ç™½
- [ ] ç¡®è®¤éŸ³ä¹å¾ªç¯/è£å‰ªæ­£ç¡®ï¼Œä¸è§†é¢‘æ—¶é•¿ä¸€è‡´

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **é›†æˆåˆ°ä¸»ä»£ç ** - æŒ‰ç…§æ­¥éª¤3ä¿®æ”¹ `ad-aka.py`
2. **æµ‹è¯•è¿è¡Œ** - ç”Ÿæˆä¸€ä¸ªå®Œæ•´è§†é¢‘éªŒè¯åŠŸèƒ½
3. **è°ƒä¼˜** - æ ¹æ®å®é™…æ•ˆæœè°ƒæ•´éŸ³é‡å’Œé£æ ¼åŒ¹é…
4. **æ‰©å±•éŸ³ä¹åº“**ï¼ˆå¯é€‰ï¼‰ - æ·»åŠ æ›´å¤šæ— ç‰ˆæƒéŸ³ä¹

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**ï¼š2025-12-23
**æ¨¡å—ç‰ˆæœ¬**ï¼šv1.0
**æµ‹è¯•çŠ¶æ€**ï¼šâœ… 6/6 é€šè¿‡
