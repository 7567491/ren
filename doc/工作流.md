# æ•°å­—äººä»»åŠ¡å·¥ä½œæµè¯´æ˜

æœ¬æ–‡æ›¿æ¢æ—§çš„ 30 ç§’æ•…äº‹å¹¿å‘Šæµç¨‹ï¼Œèšç„¦â€œå¤´åƒ â†’ è¯­éŸ³ â†’ å”‡åŒæ­¥â€ä¸‰é˜¶æ®µæ•°å­—äººæµæ°´çº¿ï¼Œä¾¿äºå‰ç«¯/åç«¯/è¿ç»´ç»Ÿä¸€è®¤çŸ¥ã€‚

## 1. é˜¶æ®µæ€»è§ˆ

| é˜¶æ®µ | çŠ¶æ€æšä¸¾ | è¯´æ˜ |
|------|----------|------|
| 0. ä»»åŠ¡åˆ›å»º | `pending` | `POST /api/tasks` å†™å…¥ `task.json` è‰ç¨¿å¹¶è¿”å› `job_id`ã€‚TaskRunner è®°å½• `trace_id` ä¸ `config_hash`ã€‚ |
| 1. å¤´åƒ | `avatar_generating` â†’ `avatar_ready` | Prompt æ¨¡å¼è°ƒç”¨ Seedreamï¼ŒUpload æ¨¡å¼å¤åˆ¶å·²æœ‰å›¾ç‰‡ã€‚è¾“å‡º `avatar.png` ä¸ CDN URLã€‚ |
| 2. è¯­éŸ³ | `speech_generating` â†’ `speech_ready` | è°ƒç”¨ MiniMax speech-02-hdï¼Œè½ç›˜ `speech.mp3`ï¼Œè®°å½•æ—¶é•¿/æˆæœ¬ã€‚ |
| 3. è§†é¢‘ | `video_rendering` â†’ `finished` | è°ƒç”¨ Infinitetalkï¼Œè½®è¯¢ `/predictions/<id>`ï¼Œå¤åˆ¶ç»“æœåˆ° `output/<job_id>/digital_human.mp4` ä¸ `/mnt/www/ren/...`ã€‚ |
| å¼‚å¸¸ | `failed` | ä»»ä¸€é˜¶æ®µæŠ›å‡ºå¼‚å¸¸ï¼ˆå« `ExternalAPIError`ï¼‰ä¼šå†™å…¥ `error.message/type/trace_id` å¹¶åœæ­¢æ‰§è¡Œã€‚ |

## 2. çŠ¶æ€æœºç»†èŠ‚

```
pending
  â”œâ”€avatar_generating â”€â”€> avatar_ready
  â”‚                        â”‚
  â”‚                        â””â”€speech_generating â”€â”€> speech_ready
  â”‚                                                  â”‚
  â”‚                                                  â””â”€video_rendering â”€â”€> finished
  â””â”€failed (ä»»æ„é˜¶æ®µå¼‚å¸¸æˆ– config_hash ä¸ä¸€è‡´)
```

- `TaskRunner` æ¯æ¬¡çŠ¶æ€åˆ‡æ¢éƒ½ä¼šï¼š
  - è°ƒ `TaskManager.update_status`ï¼ˆä¾› `/api/tasks` å¿«é€ŸæŸ¥è¯¢ï¼‰ã€‚
  - å†™å…¥ `task.json`ï¼ˆå« `stages.*.state/message/provider_task_id`ï¼‰ã€‚
  - è¿½åŠ  `log.txt`ï¼š`[timestamp][LEVEL][trace=xxx] message`ï¼Œä¾‹å¦‚ `[INFO] [avatar] å¤´åƒç”Ÿæˆå®Œæˆ`ã€‚
- `config_hash` ä¸ `task.json` ä¸­çš„ä¸€è‡´æ€§ä¼šåœ¨ä»»åŠ¡å¯åŠ¨æ—¶æ ¡éªŒï¼Œé¿å…æ—§ä»»åŠ¡ä½¿ç”¨æ–°é…ç½®ã€‚

## 3. API äº¤äº’æ—¶åº

```
Frontend â”€â”€ POST /api/tasks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> FastAPI (åˆ›å»º job_id, async è¿è¡Œ)
Frontend â”€â”€ GET  /api/tasks/<job_id> (è½®è¯¢) â”€> FastAPI
FastAPI  â”€â”€ TaskRunner.run() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> Seedream / MiniMax / Infinitetalk
TaskRunner â”€â”€ StorageService.publish_video â”€> /mnt/www/ren/ren_MMDDHHMM/digital_human.mp4
```

- å‰ç«¯æ¯ 3~5s è½®è¯¢ä¸€æ¬¡ `GET /api/tasks/<job_id>`ï¼Œå¹¶æ ¹æ® `stages.avatar/speech/video` æ˜¾ç¤ºè¿›åº¦ã€‚
- å¤±è´¥æ—¶å“åº”åŒ…å«ï¼š
  ```json
  {
    "status": "failed",
    "error": {"message": "å”‡åŒæ­¥å¤±è´¥", "type": "ExternalAPIError"},
    "trace_id": "trace-abcd1234"
  }
  ```
  å‰ç«¯éœ€å¼¹å‡ºåŒ…å« `trace_id` çš„å¯¹è¯æ¡†ï¼Œä¾›è¿ç»´æ’éšœã€‚

## 4. æ—¥å¿— / äº§ç‰©

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `output/<job_id>/task.json` | çŠ¶æ€å¿«ç…§ã€å‚æ•°ã€æˆæœ¬ã€èµ„äº§ URLã€config_hashã€trace_id |
| `output/<job_id>/log.txt` | ç»“æ„åŒ–æ—¥å¿—ï¼Œä¾›äººå·¥æ’éšœæˆ–ä¸Šä¼ è‡³ ELK |
| `output/<job_id>/digital_human.mp4` | æœ¬åœ°è§†é¢‘å‰¯æœ¬ï¼Œä¾› `publish_video()` ä¸Šä¼  |
| `/mnt/www/ren/ren_MMDDHHMM/digital_human.mp4` | å¯¹å¤–è®¿é—®åœ°å€ï¼Œè¿”å› `video_url` |

> ä»»ä½•å¯¹å¤–æ²Ÿé€šå¿…å¸¦ `trace_id`ã€‚å†’çƒŸè„šæœ¬åŒæ ·ä¼šè¾“å‡º `trace_id`ï¼Œä¾¿äºè®°å½•æˆæœ¬ã€‚

## 5. å†’çƒŸ/å›å½’æµç¨‹

1. `./test/smoke_digital_human.sh`ï¼ˆå¿…è·‘ï¼Œ10 ç§’æ–‡æ¡ˆï¼Œæˆæœ¬ < $0.1ï¼‰ã€‚
2. `PYTEST_WAVESPEED_MOCK=1 ./run_tests.sh`ï¼ˆmock + å‰ç«¯æ‰“åŒ…ï¼‰ã€‚
3. åœ¨ `test/test-digital-human.md` è®°å½•ï¼šå‘½ä»¤ã€job_idã€trace_idã€video_urlã€æˆæœ¬ã€‚
4. å‘å¸ƒå‰ç¡®è®¤ `/api/tasks/<job_id>` å“åº”åŒ…å« `avatar_url/audio_url/video_url/logs/cost_breakdown`ã€‚

## 6. å¸¸è§é—®é¢˜

| é—®é¢˜ | è§£å†³ |
|------|------|
| å‰ç«¯è½®è¯¢çŠ¶æ€åœç•™åœ¨ `video_rendering` | æŸ¥çœ‹ `log.txt` æ˜¯å¦æŒç»­è¾“å‡ºï¼›è‹¥å¡ä½ï¼Œæ ¸æŸ¥ Infinitetalk API trace ä¸ç½‘ç»œã€‚ |
| `config_hash mismatch` | è¯´æ˜é…ç½®æ–‡ä»¶å·²å˜æ›´ï¼Œæ—§ä»»åŠ¡éœ€è¦é‡æ–°è·‘ï¼›`POST /api/tasks` è‡ªåŠ¨æç¤ºã€‚ |
| `/api/assets/upload` 403/413 | Nginx éœ€ `client_max_body_size 5M`ï¼›åŒæ—¶ç¡®è®¤ä¸Šä¼ æ–‡ä»¶å¤§å°ã€‚ |
| å†’çƒŸè„šæœ¬å¤±è´¥ | æ£€æŸ¥ `.env` æ˜¯å¦åŒ…å«ä¸¤ä¸ª Keyï¼Œæˆ–ä½¿ç”¨ `--avatar-upload` é¿å… Seedream æˆæœ¬ã€‚ |

## 7. è§’è‰²åº“ç¼–æ’

- æ‰€æœ‰é¢„åˆ¶äººç‰©å­˜æ”¾åœ¨ `resource/characters/prebuilt.json`ï¼Œæ¥æºä¸º `resource/pic/*.jpg + .json` 11 å¥—ç´ æï¼›ç”¨æˆ·è‡ªå®šä¹‰è§’è‰²å†™å…¥ `resource/characters/user_defined.json`ï¼Œå›¾ç‰‡è½ç›˜åˆ° `character_library.storage_dir`ï¼ˆé»˜è®¤ `/mnt/www/ren/resource/pic/user/`ï¼Œæœ¬åœ° fallback ä¸º `./resource/pic/user/`ï¼‰ï¼ŒGit å¿½ç•¥ã€‚
- æ–°å¢ `character_library` é…ç½®æ®µï¼ŒåŒ…å« `storage_dir/uploads_subdir/public_base_url` ç­‰å­—æ®µï¼›ä¹Ÿå¯é€šè¿‡ `CHARACTER_STORAGE_DIR` ç­‰ç¯å¢ƒå˜é‡è¦†ç›–ï¼Œç¡®ä¿å¼€å‘/ç”Ÿäº§è·¯å¾„ä¸€è‡´ã€‚
- FastAPI `digital_human` è“å›¾æš´éœ² `GET/POST/PUT/DELETE /api/characters`ï¼Œå‰ç«¯åœ¨ä»»åŠ¡è¡¨å•ä¸­å±•ç¤ºé¢„åˆ¶äººç‰©å¡ç‰‡ã€æ”¯æŒä¸Šä¼ æ–°äººç‰©ã€‚ä¸Šä¼ æ¥å£é™åˆ¶ 10MBã€åªæ¥å— PNG/JPGï¼Œå¹¶è¿”å› `character_id`ã€‚
- `POST /api/tasks` æ–°å¢ `character_id` å­—æ®µï¼Œåç«¯ä¼šè‡ªåŠ¨æ³¨å…¥å¯¹åº”çš„å½¢è±¡æè¿°/æ¨èéŸ³è‰²ï¼Œå¹¶åœ¨ `avatar_mode=upload` æ—¶å¤ç”¨è¯¥è§’è‰²çš„å¤´åƒæ–‡ä»¶ã€‚TaskRunner ä¼šå°† `assets.character` ä¸ `character_id` æŒä¹…åŒ–ï¼Œå¹¶åœ¨ `output/<job_id>/log.txt` å†™å…¥ `ğŸ­ ä½¿ç”¨è§’è‰² XXX (char-xxx)`ï¼Œä¾¿äºè¿½æº¯ã€‚
- è¿ç»´æ³¨æ„äº‹é¡¹ï¼š
  - Nginx éœ€é€šè¿‡ `location /resource/` æš´éœ² `storage_dir`ï¼Œä»¥ä¾¿å‰ç«¯å¡ç‰‡ç›´æ¥è¯»å– `image_url`ï¼›
  - è§’è‰²åº“æ›´æ–°åéœ€åŒæ­¥è·‘ä¸€æ¬¡ `./test/smoke_digital_human.sh --json` å¹¶åœ¨ `test/test-digital-human.md` è®°å½• `character_id/trace_id`ï¼›
  - æ‰¹é‡å¯¼å…¥è¯·ä½¿ç”¨ `python3 py/scripts/migrate_characters.py`ï¼Œè„šæœ¬ä¼šè‡ªåŠ¨ç”Ÿæˆç»Ÿä¸€ Schemaã€‚

---

æ­¤æ–‡æ¡£ä¸ºæ•°å­—äººå·¥ä½œæµå”¯ä¸€æ¥æºï¼Œå¦‚éœ€æ–°å¢é˜¶æ®µ/çŠ¶æ€ï¼Œè¯·åŒæ—¶æ›´æ–°ï¼š
- `py/function/task_runner.py`
- `doc/plan.md`ï¼ˆçœ‹æ¿ï¼‰
- `frontend/src/App.vue`ï¼ˆUI çŠ¶æ€æœºï¼‰

## 8. å‰ç«¯ä»ªè¡¨ç›˜é€‚é… `/home/wave`

- `API Key â†’ ä»»åŠ¡ç®¡ç† â†’ è¿›åº¦ â†’ ç´ æ` çš„å¡ç‰‡é¡ºåºä¸ `/home/wave` è€é¡¹ç›®ä¿æŒä¸€è‡´ï¼Œæ–¹ä¾¿è¿ç»´åœ¨ä¸¤ä¸ªç¯å¢ƒä¹‹é—´å¯¹ç…§ã€‚æ¯å¼ å¡éƒ½æŒ‚è½½ `CardContainer`ï¼Œé»˜è®¤æ”¯æŒæŠ˜å /å±•å¼€ï¼Œç§»åŠ¨ç«¯åªå±•å¼€å‰ä¸¤å¼ å¡ç‰‡ä»¥ä¾¿å•æ‰‹æ“ä½œã€‚
- è¿›åº¦å¡ç‰‡æ–°å¢ `stageDefinitions`ï¼ˆå¤´åƒ/è¯­éŸ³/è§†é¢‘ä¸‰æ®µï¼‰ã€åŠ æƒè¿›åº¦æ¡ä¸é¢œè‰²/å›¾æ ‡æç¤ºï¼šå¤´åƒé˜¶æ®µç´«è‰²ã€è¯­éŸ³è“è‰²ã€è§†é¢‘ç»¿è‰²ï¼›å¤±è´¥æ—¶åˆ‡æ¢ä¸º âš ï¸ã€‚æ€»è¿›åº¦ç”¨äºæ›¿æ¢è€ç‰ˆæœ¬çš„â€œå‡åˆ† 33%â€å‡è¿›åº¦ã€‚
- `dashboardStore` å¼•å…¥ `errors` å­—æ®µï¼Œä»»ä½• API/ç´ æå¼‚å¸¸ä¼šè¢«è®°å½•å¹¶åœ¨å¯¹åº”å¡ç‰‡æ ‡é¢˜æ—æç¤ºï¼Œå‡å°‘é‡å¤ toastã€‚
- `materialItems` ç»Ÿä¸€æŠŠ `/mnt/www/ren/<job_id>/...` æ˜ å°„æˆå…¬ç½‘åœ°å€ `https://s.linapp.fun/ren/...`ï¼Œå¹¶å¸¦æœ‰â€œå¤åˆ¶æœ¬åœ° / å¤åˆ¶å…¬ç½‘ / æ‰“å¼€â€ä¸‰ç§æ“ä½œï¼›ä»»åŠ¡åˆ‡æ¢æ—¶ä¼šè‡ªåŠ¨é‡ç®—ç›®å½•æ ‘ã€‚
- API Key å¡ç‰‡åŠ å…¥æœ€å°æ ¡éªŒï¼ˆå¿…é¡»ä»¥ `sk_/ws_/pk_` å¼€å¤´ä¸”é•¿åº¦â‰¥20ï¼‰ï¼Œé¿å…é”™è¯¯ key æµªè´¹ä»˜è´¹è¯·æ±‚ï¼ŒåŒæ—¶åœ¨å¡ç‰‡å†…ç›´æ¥æŸ¥è¯¢ Wavespeed ä½™é¢ã€‚
