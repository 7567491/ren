# 🎵 智能音乐匹配使用指南

## 功能简介

**智能音乐匹配**通过分析旁白音频的节奏、能量、情绪等特征，使用5维度算法自动选择最合拍的背景音乐。

### 核心优势

✅ **科学精准** - 基于实际音频特征分析，客观量化匹配度
✅ **5维度算法** - 节奏同步 + 能量匹配 + 情绪一致 + 频谱互补 + 时长适配
✅ **快速稳定** - 毫秒级计算，无需等待 API 调用
✅ **完全免费** - 纯本地算法，零成本
✅ **智能降级** - 如果智能匹配不可用，自动回退到关键词匹配

---

## 快速开始

### 步骤1：安装依赖

```bash
# 激活虚拟环境
source venv/bin/activate

# 安装音频分析库
pip install librosa soundfile
```

### 步骤2：预处理音乐库

```bash
# 运行预处理（一次性操作）
python py/preprocess_music.py

# 或指定自定义路径
python py/preprocess_music.py ./resource/songs ./resource/music_features.json
```

**预处理做什么？**
- 分析每首音乐的 BPM（节奏）、能量、动态范围、频谱特征
- 生成特征缓存文件 `resource/music_features.json`
- 后续视频生成时直接加载缓存，无需重复分析

### 步骤3：启用智能匹配

编辑 `config.yaml`：

```yaml
audio:
  # 启用智能音乐匹配
  use_intelligent_music_matching: true  # 5维度算法分析
```

### 步骤4：运行视频生成

```bash
python py/ad-aka.py
```

系统会自动：
1. 生成旁白音频
2. 分析旁白的节奏、能量、情绪特征
3. 计算所有音乐的5维度匹配分数
4. 选择得分最高的音乐
5. 添加到视频中

---

## 工作原理

### 5维度匹配算法

| 维度 | 说明 | 权重 |
|------|------|------|
| **节奏同步** | 旁白语速 vs 音乐BPM | 30% |
| **能量匹配** | 旁白音量 vs 音乐能量 | 25% |
| **动态范围** | 情绪波动 vs 音乐起伏 | 20% |
| **频谱互补** | 避免人声频段冲突 | 15% |
| **时长适配** | 减少音乐循环次数 | 10% |

### 匹配流程

```
旁白音频文件
    ↓
[提取特征] BPM≈180, 能量=0.15, 音调方差=500
    ↓
[5维度评分] 节奏×0.3 + 能量×0.25 + 动态×0.2 + 频谱×0.15 + 时长×0.1
    ↓
[计算候选] Top 5 音乐：[A: 0.85分, B: 0.78分, C: 0.72分...]
    ↓
[选择最佳] 得分最高 → A
    ↓
最终音乐: Epic_Tech_Futuristic.mp3
```

---

## 配置选项

### config.yaml 配置说明

```yaml
audio:
  # 智能音乐匹配
  use_intelligent_music_matching: true
    # true  - 启用5维度算法智能匹配（需要预处理音乐库）
    # false - 使用传统关键词匹配

  prefer_style_match: true
    # 传统模式下是否优先匹配视觉风格
```

### 性能与成本

| 模式 | 精度 | 速度 | 成本 |
|------|------|------|------|
| **智能算法匹配** | ★★★★★ | 快速 | 免费 |
| **关键词匹配** | ★★★☆☆ | 最快 | 免费 |

---

## 常见问题

### Q1: 预处理很慢怎么办？
**A**: 预处理只需运行一次。如果音乐库很大（>50首），可能需要5-10分钟。建议：
- 只分析前60秒（代码已优化）
- 后台运行：`nohup python py/preprocess_music.py &`

### Q2: 如何更新音乐库？
**A**: 添加新音乐后，重新运行预处理：
```bash
python py/preprocess_music.py
```

### Q3: 智能匹配失败怎么办？
**A**: 系统会自动降级到关键词匹配，不影响视频生成。检查：
- `resource/music_features.json` 是否存在
- `librosa` 是否正确安装：`pip list | grep librosa`

### Q4: 如何禁用智能匹配？
**A**: 修改 `config.yaml`：
```yaml
audio:
  use_intelligent_music_matching: false
```

### Q5: 算法如何计算匹配分数？
**A**: 5个维度加权求和：
- 节奏匹配 30%（旁白语速 vs 音乐BPM）
- 能量匹配 25%（旁白音量 vs 音乐能量）
- 动态范围 20%（情绪波动 vs 音乐起伏）
- 频谱互补 15%（避免人声频段冲突）
- 时长适配 10%（减少音乐循环次数）

---

## 高级用法

### 自定义匹配权重

编辑 `py/audio_matcher.py:374-380`：

```python
weights = {
    'rhythm': 0.30,      # 节奏权重（默认30%）
    'energy': 0.25,      # 能量权重
    'dynamics': 0.20,    # 动态权重
    'spectral': 0.15,    # 频谱权重
    'duration': 0.10,    # 时长权重
}
```

### 查看匹配详情

运行时会在日志中显示：
```
🏆 Top 5 候选音乐:
  1. Epic_Tech.mp3 (总分: 0.850)
     节奏: 0.92 | 能量: 0.85 | 动态: 0.78
  2. Futuristic_Beat.mp3 (总分: 0.782)
     ...
```

---

## 技术架构

```
┌─────────────────────────────────────┐
│  音频特征提取（librosa）             │
│  - BPM, RMS能量, 频谱质心, 音调方差  │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  5维度匹配算法                       │
│  - 节奏同步（30%）                   │
│  - 能量匹配（25%）                   │
│  - 动态范围（20%）                   │
│  - 频谱互补（15%）                   │
│  - 时长适配（10%）                   │
└─────────────────────────────────────┘
              ↓
┌─────────────────────────────────────┐
│  排序与选择                          │
│  - 生成 Top-5 候选列表               │
│  - 选择得分最高的音乐                │
└─────────────────────────────────────┘
```

---

## 最佳实践

### 音乐命名建议

智能匹配不依赖文件名，但良好的命名有助于调试：

```
Epic_Tech_180BPM.mp3        ✅ 推荐
Futuristic_Electronic.mp3   ✅ 推荐
bgm001.mp3                  ⚠️  可用但不推荐
```

### 音乐库组织

```
resource/songs/
├── tech/          # 科技类（可选分类）
│   ├── Epic_Tech_Fast.mp3
│   └── Modern_Electronic.mp3
├── calm/          # 舒缓类
│   ├── Piano_Calm.mp3
│   └── Ambient_Slow.mp3
└── music_features.json  # 特征缓存
```

---

## 更新日志

**v1.1 (2024-12-24)**
- 🎯 简化架构：移除 DeepSeek AI 推理，使用纯算法匹配
- ⚡ 性能提升：毫秒级响应，零 API 成本
- ✨ 算法优化：5维度加权评分更加精准

**v1.0 (2024-12-24)**
- ✨ 首次发布智能音乐匹配功能
- 🎯 5维度音频分析算法
- 📊 音乐库预处理工具

---

## 反馈与支持

如有问题或建议，请查看主文档 `README.md` 或联系开发者。
