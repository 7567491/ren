# 背景一致性方案（2-3个背景池）

## 目标
- 不随镜头数爆炸：场景数控制在最少 2、最多 3 个。
- 同 ID 背景的镜头在图像/视频生成时保持环境、光线、道具一致。
- 兼容现有 ad-aka 流程（分镜→图像/视频→合成）。

## 实施步骤
1) **规划背景池**：`plan_backgrounds(outline, shot_count)` 生成 2-3 个背景描述，并返回镜头→背景 ID 的映射（基于场景类型或均匀分配）。
2) **分镜写入背景**：在 `generate_coherent_shots` 里给每个镜头附加 `background` 字段（id/name/prompt），同时在日志与 `22_shots_script.json` 保存。
3) **Prompt 硬约束**：
   - 在 `config.yaml` 的 `shot_prompt` 模板新增 `{background_note}`，内容示例：`背景#{id}：{bg_prompt}（所有使用此背景的镜头必须保持相同场景/灯光/道具，仅人物动作和运镜可变，禁止新增或更换场景元素）`。
   - 调用 `get_prompt('shot_prompt', ...)` 时传入 `background_note`。
4) **生成阶段落地**：在图像/视频生成前，如果镜头含 `background`，将其 `prompt` 拼入最终提示（可放在开头或结尾的“固定背景”段），确保模型收到一致性要求。
5) **可选配置**：支持在 `user.yaml` 提供 `background_presets`（列表），`plan_backgrounds` 读取后替换自动生成的背景池。

## 需要修改的代码位置
- `config.yaml: shot_prompt` 模板：增加 `{background_note}` 占位及固定背景约束文案。
- `py/ad-aka.py: generate_coherent_shots`：调用 `plan_backgrounds`、为镜头附加 `background`、在 `get_prompt` 传 `background_note`。
- `py/ad-aka.py` 图像/视频生成阶段：在提交模型前拼入 `shot['background']['prompt']`（若存在）。

## 验证建议
- 分别用 3 镜头、5 镜头（480p、短时长）跑一遍，检查：
  - `22_shots_script.json` 中每个镜头带 `background` 字段，ID 只出现 2-3 个。
  - 日志里的镜头 prompt 含固定背景段；生成输出无随机换景。

## 兼容性
- 若 `background_note` 缺失，旧逻辑仍可运行；新增字段仅增加约束，不影响已有参数。
