{
  "sessionId": "d667b4d8-b7e1-4fe2-b973-76d28731fc62",
  "projectHash": "cd8c738c7a1a18392f8c7b8478cd36a4fd00c22700c909f29113a59918ee224a",
  "startTime": "2026-01-03T08:29:38.275Z",
  "lastUpdated": "2026-01-03T08:36:49.511Z",
  "messages": [
    {
      "id": "446ffa8f-635f-4d88-aa44-4adc942ab443",
      "timestamp": "2026-01-03T08:29:38.276Z",
      "type": "user",
      "content": "h"
    },
    {
      "id": "70554c9b-e9fe-41c3-aac6-5d2915defa02",
      "timestamp": "2026-01-03T08:29:42.690Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "list_directory-1767428982555-66ea7f17b571e",
          "name": "list_directory",
          "args": {
            "dir_path": "py/api/"
          },
          "result": [
            {
              "functionResponse": {
                "id": "list_directory-1767428982555-66ea7f17b571e",
                "name": "list_directory",
                "response": {
                  "output": "Directory listing for /home/ren/py/api:\n[DIR] __pycache__\n__init__.py\nroutes_digital_human.py"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:29:42.690Z",
          "resultDisplay": "Listed 3 item(s).",
          "displayName": "ReadFolder",
          "description": "Lists the names of files and subdirectories directly within a specified directory path. Can optionally ignore entries matching provided glob patterns.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Exploring the API Structure",
          "description": "I'm currently focused on the `py/api/` directory. My initial goal is to understand how the project's API is structured. This investigation will guide my further analysis.",
          "timestamp": "2026-01-03T08:29:42.553Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 8606,
        "output": 10,
        "cached": 6375,
        "thoughts": 25,
        "tool": 0,
        "total": 8641
      }
    },
    {
      "id": "f51b0eb1-a473-4534-a8a6-f6f129f87339",
      "timestamp": "2026-01-03T08:29:46.209Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "read_file-1767428986179-b0953692b4b63",
          "name": "read_file",
          "args": {
            "file_path": "py/api/routes_digital_human.py"
          },
          "result": [
            {
              "functionResponse": {
                "id": "read_file-1767428986179-b0953692b4b63",
                "name": "read_file",
                "response": {
                  "output": "\"\"\"\n数字人 API 路由\n\n提供任务创建 / 查询 / 素材上传端点，后端对接 DigitalHumanService + TaskRunner。\n\"\"\"\nfrom __future__ import annotations\n\nimport asyncio\nimport os\nfrom pathlib import Path\nfrom typing import Any, Dict, Optional\nfrom urllib.parse import urlparse\nfrom uuid import uuid4\n\nimport httpx\nfrom fastapi import APIRouter, FastAPI, File, Form, HTTPException, Request, UploadFile\nfrom fastapi.responses import JSONResponse, FileResponse\nfrom pydantic import BaseModel, Field\n\nfrom py.function.config_loader import load_config\nfrom py.services.digital_human_service import DigitalHumanService, WAVESPEED_BALANCE_URL\nfrom py.services.storage_service import StorageService\nfrom py.services.task_manager import TaskManager\nfrom py.exceptions import ExternalAPIError\nfrom py.services.character_repository import CharacterRepository\n\nrouter = APIRouter(prefix=\"/api\", tags=[\"digital-human\"])\n\n\n# -----------------------------------------------------------------------------\n# 依赖实例（共享 TaskManager + StorageService，确保 task.json/状态一致）\n# -----------------------------------------------------------------------------\ntask_manager = TaskManager()\ntry:\n    _LOADED_CONFIG = load_config()\nexcept Exception as exc:  # noqa: BLE001\n    print(f\"[WARN] 加载 config.yaml 失败，改用环境变量: {exc}\")\n    _LOADED_CONFIG = None\n\nstorage_cfg = _LOADED_CONFIG.storage if _LOADED_CONFIG else {}\n\nstorage_service = StorageService(\n    output_root=storage_cfg.get(\"output_root\") or os.getenv(\"DIGITAL_HUMAN_OUTPUT_DIR\", \"output\"),\n    public_base_url=(\n        storage_cfg.get(\"public_base_url\")\n        or os.getenv(\"DIGITAL_HUMAN_PUBLIC_BASE_URL\")\n        or os.getenv(\"STORAGE_BUCKET_URL\")\n    ),\n    public_export_dir=storage_cfg.get(\"local_mount\") or os.getenv(\"DIGITAL_HUMAN_PUBLIC_EXPORT_DIR\"),\n    namespace=storage_cfg.get(\"namespace\") or os.getenv(\"DIGITAL_HUMAN_PUBLIC_NAMESPACE\", \"ren\"),\n    final_video_name=storage_cfg.get(\"final_video_name\", os.getenv(\"DIGITAL_HUMAN_FINAL_VIDEO_NAME\", \"digital_human.mp4\")),\n    task_dir_pattern=storage_cfg.get(\"task_dir_pattern\", os.getenv(\"DIGITAL_HUMAN_TASK_DIR_PATTERN\", \"ren_%m%d%H%M\")),\n    video_mirror_targets=storage_cfg.get(\"video_mirrors\"),\n)\nUPLOAD_DIR = storage_service.output_root / \"uploads\"\nUPLOAD_DIR.mkdir(parents=True, exist_ok=True)\nUPLOAD_PUBLIC_BASE = os.getenv(\n    \"DIGITAL_HUMAN_UPLOAD_BASE_URL\", \"https://s.linapp.fun/uploads\"\n).rstrip(\"/\")\ncharacter_repository = CharacterRepository()\nMAX_CHARACTER_IMAGE_SIZE = 10 * 1024 * 1024\n\n_dh_service: Optional[DigitalHumanService] = None\n\n\ndef get_digital_human_service() -> DigitalHumanService:\n    \"\"\"延迟初始化，方便测试替换环境变量。\"\"\"\n    global _dh_service\n    if _dh_service is None:\n        wavespeed_key = os.getenv(\"WAVESPEED_API_KEY\", \"\")\n        minimax_key = os.getenv(\"MINIMAX_API_KEY\", \"\")\n        _dh_service = DigitalHumanService(\n            wavespeed_key=wavespeed_key,\n            minimax_key=minimax_key,\n            storage_service=storage_service,\n            task_manager=task_manager,\n            loaded_config=_LOADED_CONFIG,\n        )\n    return _dh_service\n\n\ndef _resolve_upload_file_path(upload_url: Optional[str]) -> Optional[str]:\n    \"\"\"根据上传 URL 推导本地路径，若无法映射则返回原始值。\"\"\"\n    if not upload_url:\n        return None\n\n    candidate = Path(upload_url)\n    if candidate.exists():\n        return str(candidate)\n\n    parsed = urlparse(upload_url)\n    if parsed.scheme in {\"http\", \"https\"}:\n        filename = Path(parsed.path).name\n        if filename:\n            local_path = UPLOAD_DIR / filename\n            if local_path.exists():\n                return str(local_path)\n\n    return upload_url\n\n\n# -----------------------------------------------------------------------------\n# Pydantic 模型\n# -----------------------------------------------------------------------------\nclass CreateTaskRequest(BaseModel):\n    avatar_mode: str = Field(..., description=\"头像模式: upload / prompt\")\n    avatar_prompt: Optional[str] = Field(\n        None, description=\"头像生成提示词（prompt模式必填）\"\n    )\n    avatar_upload_url: Optional[str] = Field(\n        None, description=\"上传的头像临时路径（upload模式必填）\"\n    )\n    speech_text: str = Field(..., description=\"播报文本\")\n    voice_id: str = Field(\"male-qn-qingse\", description=\"音色ID\")\n    resolution: str = Field(\"720p\", description=\"分辨率: 720p / 1080p\")\n    speed: float = Field(1.0, ge=0.5, le=2.0, description=\"语速 0.5-2.0\")\n    pitch: int = Field(0, ge=-12, le=12, description=\"音调 -12~12\")\n    emotion: str = Field(\"neutral\", description=\"情绪: neutral/happy/sad/angry\")\n    seed: int = Field(42, description=\"随机种子\")\n    mask_image: Optional[str] = Field(None, description=\"蒙版图片URL\")\n    character_id: Optional[str] = Field(None, description=\"可选角色ID\")\n\n\nclass TaskResponse(BaseModel):\n    job_id: str\n    status: str\n    message: str\n    billing: Optional[Dict[str, Any]] = None\n    avatar_url: Optional[str] = None\n    audio_url: Optional[str] = None\n    video_url: Optional[str] = None\n    cost: Optional[float] = None\n    duration: Optional[float] = None\n    stages: Optional[Dict[str, Any]] = None\n    assets: Optional[Dict[str, Any]] = None\n    trace_id: Optional[str] = None\n    config_hash: Optional[str] = None\n    logs: Optional[list[str]] = None\n    links: Dict[str, str] = Field(default_factory=dict)\n    character: Optional[Dict[str, Any]] = None\n\n\nclass CharacterResponse(BaseModel):\n    id: str\n    name: str\n    image_url: Optional[str] = None\n    thumbnail_url: Optional[str] = None\n    image_path: Optional[str] = None\n    appearance: Dict[str, Any]\n    voice: Optional[Dict[str, Any]] = None\n    tags: list[str] = Field(default_factory=list)\n    status: str\n    source: str\n    created_at: str\n    updated_at: Optional[str] = None\n    created_by: Optional[str] = None\n\n\nclass WavespeedBalanceRequest(BaseModel):\n    wavespeed_api_key: str = Field(..., min_length=10, description=\"Wavespeed 控制台生成的 API Key\")\n\n\nclass WavespeedBalanceResponse(BaseModel):\n    balance: float\n    currency: str = Field(default=\"USD\", description=\"余额币种，恒定为 USD\")\n\n\n# -----------------------------------------------------------------------------\n# 路由实现\n# -----------------------------------------------------------------------------\n@router.post(\"/wavespeed/balance\", response_model=WavespeedBalanceResponse)\nasync def get_wavespeed_balance(payload: WavespeedBalanceRequest) -> WavespeedBalanceResponse:\n    \"\"\"查询 Wavespeed 账户余额（USD）。\"\"\"\n    api_key = payload.wavespeed_api_key.strip()\n    if not api_key:\n        raise HTTPException(status_code=400, detail=\"缺少 Wavespeed API Key\")\n\n    try:\n        async with httpx.AsyncClient(timeout=10.0) as client:\n            response = await client.get(\n                WAVESPEED_BALANCE_URL,\n                headers={\"Authorization\": f\"Bearer {api_key}\"},\n            )\n        response.raise_for_status()\n    except httpx.HTTPStatusError as exc:\n        status_code = exc.response.status_code if exc.response else 502\n        if status_code == 401:\n            raise HTTPException(status_code=401, detail=\"Wavespeed API Key 无效或已过期\") from exc\n        raise HTTPException(status_code=status_code, detail=\"查询 Wavespeed 余额失败\") from exc\n    except httpx.TimeoutException as exc:\n        raise HTTPException(status_code=504, detail=\"查询 Wavespeed 余额超时，请稍后再试\") from exc\n    except httpx.RequestError as exc:\n        raise HTTPException(status_code=502, detail=\"无法连接 Wavespeed 服务，请稍后再试\") from exc\n\n    try:\n        payload_json = response.json()\n    except ValueError as exc:\n        raise HTTPException(status_code=502, detail=\"Wavespeed 响应格式异常\") from exc\n\n    balance = DigitalHumanService._parse_balance_payload(payload_json)\n    if balance is None:\n        raise HTTPException(status_code=502, detail=\"未能从 Wavespeed API 获取余额信息\")\n\n    return WavespeedBalanceResponse(balance=round(balance, 4))\n\n\n@router.post(\"/tasks\", response_model=TaskResponse)\nasync def create_task(req: CreateTaskRequest):\n    \"\"\"创建数字人生成任务。\"\"\"\n    character_internal: Optional[Dict[str, Any]] = None\n    character_payload: Optional[Dict[str, Any]] = None\n    if req.character_id:\n        try:\n            character_internal = character_repository.get_internal(req.character_id)\n            character_payload = {\n                key: character_internal.get(key)\n                for key in [\"id\", \"name\", \"appearance\", \"voice\", \"image_url\", \"image_path\", \"tags\", \"source\"]\n                if character_internal.get(key) is not None\n            }\n            if character_internal.get(\"_abs_image_path\"):\n                character_payload[\"image_local_path\"] = character_internal[\"_abs_image_path\"]\n        except KeyError as exc:\n            raise HTTPException(status_code=404, detail=\"角色不存在\") from exc\n\n    avatar_local_path = _resolve_upload_file_path(req.avatar_upload_url)\n    avatar_prompt = req.avatar_prompt\n    resolved_mode = req.avatar_mode\n\n    if character_payload:\n        char_prompt = (\n            (character_payload.get(\"appearance\") or {}).get(\"zh\")\n            or (character_payload.get(\"appearance\") or {}).get(\"en\")\n        )\n        if char_prompt:\n            if avatar_prompt:\n                avatar_prompt = f\"{char_prompt}\\n{avatar_prompt}\"\n            else:\n                avatar_prompt = char_prompt\n        char_image_path = character_payload.get(\"image_local_path\") or character_internal.get(\"_abs_image_path\") if character_internal else None\n        if char_image_path:\n            avatar_local_path = char_image_path\n            resolved_mode = \"upload\"\n\n    if resolved_mode == \"prompt\" and not avatar_prompt:\n        raise HTTPException(\n            status_code=400, detail=\"avatar_mode=prompt 时必须提供 avatar_prompt\"\n        )\n    if resolved_mode == \"upload\" and not avatar_local_path:\n        raise HTTPException(\n            status_code=400, detail=\"avatar_mode=upload 时必须提供 avatar_upload_url 或角色图像\"\n        )\n\n    job_id = task_manager.create_task(\n        preset_name=\"digital_human\",\n        num_shots=1,\n        resolution=req.resolution,\n        user_yaml=None,\n    )\n\n    if character_payload:\n        char_voice_id = (character_payload.get(\"voice\") or {}).get(\"voice_id\")\n        if char_voice_id:\n            req.voice_id = char_voice_id\n\n    async def _runner():\n        try:\n            service = get_digital_human_service()\n            await service.generate_digital_human(\n                job_id=job_id,\n                avatar_mode=resolved_mode,\n                avatar_prompt=avatar_prompt,\n                avatar_upload_path=avatar_local_path,\n                speech_text=req.speech_text,\n                voice_id=req.voice_id,\n                resolution=req.resolution,\n                speed=req.speed,\n                pitch=req.pitch,\n                emotion=req.emotion,\n                seed=req.seed,\n                mask_image=req.mask_image,\n                character=character_payload,\n            )\n        except Exception as exc:  # noqa: BLE001\n            task_manager.update_status(job_id, \"failed\", f\"生成失败: {exc}\")\n\n    asyncio.create_task(_runner())\n\n    return TaskResponse(\n        job_id=job_id,\n        status=\"pending\",\n        message=\"任务已创建，开始生成数字人视频...\",\n        links={\"self\": f\"/api/tasks/{job_id}\"},\n    )\n\n\n@router.get(\"/tasks/{job_id}\", response_model=TaskResponse)\nasync def get_task_status(job_id: str):\n    \"\"\"查询任务状态与阶段详情。\"\"\"\n    summary = task_manager.get_task(job_id)\n    if not summary:\n        raise HTTPException(status_code=404, detail=\"任务不存在\")\n\n    meta = storage_service.load_metadata(job_id)\n    status = meta.get(\"status\") if meta else summary.get(\"status\")\n    assets = dict((meta or {}).get(\"assets\") or {})\n    if job_id:\n        filename = storage_service.final_video_name\n        video_path = assets.get(\"video_path\")\n        if isinstance(video_path, str) and video_path:\n            filename = Path(video_path).name or filename\n        assets.setdefault(\"local_video_url\", f\"/output/{job_id}/{filename}\")\n    assets.setdefault(\"character\", (meta or {}).get(\"character\") or assets.get(\"character\"))\n    character_payload = (meta or {}).get(\"character\") or assets.get(\"character\")\n    return TaskResponse(\n        job_id=job_id,\n        status=status or \"unknown\",\n        message=summary.get(\"message\", \"\"),\n        billing=(meta or {}).get(\"billing\"),\n        avatar_url=(meta or {}).get(\"avatar_url\"),\n        audio_url=(meta or {}).get(\"audio_url\"),\n        video_url=(meta or {}).get(\"video_url\"),\n        cost=(meta or {}).get(\"cost\"),\n        duration=(meta or {}).get(\"duration\"),\n        stages=(meta or {}).get(\"stages\"),\n        assets=assets,\n        trace_id=(meta or {}).get(\"trace_id\"),\n        config_hash=(meta or {}).get(\"config_hash\"),\n        logs=(meta or {}).get(\"logs\"),\n        character=character_payload,\n        links={\"self\": f\"/api/tasks/{job_id}\"},\n    )\n\n\n@router.post(\"/assets/upload\")\nasync def upload_avatar(file: UploadFile):\n    \"\"\"上传头像文件，返回临时 URL 供任务使用。\"\"\"\n    allowed_types = {\"image/png\", \"image/jpeg\"}\n    if file.content_type not in allowed_types:\n        raise HTTPException(status_code=400, detail=\"只支持图片文件 (png/jpeg)\")\n\n    suffix = Path(file.filename or \"\").suffix.lower()\n    if suffix not in {\".png\", \".jpg\", \".jpeg\"}:\n        raise HTTPException(status_code=400, detail=\"文件扩展名必须为 png/jpg/jpeg\")\n\n    contents = await file.read()\n    if len(contents) > 5 * 1024 * 1024:\n        raise HTTPException(status_code=400, detail=\"文件大小需小于 5MB\")\n\n    unique_name = f\"{uuid4().hex}{suffix}\"\n    dest_path = UPLOAD_DIR / unique_name\n    dest_path.write_bytes(contents)\n\n    public_url = f\"{UPLOAD_PUBLIC_BASE}/{unique_name}\"\n    return {\"url\": public_url, \"path\": str(dest_path)}\n\n\n@router.get(\"/characters\", response_model=list[CharacterResponse])\nasync def list_characters(\n    status: str = \"active\",\n    source: Optional[str] = None,\n    limit: int = 100,\n    offset: int = 0,\n):\n    \"\"\"返回预制+用户角色列表。\"\"\"\n    repo_status = None if status == \"all\" else status\n    return character_repository.list_characters(\n        status=repo_status,\n        source=source,\n        limit=limit,\n        offset=offset,\n        include_disabled=status == \"all\",\n    )\n\n\n@router.get(\"/characters/assets/{asset_path:path}\")\nasync def get_character_asset(asset_path: str):\n    \"\"\"返回角色图库中的原始图片文件。\"\"\"\n    try:\n        resolved_path = Path(character_repository.resolve_asset_path(asset_path))\n    except ValueError as exc:\n        raise HTTPException(status_code=400, detail=str(exc)) from exc\n\n    if not resolved_path.exists():\n        raise HTTPException(status_code=404, detail=\"角色图片不存在或已删除\")\n\n    return FileResponse(resolved_path)\n\n\ndef _parse_tags(raw: Optional[str]) -> list[str]:\n    if not raw:\n        return []\n    return [item.strip() for item in raw.split(\",\") if item.strip()]\n\n\n@router.post(\"/characters\", response_model=CharacterResponse)\nasync def create_character(\n    name: str = Form(...),\n    appearance_zh: str = Form(...),\n    appearance_en: Optional[str] = Form(None),\n    voice_zh: Optional[str] = Form(None),\n    voice_prompt: Optional[str] = Form(None),\n    voice_id: Optional[str] = Form(None),\n    tags: Optional[str] = Form(None),\n    file: UploadFile = File(...),\n):\n    \"\"\"上传新的角色素材。\"\"\"\n    contents = await file.read()\n    if len(contents) > MAX_CHARACTER_IMAGE_SIZE:\n        raise HTTPException(status_code=400, detail=\"角色图片需小于10MB\")\n    voice_payload = {\"zh\": voice_zh, \"prompt\": voice_prompt, \"voice_id\": voice_id}\n    try:\n        record = character_repository.create_character(\n            name=name,\n            appearance={\"zh\": appearance_zh, \"en\": appearance_en},\n            voice=voice_payload,\n            image_bytes=contents,\n            image_filename=file.filename,\n            tags=_parse_tags(tags),\n        )\n    except ValueError as exc:\n        raise HTTPException(status_code=400, detail=str(exc)) from exc\n    return record\n\n\n@router.put(\"/characters/{character_id}\", response_model=CharacterResponse)\nasync def update_character(\n    character_id: str,\n    name: Optional[str] = Form(None),\n    appearance_zh: Optional[str] = Form(None),\n    appearance_en: Optional[str] = Form(None),\n    voice_zh: Optional[str] = Form(None),\n    voice_prompt: Optional[str] = Form(None),\n    voice_id: Optional[str] = Form(None),\n    status: Optional[str] = Form(None),\n    tags: Optional[str] = Form(None),\n    file: Optional[UploadFile] = File(None),\n):\n    \"\"\"更新角色描述或重传头像。\"\"\"\n    image_bytes = None\n    image_name = None\n    if file:\n        contents = await file.read()\n        if len(contents) > MAX_CHARACTER_IMAGE_SIZE:\n            raise HTTPException(status_code=400, detail=\"角色图片需小于10MB\")\n        image_bytes = contents\n        image_name = file.filename\n\n    appearance_payload = None\n    if appearance_zh or appearance_en:\n        appearance_payload = {\"zh\": appearance_zh, \"en\": appearance_en}\n\n    voice_payload = None\n    if any([voice_zh, voice_prompt, voice_id]):\n        voice_payload = {\"zh\": voice_zh, \"prompt\": voice_prompt, \"voice_id\": voice_id}\n\n    try:\n        record = character_repository.update_character(\n            character_id,\n            name=name,\n            appearance=appearance_payload,\n            voice=voice_payload,\n            status=status,\n            tags=_parse_tags(tags) if tags is not None else None,\n            image_bytes=image_bytes,\n            image_filename=image_name,\n        )\n    except KeyError as exc:\n        raise HTTPException(status_code=404, detail=\"角色不存在\") from exc\n    except ValueError as exc:\n        raise HTTPException(status_code=400, detail=str(exc)) from exc\n    return record\n\n\n@router.delete(\"/characters/{character_id}\")\nasync def delete_character(character_id: str):\n    \"\"\"禁用指定角色。\"\"\"\n    try:\n        record = character_repository.disable_character(character_id)\n    except KeyError as exc:\n        raise HTTPException(status_code=404, detail=\"角色不存在\") from exc\n    return {\"status\": \"ok\", \"character\": record}\n\n\nasync def handle_external_api_error(\n    request: Request,\n    exc: ExternalAPIError,\n):\n    \"\"\"统一 ExternalAPIError -> JSON 响应。\"\"\"\n    trace_id = exc.trace_id or f\"trace-{uuid4().hex[:12]}\"\n    error_payload = {\n        \"error\": {\n            \"code\": f\"{exc.provider}_error\",\n            \"message\": exc.message,\n            \"provider\": exc.provider,\n            \"status_code\": exc.status_code,\n            \"response_data\": exc.response_data,\n        },\n        \"trace_id\": trace_id,\n    }\n    return JSONResponse(\n        status_code=exc.status_code or 502,\n        content=error_payload,\n    )\n\n\ndef register_exception_handlers(app: FastAPI) -> None:\n    \"\"\"在 FastAPI 应用中注册数字人路由使用的异常处理。\"\"\"\n    app.add_exception_handler(ExternalAPIError, handle_external_api_error)\n\n\n__all__ = [\"router\", \"register_exception_handlers\"]\n"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:29:46.209Z",
          "resultDisplay": "",
          "displayName": "ReadFile",
          "description": "Reads and returns the content of a specified file. If the file is large, the content will be truncated. The tool's response will clearly indicate if truncation has occurred and will provide details on how to read more of the file using the 'offset' and 'limit' parameters. Handles text, images (PNG, JPG, GIF, WEBP, SVG, BMP), audio files (MP3, WAV, AIFF, AAC, OGG, FLAC), and PDF files. For text files, it can read specific line ranges.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Analyzing the Routes File",
          "description": "I'm now examining `routes_digital_human.py`. I'm going through the API endpoints to grasp the underlying logic. So far, the structure is becoming clearer. I'm focusing on the request handling and data flow to see how it operates.",
          "timestamp": "2026-01-03T08:29:46.178Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 8653,
        "output": 17,
        "cached": 7945,
        "thoughts": 30,
        "tool": 0,
        "total": 8700
      }
    },
    {
      "id": "5d3fa3d5-28e6-4171-8b29-89f1a992d81b",
      "timestamp": "2026-01-03T08:29:53.769Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "read_file-1767428993747-ceb2b3cedceb3",
          "name": "read_file",
          "args": {
            "file_path": "config.yaml"
          },
          "result": [
            {
              "functionResponse": {
                "id": "read_file-1767428993747-ceb2b3cedceb3",
                "name": "read_file",
                "response": {
                  "output": "# AI视频生成系统配置文件\n# 修改此文件可调整模型、限流等参数，无需修改代码\n\n# ============================================================\n# 视觉风格配置 - 专注科技产品广告（10种精选风格）\n# 基于AI视频生成最佳实践优化（2025版）\n# ============================================================\nvisual_styles:\n  # ==================== 故事/创意类 ====================\n\n  cartoon_adventure:\n    name: \"卡通冒险\"\n    visual_style: \"colorful stylized 3D animation, lively animal-inspired characters without licensed names, playful city sets, exaggerated squash-and-stretch action, bright signage and props\"\n    color_palette: \"vibrant teal, sunshine yellow, coral orange, lilac purple, warm brown\"\n    lighting: \"soft bounce light with saturated rims, gentle area lights, glossy highlights, motivated neon signs\"\n    camera_movement: \"whip pan transitions, dynamic dolly with parallax, low-angle hero reveal, playful crane downs\"\n    mood: \"optimistic, witty, energetic, heartwarming\"\n    music_keywords: [\"cartoon\", \"playful\", \"bright\"]\n    agent_prompt: \"作为动画电影导演与分镜摄影指导，请用儿童向大片的节奏与幽默调度镜头，确保角色表情夸张、动作流畅，避免提及任何具体IP名称。\"\n\n  luxury_fashion:\n    name: \"时尚奢华\"\n    visual_style: \"luxury fashion aesthetic, high-end tech products, elegant sophistication, premium brand presentation, glossy surfaces\"\n    color_palette: \"gold, black, champagne, pearl white, rose gold\"\n    lighting: \"soft key light with fill, rim lighting for glamour, glamorous highlights, luxury boutique ambiance\"\n    camera_movement: \"smooth dolly push in, elegant pan across product, slow luxury reveal, crane down from above\"\n    mood: \"elegant, sophisticated, aspirational, exclusive\"\n    music_keywords: [\"elegant\", \"luxury\", \"sophisticated\"]\n    agent_prompt: \"作为时尚大片导演与高级摄影师，请以奢侈品陈列节奏推拉镜头，强调材质光泽与优雅姿态，保持高级留白。\"\n\n  ink_xianxia:\n    name: \"水墨仙侠\"\n    visual_style: \"Chinese ink-wash wuxia fantasy, brushstroke textures, floating peaks and ancient pavilions, swirling mist, flowing robes and swords, aura glow\" \n    color_palette: \"ink black, rice paper white, jade green, indigo, cinnabar red\"\n    lighting: \"soft diffused skylight, rim glow through mist, lantern highlights, moonlit backlight\"\n    camera_movement: \"crane across mountains, slow-motion glide with robes, parallax push through bamboo forest, orbit around duel\" \n    mood: \"elegant, mystical, heroic, poetic\"\n    music_keywords: [\"guqin\", \"erhu\", \"oriental\"]\n    agent_prompt: \"作为武侠奇幻导演与摄影指导，请用诗意运镜与留白呈现水墨层次，突出飘带衣袂、轻功腾跃与古风器物，不提及具体IP名称。\"\n\n  realistic_3d:\n    name: \"3D写实\"\n    visual_style: \"photorealistic 3D rendering, physically accurate materials, product visualization, detailed textures, CGI perfection\"\n    color_palette: \"natural color grading, cinematic tones, realistic material colors\"\n    lighting: \"three-point lighting setup, realistic shadows, global illumination, bounce light, subsurface scattering\"\n    camera_movement: \"cinematic dolly move, steady cam tracking, rack focus transition, crane shot reveal\"\n    mood: \"realistic, cinematic, immersive, professional\"\n    music_keywords: [\"epic\", \"heroic\", \"majestic\"]\n    agent_prompt: \"作为CG电影级总监和摄影师，请以真实物理光线与机位呈现材质细节，保证镜头稳定、景深合理。\"\n\n  cinematic:\n    name: \"电影写实\"\n    visual_style: \"cinematic film look, shallow depth of field, narrative storytelling, human-centric scenes, lifestyle integration\"\n    color_palette: \"cinematic color grading, warm-cool contrast, natural skin tones, film emulation\"\n    lighting: \"natural sunlight, golden hour glow, soft window light, motivated lighting, dramatic shadows\"\n    camera_movement: \"steady cam handheld feel, gimbal smooth tracking, focus pull between subjects, slow dolly reveal\"\n    mood: \"cinematic, artistic, emotional, authentic\"\n    music_keywords: [\"epic\", \"heroic\", \"dramatic\"]\n    agent_prompt: \"作为电影导演与摄影指导，请以情感驱动的景别与调度讲故事，使用景深与光影塑造人物关系。\"\n\n  # ==================== 未来科技概念类 ====================\n\n  technology:\n    name: \"科技/未来风\"\n    visual_style: \"futuristic high-tech environment, digital data streams, holographic interfaces, glowing circuit patterns, sci-fi UI elements\"\n    color_palette: \"electric blue, neon purple, cyan glow, deep black, white highlights\"\n    lighting: \"neon accent lighting, digital glow effects, volumetric fog lights, particle light trails\"\n    camera_movement: \"fly through data streams, smooth tracking along circuits, orbital rotation around tech, dolly zoom effect\"\n    mood: \"innovative, cutting-edge, advanced, futuristic\"\n    music_keywords: [\"tech\", \"electronic\", \"futuristic\"]\n    agent_prompt: \"作为未来科技导演与技术摄影师，请用流畅的轨道与环绕镜头展现光迹和全息界面，突出前景中景背景的科技层次。\"\n\n  cyberpunk:\n    name: \"赛博朋克\"\n    visual_style: \"neon-lit dystopian cityscape, cyberpunk aesthetics, high-tech low-life contrast, holographic billboards, rain-soaked streets\"\n    color_palette: \"neon pink, electric blue, toxic green, deep purple, black, chrome\"\n    lighting: \"neon signs glow, holographic projections, volumetric fog, rim lighting on subjects, lens flares from lights\"\n    camera_movement: \"push in on product through neon, fast tracking through city, vertical crane down skyscraper, orbit around subject\"\n    mood: \"edgy, futuristic, rebellious, tech-forward, urban\"\n    music_keywords: [\"electronic\", \"synthwave\", \"cyberpunk\"]\n    agent_prompt: \"作为夜景动作片导演与摄影指导，请用湿地反射、霓虹逆光与快速移动车轨，营造都市赛博张力。\"\n\n  space_exploration:\n    name: \"太空探险\"\n    visual_style: \"cinematic space odyssey, starships and orbital stations, luminous nebulas, planet surfaces with dust storms, cockpit HUDs, EVA astronauts\"\n    color_palette: \"deep space black, starlight white, plasma blue, burnt orange, metallic silver\"\n    lighting: \"rim light from stars, console glow, volumetric shafts through cockpit, hard sun backlight on suits\"\n    camera_movement: \"zero-g drift shots, slow roll reveal of planets, POV from cockpit HUD, exterior orbit pans\"\n    mood: \"awe-inspiring, adventurous, disciplined, vast\"\n    music_keywords: [\"orchestral\", \"space\", \"epic\"]\n    agent_prompt: \"作为硬科幻航天导演与摄影指导，请用失重漂移、星球揭示与舱内HUD视角设计镜头，不提及具体影片名称。\"\n\n  outdoor_adventure:\n    name: \"户外探险\"\n    visual_style: \"wide natural landscapes, alpine ridges, rivers and forests, hikers with gear, dust and wind details, practical survival props\"\n    color_palette: \"forest green, sky blue, sunrise amber, slate gray, earth brown\"\n    lighting: \"natural golden hour, backlit dust particles, campfire warm fill, cloud-soft diffused light\"\n    camera_movement: \"drone-style sweep over cliffs, steadycam follow on trails, slider close-ups on gear, tilt up to reveal peaks\"\n    mood: \"brave, free, grounded, hopeful\"\n    music_keywords: [\"acoustic\", \"folk\", \"adventure\"]\n    agent_prompt: \"作为纪录片式探险导演与摄影指导，请以广角与跟随镜头展示地形层次，突出人物与自然尺度对比。\"\n\n  magical_fantasy:\n    name: \"魔幻史诗\"\n    visual_style: \"majestic wizarding fantasy without named franchises, ancient castles and candle-lit halls, enchanted forests, glowing runes and spells, flying creatures\"\n    color_palette: \"emerald green, royal navy, silver moonlight, candle gold, deep burgundy\"\n    lighting: \"mystic rim lights, volumetric beams through windows, torch and candle accents, moonlit fog\"\n    camera_movement: \"heroic crane reveals of castles, arc tracking during spell casting, glide through enchanted halls, POV wand casting\"\n    mood: \"mysterious, grand, wondrous, adventurous\"\n    music_keywords: [\"orchestral\", \"choir\", \"fantasy\"]\n    agent_prompt: \"作为魔幻史诗导演与摄影指导，请用庄重的运镜与光束描绘魔法氛围，强调场景规模与仪式感，避免提及具体电影名称。\"\n\n# ============================================================\n# API配置（留空则从.env文件读取）\n# ============================================================\napi:\n  deepseek_key: \"\"  # 留空从环境变量读取\n  wavespeed_key: \"\"  # 留空从环境变量读取\n\n# ============================================================\n# API限流配置\n# ============================================================\nrate_limits:\n  # DeepSeek API限流（故事生成）\n  deepseek:\n    max_requests_per_minute: 50  # 每分钟最多50次\n    max_requests_per_day: null   # 不限制每天次数（null表示不限制）\n\n  # WavespeedAI 图像生成限流\n  image_generation:\n    max_requests_per_minute: 10  # 每分钟最多10次（建议值）\n    max_requests_per_day: 500    # 每天最多500次\n\n  # WavespeedAI 视频生成限流\n  video_generation:\n    max_requests_per_minute: 3   # 每分钟最多3次（较保守）\n    max_requests_per_day: 100    # 每天最多100次\n\n# ============================================================\n# 工作流配置\n# ============================================================\nworkflow:\n  # 视频生成模式：false=T2I+I2V（稳定）, true=直接T2V（快速）\n  use_direct_t2v: false\n\n  # 并发配置\n  max_concurrent_workers: 3  # 图像生成并发数（建议2-4，过高可能触发限流）\n  task_runner:\n    max_parallel_tasks: 2\n    retry:\n      max_attempts: 3\n      initial_delay: 5  # seconds\n      backoff_multiplier: 2\n\n  # 输出目录\n  output_base: \"./output\"\n\n# ============================================================\n# 运行参数与默认值\n# ============================================================\nruntime:\n  # 图像生成默认参数\n  image_generation:\n    duration_seconds: 5\n    seed: -1\n    enable_prompt_expansion: false\n\n  # 视频生成默认参数\n  video_generation:\n    duration_seconds: 5\n    seed: -1\n    enable_prompt_expansion: false\n\n  # 结果轮询配置\n  polling:\n    check_interval_seconds: 10\n    max_wait_seconds:\n      image: 120\n      video: 600\n    max_network_retries: 10\n    backoff_seconds: 5\n    max_backoff_seconds: 30\n\n# ============================================================\n# 角色库配置\n# ============================================================\ncharacter_library:\n  storage_dir: \"/mnt/www/ren/resource/pic\"\n  uploads_subdir: \"user\"\n  prebuilt_file: \"./resource/characters/prebuilt.json\"\n  user_library_file: \"./resource/characters/user_defined.json\"\n  public_base_url: \"/api/characters/assets\"\n\nfrontend:\n  public_url: \"https://ren.linapp.fun\"\n  assets_cdn: null\n  # 图床上传（多图床自动容错）\n  image_upload:\n    # 旧配置（向后兼容）\n    endpoint: \"https://api.imgbb.com/1/upload\"\n    api_key: \"d139be0b91a49610f8c8b2a5c07d3cd7\"  # 公共测试key（已失效，仅用于备用）\n    timeout_seconds: 30\n\n    # 多图床配置（按优先级排序，失败自动切换）\n    hosts:\n      - name: \"catbox.moe\"\n        type: \"catbox\"\n        # 特点：匿名上传，最稳定，单文件<200MB，永久保存\n      - name: \"sm.ms\"\n        type: \"smms\"\n        # 特点：国内稳定，免费5GB，单文件<5MB\n      - name: \"telegraph\"\n        type: \"telegraph\"\n        # 特点：Telegram官方，完全免费，单文件<5MB\n      - name: \"imgbb\"\n        type: \"imgbb\"\n        api_key: \"d139be0b91a49610f8c8b2a5c07d3cd7\"\n        # 特点：需要API key，仅作备用（当前key已失效）\n\nstorage:\n  local_mount: \"/mnt/www\"\n  public_base_url: \"https://s.linapp.fun\"\n  namespace: \"ren\"\n  final_video_name: \"digital_human.mp4\"\n  task_dir_pattern: \"ren_%m%d%H%M\"\n  video_mirrors:\n    - name: \"wave-ad\"\n      dir: \"/mnt/www/ad\"\n      base_url: \"https://s.linapp.fun/ad\"\n      filename_template: \"{job_id}.mp4\"\n# ============================================================\n# 模型配置\n# ============================================================\nmodels:\n  # 图像生成模型配置\n  image:\n    # 当前使用的模型（在下面的可用模型列表中选择）\n    current: \"kling-image-o1\"\n\n    # 数字映射（方便 user.yaml 中选择）\n    number_map:\n      1: \"flux-dev-lora\"           # 最便宜 $0.006\n      2: \"seedream-v4\"             # 推荐，高质量 $0.027\n      3: \"seedream-v4.5\"           # 最高质量（4K）$0.04\n      4: \"kling-image-o1\"          # 支持参考图 $0.028（默认）\n      5: \"vidu-reference-q2\"       # 多参考图 $0.04\n      6: \"nano-banana-pro\"         # Google I2I图像编辑（14张参考图）$0.14-0.24\n\n    # 可用模型列表\n    available:\n      flux-dev-lora:\n        endpoint: \"/api/v3/wavespeed-ai/flux-dev-lora\"\n        cost: 0.006\n        speed: \"快\"\n        quality: \"中\"\n        support_reference: false\n        params:\n          output_format: \"png\"\n\n      seedream-v4:\n        endpoint: \"/api/v3/bytedance/seedream-v4\"\n        cost: 0.027\n        speed: \"快\"\n        quality: \"高\"\n        support_reference: false\n        params:\n          size: \"1024*1024\"\n\n      seedream-v4.5:\n        endpoint: \"/api/v3/bytedance/seedream-v4.5\"\n        cost: 0.04\n        speed: \"快\"\n        quality: \"最高（4K）\"\n        support_reference: false\n        params:\n          size: \"2048*2048\"\n\n      kling-image-o1:\n        endpoint: \"/api/v3/kwaivgi/kling-image-o1\"\n        cost: 0.028\n        speed: \"快\"\n        quality: \"高（支持参考图）\"\n        support_reference: true\n        max_reference_images: 10\n        # 参考图使用说明:\n        # - 支持公开URL: 如 https://你的存储桶.com/image.jpg（推荐）\n        # - 支持本地文件: 如 ./resource/pic/character.jpg（需上传图床，可能不稳定）\n        params:\n          aspect_ratio: \"1:1\"\n          resolution: \"1k\"  # Kling使用1k/2k，不是1080p\n          num_images: 1\n\n      vidu-reference-q2:\n        endpoint: \"/api/v3/vidu/reference-to-image-q2\"\n        cost: 0.04\n        speed: \"快\"\n        quality: \"高（1-3参考图）\"\n        support_reference: true\n        max_reference_images: 7\n        params:\n          aspect_ratio: \"auto\"\n          resolution: \"1080p\"\n\n      nano-banana-pro:\n        endpoint: \"/api/v3/google/nano-banana-pro/edit\"\n        cost: 0.14  # 1K/2K基础价格，4K为$0.24\n        speed: \"快\"\n        quality: \"极高（4K I2I图像编辑）\"\n        support_reference: true  # I2I模式需要输入参考图\n        max_reference_images: 14  # 最多支持14张参考图\n        params:\n          resolution: \"2k\"  # 可选: 1k, 2k, 4k\n          aspect_ratio: \"1:1\"  # 支持多种比例: 1:1, 16:9, 9:16, 等\n          output_format: \"png\"\n\n  # 视频生成模型配置\n  video:\n    # 当前使用的模型（在下面的可用模型列表中选择）\n    current: \"wan-2.5-i2v\"\n\n    # 数字映射（方便 user.yaml 中选择）\n    number_map:\n      1: \"wan-2.5-i2v\"         # 性价比最高 $0.30-2.00（默认）\n      2: \"wan-2.6-i2v\"         # 音频同步 $0.50-3.00\n      3: \"wan-2.6-t2v\"         # 直接T2V（快速）$0.50-3.00\n      4: \"hailuo-2.3-pro\"      # 最高质量（1080p）$0.50-3.00\n      5: \"veo-3.1-i2v\"         # Google 原生1080p+音频 $3.20/8秒\n\n    # 可用模型列表\n    available:\n      wan-2.5-i2v:\n        endpoint: \"/api/v3/alibaba/wan-2.5/image-to-video\"\n        cost: 0.30  # 基础价格（480p）\n        cost_by_resolution:  # 按分辨率定价\n          \"480p\": 0.30\n          \"720p\": 1.00\n          \"1080p\": 2.00\n        speed: \"127秒\"\n        quality: \"高（720p）\"\n        type: \"i2v\"\n        # API参数配置\n        params:\n          # 必需参数（代码中处理）: image, prompt\n          # 可选参数及其默认值\n          audio: null  # 音频URL（可选）\n          negative_prompt: null\n          resolution: \"720p\"  # 480p/720p/1080p\n          duration: 5  # 3-10秒\n          enable_prompt_expansion: false\n          seed: -1  # -1为随机\n        # 参数约束\n        constraints:\n          resolution_options: [\"480p\", \"720p\", \"1080p\"]\n          duration_range: [3, 10]\n          duration_type: \"range\"  # range=范围, fixed=固定值\n\n      wan-2.6-i2v:\n        endpoint: \"/api/v3/alibaba/wan-2.6/image-to-video\"\n        cost: 0.50  # 基础价格（480p）\n        cost_by_resolution:  # 按分辨率定价\n          \"480p\": 0.50\n          \"720p\": 1.50\n          \"1080p\": 3.00\n        speed: \"171秒\"\n        quality: \"最高（音频同步）\"\n        type: \"i2v\"\n        # API参数配置\n        params:\n          # 必需参数: image, prompt\n          audio: null\n          negative_prompt: null\n          resolution: \"720p\"  # 720p/1080p (注意：不支持480p)\n          duration: 5  # 5/10/15秒\n          shot_type: \"single\"  # single/multi (WAN 2.6特有)\n          enable_prompt_expansion: false\n          seed: -1\n        constraints:\n          resolution_options: [\"720p\", \"1080p\"]  # 不支持480p\n          duration_options: [5, 10, 15]\n          duration_type: \"fixed\"  # 只能选择5/10/15\n\n      wan-2.6-t2v:\n        endpoint: \"/api/v3/alibaba/wan-2.6/text-to-video\"\n        cost: 0.50  # 基础价格（480p）\n        cost_by_resolution:  # 按分辨率定价\n          \"480p\": 0.50\n          \"720p\": 1.50\n          \"1080p\": 3.00\n        speed: \"95秒\"\n        quality: \"高（单步）\"\n        type: \"t2v\"\n        # API参数配置\n        params:\n          # 必需参数: prompt\n          # 注意：此模型使用size而非resolution!\n          audio: null\n          negative_prompt: null\n          size: \"1280*720\"  # 注意：不是resolution!\n          duration: 5  # 5/10/15秒\n          shot_type: \"single\"  # single/multi\n          enable_prompt_expansion: false\n          seed: -1\n        constraints:\n          size_options: [\"1280*720\", \"720*1280\", \"1920*1080\", \"1080*1920\"]\n          # size映射到分辨率\n          size_to_resolution:\n            \"1280*720\": \"720p\"\n            \"720*1280\": \"720p\"\n            \"1920*1080\": \"1080p\"\n            \"1080*1920\": \"1080p\"\n          duration_options: [5, 10, 15]\n          duration_type: \"fixed\"\n\n      hailuo-2.3-pro:\n        endpoint: \"/api/v3/minimax/hailuo-2.3/i2v-pro\"\n        cost: 0.50  # 基础价格（480p）\n        cost_by_resolution:  # 按分辨率定价\n          \"480p\": 0.50\n          \"720p\": 1.50\n          \"1080p\": 3.00\n        speed: \"87秒\"\n        quality: \"最高（1080p）\"\n        type: \"i2v\"\n        # API参数配置\n        params:\n          # 必需参数: image\n          # 注意：prompt是可选的！duration和resolution由API自动处理\n          prompt: null  # 可选（特殊！）\n          duration: 5   # Hailuo 2.3需要显式duration，否则返回400\n          enable_prompt_expansion: true  # 默认true（与其他模型不同）\n        constraints:\n          # Hailuo没有resolution/duration参数，由API自动决定\n          auto_resolution: true\n          auto_duration: true\n          output_resolution: \"1080p\"  # 固定输出1080p\n\n      veo-3.1-i2v:\n        endpoint: \"/api/v3/google/veo3.1/image-to-video\"\n        cost: 3.20  # 8秒视频+音频的价格（$0.40/秒）\n        cost_by_duration:  # 按时长定价（视频+音频）\n          4: 1.60   # 4秒\n          6: 2.40   # 6秒\n          8: 3.20   # 8秒\n        cost_video_only:  # 仅视频（无音频）\n          4: 0.80   # $0.20/秒\n          6: 1.20\n          8: 1.60\n        speed: \"120-180秒\"\n        quality: \"极高（原生1080p+音频同步）\"\n        type: \"i2v\"\n        # API参数配置\n        params:\n          # 必需参数: prompt, image\n          last_image: null  # 可选，用于转场\n          aspect_ratio: \"16:9\"  # 16:9/9:16\n          duration: 8  # 4/6/8秒\n          resolution: \"1080p\"  # 720p/1080p\n          generate_audio: true  # 是否生成音频\n          negative_prompt: null\n          seed: -1\n        constraints:\n          aspect_ratio_options: [\"16:9\", \"9:16\"]\n          duration_options: [4, 6, 8]\n          duration_type: \"fixed\"\n          resolution_options: [\"720p\", \"1080p\"]\n          frame_rate: 24  # 固定24fps\n\n# ============================================================\n# 运镜模板（用于镜头选择）\n# ============================================================\ncamera_movements:\n  M1:\n    name: \"推进特写\"\n    description: \"Smooth camera push-in movement starting from medium shot and gradually zooming into extreme close-up of the main subject. The camera slowly tracks forward with steady dolly motion, maintaining sharp focus on the main subject while background gently blurs with shallow depth of field. Cinematic focus pulling technique creates professional depth separation. The movement is fluid and controlled, emphasizing subject details with elegant approach. Speed is medium-slow for dramatic effect, taking approximately 3-4 seconds to complete the full push-in motion. IMPORTANT: Keep the scene composition exactly as shown in the reference image - only move the camera closer to the subject. Do not add new elements. Lighting remains consistent throughout the movement, highlighting key features as camera advances.\"\n    suitable_for: \"开场钩子、核心功能强调、重点展示\"\n    duration: \"3-4s\"\n  M2:\n    name: \"俯视展开\"\n    description: \"Overhead crane shot beginning from high bird-eye view angle, descending gracefully to reveal architectural layout and spatial relationships. Camera starts at 80-90 degree top-down perspective, then smoothly cranes down to 45-degree angle while maintaining center framing. The descending motion reveals different viewing angles of the existing scene, from macro overview to detailed mid-level view. Movement is slow and majestic, spanning 3-5 seconds, allowing viewers to comprehend spatial structure. IMPORTANT: Maintain all subjects and elements exactly as shown in the reference image - only the camera angle changes from overhead to angled view. Do not add new objects or elements during the descent. This aerial-to-angled transition creates sense of scale and grandeur, perfect for showcasing complex systems, data centers, or global network visualizations.\"\n    suitable_for: \"云架构、数据中心、全局视角、宏观展示\"\n    duration: \"3-5s\"\n  M3:\n    name: \"平移扫过\"\n    description: \"Lateral tracking shot with smooth horizontal camera movement panning across the existing scene from left to right. Camera glides on steady rails maintaining constant distance and angle, creating elegant parallax effect between foreground and background elements. The pan motion is fluid and continuous, revealing different perspectives and details of the same scene composition. Speed is medium-paced, completing the sweep in 4-5 seconds. IMPORTANT: Keep all subjects and elements exactly as shown in the reference image - do not add new objects, products, or people. Only the camera angle changes as it pans horizontally across the scene. Camera height remains constant throughout the lateral motion.\"\n    suitable_for: \"多场景应用、功能列表、并列展示\"\n    duration: \"4-5s\"\n  M4:\n    name: \"旋转环绕\"\n    description: \"Dynamic 360-degree orbital camera movement circling around the central subject shown in the reference image. Camera maintains fixed distance while rotating smoothly in circular path, revealing subject from all angles. The rotation speed is steady and controlled, completing full or partial orbit in 3-4 seconds. As camera circles, different perspectives and details of the same subject are progressively revealed, creating dimensional understanding. IMPORTANT: Keep all subjects and scene elements exactly as shown in the reference image - only the camera rotates around the central subject. Do not add new objects or people during rotation. Lighting adjusts dynamically to maintain subject visibility from all angles. This rotation creates sense of three-dimensionality and showcases product design, AI model complexity, or architectural features comprehensively. Perfect for highlighting innovation and technological sophistication.\"\n    suitable_for: \"产品展示、AI模型可视化、立体呈现\"\n    duration: \"3-4s\"\n  M5:\n    name: \"拉出揭示\"\n    description: \"Reverse zoom movement pulling camera back from intimate close-up detail to reveal expansive wide shot. Starting with focused detail filling the frame, camera smoothly dollies backward while simultaneously zooming out, maintaining subject in frame while revealing surrounding context. The pull-back motion is deliberate and measured, taking 4-5 seconds to complete full reveal. As camera retreats, more of the existing scene becomes visible in the frame, showing how individual element fits into larger ecosystem. IMPORTANT: All elements should already exist in the reference image - the camera movement only reveals what is already there by pulling back. Do not add new objects, people, or scene elements during the pull-back. This movement creates powerful storytelling effect, transitioning from micro to macro perspective, ideal for concluding sequences and grand finale moments.\"\n    suitable_for: \"从单点到整体价值、结尾升华、全局揭示\"\n    duration: \"4-5s\"\n  M6:\n    name: \"分屏对比\"\n    description: \"Split-screen composition with side-by-side or top-bottom layout presenting contrasting scenarios simultaneously. Camera remains relatively static on both sides, with subtle push-in or drift movements to maintain visual interest. The split can be vertical (left-right) or horizontal (top-bottom), with clean dividing line or soft gradient transition. Each side presents distinct scenario: before/after, traditional/modern, manual/automated, or competing solutions. Within each frame, gentle camera movements highlight key differences. Duration is 3-4 seconds, allowing viewers to comprehend both scenarios and their contrast. This layout creates immediate visual comparison impact, perfect for demonstrating improvements, ROI, or competitive advantages.\"\n    suitable_for: \"Before/After对比、多场景并行、效果证明\"\n    duration: \"3-4s\"\n\n# ============================================================\n# LLM 配置（多提供商支持）\n# ============================================================\nllm:\n  # 默认提供商（可在 user.yaml 中用数字或名称覆盖）\n  default: \"deepseek\"\n\n  # 数字映射（方便 user.yaml 中选择）\n  number_map:\n    1: \"deepseek\"  # DeepSeek 直连（推荐，最便宜）\n\n  # 提供商配置\n  providers:\n    deepseek:\n      name: \"DeepSeek Chat\"\n      endpoint: \"https://api.deepseek.com/v1/chat/completions\"\n      model: \"deepseek-chat\"\n      api_key_env: \"DeepSeek_API_KEY\"  # 从 .env 读取\n      temperature: 0.7\n      max_tokens: null  # null 表示不限制\n      timeout_seconds: 60\n      rate_limits:\n        max_requests_per_minute: 50\n        max_requests_per_day: null\n\n# ============================================================\n# DeepSeek API配置（旧版，保留向后兼容）\n# ============================================================\ndeepseek:\n  base_url: \"https://api.deepseek.com\"\n  model: \"deepseek-chat\"\n  temperature: 0.7\n\n# ============================================================\n# WavespeedAI API配置\n# ============================================================\nwavespeed:\n  base_url: \"https://api.wavespeed.ai\"\n\n  # 轮询配置\n  polling:\n    interval: 5      # 轮询间隔（秒）\n    max_wait: 600    # 最大等待时间（秒）\n\n  # 重试配置\n  retry:\n    max_attempts: 3          # 最大重试次数\n    initial_delay: 5         # 初始延迟（秒）\n    backoff_multiplier: 2    # 退避倍数\n\n# ============================================================\n# 音频配置（方案A - Edge TTS + 本地音乐库）\n# ============================================================\naudio:\n  # 语音合成设置\n  voice_provider: \"edge\"  # 选项: edge（推荐，免费）\n  voice_name: \"zh-CN-YunyangNeural\"  # 默认Edge TTS音色（云扬-男声）\n  voice_volume: 1.0  # 配音音量 (0.0-1.0)\n\n  # Edge TTS音色映射表（用于user.yaml的数字选择）\n  voices:\n    1:\n      name: \"zh-CN-XiaoxiaoNeural\"\n      gender: \"Female\"\n      scene: \"新闻、小说\"\n      style: \"温柔\"\n      description: \"晓晓（女）- 温柔女声，适合新闻、小说旁白\"\n    2:\n      name: \"zh-CN-XiaoyiNeural\"\n      gender: \"Female\"\n      scene: \"卡通、小说\"\n      style: \"活泼\"\n      description: \"晓伊（女）- 活泼女声，适合卡通、小说\"\n    3:\n      name: \"zh-CN-YunjianNeural\"\n      gender: \"Male\"\n      scene: \"体育、小说\"\n      style: \"热情\"\n      description: \"云健（男）- 热情男声，适合体育、小说\"\n    4:\n      name: \"zh-CN-YunxiNeural\"\n      gender: \"Male\"\n      scene: \"小说\"\n      style: \"活泼、阳光\"\n      description: \"云希（男）- 活泼阳光男声，适合小说\"\n    5:\n      name: \"zh-CN-YunxiaNeural\"\n      gender: \"Male\"\n      scene: \"卡通、小说\"\n      style: \"可爱\"\n      description: \"云夏（男）- 可爱男声，适合卡通、小说\"\n    6:\n      name: \"zh-CN-YunyangNeural\"\n      gender: \"Male\"\n      scene: \"新闻\"\n      style: \"专业、可靠\"\n      description: \"云扬（男）- 专业可靠，适合新闻播音\"\n    7:\n      name: \"zh-CN-liaoning-XiaobeiNeural\"\n      gender: \"Female\"\n      scene: \"方言（辽宁）\"\n      style: \"幽默\"\n      description: \"晓北（女/辽宁）- 幽默方言\"\n    8:\n      name: \"zh-HK-HiuGaaiNeural\"\n      gender: \"Female\"\n      scene: \"通用\"\n      style: \"友好、积极\"\n      description: \"晓佳（女/香港）- 友好积极粤语\"\n    9:\n      name: \"zh-HK-HiuMaanNeural\"\n      gender: \"Female\"\n      scene: \"通用\"\n      style: \"友好、积极\"\n      description: \"晓曼（女/香港）- 友好积极粤语\"\n    10:\n      name: \"zh-HK-WanLungNeural\"\n      gender: \"Male\"\n      scene: \"通用\"\n      style: \"友好、积极\"\n      description: \"云龙（男/香港）- 友好积极粤语\"\n    11:\n      name: \"zh-TW-HsiaoChenNeural\"\n      gender: \"Female\"\n      scene: \"通用\"\n      style: \"友好、积极\"\n      description: \"晓臻（女/台湾）- 友好积极国语\"\n    12:\n      name: \"zh-TW-HsiaoYuNeural\"\n      gender: \"Female\"\n      scene: \"通用\"\n      style: \"友好、积极\"\n      description: \"晓雨（女/台湾）- 友好积极国语\"\n    13:\n      name: \"zh-TW-YunJheNeural\"\n      gender: \"Male\"\n      scene: \"通用\"\n      style: \"友好、积极\"\n      description: \"云哲（男/台湾）- 友好积极国语\"\n\n  # 旁白速度设置\n  chars_per_second: 4.0  # 旁白速度（字/秒）\n                         # 推荐值：4.0（精确匹配，后续加速控制）\n                         # 参考值：3.5-4.0（较快），2.5-3.0（慢速清晰）\n                         # Edge TTS实测最快约4.6字/秒\n\n  # 背景音乐设置\n  enable_background_music: true  # 是否启用背景音乐\n  music_source: \"local\"  # 选项: local（本地音乐库）\n  music_dir: \"./resource/songs\"  # 本地音乐目录\n  music_volume: 0.25  # 背景音乐音量 (0.0-1.0)\n\n  # 智能音乐匹配（新功能！）\n  use_intelligent_music_matching: true  # 是否启用基于旁白音频的智能匹配\n                                        # true: 5维度算法分析（节奏/能量/情绪/频谱/时长）\n                                        # false: 使用传统的关键词匹配\n  prefer_style_match: true  # 传统模式下是否优先匹配视觉风格\n\n# ============================================================\n# 字幕配置（方案A - SubMaker）\n# ============================================================\nsubtitle:\n  # 字幕生成设置\n  subtitle_provider: \"submaker\"  # 选项: submaker（推荐，免费且精确）\n  language: \"zh\"  # 语言代码\n\n  # 字幕样式\n  font_name: \"STHeiti\"  # 字体（macOS: STHeiti, Windows: Microsoft YaHei, Linux: WenQuanYi Zen Hei）\n  font_size: 24  # 字号（默认24，原来是48）\n  font_color: \"white\"  # 字体颜色\n  outline_color: \"black\"  # 描边颜色\n  outline_width: 2  # 描边宽度\n  position: \"bottom\"  # 位置: top, center, bottom\n  bottom_margin: 60  # 与画面底部的安全距离\n  line_offset_ratio: 0  # 额外抬升 0-1 倍行高，避免和进度条/遮挡重叠\n  safe_area_padding: 12  # 在字幕贴图底部增加透明 padding，避免被裁\n  font_size: 48  # 作为兜底字号，若未匹配分辨率映射时使用\n  font_size_by_resolution:\n    \"480p\": 42\n    \"720p\": 54\n    \"1080p\": 66\n\n# ============================================================\n# 视频写入与字幕样式（MoviePy参数）\n# ============================================================\nvideo_encoding:\n  codec: \"libx264\"\n  audio_codec: \"aac\"\n  preset: \"medium\"\n  logger: null\n  threads: 4\n  ffmpeg_params: ['-pix_fmt', 'yuv420p']\n\nsubtitles:\n  default_style:\n    font: './resource/fonts/NotoSansSC-Regular.otf'\n    font_candidates:\n      - './resource/fonts/NotoSansSC-Regular.otf'\n      - '/System/Library/Fonts/STHeiti Medium.ttc'\n      - '/System/Library/Fonts/PingFang.ttc'\n      - '/System/Library/Fonts/Hiragino Sans GB.ttc'\n      - 'C:\\\\Windows\\\\Fonts\\\\msyh.ttc'\n      - '/usr/share/fonts/truetype/wqy/wqy-zenhei.ttc'\n      - '/System/Library/Fonts/Supplemental/Arial Unicode.ttf'\n    fallback_font: './resource/fonts/NotoSansSC-Regular.otf'\n    fontsize: 48\n    color: 'white'\n    stroke_color: 'black'\n    stroke_width: 2\n    bottom_margin: 60\n    line_offset_ratio: 0  # 0=紧贴底部(含bottom_margin)，0.5=上移半行\n    safe_area_padding: 12  # 额外透明留白，防止渲染时裁切\n    resolution_styles:\n      \"480p\":\n        fontsize: 42\n        bottom_margin: 60\n      \"720p\":\n        fontsize: 54\n        bottom_margin: 72\n      \"1080p\":\n        fontsize: 66\n        bottom_margin: 90\n\n# ============================================================\n# 提示词模板（可编辑文案，减少硬编码）\n# ============================================================\nprompt_templates:\n  character_translation: |\n    请将以下中文角色描述翻译成适合AI图像生成的英文prompt：\n\n    中文描述：{description_cn}\n\n    要求：\n    1. 翻译成专业的英文prompt\n    2. 添加必要的视觉细节（如材质、光效、姿态）\n    3. 添加\"character design sheet, front view, full body, white background\"\n    4. 80-120词\n\n    只返回英文prompt，不要其他内容。\n\n  character_dna: |\n    基于以下角色描述，生成一个**极其详细**的英文外观描述（Character DNA），用于AI图像/视频生成时保持角色一致性。\n\n    原始描述：{description_cn}\n    参考prompt：{prompt_en}\n    {reference_note}\n\n    请生成一个70-100词的详细英文描述，**必须包含以下关键视觉特征**：\n    1. 性别、年龄、身高体型\n    2. **最显著的**面部特征（眼睛、发型、肤色）\n    3. **🎨 服装细节（重点！至少20-30词）**：\n       - 具体款式（如：长袖/短袖、领口样式、裙长/裤长）\n       - 精确颜色（主色调+辅助色，如\"深红色\"而非\"红色\"）\n       - 材质质感（如：丝绸、棉质、皮革、针织）\n       - 关键细节（纽扣、图案、装饰、配件）\n    4. **最独特的**标识（如有纹身、logo、特殊配饰）\n    5. 整体气质（1-2个形容词）\n\n    ⚠️ **服装一致性是角色识别的关键！必须详细描述服装的颜色、款式、材质和细节。**\n\n    格式要求：\n    - 用英文\n    - 第三人称描述（如\"She has...\"、\"He wears...\")\n    - 适合作为AI视频生成prompt的一部分\n    - 具体、详细、专业\n    - 重点描述关键视觉特征\n\n    示例1（东方女性，约90词，强调服装）：\n    \"An East Asian woman in her early 20s, approximately 165cm tall with a slender graceful build. She has shoulder-length straight jet-black hair with subtle layers, warm porcelain complexion, and almond-shaped dark brown eyes. **CLOTHING DETAILS**: She wears a vibrant crimson red long-sleeve silk qipao dress with a fitted bodice. The dress features a high mandarin collar with delicate golden frog button closures, knee-length hem with elegant side slits revealing black silk stockings. Gold floral embroidery patterns adorn the right shoulder area. She pairs this with simple white pearl earrings and black low-heeled shoes. Overall demeanor: elegant and graceful.\"\n\n    示例2（商务女性，约85词，强调服装）：\n    \"A professional woman in her mid-30s, 170cm tall with an athletic build. She has short, neat dark brown bob-cut hair styled with professional precision, fair complexion, and sharp hazel eyes behind thin-rimmed glasses. **CLOTHING DETAILS**: She wears a tailored navy blue wool blazer with notched lapels and two front buttons, paired with a crisp white cotton button-down shirt underneath. The outfit includes matching navy blue slim-fit trousers with a subtle pinstripe pattern and black leather belt. Silver wristwatch on left wrist. Black leather oxford shoes. Confident, authoritative presence.\"\n\n    只返回英文描述，不要其他内容。\n\n  story_outline: |\n    你是一位专业的视频脚本策划师。请为以下主题创作一个{shot_count}镜头的短视频故事大纲。\n\n    主题：{topic}\n    视觉风格：{style_name}\n    镜头数：{shot_count}个\n\n    故事结构要求（起承转合）：\n    1. 每个镜头是故事的有机组成部分，不是独立的片段\n    2. 镜头之间有明确的因果关系或时间推进\n    3. 视觉风格统一：{visual_style}\n    4. 色彩基调：{color_palette}\n\n    请以JSON格式输出故事大纲：\n    {{\n      \"title\": \"故事标题\",\n      \"theme\": \"核心主题（一句话）\",\n      \"visual_theme\": {{\n        \"primary_colors\": [\"{primary_color_1}\", \"{primary_color_2}\"],\n        \"mood\": \"{mood}\"\n      }},\n      \"shot_breakdown\": [\n        {{\n          \"shot_number\": 1,\n          \"scene_summary\": \"镜头内容概要（20字内）\",\n          \"key_action\": \"关键动作或视觉重点\",\n          \"transition_to_next\": \"与下一镜头的连接点\"\n        }}\n        // ... {shot_count}个镜头\n      ]\n    }}\n\n  narration_framework: |\n    你是一位资深广告文案大师。请为以下故事创作广告词整体框架。\n\n    主题：{topic}\n    故事标题：{title}\n    核心主题：{theme}\n    视频总时长：{total_duration}秒（{shot_count}个镜头，每镜头{shot_duration}秒）\n    配音语速：{chars_per_second}字/秒\n\n    故事分镜概要：\n    {shot_summaries}\n\n    创作要求：\n    1. **整体定位**：确定广告词的主线（一句话，如\"探索未知，点燃激情\"）\n    2. **语言风格**：定义文案的语言特色，要求：\n       - ❌ 禁止四字成语堆砌\n       - ✅ 必须长短句结合（短句冲击+长句铺陈）\n       - 自然流畅，像真实的广告配音\n       - 风格示例：\"诗意叙事型\"、\"悬念递进型\"、\"情感共鸣型\"\n    3. **分段要点**：为每个镜头分配核心表达要点，确保：\n       - 全片叙事连贯递进（引入→展开→高潮→升华）\n       - 每段要点不重复、不跳跃\n       - 与画面内容紧密呼应\n\n    注意事项：\n    - 不要生成具体文案，只需框架性指导\n    - 确保情感递进自然（平和→激昂→震撼）\n    - 避免空洞词汇（创新、强大、完美等）\n    - 强调长短句交替的节奏感\n\n    请以JSON格式输出：\n    {{\n      \"overall_tagline\": \"整体主线（一句话）\",\n      \"narration_style\": \"语言风格描述\",\n      \"emotion_arc\": \"情感曲线（如：平静→好奇→振奋→震撼）\",\n      \"shot_points\": [\n        {{\n          \"shot_number\": 1,\n          \"core_message\": \"本镜头核心要传达的信息\",\n          \"emotion\": \"本镜头的情感基调\",\n          \"connection\": \"与上下镜头的关系\"\n        }}\n        // ... {shot_count}个镜头\n      ]\n    }}\n\n  shot_prompt: |\n    基于故事大纲，生成第{shot_index}个镜头的详细英文prompt（用于AI视频生成）。\n\n    整体故事：{story_theme}\n    视觉主题：色调{visual_colors}，氛围{visual_mood}\n    {character_section}\n    {background_note}\n    当前镜头（{shot_index}/{shot_total}）：\n    - 场景概要：{scene_summary}\n    - 关键动作：{key_action}\n\n    {previous_line}\n    {next_line}\n\n    风格要求：\n    - 视觉风格：{visual_style}\n    - 色彩方案：{color_palette}\n    - 光影：{lighting}\n    - 镜头运动（必须严格遵守）：{camera_description}\n\n    请生成一个80-120词的详细英文prompt，要求：\n    1. {first_requirement}\n    2. {second_requirement}\n    3. {third_requirement}\n    4. 严格遵守上述风格模板\n    5. 使用cinematic专业术语\n\n    只返回prompt文本，不要其他内容。\n\n  narration_shot: |\n    为这个广告视频镜头创作配音文案（中文）。\n\n    【镜头信息】\n    场景：{scene_summary}\n    位置：第{shot_index}/{shot_total}个镜头\n    实际视频时长：{actual_duration}秒\n    {framework_guidance}{previous_context}\n\n    【核心要求】\n    1. **字数精确**：严格{target_chars}字左右（±2字），对应{actual_duration}秒配音\n    2. **长短句结合**（最重要！）：\n       - ❌ 严禁：纯四字成语（如\"破碎凝视，数据涌动\"）\n       - ✅ 必须：短句(3-6字) + 长句(8-15字)交替\n       - 好示例：\"光影交织。数据在云端流转，智慧在指尖绽放。\"（17字）\n       - 好示例：\"这是开始。当第一行代码运行，未来就在眼前。\"（18字）\n       - 差示例：\"破碎凝视，数据涌动，智慧觉醒，未来可期。\"（16字，全是四字）\n    3. **连贯递进**：与前文{continuity}，情感逐步{emotion_arc}\n    4. **有感染力**：使用具体意象、动词和细节，避免空洞形容词\n    5. **纯文本**：不要markdown符号，直接输出文案\n\n    【创作规范】\n    - 必须至少包含一个长句（≥8字），不能全是短句\n    - 使用比喻、排比等修辞（但不要过度）\n    - 自然口语化，像真人在讲广告故事\n    - {ending_requirement}\n\n    请直接输出{target_chars}字的旁白文案：\n\n  condense_narration: |\n    请精简以下广告文案，保留核心信息和感染力：\n\n    原文（{original_chars}字）：\n    {original_text}\n\n    要求：\n    1. **字数**: 严格控制在{target_chars}字左右（±5字）\n    2. **保留**: 核心信息、情感基调、修辞手法\n    3. **删减**: 重复内容、过度修饰、不必要的细节\n    4. **风格**: 保持原有的语言风格和节奏感\n    5. **流畅**: 精简后依然通顺自然，不生硬\n\n    请直接输出精简后的文案，不要其他内容：\n\n  full_narration: |\n    为这个广告视频创作一段完整的配音文案（中文）。\n\n    【视频信息】\n    全片时长：{total_duration}秒\n    镜头数量：{shot_count}个\n    分镜概览：\n    {story_context}\n    {framework_info}\n\n    【核心要求】\n    1. **完整连贯**：生成一段完整的旁白文案，覆盖整个视频故事\n    2. **字数限制**：必须严格控制在{min_chars}到{max_chars}字之间（对应{total_duration}秒配音，语速{chars_per_second}字/秒）。这是硬性要求，超出范围的文案将被截断。\n    3. **自然流畅**：像讲故事一样，有起承转合，有情感递进\n    4. **不要分段**：直接输出完整文案，不要分镜头或分段标记\n    5. **有感染力**：使用具体意象、动词和细节，避免空洞形容词\n    6. **纯文本**：不要markdown符号、不要分段序号，直接输出文案\n\n    【创作规范】\n    - 长短句结合，富有节奏感\n    - 使用比喻、排比等修辞手法\n    - 自然口语化，像真人在讲广告故事\n    - 结尾要有升华和余味\n\n    请直接输出完整的旁白文案（约{suggested_chars}字）：\n\n  rewrite_narration: |\n    请将以下广告文案精简到{target_chars}字以内，保持核心信息和感染力：\n\n    原文案（{original_chars}字）：\n    {original_text}\n\n    要求：\n    1. 必须控制在{target_chars}字以内\n    2. 保留核心卖点和情感\n    3. 保持语言的流畅和感染力\n    4. 直接输出精简后的文案，不要任何说明\n\n# ============================================================\n# 视频合成配置\n# ============================================================\ncomposer:\n  video_codec: \"libx264\"  # 视频编码\n  audio_codec: \"aac\"  # 音频编码\n  bitrate: \"5000k\"  # 码率\n  transition_duration: 0.5  # 转场时长（秒）\n\n# ============================================================\n# Logo动画配置\n# ============================================================\nlogo:\n  # 是否启用logo动画\n  enabled: true  # 设为true启用\n\n  # Logo文件路径（支持PNG/JPG，推荐透明PNG）\n  logo_file: \"./resource/logo/aka.jpg\"\n\n  # Logo显示位置: 固定片尾\n  position: \"end\"\n\n  # Logo展示总时长（秒）\n  duration: 2.0\n\n  # 淡入时长（秒）\n  fadein_time: 1.0\n\n  # 淡出时长（秒，已停用）\n  fadeout_time: 0.0\n\n  # Logo缩放比例（相对视频宽度，0.3=视频宽度的30%）\n  logo_scale: 0.3\n"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:29:53.769Z",
          "resultDisplay": "",
          "displayName": "ReadFile",
          "description": "Reads and returns the content of a specified file. If the file is large, the content will be truncated. The tool's response will clearly indicate if truncation has occurred and will provide details on how to read more of the file using the 'offset' and 'limit' parameters. Handles text, images (PNG, JPG, GIF, WEBP, SVG, BMP), audio files (MP3, WAV, AIFF, AAC, OGG, FLAC), and PDF files. For text files, it can read specific line ranges.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Analyzing API Endpoints",
          "description": "I've been delving into the `routes_digital_human.py` file and have grasped its core function: It's a FastAPI router tailored for digital human creation. Specifically, my attention is drawn to the defined endpoints, with a clear focus on those handling the generation and management of digital human tasks. The `/api/tasks` endpoint, for task creation, has caught my eye.",
          "timestamp": "2026-01-03T08:29:53.736Z"
        },
        {
          "subject": "Inspecting Endpoint Details",
          "description": "I'm now zeroing in on the individual endpoints. The `POST /api/tasks` endpoint looks particularly interesting, as it seems to orchestrate the entire digital human creation pipeline. I'm also examining the data models used for requests and responses, to understand how data is passed between the client and the server. I'm taking notes on potential areas for optimization.",
          "timestamp": "2026-01-03T08:29:53.737Z"
        },
        {
          "subject": "Checking Configuration Details",
          "description": "My current focus is the `config.yaml` file. I'm parsing it to pinpoint key configurations, such as API keys and storage locations, to fully understand the system's dependencies. Examining the `DigitalHumanService`'s initialization is my next step, to get a better grasp of how these configurations are being used within the application.",
          "timestamp": "2026-01-03T08:29:53.738Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 14156,
        "output": 9,
        "cached": 1735,
        "thoughts": 364,
        "tool": 0,
        "total": 14529
      }
    },
    {
      "id": "48f0d515-4e58-42d6-aabc-f7506fcaab4f",
      "timestamp": "2026-01-03T08:30:01.347Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "read_file-1767429001309-a0ddae1e27752",
          "name": "read_file",
          "args": {
            "file_path": "run_tests.sh"
          },
          "result": [
            {
              "functionResponse": {
                "id": "read_file-1767429001309-a0ddae1e27752",
                "name": "read_file",
                "response": {
                  "output": "#!/bin/bash\n# 运行前端构建 + 后端测试的统一脚本\n\nset -euo pipefail\n\nREPO_ROOT=\"$(cd \"$(dirname \"${BASH_SOURCE[0]}\")\" && pwd)\"\n\nif [ ! -d \"$REPO_ROOT/frontend\" ]; then\n  echo \"frontend/ 不存在，跳过前端构建\"\nelse\n  echo \"==> 构建前端 (frontend/)\"\n  pushd \"$REPO_ROOT/frontend\" >/dev/null\n  if [ ! -d node_modules ]; then\n    npm ci\n  else\n    npm install\n  fi\n  npm run build\n  popd >/dev/null\nfi\n\necho \"==> 运行 Python 测试\"\nexport PYTHONPATH=\"$REPO_ROOT\"\nsource \"$REPO_ROOT/venv/bin/activate\"\npytest \"$@\"\n"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:30:01.346Z",
          "resultDisplay": "",
          "displayName": "ReadFile",
          "description": "Reads and returns the content of a specified file. If the file is large, the content will be truncated. The tool's response will clearly indicate if truncation has occurred and will provide details on how to read more of the file using the 'offset' and 'limit' parameters. Handles text, images (PNG, JPG, GIF, WEBP, SVG, BMP), audio files (MP3, WAV, AIFF, AAC, OGG, FLAC), and PDF files. For text files, it can read specific line ranges.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Inspecting Project Configuration",
          "description": "I'm currently focused on the `config.yaml` file. My attention has been caught by the visual styles configurations, recognizing the potential for diverse video generation. I'm also noting the API key placeholders, and I'm checking the rate limits that are set up.",
          "timestamp": "2026-01-03T08:30:01.301Z"
        },
        {
          "subject": "Examining Configuration Details",
          "description": "I'm now diving deep into the configuration details. The visual styles, API key locations, and rate limits are the core focus, but I'm also examining the video generation workflow and runtime parameters. I'm taking a close look at the concurrency, retry settings and default parameters to tune them and establish robust defaults. I'm also reviewing the polling and camera movements details.",
          "timestamp": "2026-01-03T08:30:01.305Z"
        },
        {
          "subject": "Grasping Project Components",
          "description": "I've just finished a comprehensive review of the `config.yaml` file. I've gained a good understanding of the project's capabilities. I'm moving on to examine the `run_tests.sh` script to understand the project's test suite and how to verify my future modifications.",
          "timestamp": "2026-01-03T08:30:01.306Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 27188,
        "output": 11,
        "cached": 14786,
        "thoughts": 372,
        "tool": 0,
        "total": 27571
      }
    },
    {
      "id": "384c468d-43e6-44da-9029-f5490188b2ef",
      "timestamp": "2026-01-03T08:30:05.672Z",
      "type": "gemini",
      "content": "Okay, I've reviewed the project's structure, including the FastAPI backend, the `config.yaml` file, and the testing script. I'm ready for your instructions.",
      "thoughts": [
        {
          "subject": "Analyzing Project Setup",
          "description": "I've been examining the project structure. I've grasped the script's functionality: building the frontend and running pytest. I'm feeling confident about my comprehension of the dependencies and testing workflow now. I'm prepared to contribute to whatever task you need me for.",
          "timestamp": "2026-01-03T08:30:05.661Z"
        }
      ],
      "tokens": {
        "input": 27385,
        "output": 38,
        "cached": 9129,
        "thoughts": 60,
        "tool": 0,
        "total": 27483
      },
      "model": "gemini-2.5-pro"
    },
    {
      "id": "0f4e6cc7-879d-49ef-a8b7-4776be5de7de",
      "timestamp": "2026-01-03T08:30:35.203Z",
      "type": "user",
      "content": "扮演资深ux，对前端网页给出批判性意见"
    },
    {
      "id": "be38e78f-08f0-4667-a551-7fd203195950",
      "timestamp": "2026-01-03T08:30:45.071Z",
      "type": "gemini",
      "content": "I'll now act as a senior UX designer. To give you the most relevant and critical feedback, I need to understand what I'm looking at. Could you please first tell me the URL of the web page you want me to review? If it's running locally, I'll need to inspect the code.",
      "thoughts": [
        {
          "subject": "Assessing the Application's Goal",
          "description": "I'm starting to unpack the application's core functionality. By examining file names and the `config.yaml` file, I'm forming an initial hypothesis about the intended purpose of the frontend. I need to nail down the fundamental goals before I can provide any meaningful UX critique.",
          "timestamp": "2026-01-03T08:30:45.061Z"
        },
        {
          "subject": "Deconstructing the Project Scope",
          "description": "Now I am aiming to establish the application's boundaries. I'm focusing on the frontend, specifically a Vue.js project. Examining `App.vue` and component directories is the next crucial step. My priority is to grasp the core user flow, from initial interaction through to video generation, and how all the elements interact with each other.",
          "timestamp": "2026-01-03T08:30:45.064Z"
        },
        {
          "subject": "Mapping the User's Intent",
          "description": "I'm now prioritizing the user's requirements. It appears they are seeking a thorough UX audit of a Vue.js-based video generation tool. My plan is to start by understanding the system's purpose. Then, I'll dive deep into the frontend code, specifically `App.vue`, to uncover its functionality and user flows. Finally, I'll provide actionable feedback, and look for potential UX pain points.",
          "timestamp": "2026-01-03T08:30:45.065Z"
        }
      ],
      "tokens": {
        "input": 27435,
        "output": 66,
        "cached": 25506,
        "thoughts": 393,
        "tool": 0,
        "total": 27894
      },
      "model": "gemini-2.5-pro"
    },
    {
      "id": "01ea9e44-3d37-484f-8d7e-37bcbc1dbc77",
      "timestamp": "2026-01-03T08:31:52.324Z",
      "type": "user",
      "content": "ren.linapp.fun,这个前端页面就在本项目里，参考agents.md"
    },
    {
      "id": "9ce4ebf2-16e7-429c-bacd-98995591480a",
      "timestamp": "2026-01-03T08:31:58.263Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "read_file-1767429118231-2aa89f5db7a95",
          "name": "read_file",
          "args": {
            "file_path": "AGENTS.md"
          },
          "result": [
            {
              "functionResponse": {
                "id": "read_file-1767429118231-2aa89f5db7a95",
                "name": "read_file",
                "response": {
                  "output": "中文对话\n\n# Repository Guidelines\n\n## 项目定位\n- 本仓库现为**数字人生成 Web 项目**，前端负责配置、头像上传与播放展示，后端聚焦编排数字人三阶段（形象→语音→唇形）生成。\n- 所有数字人生成能力以 `doc/数字人.md` 的 WaveSpeedAI API 规范为准：Seedream 图像、MiniMax 语音、Infinitetalk 唇同步等模型需在 `py/services/` 中封装为可复用客户端。\n- 继承原故事化视频工程的日志、配置与限流体系，确保新功能沿用既有 `py/function/`、`py/api/` 的架构与异常处理模式。\n\n## 目录与模块\n- **前端 (`frontend/`)**：基于 Vite + Vue 3 的 SPA（`src/App.vue`），`npm run build` 输出 `frontend/dist/`，`config.js` 启动时自动推导 `API_BASE`；负责提示词/脚本/角色参数输入与任务轮询、播放器/下载交互。\n- **后端 (`ad-back.py` + `py/`)**：保留 Flask/FastAPI 结构，新增 `digital_human` 相关蓝图，暴露任务编排、任务状态查询与素材上传 API。端口固定 **18005** (供 `ren.linapp.fun` Nginx 反代)。\n- **配置**：`.env` 存放 WaveSpeed API Key 等敏感信息；`config.yaml` 负责任务超时、并发、静态资源目录；`user.yaml` 仅保留示例参数。\n- **文档**：除 `README.md` 以外的新增文档只放在 `doc/`，测试说明集中在 `test/`；`doc/design.md` 为唯一权威架构文档，历史 `doc/plan.md` 已下线。\n\n## 开发与测试\n- Python 3.10+ 且遵循 PEP 8，组件之间优先通过服务层交互（例如 `services/digital_human_service.py`）。前端保持 ESLint/Prettier 默认配置，提交前运行 `npm run build`（如适用）。\n- 常用命令：\n  - `source venv/bin/activate && pip install -r requirements.txt`\n  - `python3 ad-back.py --port 18005` 或 `restart_api_server.sh`（自动加载 `.env` 并重启 uvicorn）\n  - `npm install && npm run dev`（位于 `frontend/`）\n- `python3 py/test_network.py --digital-human` 或 `test/smoke_digital_human.sh`（10 秒冒烟，输出到 `output/smoke/aka-*`）\n- 提交前默认运行 `PYTEST_WAVESPEED_MOCK=1 ./run_tests.sh`（聚合 `npm run build` + `pytest`）；CI/预提交可直接调用 `./ci.sh` 以保持一致。\n- 后端涉及付费 API 的联调需使用最短文本、低分辨率头像以控制成本；本地调试优先使用 mock，并记录 `trace_id` + 成本至 `test/test-digital-human.md`。\n- `TaskResponse.assets.local_video_url` 必须指向 `/output/<job_id>/digital_human.mp4`，前端会优先使用该本地域名播放/下载；若返回 CDN URL 需放在 `video_url` 备用。\n\n## 部署与安全\n- Nginx 需将 `ren.linapp.fun` 的 HTTPS 流量转发到 `127.0.0.1:18005`，并开启 `/api/` 的超时 120s 以容纳视频合成轮询。\n- 同步部署 `frontend/dist` 到 Nginx 根目录，`client_max_body_size 200m` 以便上传头像/脚本，并通过 `location /output/ { alias /home/ren/output/; }` 公开任务产物；其余未命中路由需回退到 `index.html`。\n- `.env` 永不提交；若需要演示配置，提供 `.env.example` 并写明需要的 Key：`WAVESPEED_API_KEY`、`MINIMAX_KEY` 等。\n- 静态文件（例如生成后的数字人片段）统一放到 `output/` 子目录或对象存储挂载点，Git 忽略。\n\n## 代码与提交流程\n- 提交信息使用祈使句（如 “add digital human service client”），一次提交聚焦单变更。\n- PR 说明需覆盖：数字人 API 调用更改、前后端交互协议、测试命令（含 mock/真实调用）、可能成本。\n- 引入新第三方库时同步更新 `requirements.txt` 或前端 `package.json`，并在 README 记录用途。\n\n## 质量保障\n- 关键路径必须有最小化端到端验证：调用接口生成 1 段短语音 + 5-10 秒唇同步视频；通过 `test/test-digital-human.md` 记录命令、job_id、trace_id、cost。\n- 继续沿用原项目日志与重试策略，任何调用 WaveSpeed API 的地方默认 3 次指数退避重试并输出 trace id；`output/<job_id>/log.txt` 必须保持 `[ISO][LEVEL][trace=xxx] message` 结构。\n"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:31:58.262Z",
          "resultDisplay": "",
          "displayName": "ReadFile",
          "description": "Reads and returns the content of a specified file. If the file is large, the content will be truncated. The tool's response will clearly indicate if truncation has occurred and will provide details on how to read more of the file using the 'offset' and 'limit' parameters. Handles text, images (PNG, JPG, GIF, WEBP, SVG, BMP), audio files (MP3, WAV, AIFF, AAC, OGG, FLAC), and PDF files. For text files, it can read specific line ranges.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Inspecting the Codebase",
          "description": "\\n\\n\n\nI've begun by examining the `AGENTS.md` file, hoping to find insights into the project's architecture and the role of the agents. After that, I will attempt to fetch and analyze the content from the provided URL, focusing on understanding the web interface's functionality. This will hopefully help me find any initial useful information.",
          "timestamp": "2026-01-03T08:31:58.226Z"
        },
        {
          "subject": "Evaluating the Architecture",
          "description": "\\n\\n\n\nMy initial focus remains on understanding the system's core components. I successfully reviewed `AGENTS.md`, taking notes on the agents' responsibilities. Now I'm preparing to fetch and analyze the content from the provided URL, focusing on UX aspects. The goal is to identify early design issues.",
          "timestamp": "2026-01-03T08:31:58.228Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 27519,
        "output": 10,
        "cached": 26982,
        "thoughts": 137,
        "tool": 0,
        "total": 27666
      }
    },
    {
      "id": "03356de7-908f-4a67-986b-9c270d39e9d8",
      "timestamp": "2026-01-03T08:33:26.794Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "web_fetch-1767429122271-e2326147a3303",
          "name": "web_fetch",
          "args": {
            "prompt": "Fetch the content of the URL https://ren.linapp.fun"
          },
          "result": [
            {
              "functionResponse": {
                "id": "web_fetch-1767429122271-e2326147a3303",
                "name": "web_fetch",
                "response": {
                  "error": "Error during fallback fetch for https://ren.linapp.fun/: This operation was aborted"
                }
              }
            }
          ],
          "status": "error",
          "timestamp": "2026-01-03T08:33:26.793Z",
          "resultDisplay": "Error during fallback fetch for https://ren.linapp.fun/: This operation was aborted",
          "displayName": "WebFetch",
          "description": "Processes content from URL(s), including local and private network addresses (e.g., localhost), embedded in a prompt. Include up to 20 URLs and instructions (e.g., summarize, extract specific data) directly in the 'prompt' parameter.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Assessing the Project's Scope",
          "description": "I've reviewed the `AGENTS.md` file, confirming this is a digital human generation project. I see a Vue 3 SPA frontend for configuration and results display. The backend houses the generation logic. Next, I'll analyze the URL's content to get a clearer picture of the web page's specifics.",
          "timestamp": "2026-01-03T08:32:02.267Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 28754,
        "output": 18,
        "cached": 26992,
        "thoughts": 64,
        "tool": 0,
        "total": 28836
      }
    },
    {
      "id": "752e90d3-017d-4e61-9e2f-e774e4a53079",
      "timestamp": "2026-01-03T08:33:32.145Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "list_directory-1767429212119-10c101631d634",
          "name": "list_directory",
          "args": {
            "dir_path": "frontend/src/components/"
          },
          "result": [
            {
              "functionResponse": {
                "id": "list_directory-1767429212119-10c101631d634",
                "name": "list_directory",
                "response": {
                  "output": "Directory listing for /home/ren/frontend/src/components:\n[DIR] panels\n[DIR] workspace\nConfigCard.vue\nTaskFlowPreview.vue"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:33:32.144Z",
          "resultDisplay": "Listed 4 item(s).",
          "displayName": "ReadFolder",
          "description": "Lists the names of files and subdirectories directly within a specified directory path. Can optionally ignore entries matching provided glob patterns.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Analyzing Web Failure",
          "description": "I've determined the web fetch failed due to the website's SPA design. Initial HTML retrieval won't suffice. My plan now is to leverage the frontend source code I have access to. I'll begin by systematically listing components to understand the UI and UX.",
          "timestamp": "2026-01-03T08:33:32.114Z"
        },
        {
          "subject": "Enumerating Component Files",
          "description": "I am now focused on listing all the files within the `frontend/src/components` directory. This should provide me with a comprehensive view of the UI components and how they're structured, allowing me to better understand the SPA and its inner workings. I believe this will then lead to a more effective method of content retrieval.",
          "timestamp": "2026-01-03T08:33:32.116Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 28794,
        "output": 12,
        "cached": 26926,
        "thoughts": 93,
        "tool": 0,
        "total": 28899
      }
    },
    {
      "id": "1424f5e9-8347-46ed-89b6-0c42cb866c8d",
      "timestamp": "2026-01-03T08:33:37.623Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "list_directory-1767429217600-f51ca3e6d9408",
          "name": "list_directory",
          "args": {
            "dir_path": "frontend/src/components/panels"
          },
          "result": [
            {
              "functionResponse": {
                "id": "list_directory-1767429217600-f51ca3e6d9408",
                "name": "list_directory",
                "response": {
                  "output": "Directory listing for /home/ren/frontend/src/components/panels:\nAvatarConfigurator.vue\nCostEstimateBadge.vue\nCreationPanel.vue\nMaterialPanel.vue\nMonitorPanel.vue\nProgressPanel.vue\nResultAssetSection.vue\nScriptEditor.vue"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:33:37.622Z",
          "resultDisplay": "Listed 8 item(s).",
          "displayName": "ReadFolder",
          "description": "Lists the names of files and subdirectories directly within a specified directory path. Can optionally ignore entries matching provided glob patterns.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Analyzing the UI Structure",
          "description": "I'm starting to get a picture of the UI. The presence of `ConfigCard.vue`, `TaskFlowPreview.vue`, and the `panels` and `workspace` directories strongly suggests a configuration area alongside a task flow preview. I'm now digging into the `panels` directory.",
          "timestamp": "2026-01-03T08:33:37.596Z"
        },
        {
          "subject": "Unpacking Directory Contents",
          "description": "I've got a grasp of the general UI layout, thanks to the filenames. The inclusion of the `panels` and `workspace` directories reinforces the configuration/preview concept. Now I'm focused on the contents within those directories to understand how the components are arranged and how they interact. This should reveal the workflow logic.",
          "timestamp": "2026-01-03T08:33:37.598Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 28845,
        "output": 13,
        "cached": 1789,
        "thoughts": 73,
        "tool": 0,
        "total": 28931
      }
    },
    {
      "id": "d92134e5-0dfa-4a28-992b-5a00c28d27c4",
      "timestamp": "2026-01-03T08:33:42.742Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "list_directory-1767429222719-3d86d8af1425",
          "name": "list_directory",
          "args": {
            "dir_path": "frontend/src/components/workspace"
          },
          "result": [
            {
              "functionResponse": {
                "id": "list_directory-1767429222719-3d86d8af1425",
                "name": "list_directory",
                "response": {
                  "output": "Directory listing for /home/ren/frontend/src/components/workspace:\nPreparationPanel.vue\nTaskList.vue"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:33:42.741Z",
          "resultDisplay": "Listed 2 item(s).",
          "displayName": "ReadFolder",
          "description": "Lists the names of files and subdirectories directly within a specified directory path. Can optionally ignore entries matching provided glob patterns.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Considering the UI Structure",
          "description": "I'm now diving into the `panels` directory. Analyzing `AvatarConfigurator.vue`, I suspect it handles avatar customization. The presence of `CostEstimateBadge.vue` suggests real-time cost feedback, and now I'm getting into the `CreationPanel`...",
          "timestamp": "2026-01-03T08:33:42.714Z"
        },
        {
          "subject": "Exploring Panel Functionality",
          "description": "I've got a grasp of the `panels` directory now. The `AvatarConfigurator`, `CostEstimateBadge`, and `CreationPanel` are clear, and I'm beginning to see the layout. Now, I'm shifting to the `MaterialPanel`,  `MonitorPanel`, and other panels to understand how they work together, and I'll soon move onto the `workspace` directory.",
          "timestamp": "2026-01-03T08:33:42.716Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 28921,
        "output": 13,
        "cached": 28554,
        "thoughts": 177,
        "tool": 0,
        "total": 29111
      }
    },
    {
      "id": "1d128051-df91-4e6a-832f-dae8da451ba8",
      "timestamp": "2026-01-03T08:33:47.635Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "read_file-1767429227613-e7ceaea42d8ee",
          "name": "read_file",
          "args": {
            "file_path": "frontend/src/App.vue"
          },
          "result": [
            {
              "functionResponse": {
                "id": "read_file-1767429227613-e7ceaea42d8ee",
                "name": "read_file",
                "response": {
                  "output": "\nIMPORTANT: The file content has been truncated.\nStatus: Showing lines 1-2000 of 2592 total lines.\nAction: To read more of the file, you can use the 'offset' and 'limit' parameters in a subsequent 'read_file' call. For example, to read the next section of the file, use offset: 2000.\n\n--- FILE CONTENT (truncated) ---\n<template>\n  <main class=\"page\">\n    <header class=\"hero hero--minimal\">\n      <div class=\"hero-main\">\n        <div class=\"hero-title\">\n          <p class=\"hero-eyebrow\">数字人生成中心</p>\n          <h1>10 秒配置，即刻生成数字人</h1>\n          <p class=\"hero-subtitle\">Seedream 形象 · MiniMax 语音 · Infinitetalk 唇形</p>\n        </div>\n        <div class=\"hero-cta\">\n          <button type=\"button\" class=\"hero-cta__primary\" :disabled=\"submitting\" @click=\"handleHeroCreateTask\">\n            {{ submitting ? '创建中…' : '开始创建' }}\n          </button>\n          <button type=\"button\" class=\"hero-cta__ghost\" @click=\"handleHeroMonitor\">查看任务状态</button>\n          <p class=\"hero-cta__hint\">{{ heroSummaryText }}</p>\n        </div>\n      </div>\n    </header>\n\n    <div class=\"workspace\">\n      <section class=\"workspace__column workspace__column--system\">\n        <PreparationPanel\n          class=\"workspace__preparation\"\n          :is-mobile=\"isMobile\"\n          :api-key-value=\"apiKeyInput\"\n          :api-key-visible=\"apiKeyVisible\"\n          :api-key-error=\"apiKeyError\"\n          :is-api-key-valid=\"isApiKeyValid\"\n          :has-stored-key=\"Boolean(dashboardStore.apiKey)\"\n          :balance-display=\"balanceDisplay\"\n          :balance-loading=\"balanceLoading\"\n          :debug-mode=\"debugMode\"\n          :debug-hint=\"debugHint\"\n          :app-config=\"config\"\n          :error-message=\"dashboardStore.errors.apiKey\"\n          :task-error=\"dashboardStore.errors.tasks\"\n          :task-history=\"taskHistory\"\n          :current-job-id=\"currentJobId\"\n          :polling-active=\"pollingActive\"\n          :describe-status=\"describeStatus\"\n          :format-timestamp=\"formatTimestamp\"\n          @update:api-key-value=\"handleApiKeyInputChange\"\n          @update:api-key-visible=\"handleApiKeyVisibleChange\"\n          @validate-api-key=\"validateApiKey\"\n          @save-api-key=\"saveApiKeySetting\"\n          @clear-api-key=\"clearApiKeySetting\"\n          @refresh-balance=\"refreshBalance\"\n          @refresh-selected-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @select-task=\"handleTaskSelection\"\n          @remove-task=\"removeTaskFromHistory\"\n          @update:debug-mode=\"updateDebugMode\"\n        />\n      </section>\n      <section class=\"workspace__column workspace__column--input\">\n        <CreationPanel\n          ref=\"creationPanelRef\"\n          :is-mobile=\"isMobile\"\n          :form-alert=\"formAlert\"\n          :avatar-mode=\"avatarMode\"\n          :avatar-prompt=\"avatarPrompt\"\n          :avatar-file-error=\"avatarFileError\"\n          :accepted-avatar-types=\"acceptedAvatarTypes\"\n          :max-avatar-size-label=\"maxAvatarSizeLabel\"\n          :pond-label=\"pondLabel\"\n          :speech-text=\"speechText\"\n          :char-count=\"charCount\"\n          :estimated-duration=\"estimatedDuration\"\n          :estimated-cost=\"estimatedCost\"\n          :voice-id=\"voiceId\"\n          :resolution=\"resolution\"\n          :speed=\"speed\"\n          :pitch=\"pitch\"\n          :emotion=\"emotion\"\n          :seed=\"seed\"\n          :submitting=\"submitting\"\n          :characters=\"characters\"\n          :character-loading=\"characterLoading\"\n          :character-error=\"characterError\"\n          :selected-character-id=\"selectedCharacterId\"\n          :selected-character=\"selectedCharacter\"\n          :character-preview-url=\"characterPreviewUrl\"\n          :new-character-form=\"newCharacterForm\"\n          :new-character-alert=\"newCharacterAlert\"\n          :creating-character=\"creatingCharacter\"\n          :creation-sections=\"creationSections\"\n          @update:avatar-mode=\"updateAvatarMode\"\n          @update:avatar-prompt=\"updateAvatarPrompt\"\n          @update:speech-text=\"updateSpeechText\"\n          @update:voice-id=\"updateVoiceId\"\n          @update:resolution=\"updateResolution\"\n          @update:speed=\"updateSpeed\"\n          @update:pitch=\"updatePitch\"\n          @update:emotion=\"updateEmotion\"\n          @update:seed=\"updateSeed\"\n          @refresh-characters=\"refreshCharacters\"\n          @update:selected-character-id=\"updateSelectedCharacterId\"\n          @clear-character-selection=\"clearCharacterSelection\"\n          @avatar-files-change=\"handleAvatarFiles\"\n          @update:new-character-form=\"updateNewCharacterForm\"\n          @new-character-file-change=\"handleNewCharacterFile\"\n          @submit-new-character=\"submitNewCharacter\"\n          @toggle-section=\"handleCreationSectionToggle\"\n          @submit=\"handleSubmit\"\n        />\n      </section>\n      <section class=\"workspace__column workspace__column--output\">\n        <MonitorPanel\n          ref=\"monitorPanelRef\"\n          :current-job-id=\"currentJobId\"\n          :task-status=\"taskStatus\"\n          :overall-progress-percent=\"overallProgressPercent\"\n          :overall-progress-label=\"overallProgressLabel\"\n          :stage-definitions=\"stageDefinitions\"\n          :stage-status=\"stageStatus\"\n          :status-message=\"statusMessage\"\n          :status-accent=\"statusAccent\"\n          :trace-id=\"monitorTraceId\"\n          :countdown-visible=\"countdownVisible\"\n          :countdown-label=\"countdownLabel\"\n          :countdown-source=\"countdownSource\"\n          :cost-estimate-value=\"costEstimateValue\"\n          :cost-estimate-desc=\"costEstimateDesc\"\n          :avatar-url=\"avatarUrl\"\n          :audio-url=\"audioUrl\"\n          :result-video-url=\"resultVideoUrl\"\n          :total-cost=\"totalCost\"\n          :billing-summary=\"billingSummary\"\n          :error-message=\"errorMessage\"\n          :material-items=\"materialItems\"\n          :polling-active=\"pollingActive\"\n          :result-section-collapsed=\"resultSectionCollapsed\"\n          :material-warning=\"resultSectionWarning\"\n          :task-logs=\"taskLogs\"\n          @download-video=\"downloadVideo\"\n          @copy-video-link=\"copyVideoLink\"\n          @copy-local-path=\"copyLocalPath\"\n          @copy-public-link=\"copyPublicLink\"\n          @open-public-link=\"openPublicLink\"\n          @refresh-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @toggle-result-section=\"handleResultSectionToggle\"\n        />\n      </section>\n    </div>\n  </main>\n\n  <div v-if=\"isMobile\" class=\"mobile-drawer-bar\">\n    <button\n      v-for=\"btn in drawerButtons\"\n      :key=\"btn.id\"\n      type=\"button\"\n      class=\"drawer-toggle\"\n      :class=\"{ active: mobileDrawerPanel === btn.id }\"\n      @click=\"toggleMobileDrawer(btn.id)\"\n    >\n      <span class=\"drawer-icon\">{{ btn.icon }}</span>\n      <span class=\"drawer-label\">{{ btn.label }}</span>\n      <small>{{ overallProgressLabel }}</small>\n    </button>\n  </div>\n  <transition name=\"drawer-fade\">\n    <div v-if=\"drawerActive\" class=\"drawer-overlay\" @click=\"closeMobileDrawer\"></div>\n  </transition>\n  <transition name=\"drawer-slide\">\n    <section v-if=\"drawerActive\" class=\"drawer-panel\">\n      <header class=\"drawer-panel__header\">\n        <div>\n          <p class=\"drawer-panel__eyebrow\">{{ drawerPanelSubtitle }}</p>\n          <h3>{{ drawerPanelTitle }}</h3>\n        </div>\n        <button type=\"button\" class=\"drawer-close\" @click=\"closeMobileDrawer\">关闭</button>\n      </header>\n      <div class=\"drawer-panel__body\">\n        <MonitorPanel\n          v-if=\"mobileDrawerPanel === 'monitor'\"\n          :current-job-id=\"currentJobId\"\n          :task-status=\"taskStatus\"\n          :overall-progress-percent=\"overallProgressPercent\"\n          :overall-progress-label=\"overallProgressLabel\"\n          :stage-definitions=\"stageDefinitions\"\n          :stage-status=\"stageStatus\"\n          :status-message=\"statusMessage\"\n          :status-accent=\"statusAccent\"\n          :trace-id=\"monitorTraceId\"\n          :countdown-visible=\"countdownVisible\"\n          :countdown-label=\"countdownLabel\"\n          :countdown-source=\"countdownSource\"\n          :cost-estimate-value=\"costEstimateValue\"\n          :cost-estimate-desc=\"costEstimateDesc\"\n          :avatar-url=\"avatarUrl\"\n          :audio-url=\"audioUrl\"\n          :result-video-url=\"resultVideoUrl\"\n          :total-cost=\"totalCost\"\n          :billing-summary=\"billingSummary\"\n          :error-message=\"errorMessage\"\n          :material-items=\"materialItems\"\n          :polling-active=\"pollingActive\"\n          :result-section-collapsed=\"resultSectionCollapsed\"\n          :material-warning=\"resultSectionWarning\"\n          @download-video=\"downloadVideo\"\n          @copy-video-link=\"copyVideoLink\"\n          @copy-local-path=\"copyLocalPath\"\n          @copy-public-link=\"copyPublicLink\"\n          @open-public-link=\"openPublicLink\"\n          @refresh-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @toggle-result-section=\"handleResultSectionToggle\"\n        />\n      </div>\n    </section>\n  </transition>\n\n  <div v-if=\"toastMessage\" class=\"toast\">{{ toastMessage }}</div>\n\n  <div v-if=\"errorDialogVisible\" class=\"error-overlay\">\n    <div class=\"error-dialog\">\n      <h3>{{ errorDialogTitle }}</h3>\n      <p>{{ errorDialogMessage }}</p>\n      <pre>{{ errorDialogDetail }}</pre>\n      <button type=\"button\" @click=\"closeErrorDialog\">关闭</button>\n    </div>\n  </div>\n</template>\n\n\n<script setup lang=\"ts\">\nimport { computed, onBeforeUnmount, onMounted, reactive, ref, watch } from 'vue';\nimport type { ComponentPublicInstance, Ref } from 'vue';\nimport { storeToRefs } from 'pinia';\nimport { useAppConfig } from '@/composables/useAppConfig';\nimport { useMediaQuery } from '@/composables/useMediaQuery';\nimport { useAnalytics } from '@/composables/useAnalytics';\nimport CreationPanel from '@/components/panels/CreationPanel.vue';\nimport MonitorPanel from '@/components/panels/MonitorPanel.vue';\nimport PreparationPanel from '@/components/workspace/PreparationPanel.vue';\nimport { useDashboardStore } from '@/stores/dashboard';\nimport { useLayoutPrefsStore } from '@/stores/layoutPrefs';\nimport type { CreationSectionKey } from '@/stores/layoutPrefs';\nimport type { MaterialEntry, StageDefinition, StageKey, StageViewState } from '@/types/dashboard';\nimport type { CharacterRecord } from '@/types/characters';\n\ninterface BillingInfo {\n  balance_before?: number;\n  balance_after?: number;\n  actual_cost?: number;\n  currency?: string;\n  updated_at?: string;\n}\n\ninterface TaskResponse {\n  job_id?: string;\n  status: string;\n  message?: string;\n  billing?: BillingInfo;\n  avatar_url?: string;\n  audio_url?: string;\n  video_url?: string;\n  assets?: Record<string, any>;\n  cost_estimate?: number | CostEstimate;\n  cost?: number;\n  duration?: number;\n  error_code?: string;\n  trace_id?: string;\n  logs?: string[];\n}\n\ninterface CostEstimate {\n  total?: number;\n  avatar?: number;\n  speech?: number;\n  video?: number;\n}\n\nconst DEBUG_MAX_DURATION = 10;\nconst DEBUG_MAX_CHARS = DEBUG_MAX_DURATION * 5;\nconst MAX_AVATAR_SIZE = 5 * 1024 * 1024;\nconst MAX_CHARACTER_IMAGE_SIZE = 10 * 1024 * 1024;\nconst DEFAULT_CHARACTER_ID = 'char-mai';\nconst DEFAULT_VIDEO_SECONDS_PER_CHAR = 1.2;\n\nconst STAGE_PIPELINE: StageDefinition[] = [\n  { id: 'avatar', label: '头像生成', icon: '🧑‍🎨', color: '#a855f7', weight: 0.2 },\n  { id: 'speech', label: '语音生成', icon: '🎙️', color: '#0ea5e9', weight: 0.3 },\n  { id: 'video', label: '唇形视频', icon: '🎬', color: '#22c55e', weight: 0.5 }\n];\n\nconst config = useAppConfig();\nconst isMobile = useMediaQuery('(max-width: 768px)', { defaultState: false });\nconst dashboardStore = useDashboardStore();\nconst analytics = useAnalytics();\nconst layoutPrefsStore = useLayoutPrefsStore();\nconst { sortedTasks, currentTask: storeCurrentTask } = storeToRefs(dashboardStore);\nconst lastSelectionRevision = ref(0);\nconst { creationSections, resultSectionCollapsed } = storeToRefs(layoutPrefsStore);\nconst BUCKET_PUBLIC_BASE = 'https://s.linapp.fun';\nconst API_KEY_PATTERN = /^.{1,}$/;\nconst stageDefinitions = STAGE_PIPELINE;\ntype DrawerPanel = 'monitor';\nconst drawerButtons: Array<{ id: DrawerPanel; label: string; icon: string }> = [\n  { id: 'monitor', label: '监控', icon: '📊' }\n];\n\nconst creationPanelRef = ref<InstanceType<typeof CreationPanel> | null>(null);\nconst monitorPanelRef = ref<InstanceType<typeof MonitorPanel> | null>(null);\nconst apiKeyInput = ref(dashboardStore.apiKey);\nconst apiKeyVisible = ref(false);\nconst apiKeyError = ref('');\nconst isApiKeyValid = computed(() => {\n  const value = apiKeyInput.value.trim();\n  if (!value) {\n    return false;\n  }\n  return API_KEY_PATTERN.test(value);\n});\nconst balanceValue = ref<number | null>(null);\nconst balanceTimestamp = ref<number | null>(null);\nconst balanceError = ref('');\nconst balanceLoading = ref(false);\nlet balanceRefreshTimer: number | null = null;\nconst toastMessage = ref('');\nconst toastTimer = ref<number | null>(null);\nconst processedAnalytics = new Set<string>();\nlet analyticsHydrationRunning = false;\nconst latestTaskSnapshot = ref<TaskResponse | null>(null);\nconst monitorTraceId = computed(() => {\n  if (latestTaskSnapshot.value?.trace_id) {\n    return latestTaskSnapshot.value.trace_id;\n  }\n  const jobId = currentJobId.value;\n  if (!jobId) return '';\n  const entry = dashboardStore.tasks.find((task) => task.id === jobId);\n  const snapshot = entry?.snapshot as TaskResponse | undefined;\n  return snapshot?.trace_id || '';\n});\nconst taskHistory = computed(() => sortedTasks.value);\nconst heroReferenceTask = computed(() => storeCurrentTask.value || taskHistory.value[0] || null);\nconst heroSummaryText = computed(() => {\n  const task = heroReferenceTask.value;\n  if (!task) {\n    return '尚未创建任务，先在左侧完整配置一次数字人吧。';\n  }\n  const statusLabel = describeStatus(task.status);\n  const timestamp = task.updatedAt ? formatTimestamp(task.updatedAt) : '';\n  return `任务 ${task.id} · ${statusLabel}${timestamp ? ` · ${timestamp}` : ''}`;\n});\nwatch(\n  () => dashboardStore.apiKey,\n  (value, previous) => {\n    apiKeyInput.value = value;\n    if (!value) {\n      balanceValue.value = null;\n      balanceTimestamp.value = null;\n      balanceError.value = '';\n      cancelBalanceRefreshTimer();\n      return;\n    }\n    if (value !== previous) {\n      scheduleBalanceRefresh();\n    }\n  }\n);\nwatch(apiKeyInput, (value) => {\n  if (!value.trim()) {\n    apiKeyError.value = '';\n    return;\n  }\n  validateApiKey();\n});\n\nfunction cancelBalanceRefreshTimer() {\n  if (balanceRefreshTimer !== null && typeof window !== 'undefined') {\n    window.clearTimeout(balanceRefreshTimer);\n  }\n  balanceRefreshTimer = null;\n}\n\nfunction scheduleBalanceRefresh(immediate = false) {\n  if (typeof window === 'undefined') return;\n  cancelBalanceRefreshTimer();\n  const candidate = apiKeyInput.value.trim() || dashboardStore.apiKey.trim();\n  if (!candidate || !API_KEY_PATTERN.test(candidate) || balanceLoading.value) {\n    return;\n  }\n  const delay = immediate ? 0 : 600;\n  balanceRefreshTimer = window.setTimeout(() => {\n    balanceRefreshTimer = null;\n    refreshBalance();\n  }, delay);\n}\n\nfunction handleApiKeyInputChange(value: string) {\n  apiKeyInput.value = value;\n  const trimmed = value.trim();\n  dashboardStore.setApiKey(trimmed);\n  if (!trimmed) {\n    cancelBalanceRefreshTimer();\n    return;\n  }\n  if (API_KEY_PATTERN.test(trimmed)) {\n    scheduleBalanceRefresh();\n  }\n}\nfunction handleApiKeyVisibleChange(value: boolean) {\n  apiKeyVisible.value = value;\n}\nconst balanceDisplay = computed(() => {\n  if (balanceLoading.value) return '余额查询中...';\n  if (balanceError.value) return `余额：${balanceError.value}`;\n  if (balanceValue.value !== null) {\n    const time = balanceTimestamp.value\n      ? new Date(balanceTimestamp.value).toLocaleTimeString('zh-CN', {\n          hour: '2-digit',\n          minute: '2-digit',\n          hour12: false\n        })\n      : '';\n    return `余额 $${balanceValue.value.toFixed(2)}${time ? ` · ${time}` : ''}`;\n  }\n  return '余额：未查询';\n});\n\nconst avatarMode = ref<'character' | 'prompt' | 'upload'>('character');\nconst avatarPrompt = ref('一位专业的女性播音员，微笑，正面照');\nconst speechText = ref('你好啊！欢迎进入Linode+WavespeedAI数字人空间。');\nconst voiceId = ref('female-shaonv');\nconst resolution = ref<'720p' | '1080p'>('720p');\nconst speed = ref(1.0);\nconst pitch = ref(0);\nconst emotion = ref('neutral');\nconst seed = ref('');\nconst debugMode = ref(config.DEBUG);\n\nfunction bindRef<T>(target: Ref<T>) {\n  return (value: T) => {\n    target.value = value;\n  };\n}\n\nconst formAlert = reactive({ message: '', type: '' as 'info' | 'error' | '' });\nconst submitting = ref(false);\nconst avatarFileError = ref('');\nconst avatarFile = ref<File | null>(null);\n\nconst currentJobId = ref<string | null>(null);\nconst bucketBasePath = computed(() => {\n  const root = dashboardStore.bucketRoot.replace(/\\/+$/, '');\n  return `${root}/${dashboardStore.bucketUserDir}`.replace(/\\/+/g, '/');\n});\nconst currentBucketDir = computed(() =>\n  currentJobId.value ? `${bucketBasePath.value}/${currentJobId.value}` : ''\n);\nconst taskStatus = ref<'idle' | 'running' | 'finished' | 'failed'>('idle');\nconst statusMessage = ref('尚未创建任务');\nconst avatarUrl = ref('');\nconst audioUrl = ref('');\nconst stageStatus = reactive<Record<StageKey, StageViewState>>({\n  avatar: { state: 'pending', description: '等待调度' },\n  speech: { state: 'pending', description: '等待调度' },\n  video: { state: 'pending', description: '等待调度' }\n});\n\nconst costEstimateValue = ref<number | null>(null);\nconst costEstimateDesc = ref('');\nconst resultVideoUrl = ref('');\nconst totalCost = ref(0);\nconst billingInfo = ref<BillingInfo | null>(null);\nconst billingSummary = computed(() => {\n  const info = billingInfo.value;\n  if (!info) return '';\n  const hasBefore = typeof info.balance_before === 'number';\n  const hasAfter = typeof info.balance_after === 'number';\n  if (hasBefore && hasAfter) {\n    return `余额 ${formatBalance(info.balance_before)} → ${formatBalance(info.balance_after)}`;\n  }\n  if (hasAfter) {\n    return `余额剩余 ${formatBalance(info.balance_after)}`;\n  }\n  return '';\n});\nconst errorMessage = ref('');\n\nconst errorDialogVisible = ref(false);\nconst errorDialogTitle = ref('');\nconst errorDialogMessage = ref('');\nconst errorDialogDetail = ref('');\n\nconst pollTimer = ref<number | null>(null);\nconst pollingActive = computed(() => Boolean(pollTimer.value));\nconst currentJobTextLength = ref<number | null>(null);\nconst videoStageStartAt = ref<number | null>(null);\nconst videoCountdownTimer = ref<number | null>(null);\nconst videoCountdown = reactive({\n  total: 0,\n  remaining: 0,\n  source: '',\n  samples: 0,\n  active: false\n});\nconst historicalStats = reactive({ secondsPerChar: 0, sampleSize: 0 });\n\nconst characters = ref<CharacterRecord[]>([]);\nconst characterLoading = ref(false);\nconst characterError = ref('');\nconst selectedCharacterId = ref('');\nconst selectedCharacter = computed(() =>\n  characters.value.find((item) => item.id === selectedCharacterId.value) || null\n);\nconst updateAvatarMode = bindRef(avatarMode);\nconst updateAvatarPrompt = bindRef(avatarPrompt);\nconst updateSpeechText = bindRef(speechText);\nconst updateVoiceId = bindRef(voiceId);\nconst updateResolution = bindRef(resolution);\nconst updateSpeed = bindRef(speed);\nconst updatePitch = bindRef(pitch);\nconst updateEmotion = bindRef(emotion);\nconst updateSeed = bindRef(seed);\nconst updateDebugMode = bindRef(debugMode);\nconst updateSelectedCharacterId = bindRef(selectedCharacterId);\nconst characterPreviewUrl = computed(() =>\n  selectedCharacter.value ? buildCharacterImageUrl(selectedCharacter.value) : ''\n);\nconst newCharacterForm = reactive({\n  name: '',\n  appearanceZh: '',\n  appearanceEn: '',\n  voiceZh: '',\n  voicePrompt: '',\n  voiceId: ''\n});\nconst newCharacterFile = ref<File | null>(null);\nconst creatingCharacter = ref(false);\nconst newCharacterAlert = reactive({ message: '', type: '' as 'error' | 'success' | '' });\nfunction updateNewCharacterForm(value: Record<string, string>) {\n  Object.assign(newCharacterForm, value);\n}\nfunction handleCreationSectionToggle(payload: { id: CreationSectionKey; value: boolean }) {\n  layoutPrefsStore.setCreationSection(payload.id, payload.value);\n}\nfunction handleResultSectionToggle(collapsed: boolean) {\n  layoutPrefsStore.setResultSectionCollapsed(collapsed);\n  analytics.track('result_section_toggle', {\n    job_id: currentJobId.value || '',\n    collapsed\n  });\n}\nconst charCount = computed(() => speechText.value.length);\nconst estimatedDuration = computed(() => Math.ceil(charCount.value / 5) || 0);\nconst estimatedCost = computed(() => {\n  const avatarCost = 0.03;\n  const voiceCost = estimatedDuration.value / 60 * 0.02;\n  const videoCost = estimatedDuration.value * (resolution.value === '720p' ? 0.06 : 0.12);\n  return avatarCost + voiceCost + videoCost;\n});\n\nconst acceptedAvatarTypes = ['image/png', 'image/jpeg'];\nconst maxAvatarSizeLabel = '5MB';\nconst pondLabel =\n  \"拖拽或 <span class='filepond--label-action'>点击</span> 上传头像\";\n\nconst debugHint = computed(() =>\n  debugMode.value\n    ? `调试模式开启：限制 ${DEBUG_MAX_CHARS} 字以内（约 ${DEBUG_MAX_DURATION} 秒）。`\n    : '调试模式关闭：可输入最多 1000 字生成正式视频。'\n);\n\nconst statusAccent = computed(() => ({\n  success: taskStatus.value === 'finished',\n  danger: taskStatus.value === 'failed'\n}));\nconst mobileDrawerPanel = ref<DrawerPanel | ''>('');\nconst drawerActive = computed(() => Boolean(mobileDrawerPanel.value));\nconst drawerPanelTitle = computed(() => {\n  if (mobileDrawerPanel.value === 'monitor') return '任务监控';\n  return '';\n});\nconst drawerPanelSubtitle = computed(() => {\n  if (mobileDrawerPanel.value === 'monitor') {\n    if (!currentJobId.value) return '尚未创建任务';\n    return statusMessage.value || '等待最新状态';\n  }\n  return '';\n});\nwatch(isMobile, (value) => {\n  if (!value) {\n    closeMobileDrawer();\n  }\n});\nwatch(\n  () => mobileDrawerPanel.value,\n  (panel) => {\n    if (typeof document === 'undefined') return;\n    if (panel) {\n      document.body.classList.add('drawer-lock');\n    } else {\n      document.body.classList.remove('drawer-lock');\n    }\n  }\n);\n\nfunction getComponentRootEl(component: ComponentPublicInstance | null | undefined) {\n  return (component?.$el as HTMLElement | null | undefined) || null;\n}\n\nfunction scrollElementIntoView(el: HTMLElement | null | undefined) {\n  if (!el) return;\n  el.scrollIntoView({ behavior: 'smooth', block: 'start' });\n}\n\nfunction handleHeroCreateTask() {\n  analytics.track('hero_cta_click', {\n    job_id: currentJobId.value || '',\n    task_status: taskStatus.value,\n    polling_active: pollingActive.value,\n    char_count: charCount.value\n  });\n  const el = getComponentRootEl(creationPanelRef.value);\n  if (el) {\n    scrollElementIntoView(el);\n  }\n}\n\nfunction handleHeroMonitor() {\n  analytics.track('hero_monitor_click', {\n    job_id: currentJobId.value || '',\n    overall_progress: overallProgressPercent.value,\n    is_mobile: isMobile.value,\n    drawer_active: mobileDrawerPanel.value === 'monitor'\n  });\n  if (isMobile.value) {\n    toggleMobileDrawer('monitor');\n    return;\n  }\n  const el = getComponentRootEl(monitorPanelRef.value);\n  if (el) {\n    scrollElementIntoView(el);\n  }\n}\n\nfunction toggleMobileDrawer(panel: DrawerPanel) {\n  if (!isMobile.value) return;\n  mobileDrawerPanel.value = mobileDrawerPanel.value === panel ? '' : panel;\n}\n\nfunction closeMobileDrawer() {\n  if (!mobileDrawerPanel.value) return;\n  mobileDrawerPanel.value = '';\n}\n\nconst overallProgress = computed(() =>\n  stageDefinitions.reduce((total, definition) => {\n    const state = stageStatus[definition.id].state;\n    if (state === 'done') {\n      return total + definition.weight;\n    }\n    if (state === 'active') {\n      return total + definition.weight * 0.5;\n    }\n    return total;\n  }, 0)\n);\n\nconst overallProgressPercent = computed(() => Math.round(overallProgress.value * 100));\nconst overallProgressLabel = computed(() => `${overallProgressPercent.value}%`);\n\nconst countdownVisible = computed(() => videoCountdown.active && videoCountdown.remaining > 0);\nconst countdownLabel = computed(() => formatDuration(videoCountdown.remaining));\nconst countdownSource = computed(() => videoCountdown.source);\nconst resultSectionWarning = computed(() => {\n  const jobId = currentJobId.value;\n  if (!jobId || taskStatus.value !== 'finished') return false;\n  const localPath = latestTaskSnapshot.value?.assets?.local_video_url;\n  if (!localPath) return true;\n  const expectedSuffix = `/output/${jobId}/digital_human.mp4`;\n  return !localPath.endsWith(expectedSuffix);\n});\n\nconst materialItems = computed<MaterialEntry[]>(() => {\n  if (!currentJobId.value) {\n    dashboardStore.clearError('material');\n    return [];\n  }\n  const jobId = currentJobId.value;\n  const snapshot = latestTaskSnapshot.value;\n  const assets = snapshot?.assets || {};\n  const items: MaterialEntry[] = [];\n  let hasPathError = false;\n\n  if (currentBucketDir.value) {\n    items.push({\n      id: 'dir-root',\n      label: '任务目录',\n      type: 'other',\n      localPath: currentBucketDir.value,\n      publicUrl: bucketPathToPublicUrl(currentBucketDir.value),\n      description: '桶内该任务的根目录'\n    });\n  }\n\n  const pushItem = (\n    idSuffix: string,\n    label: string,\n    type: MaterialEntry['type'],\n    rawPath?: string,\n    fallback?: string,\n    description?: string\n  ) => {\n    const { localPath, publicUrl } = normalizeMaterialPath(rawPath || fallback || '', jobId);\n    if (!localPath && !publicUrl) return;\n    if (localPath && !localPath.startsWith(bucketBasePath.value)) {\n      hasPathError = true;\n      return;\n    }\n    items.push({\n      id: `${type}-${idSuffix}`,\n      label,\n      type,\n      localPath,\n      publicUrl,\n      description\n    });\n  };\n\n  pushItem('avatar', '生成头像', 'avatar', assets.avatar_local_path || assets.avatar_path, avatarUrl.value);\n  pushItem(\n    'audio',\n    '语音合成',\n    'audio',\n    assets.audio_local_path || assets.audio_path || assets.local_audio_url,\n    audioUrl.value\n  );\n  const finalVideoPath =\n    assets.local_video_url || assets.video_local_path || assets.video_path || resultVideoUrl.value;\n  pushItem('video', '唇形视频', 'video', finalVideoPath, finalVideoPath);\n  const logPath = currentBucketDir.value ? `${currentBucketDir.value}/log.txt` : '';\n  if (logPath) {\n    pushItem('log', '任务日志', 'log', logPath, logPath, '记录 trace id 与成本');\n  }\n\n  if (hasPathError) {\n    dashboardStore.setError('material', '素材路径异常，请检查桶映射');\n  } else {\n    dashboardStore.clearError('material');\n  }\n  return items;\n});\n\nconst taskLogs = computed(() => {\n  const snapshotLogs = latestTaskSnapshot.value?.logs;\n  if (Array.isArray(snapshotLogs)) {\n    return snapshotLogs;\n  }\n  const jobId = currentJobId.value;\n  if (!jobId) return [];\n  const stored = dashboardStore.tasks.find((task) => task.id === jobId);\n  const fallbackLogs = (stored?.snapshot as TaskResponse | undefined)?.logs;\n  if (Array.isArray(fallbackLogs)) {\n    return fallbackLogs;\n  }\n  return [];\n});\n\nwatch(avatarMode, (mode) => {\n  if (mode === 'prompt') {\n    clearAvatarFile();\n    avatarFileError.value = '';\n  }\n  if (mode === 'character' && !selectedCharacterId.value && characters.value.length) {\n    selectedCharacterId.value = characters.value[0].id;\n  }\n});\n\nwatch(selectedCharacterId, (id) => {\n  const character = characters.value.find((item) => item.id === id) || null;\n  if (id) {\n    avatarMode.value = 'character';\n    clearAvatarFile();\n  }\n  if (character?.voice?.voice_id) {\n    voiceId.value = character.voice.voice_id;\n  }\n});\n\nwatch(\n  () => ({\n    id: dashboardStore.selectedTaskId,\n    revision: dashboardStore.selectionRevision\n  }),\n  ({ id, revision }) => {\n    if (revision === lastSelectionRevision.value && id === currentJobId.value) {\n      return;\n    }\n    lastSelectionRevision.value = revision;\n    stopPolling();\n    if (!id) {\n      currentJobId.value = null;\n      latestTaskSnapshot.value = null;\n      resetProgress('idle');\n      return;\n    }\n    currentJobId.value = id;\n    const stored = dashboardStore.tasks.find((task) => task.id === id);\n    if (stored?.snapshot) {\n      applyTask(stored.snapshot as TaskResponse, { silent: true });\n    }\n    const status = (stored?.snapshot as TaskResponse | undefined)?.status || '';\n    if (!status || (status !== 'finished' && status !== 'failed')) {\n      fetchTaskStatus();\n      startPolling();\n    }\n  },\n  { immediate: true }\n);\n\nwatch(\n  () => currentJobId.value,\n  () => {\n    syncCurrentJobMetadata();\n  }\n);\n\nwatch(\n  taskHistory,\n  () => {\n    syncCurrentJobMetadata();\n    scheduleAnalyticsHydration();\n    recomputeHistoricalStats();\n  },\n  { deep: true }\n);\n\nwatch(\n  () => historicalStats.secondsPerChar,\n  () => {\n    if (videoCountdown.active && latestTaskSnapshot.value?.status === 'video_rendering') {\n      startVideoCountdown(latestTaskSnapshot.value);\n    }\n  }\n);\n\nonMounted(() => {\n  if (dashboardStore.apiKey) {\n    scheduleBalanceRefresh(true);\n  }\n  fetchCharacters();\n  scheduleAnalyticsHydration();\n  recomputeHistoricalStats();\n  resetCompletedTaskSelection();\n});\n\nfunction saveApiKeySetting() {\n  if (!validateApiKey()) {\n    showToast('请检查 API Key 格式');\n    return;\n  }\n  const trimmed = apiKeyInput.value.trim();\n  dashboardStore.setApiKey(trimmed);\n  scheduleBalanceRefresh(true);\n  showToast('API Key 已保存');\n}\n\nfunction clearApiKeySetting() {\n  apiKeyInput.value = '';\n  dashboardStore.clearApiKey();\n  cancelBalanceRefreshTimer();\n  showToast('API Key 已清除');\n  balanceValue.value = null;\n  balanceTimestamp.value = null;\n  balanceError.value = '';\n  apiKeyError.value = '';\n  dashboardStore.clearError('apiKey');\n}\n\nfunction validateApiKey() {\n  const trimmed = apiKeyInput.value.trim();\n  if (!trimmed) {\n    apiKeyError.value = '';\n    dashboardStore.clearError('apiKey');\n    return false;\n  }\n  if (!API_KEY_PATTERN.test(trimmed)) {\n    apiKeyError.value = 'Key 不能为空';\n    dashboardStore.setError('apiKey', apiKeyError.value);\n    return false;\n  }\n  apiKeyError.value = '';\n  dashboardStore.clearError('apiKey');\n  return true;\n}\n\nfunction handleTaskSelection(taskId: string) {\n  if (taskId) {\n    dashboardStore.selectTask(taskId);\n  }\n}\n\nfunction togglePolling() {\n  if (pollingActive.value) {\n    stopPolling();\n  } else {\n    startPolling();\n  }\n}\n\nfunction refreshSelectedTask() {\n  fetchTaskStatus();\n}\n\nasync function refreshBalance() {\n  if (balanceLoading.value) {\n    return;\n  }\n  cancelBalanceRefreshTimer();\n  const key = apiKeyInput.value.trim() || dashboardStore.apiKey.trim();\n  if (!key) {\n    showToast('请先填写 Wavespeed API Key');\n    return;\n  }\n  balanceLoading.value = true;\n  balanceError.value = '';\n  try {\n    const response = await fetch(`${config.API_BASE}/api/wavespeed/balance`, {\n      method: 'POST',\n      headers: buildRequestHeaders({ 'Content-Type': 'application/json' }),\n      body: JSON.stringify({ wavespeed_api_key: key })\n    });\n    if (!response.ok) {\n      const error = await safeJson(response);\n      throw new Error(error.detail || '查询失败');\n    }\n    const result = await response.json();\n    balanceValue.value = typeof result.balance === 'number' ? Number(result.balance) : null;\n    balanceTimestamp.value = Date.now();\n    balanceError.value = '';\n    if (!dashboardStore.apiKey && key) {\n      dashboardStore.setApiKey(key);\n    }\n    if (balanceValue.value !== null) {\n      showToast(`余额 $${balanceValue.value.toFixed(2)}`);\n    }\n  } catch (err) {\n    balanceError.value = (err as Error).message || '查询失败';\n    showToast(balanceError.value);\n    dashboardStore.setError('apiKey', balanceError.value);\n  } finally {\n    if (!balanceError.value) {\n      dashboardStore.clearError('apiKey');\n    }\n    balanceLoading.value = false;\n  }\n}\n\nfunction removeTaskFromHistory(taskId: string) {\n  dashboardStore.removeTask(taskId);\n  if (dashboardStore.selectedTaskId === taskId) {\n    resetProgress('idle');\n  }\n}\n\nfunction showToast(message: string) {\n  toastMessage.value = message;\n  if (toastTimer.value) {\n    clearTimeout(toastTimer.value);\n  }\n  toastTimer.value = window.setTimeout(() => {\n    toastMessage.value = '';\n    toastTimer.value = null;\n  }, 4000);\n}\n\nasync function copyText(value: string, successMessage: string) {\n  if (!value) return;\n  try {\n    await navigator.clipboard.writeText(value);\n    showToast(successMessage);\n  } catch {\n    const input = document.createElement('textarea');\n    input.value = value;\n    input.style.position = 'fixed';\n    input.style.opacity = '0';\n    document.body.appendChild(input);\n    input.focus();\n    input.select();\n    try {\n      document.execCommand('copy');\n      showToast(successMessage);\n    } catch {\n      showFormAlert('复制失败，请手动复制');\n    } finally {\n      document.body.removeChild(input);\n    }\n  }\n}\n\nfunction copyLocalPath(path: string) {\n  if (!path) return;\n  copyText(path, '本地路径已复制');\n}\n\nfunction copyPublicLink(link: string) {\n  if (!link) return;\n  copyText(link, '公网链接已复制');\n}\n\nfunction openPublicLink(link: string) {\n  if (!link) return;\n  window.open(link, '_blank', 'noreferrer');\n}\n\nfunction formatTimestamp(timestamp: number) {\n  if (!timestamp) return '';\n  return new Date(timestamp).toLocaleString('zh-CN', {\n    hour12: false,\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit'\n  });\n}\n\nfunction formatDuration(seconds: number) {\n  if (!Number.isFinite(seconds) || seconds <= 0) return '不到 1 秒';\n  const value = Math.max(0, Math.round(seconds));\n  const mins = Math.floor(value / 60);\n  const secs = value % 60;\n  if (!mins) {\n    return `${secs} 秒`;\n  }\n  return `${mins} 分 ${secs.toString().padStart(2, '0')} 秒`;\n}\n\nfunction extractTextLength(task?: TaskResponse | null) {\n  if (!task) return null;\n  const raw = (task.assets || {}).text_length ?? (task.assets || {}).speech_text_length;\n  const parsed = Number(raw);\n  if (Number.isFinite(parsed) && parsed > 0) {\n    return Math.round(parsed);\n  }\n  return null;\n}\n\nfunction describeStatus(status: string) {\n  const map: Record<string, string> = {\n    finished: '已完成',\n    failed: '失败',\n    running: '执行中',\n    created: '已创建',\n    idle: '待执行',\n    pending: '排队中'\n  };\n  return map[status] || status || '未知';\n}\n\nfunction buildRequestHeaders(extra: HeadersInit = {}) {\n  const headers: HeadersInit = { ...extra };\n  if (dashboardStore.apiKey) {\n    headers['X-API-Key'] = dashboardStore.apiKey;\n  }\n  return headers;\n}\n\nasync function handleSubmit() {\n  clearFormAlert();\n\n  if (avatarMode.value === 'prompt' && !avatarPrompt.value.trim()) {\n    return showFormAlert('请输入头像描述');\n  }\n\n  if (avatarMode.value === 'character' && !selectedCharacterId.value) {\n    return showFormAlert('请选择一个预制人物');\n  }\n\n  if (avatarMode.value === 'upload') {\n    const file = getSelectedAvatarFile();\n    if (!file) {\n      return showFormAlert('请上传头像图片');\n    }\n    const validationError = validateAvatarFile(file);\n    if (validationError) {\n      avatarFileError.value = validationError;\n      return showFormAlert(validationError);\n    }\n  }\n\n  const trimmedSpeech = speechText.value.trim();\n  if (!trimmedSpeech) {\n    return showFormAlert('请输入播报文本');\n  }\n\n  if (debugMode.value && trimmedSpeech.length > DEBUG_MAX_CHARS) {\n    return showFormAlert(`调试模式下最多输入 ${DEBUG_MAX_CHARS} 个字符。`);\n  }\n\n  let avatarUploadUrl: string | null = null;\n  if (avatarMode.value === 'upload') {\n    try {\n      const file = getSelectedAvatarFile();\n      if (!file) throw new Error('未选择头像文件');\n      const validationError = validateAvatarFile(file);\n      if (validationError) {\n        avatarFileError.value = validationError;\n        throw new Error(validationError);\n      }\n      avatarUploadUrl = await uploadAvatar(file);\n    } catch (err) {\n      return showFormAlert(`上传头像失败：${(err as Error).message}`);\n    }\n  }\n\n  let parsedSeed: number | undefined;\n  if (seed.value.trim()) {\n    const seedNumber = Number(seed.value.trim());\n    if (!Number.isInteger(seedNumber)) {\n      return showFormAlert('随机种子必须为整数，例如 42 或 1001。');\n    }\n    parsedSeed = seedNumber;\n  }\n\n  const payload: Record<string, any> = {\n    avatar_mode: avatarMode.value,\n    avatar_prompt: avatarMode.value === 'prompt' ? avatarPrompt.value.trim() : null,\n    avatar_upload_url: avatarUploadUrl,\n    speech_text: trimmedSpeech,\n    voice_id: voiceId.value,\n    resolution: resolution.value,\n    speed: speed.value,\n    pitch: pitch.value,\n    emotion: emotion.value,\n    debug_mode: debugMode.value\n  };\n\n  if (typeof parsedSeed === 'number') {\n    payload.seed = parsedSeed;\n  }\n  if (avatarMode.value === 'character' && selectedCharacterId.value) {\n    payload.character_id = selectedCharacterId.value;\n  }\n\n  try {\n    submitting.value = true;\n    taskStatus.value = 'running';\n    statusMessage.value = '⏳ 正在创建任务...';\n\n    const response = await fetch(`${config.API_BASE}/api/tasks`, {\n      method: 'POST',\n      headers: buildRequestHeaders({ 'Content-Type': 'application/json' }),\n      body: JSON.stringify(payload)\n    });\n\n    if (!response.ok) {\n      const error = await safeJson(response);\n      showErrorDialog('创建任务失败', error);\n      throw new Error(error.detail || '创建任务失败');\n    }\n\n    const result = await response.json();\n    const jobId = result.job_id || result.task_id;\n    currentJobId.value = jobId;\n    dashboardStore.selectTask(jobId);\n    const now = Date.now();\n    const textLength = trimmedSpeech.length;\n    const initialSnapshot: TaskResponse = {\n      status: 'created',\n      message: '任务已创建，正在调度...',\n      cost_estimate: result.cost_estimate,\n      assets: {\n        ...(result.assets || {}),\n        text_length: textLength\n      }\n    };\n    latestTaskSnapshot.value = initialSnapshot;\n    dashboardStore.upsertTask({\n      id: jobId,\n      status: 'created',\n      message: '任务已创建，正在调度...',\n      createdAt: now,\n      updatedAt: now,\n      costEstimate: extractCostValue(result.cost_estimate),\n      assets: initialSnapshot.assets,\n      snapshot: initialSnapshot,\n      textLength\n    });\n    currentJobTextLength.value = textLength;\n    statusMessage.value = '任务已创建，正在调度...';\n    resetProgress('running');\n    updateCostEstimate(result.cost_estimate, '来自任务创建的初步估算。');\n    startPolling();\n    dashboardStore.clearError('tasks');\n  } catch (err) {\n    showFormAlert((err as Error).message || '未知错误');\n    dashboardStore.setError('tasks', (err as Error).message || '创建任务失败');\n    taskStatus.value = 'idle';\n  } finally {\n    submitting.value = false;\n  }\n}\n\nasync function uploadAvatar(file: File) {\n  const formData = new FormData();\n  formData.append('file', file);\n  const response = await fetch(`${config.API_BASE}/api/assets/upload`, {\n    method: 'POST',\n    headers: buildRequestHeaders(),\n    body: formData\n  });\n\n  if (!response.ok) {\n    const error = await safeJson(response);\n    throw new Error(error.detail || '上传失败');\n  }\n\n  const result = await response.json();\n  return result.url;\n}\n\nasync function fetchCharacters() {\n  characterLoading.value = true;\n  characterError.value = '';\n  try {\n    const response = await fetch(`${config.API_BASE}/api/characters`, {\n      headers: buildRequestHeaders()\n    });\n    if (!response.ok) {\n      const error = await safeJson(response);\n      throw new Error(error.detail || '加载角色失败');\n    }\n    characters.value = await response.json();\n    applyDefaultCharacterSelection(characters.value);\n  } catch (err) {\n    characterError.value = (err as Error).message;\n    characters.value = [];\n    selectedCharacterId.value = '';\n  } finally {\n    characterLoading.value = false;\n  }\n}\n\nfunction refreshCharacters() {\n  fetchCharacters();\n}\nfunction resetCompletedTaskSelection() {\n  const selectedId = dashboardStore.selectedTaskId;\n  if (!selectedId) return;\n  const task = dashboardStore.tasks.find((item) => item.id === selectedId);\n  if (!task || task.status === 'finished' || task.status === 'failed') {\n    dashboardStore.selectTask(null);\n  }\n}\n\nfunction clearCharacterSelection() {\n  selectedCharacterId.value = '';\n}\n\nfunction handleNewCharacterFile(event: Event) {\n  const target = event.target as HTMLInputElement;\n  const file = target.files?.[0];\n  if (!file) {\n    newCharacterFile.value = null;\n    return;\n  }\n  if (file.size > MAX_CHARACTER_IMAGE_SIZE) {\n    newCharacterAlert.message = '角色图片需小于 10MB';\n    newCharacterAlert.type = 'error';\n    newCharacterFile.value = null;\n    return;\n  }\n  newCharacterAlert.message = '';\n  newCharacterAlert.type = '';\n  newCharacterFile.value = file;\n}\n\nfunction resetNewCharacterForm() {\n  newCharacterForm.name = '';\n  newCharacterForm.appearanceZh = '';\n  newCharacterForm.appearanceEn = '';\n  newCharacterForm.voiceZh = '';\n  newCharacterForm.voicePrompt = '';\n  newCharacterForm.voiceId = '';\n  newCharacterFile.value = null;\n}\n\nasync function submitNewCharacter() {\n  if (!newCharacterForm.name.trim() || !newCharacterForm.appearanceZh.trim()) {\n    newCharacterAlert.message = '名称与中文描述为必填项';\n    newCharacterAlert.type = 'error';\n    return;\n  }\n  if (!newCharacterFile.value) {\n    newCharacterAlert.message = '请上传人物图片';\n    newCharacterAlert.type = 'error';\n    return;\n  }\n  const formData = new FormData();\n  formData.append('name', newCharacterForm.name.trim());\n  formData.append('appearance_zh', newCharacterForm.appearanceZh.trim());\n  if (newCharacterForm.appearanceEn.trim()) {\n    formData.append('appearance_en', newCharacterForm.appearanceEn.trim());\n  }\n  if (newCharacterForm.voiceZh.trim()) {\n    formData.append('voice_zh', newCharacterForm.voiceZh.trim());\n  }\n  if (newCharacterForm.voicePrompt.trim()) {\n    formData.append('voice_prompt', newCharacterForm.voicePrompt.trim());\n  }\n  if (newCharacterForm.voiceId.trim()) {\n    formData.append('voice_id', newCharacterForm.voiceId.trim());\n  }\n  formData.append('file', newCharacterFile.value);\n\n  try {\n    creatingCharacter.value = true;\n    const response = await fetch(`${config.API_BASE}/api/characters`, {\n      method: 'POST',\n      headers: buildRequestHeaders(),\n      body: formData\n    });\n    if (!response.ok) {\n      const error = await safeJson(response);\n      throw new Error(error.detail || '上传失败');\n    }\n    const record: CharacterRecord = await response.json();\n    newCharacterAlert.message = '角色上传成功';\n    newCharacterAlert.type = 'success';\n    await fetchCharacters();\n    selectedCharacterId.value = record.id;\n    resetNewCharacterForm();\n  } catch (err) {\n    newCharacterAlert.message = (err as Error).message;\n    newCharacterAlert.type = 'error';\n  } finally {\n    creatingCharacter.value = false;\n  }\n}\n\nfunction applyDefaultCharacterSelection(list: CharacterRecord[]) {\n  if (!list.length) {\n    selectedCharacterId.value = '';\n    return;\n  }\n  if (selectedCharacterId.value && list.some((item) => item.id === selectedCharacterId.value)) {\n    return;\n  }\n  const preferred = list.find((item) => item.id === DEFAULT_CHARACTER_ID);\n  selectedCharacterId.value = (preferred || list[0]).id;\n}\n\nfunction buildCharacterImageUrl(record: CharacterRecord | null): string {\n  if (!record || !record.image_url) return '';\n  if (record.image_url.startsWith('http')) return record.image_url;\n  return `${config.API_BASE}${record.image_url}`;\n}\n\nfunction startPolling() {\n  if (!currentJobId.value) return;\n  stopPolling();\n  fetchTaskStatus();\n  pollTimer.value = window.setInterval(fetchTaskStatus, config.POLL_INTERVAL);\n}\n\nfunction stopPolling() {\n  if (pollTimer.value) {\n    clearInterval(pollTimer.value);\n    pollTimer.value = null;\n  }\n}\n\nasync function fetchTaskStatus() {\n  if (!currentJobId.value) return;\n  try {\n    const response = await fetch(`${config.API_BASE}/api/tasks/${currentJobId.value}`, {\n      headers: buildRequestHeaders()\n    });\n    if (!response.ok) {\n      const error = await safeJson(response);\n      showErrorDialog('查询任务失败', error);\n      throw new Error(error.detail || '查询任务失败');\n    }\n    const task: TaskResponse = await response.json();\n    applyTask(task);\n    dashboardStore.clearError('progress');\n  } catch (err) {\n    console.error('轮询错误:', err);\n    dashboardStore.setError('progress', (err as Error).message || '轮询失败');\n  }\n}\n\nfunction applyTask(task: TaskResponse, options: { silent?: boolean } = {}) {\n  latestTaskSnapshot.value = task;\n  const jobId = task.job_id || currentJobId.value;\n  const detectedTextLength = extractTextLength(task);\n  if (detectedTextLength && jobId && jobId === currentJobId.value) {\n    currentJobTextLength.value = detectedTextLength;\n  }\n  if (task.status === 'video_rendering') {\n    startVideoCountdown(task);\n  } else {\n    stopVideoCountdown();\n  }\n  statusMessage.value = task.message || task.status || '执行中';\n  billingInfo.value = task.billing || null;\n  updateStages(task);\n  updateCostEstimate(task.cost_estimate, '执行中估算（含头像/语音/视频）。');\n  if (task.avatar_url) {\n    avatarUrl.value = task.avatar_url;\n  }\n  if (task.audio_url) {\n    audioUrl.value = task.audio_url;\n  }\n  const resolvedVideo = resolveVideoUrl(task);\n  if (resolvedVideo && task.status !== 'failed') {\n    resultVideoUrl.value = resolvedVideo;\n  }\n\n  if (!options.silent) {\n    trackTaskHistory(task);\n  }\n\n  if (task.status === 'finished' || task.status === 'failed') {\n    stopPolling();\n    handleCompletion(task);\n    if (task.status === 'finished' && jobId) {\n      void hydrateTaskAnalytics(jobId, task);\n    }\n  }\n}\n\nfunction trackTaskHistory(task: TaskResponse) {\n  if (!currentJobId.value) return;\n  const now = Date.now();\n  const existing = dashboardStore.tasks.find((item) => item.id === currentJobId.value);\n  const resolvedTextLength = extractTextLength(task) ?? existing?.textLength ?? currentJobTextLength.value ?? undefined;\n  dashboardStore.upsertTask({\n    id: currentJobId.value,\n    status: task.status || existing?.status || 'running',\n    message: task.message || existing?.message || '',\n    createdAt: existing?.createdAt || now,\n    updatedAt: now,\n    costEstimate: extractCostValue(task.cost_estimate) ?? existing?.costEstimate,\n    assets: task.assets || existing?.assets,\n    snapshot: task,\n    textLength: resolvedTextLength,\n    analytics: existing?.analytics\n  });\n}\n\nfunction updateStages(task: TaskResponse) {\n  const status = task.status || '';\n  const finished = status === 'finished';\n  const failed = status === 'failed';\n  const activeStage = inferStageFromStatus(status);\n\n  stageDefinitions.forEach((definition, index) => {\n    const current = stageStatus[definition.id];\n    const doneByAsset = isStageAssetReady(definition.id, task);\n\n    if (finished || doneByAsset) {\n      current.state = 'done';\n      current.description = '已完成';\n      return;\n    }\n\n    if (failed && activeStage === definition.id) {\n      current.state = 'failed';\n      current.description = task.message || stageActiveDescription(definition.id);\n      return;\n    }\n\n    if (activeStage) {\n      const activeIndex = stageDefinitions.findIndex((item) => item.id === activeStage);\n      if (index < activeIndex) {\n        current.state = 'done';\n        current.description = '已完成';\n      } else if (index === activeIndex) {\n        current.state = 'active';\n        current.description = stageActiveDescription(definition.id);\n      } else {\n        current.state = 'pending';\n        current.description = '等待调度';\n      }\n      return;\n    }\n\n    current.state = 'pending';\n    current.description = '等待调度';\n  });\n}\n\nfunction resolveVideoUrl(task: TaskResponse) {\n  if (task.assets?.local_video_url) {\n    return task.assets.local_video_url;\n  }\n  if (task.video_url) {\n    return task.video_url;\n  }\n  if (task.assets?.video_url) {\n    return task.assets.video_url;\n  }\n  return '';\n}\n\nfunction inferStageFromStatus(status: string | undefined | null): StageKey | null {\n  if (!status) return null;\n  if (status.includes('video')) return 'video';\n  if (status.includes('speech')) return 'speech';\n  if (status.includes('avatar')) return 'avatar';\n  return null;\n}\n\nfunction isStageAssetReady(stage: StageKey, task: TaskResponse) {\n  if (stage === 'avatar') {\n    return Boolean(task.avatar_url || task.assets?.avatar_local_path);\n  }\n  if (stage === 'speech') {\n    return Boolean(task.audio_url || task.assets?.audio_local_path || task.assets?.local_audio_url);\n  }\n  if (stage === 'video') {\n    return Boolean(resolveVideoUrl(task));\n  }\n  return false;\n}\n\nfunction stageActiveDescription(stage: StageKey) {\n  if (stage === 'avatar') return '头像生成中';\n  if (stage === 'speech') return '语音合成中';\n  return '唇形渲染中';\n}\n\nfunction normalizeMaterialPath(raw: string, jobId?: string) {\n  if (!raw) {\n    return { localPath: '', publicUrl: '' };\n  }\n  const trimmed = raw.trim();\n  if (!trimmed) {\n    return { localPath: '', publicUrl: '' };\n  }\n  if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) {\n    return { localPath: '', publicUrl: trimmed };\n  }\n  if (trimmed.startsWith('/mnt/www')) {\n    return { localPath: trimmed, publicUrl: bucketPathToPublicUrl(trimmed) };\n  }\n  const normalizedJobId = jobId || currentJobId.value || '';\n  let relative = trimmed.replace(/^\\.\\/?/, '');\n  if (relative.startsWith('/')) {\n    relative = relative.slice(1);\n  }\n  if (relative.startsWith('output/')) {\n    const localPath = `${bucketBasePath.value}/${relative}`.replace(/\\\\/g, '/');\n    return { localPath, publicUrl: bucketPathToPublicUrl(localPath) };\n  }\n  const suffix = normalizedJobId ? `${normalizedJobId}/${relative}` : relative;\n  const localPath = `${bucketBasePath.value}/${suffix}`.replace(/\\\\/g, '/');\n  return { localPath, publicUrl: bucketPathToPublicUrl(localPath) };\n}\n\nfunction bucketPathToPublicUrl(localPath: string) {\n  if (!localPath) return '';\n  if (localPath.startsWith('http://') || localPath.startsWith('https://')) {\n    return localPath;\n  }\n  if (!localPath.startsWith('/mnt/www')) {\n    return '';\n  }\n  const relative = localPath.replace(/^\\/mnt\\/www\\/?/, '');\n  try {\n    const url = new URL(`${BUCKET_PUBLIC_BASE.replace(/\\/$/, '')}/${relative}`);\n    return url.toString();\n  } catch {\n    return `${BUCKET_PUBLIC_BASE}/${relative}`;\n  }\n}\n\nfunction syncCurrentJobMetadata() {\n  if (!currentJobId.value) {\n    currentJobTextLength.value = null;\n    stopVideoCountdown();\n    return;\n  }\n  const entry = dashboardStore.tasks.find((task) => task.id === currentJobId.value);\n  const snapshot = (entry?.snapshot as TaskResponse | undefined) || latestTaskSnapshot.value;\n  const length = entry?.textLength ?? extractTextLength(snapshot);\n  currentJobTextLength.value = length ?? null;\n  if (entry && length && entry.textLength !== length) {\n    dashboardStore.upsertTask({ ...entry, textLength: length, updatedAt: entry.updatedAt ?? Date.now() });\n  }\n}\n\nfunction startVideoCountdown(task?: TaskResponse | null) {\n  if (!currentJobId.value) return;\n  const textLength = currentJobTextLength.value || extractTextLength(task) || null;\n  if (!textLength) {\n    stopVideoCountdown();\n    return;\n  }\n  const secondsPerChar = resolveSecondsPerChar();\n  const estimatedTotal = Math.max(Math.round(textLength * secondsPerChar), 5);\n  const stageStart = resolveVideoStageStart(task) ?? videoStageStartAt.value ?? Date.now();\n  videoStageStartAt.value = stageStart;\n  videoCountdown.total = estimatedTotal;\n  videoCountdown.active = true;\n  videoCountdown.source =\n    historicalStats.sampleSize > 0\n      ? `基于 ${historicalStats.sampleSize} 个历史样本`\n      : '经验估算';\n  videoCountdown.samples = historicalStats.sampleSize;\n  updateVideoCountdownRemaining();\n  if (!videoCountdownTimer.value) {\n    videoCountdownTimer.value = window.setInterval(updateVideoCountdownRemaining, 1000);\n  }\n}\n\nfunction stopVideoCountdown() {\n  videoCountdown.active = false;\n  videoCountdown.remaining = 0;\n  videoStageStartAt.value = null;\n  if (videoCountdownTimer.value) {\n    clearInterval(videoCountdownTimer.value);\n    videoCountdownTimer.value = null;\n  }\n}\n\nfunction updateVideoCountdownRemaining() {\n  if (!videoCountdown.active || videoStageStartAt.value === null) {\n    videoCountdown.remaining = 0;\n    return;\n  }\n  const elapsed = (Date.now() - videoStageStartAt.value) / 1000;\n  const remaining = Math.max(videoCountdown.total - elapsed, 0);\n  videoCountdown.remaining = remaining;\n  if (remaining <= 0.1) {\n    stopVideoCountdown();\n  }\n}\n\nfunction resolveVideoStageStart(task?: TaskResponse | null) {\n  if (!task) return null;\n  const iso = (task.assets || {}).video_stage_started_at;\n  if (typeof iso === 'string') {\n    const parsed = Date.parse(iso);\n    if (!Number.isNaN(parsed)) {\n      return parsed;\n    }\n  }\n  return null;\n}\n\nfunction resolveSecondsPerChar() {\n  if (historicalStats.secondsPerChar > 0) {\n    return historicalStats.secondsPerChar;\n  }\n  return DEFAULT_VIDEO_SECONDS_PER_CHAR;\n}\n\nfunction scheduleAnalyticsHydration() {\n  void hydrateFinishedTaskAnalytics();\n}\n\nasync function hydrateFinishedTaskAnalytics() {\n  if (analyticsHydrationRunning) return;\n  analyticsHydrationRunning = true;\n  try {\n    const finished = dashboardStore.tasks.filter((task) => task.status === 'finished');\n    for (const entry of finished) {\n      await hydrateTaskAnalytics(entry.id, entry.snapshot as TaskResponse | undefined);\n    }\n    recomputeHistoricalStats();\n  } finally {\n    analyticsHydrationRunning = false;\n  }\n}\n\nasync function hydrateTaskAnalytics(jobId: string, snapshot?: TaskResponse) {\n  if (processedAnalytics.has(jobId)) return;\n  const entry = dashboardStore.tasks.find((task) => task.id === jobId);\n  if (!entry) return;\n  if (entry.analytics?.perCharSeconds && entry.textLength) {\n    processedAnalytics.add(jobId);\n    return;\n  }\n  const textLength = entry.textLength ?? extractTextLength(snapshot);\n  if (!textLength) return;\n  let seconds = snapshot?.assets?.video_stage_seconds;\n  if (seconds == null) {\n    seconds = await fetchVideoStageSecondsFromLog(jobId);\n    if (seconds == null && typeof snapshot?.duration === 'number') {\n      seconds = snapshot.duration;\n    }\n  }\n  if (seconds == null || seconds <= 0) return;\n  const analytics = {\n    textLength,\n    videoStageSeconds: seconds,\n    perCharSeconds: seconds / textLength\n  };\n  const updatedAt = entry.updatedAt || Date.now();\n  dashboardStore.upsertTask({ ...entry, analytics, textLength, updatedAt });\n  processedAnalytics.add(jobId);\n}\n\nasync function fetchVideoStageSecondsFromLog(jobId: string) {\n  if (!jobId) return null;\n  try {\n    const response = await fetch(`${config.API_BASE}/output/${jobId}/log.txt`);\n    if (!response.ok) {\n      return null;\n    }\n    const text = await response.text();\n    return parseVideoStageDuration(text);\n  } catch {\n    return null;\n  }\n}\n\nfunction parseVideoStageDuration(logText: string) {\n  if (!logText) return null;\n  const lines = logText.split(/\\r?\\n/);\n  const regex = /^\\[(?<time>[^\\]]+)\\]\\s+\\[[^\\]]+\\](?:\\s+\\[[^\\]]+\\])?\\s+(?<message>.*)$/;\n  let start: number | null = null;\n  for (const line of lines) {\n    const match = regex.exec(line.trim());\n    if (!match || !match.groups) continue;\n    const { time, message } = match.groups;\n    if (!time || !message) continue;\n    if (start === null && message.includes('正在生成数字人视频')) {\n      const parsed = Date.parse(time);\n      if (!Number.isNaN(parsed)) {\n        start = parsed;\n      }\n      continue;\n    }\n    if (start !== null && message.includes('数字人视频生成完成')) {\n      const end = Date.parse(time);\n      if (!Number.isNaN(end)) {\n        return Math.max((end - start) / 1000, 0);\n      }\n    }\n  }\n  return null;\n}\n\nfunction recomputeHistoricalStats() {\n  const samples = dashboardStore.tasks\n    .map((task) => task.analytics?.perCharSeconds)\n    .filter((value): value is number => typeof value === 'number' && Number.isFinite(value) && value > 0);\n  if (!samples.length) {\n    historicalStats.secondsPerChar = 0;\n    historicalStats.sampleSize = 0;\n    return;\n  }\n  const avg = samples.reduce((sum, item) => sum + item, 0) / samples.length;\n  historicalStats.secondsPerChar = avg;\n  historicalStats.sampleSize = samples.length;\n}\n\nfunction formatBalance(value?: number | null) {\n  if (typeof value !== 'number' || Number.isNaN(value)) {\n    return '';\n  }\n  return `$${value.toFixed(2)}`;\n}\n\nfunction handleCompletion(task: TaskResponse) {\n  if (task.status === 'finished') {\n    taskStatus.value = 'finished';\n    resultVideoUrl.value = resolveVideoUrl(task);\n    totalCost.value = resolveActualCost(task);\n    statusMessage.value = '✅ 数字人视频生成完成！';\n  } else {\n    taskStatus.value = 'failed';\n    errorMessage.value = task.message || '任务执行失败';\n    showErrorDialog('任务执行失败', task);\n  }\n}\n\nfunction resolveActualCost(task: TaskResponse) {\n  if (typeof task.billing?.actual_cost === 'number') {\n    return task.billing.actual_cost;\n  }\n  if (typeof task.cost === 'number') {\n    return task.cost;\n  }\n  const extracted = extractCostValue(task.cost_estimate);\n  if (typeof extracted === 'number') {\n    return extracted;\n  }\n  return estimatedCost.value;\n}\n\nfunction resetProgress(state: 'idle' | 'running' = 'running') {\n  stageDefinitions.forEach((definition) => {\n    stageStatus[definition.id].state = 'pending';\n    stageStatus[definition.id].description = '等待调度';\n  });\n  taskStatus.value = state;\n  avatarUrl.value = '';\n  audioUrl.value = '';\n  resultVideoUrl.value = '';\n  totalCost.value = 0;\n  billingInfo.value = null;\n  errorMessage.value = '';\n  costEstimateValue.value = null;\n  costEstimateDesc.value = '';\n  dashboardStore.clearError('progress');\n}\n\nfunction updateCostEstimate(value: TaskResponse['cost_estimate'], fallbackDesc = '') {\n  if (typeof value === 'number') {\n    costEstimateValue.value = value;\n    costEstimateDesc.value = fallbackDesc;\n    return;\n  }\n\n  if (value) {\n    const total = extractCostValue(value);\n    costEstimateValue.value = typeof total === 'number' ? Number(total) : null;\n    const parts = [\n      value.avatar ? `头像 $${value.avatar.toFixed(2)}` : null,\n      value.speech ? `语音 $${value.speech.toFixed(2)}` : null,\n      value.video ? `视频 $${value.video.toFixed(2)}` : null\n    ]\n      .filter(Boolean)\n      .join(' / ');\n    costEstimateDesc.value = parts || fallbackDesc;\n    return;\n  }\n\n  costEstimateValue.value = null;\n  costEstimateDesc.value = '';\n}\n\nfunction extractCostValue(value: TaskResponse['cost_estimate']) {\n  if (typeof value === 'number') {\n    return value;\n  }\n  if (value) {\n    return value.total ?? (value.avatar ?? 0) + (value.speech ?? 0) + (value.video ?? 0);\n  }\n  return undefined;\n}\n\nfunction stageStateIcon(stage: StageKey) {\n  const state = stageStatus[stage].state;\n  if (state === 'done') return '✅';\n  if (state === 'active') return '⚙️';\n  if (state === 'failed') return '⚠️';\n  return '⏳';\n}\n\nfunction downloadVideo() {\n  if (!resultVideoUrl.value) return;\n  const link = document.createElement('a');\n  link.href = resultVideoUrl.value;\n  link.download = `digital_human_${currentJobId.value ?? ''}.mp4`;\n  link.click();\n}\n\nasync function copyVideoLink() {\n  if (!resultVideoUrl.value) return;\n  try {\n    await navigator.clipboard.writeText(resultVideoUrl.value);\n    showFormAlert('链接已复制到剪贴板', 'info');\n  } catch {\n    showFormAlert('复制失败，请手动复制链接');\n  }\n}\n\nfunction showFormAlert(message: string, type: 'info' | 'error' = 'error') {\n  formAlert.message = message;\n  formAlert.type = type;\n}\n\nfunction clearFormAlert() {\n  formAlert.message = '';\n  formAlert.type = '';\n}\n\nfunction showErrorDialog(title: string, payload: { detail?: string; error_code?: string; trace_id?: string }) {\n  errorDialogTitle.value = title;\n  errorDialogMessage.value = payload.detail || '';\n  const meta = [\n    payload.error_code ? `错误码: ${payload.error_code}` : null,\n    payload.trace_id ? `Trace ID: ${payload.trace_id}` : null\n  ]\n    .filter(Boolean)\n    .join('\\n');\n  errorDialogDetail.value = meta || '暂无更多信息';\n  errorDialogVisible.value = true;\n}\n\nfunction closeErrorDialog() {\n  errorDialogVisible.value = false;\n  errorDialogTitle.value = '';\n  errorDialogMessage.value = '';\n  errorDialogDetail.value = '';\n}\n\nasync function safeJson(response: Response) {\n  try {\n    return await response.json();\n  } catch {\n    const status = response.status || 0;\n    const text = (response.statusText || '').trim();\n    if (status && text) {\n      return { detail: `HTTP ${status} ${text}` };\n    }\n    if (status) {\n      return { detail: `HTTP ${status}` };\n    }\n    return { detail: text || '未知错误' };\n  }\n}\n\nfunction getSelectedAvatarFile() {\n  return avatarFile.value;\n}\n\nfunction validateAvatarFile(file: File) {\n  if (!file.type.startsWith('image/')) {\n    return '仅支持 PNG/JPG 等图片格式';\n  }\n  if (file.size > MAX_AVATAR_SIZE) {\n    return '头像文件不能超过 5MB';\n  }\n  return null;\n}\n\nfunction handleAvatarFiles(files: Array<{ file?: File }>) {\n  if (!files.length) {\n    avatarFile.value = null;\n    avatarFileError.value = '';\n    return;\n  }\n  const file = files[0].file ?? null;\n  if (!file) {\n    avatarFile.value = null;\n    return;\n  }\n  const validationError = validateAvatarFile(file);\n  if (validationError) {\n    avatarFileError.value = validationError;\n    avatarFile.value = null;\n    return;\n  }\n  avatarFileError.value = '';\n  avatarFile.value = file;\n}\n\nfunction clearAvatarFile() {\n  avatarFile.value = null;\n  avatarFileError.value = '';\n  creationPanelRef.value?.clearAvatarUpload?.();\n}\n\nonBeforeUnmount(() => {\n  stopPolling();\n  if (typeof document !== 'undefined') {\n    document.body.classList.remove('drawer-lock');\n  }\n  cancelBalanceRefreshTimer();\n});\n</script>\n\n<style scoped>\n.hero {\n  background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(5, 150, 105, 0.35));\n  border-radius: 32px;\n  border: 1px solid rgba(16, 185, 129, 0.25);\n  padding: 2rem;\n  display: flex;\n  flex-direction: column;\n  gap: 1.5rem;\n  box-shadow: 0 25px 50px rgba(2, 6, 23, 0.45);\n}\n\n.hero-main {\n  display: flex;\n  justify-content: space-between;\n  gap: 1.25rem;\n  flex-wrap: wrap;\n  text-align: left;\n}\n\n.hero-title h1 {\n  margin: 0.25rem 0;\n  font-size: clamp(2rem, 4vw, 2.75rem);\n}\n\n.hero-eyebrow {\n  margin: 0;\n  color: rgba(226, 232, 240, 0.8);\n  letter-spacing: 0.12em;\n  text-transform: uppercase;\n  font-size: 0.8rem;\n}\n\n.hero-subtitle {\n  margin: 0.25rem 0 0;\n  color: rgba(226, 232, 240, 0.78);\n}"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:33:47.634Z",
          "resultDisplay": "Read lines 1-2000 of 2592 from frontend/src/App.vue",
          "displayName": "ReadFile",
          "description": "Reads and returns the content of a specified file. If the file is large, the content will be truncated. The tool's response will clearly indicate if truncation has occurred and will provide details on how to read more of the file using the 'offset' and 'limit' parameters. Handles text, images (PNG, JPG, GIF, WEBP, SVG, BMP), audio files (MP3, WAV, AIFF, AAC, OGG, FLAC), and PDF files. For text files, it can read specific line ranges.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Reviewing the Components",
          "description": "I'm currently focused on the contents of the `workspace` directory. I've noted `PreparationPanel.vue`, which seems to be for task pre-configuration, and `TaskList.vue`, implying recent task display. With a better understanding of the components I am now exploring possible connections.",
          "timestamp": "2026-01-03T08:33:47.608Z"
        },
        {
          "subject": "Understanding the User Flow",
          "description": "Now, I've dug into the `App.vue` file. This should clarify how `PreparationPanel.vue` and `TaskList.vue` fit together. I'm keen on understanding the order of operations, to see how the user interacts with both components. I'm looking to identify the high level features now.",
          "timestamp": "2026-01-03T08:33:47.610Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 28963,
        "output": 13,
        "cached": 7097,
        "thoughts": 104,
        "tool": 0,
        "total": 29080
      }
    },
    {
      "id": "e0dff3ca-606d-4656-97c3-9c5a95019602",
      "timestamp": "2026-01-03T08:34:22.713Z",
      "type": "gemini",
      "content": "好的，作为一名资深的 UX 设计师，我已经对 `ren.linapp.fun` 的前端应用（通过分析 `frontend/` 下的源代码）进行了初步评估。\n\n这个应用功能非常强大，可以说是“专家模式”——为熟悉整个流程的用户提供了极高的效率。然而，这也正是其最大的 UX 问题所在。对于新用户，当前界面无疑是信息过载的，就像一个飞机的驾驶舱，充满了开关和仪表盘，令人望而生畏。\n\n以下是我的批判性意见和改进建议，将从最核心的体验问题开始：\n\n---\n\n### **UX 核心问题与改进建议**\n\n#### **1. 认知负荷过高：三栏“驾驶舱”布局劝退新手**\n\n当前的 `准备` | `创建` | `监控` 三栏布局，将所有信息一股脑地展示给用户，导致了极高的认知负荷。\n\n*   **问题**：一个新用户首次访问，他需要同时理解 API Key、复杂的创建表单和一个空白的监控面板。视线无处安放，不知道从何开始。这违反了“引导用户”的核心原则。\n*   **改进建议**：“化整为零，分步引导”。我们应该将这个复杂的任务拆解成一个线性的、有节奏的流程。\n\n    1.  **第一步：配置 (Setup)**。首次访问或 API Key 未设置时，界面应**只显示** `PreparationPanel`。这是用户的第一个任务，必须清晰、独立。当 Key 验证通过并查询到余额后，自动引导至下一步。\n    2.  **第二步：创建 (Create)**。这是核心操作区。`CreationPanel` 应该成为页面的绝对主角。历史任务列表 (`TaskList`) 可以作为左侧的次要导航，而不是一个需要持续关注的面板。\n    3.  **第三步：监控 (Monitor)**。当用户点击“创建”按钮，任务提交成功后，界面应**自动切换**到 `MonitorPanel`，让用户聚焦于任务进度。\n\n#### **2. “表单之墙”：创建面板缺乏视觉焦点和引导**\n\n`CreationPanel` 本身就是一个很长的表单，所有选项（从“播报文本”到“随机种子”）在视觉上具有相同的权重。\n\n*   **问题**：这会让用户感到疲劳，难以区分哪些是必填项，哪些是高级微调选项。用户可能在不重要的细节上花费过多时间。\n*   **改进建议**：\n    *   **渐进式披露 (Progressive Disclosure)**：默认隐藏高级选项。将 `语速`、`音调`、`情绪`、`随机种子` 等参数收起到一个名为“高级参数微调”的可折叠区域中。\n    *   **突出智能默认值**：UI 应明确标识出推荐的默认选项，例如给默认音色一个“推荐”徽章，或在分辨率选项旁注明“720p (推荐)”。\n    *   **强化分组**：使用卡片式设计或带有明确标题的字段集 (`<fieldset>`) 来区隔 `形象配置`、`语音配置` 和 `输出设置`，让表单的结构一目了然。\n\n#### **3. 引导性缺失：应用的“空状态”和“首次使用”体验不足**\n\n应用似乎假设用户已经知道该做什么。虽然顶部的 Hero 区域提供了入口，但从那里到复杂工作区的过渡太突兀。\n\n*   **问题**：`TaskList` 为空时，只是一个空列表。`MonitorPanel` 在没有任务时，也只是显示“尚未创建任务”。这些都是与用户沟通、引导他们的绝佳机会，但都被浪费了。\n*   **改进建议**：\n    *   **优化空状态 (Empty States)**：在 `TaskList` 为空时，应显示：“你还没有创建过数字人视频，让我们开始第一个吧！”，并附上一个醒目的“开始创作”按钮，点击后能将用户视线引导至创建面板。\n    *   **首次用户引导 (Onboarding Tour)**：对于新用户（可以通过 `localStorage` 标记），可以考虑一个简单的、可关闭的引导流程（例如使用 `Shepherd.js` 库），依次介绍：1. 在这里设置你的 Key；2. 在这里填写内容；3. 在这里查看进度。\n\n#### **4. 语言的“技术味”：部分术语和标签对普通用户不友好**\n\n*   **问题**：“随机种子 (Seed)”、“音调 (Pitch)” 等术语对非技术用户来说很抽象。Hero 区域的任务摘要（`任务 {id} · {status}`）也过于技术化。\n*   **改进建议**：\n    *   **增加辅助提示 (Tooltips)**：在这些技术术语旁边增加一个小问号图标 `(?)`，鼠标悬停时显示简单的解释。例如，为“随机种子”增加提示：“控制生成结果的随机性。相同的设置和种子会产生相似的结果。”\n    *   **人性化的话术**：任务摘要可以更友好，例如：“你的视频正在生成中...”。另外，建议在创建时增加一个“任务标题”字段，这样历史列表就可以显示为 “我的第一个作品 - 已完成”，而不是一长串 ID。\n\n---\n\n### **下一步行动计划**\n\n我会遵循“先解决最痛的点”的原则，逐步实施改进。\n\n1.  **首要任务：实现引导式、分步式的工作流。** 这是对整体体验改善最明显的改动。我会修改 `App.vue`，引入一个管理当前视图状态的机制（例如 `setup`, `create`, `monitor`），并根据此状态一次只显示一个核心面板。\n2.  **其次：简化 `CreationPanel`。** 通过渐进式披露，隐藏高级设置，降低用户的决策压力。\n3.  **最后：优化空状态和提示文案。** 增加更多引导性文本和 Tooltips。\n\n我现在将开始执行第一个任务：**将三栏“驾驶舱”改造为分步式工作流**。\n\n我将从修改 `App.vue` 开始，添加一个新的状态变量来控制当前激活的面板。",
      "thoughts": [
        {
          "subject": "Reviewing the Layout",
          "description": "I'm currently digesting the architecture of the `App.vue` component, which is handling the whole UI. Initial impressions highlight a three-column layout. I'm scrutinizing how content is structured in these columns, and I'm starting to build a mental map of how the user will navigate and interact within each section.",
          "timestamp": "2026-01-03T08:34:22.295Z"
        },
        {
          "subject": "Evaluating Navigation Flows",
          "description": "I've been drilling down into the three-column layout in `App.vue`. I'm now sketching out the user's potential journeys through the panels. I'm focusing on the Preparation, Creation, and Monitor sections, analyzing how users will move between them. I'm especially focused on the mobile drawer implementation.",
          "timestamp": "2026-01-03T08:34:22.300Z"
        },
        {
          "subject": "Dissecting Initial Impressions",
          "description": "Now, I'm examining how each panel aligns with user goals. I'm especially concerned by the simultaneous exposure to multiple panels. The three-column approach feels overwhelming, and I'm leaning toward a more sequential user flow. Specifically, I'm prioritizing the onboarding process, focusing on API key setup as the initial step to ease users into the application. This could resolve some initial confusion.",
          "timestamp": "2026-01-03T08:34:22.303Z"
        },
        {
          "subject": "Refining User Journey",
          "description": "I'm now prioritizing the onboarding flow. The initial state, especially for new users, presents an opportunity. The key is to simplify the `PreparationPanel` experience and focus first on essential actions like API key setup. My focus is on a phased approach, leading users through a controlled sequence. The goal is to reduce initial cognitive load and guide them toward a successful first task.",
          "timestamp": "2026-01-03T08:34:22.314Z"
        },
        {
          "subject": "Evaluating Initial Impressions",
          "description": "I've just finished a deeper dive into the `App.vue` component, and I'm quite concerned about the cognitive load presented by the three-column layout. The simultaneous display of the `Preparation`, `Creation`, and `Monitor` panels feels overwhelming to the uninitiated. I'm now pushing for a more sequential flow. The priority is to implement a guided onboarding that first addresses API key setup to ease the user into the process, followed by a streamlined creation workflow.",
          "timestamp": "2026-01-03T08:34:22.317Z"
        },
        {
          "subject": "Refining Initial Assessment",
          "description": "After reviewing the `App.vue` component, my primary concern remains the overwhelming three-column layout. I'm focusing on the first-time user experience, and a sequential onboarding flow seems essential. I'm designing a streamlined approach to guide the user from API key setup to their first digital human task. The aim is to reduce initial confusion and maximize engagement.",
          "timestamp": "2026-01-03T08:34:22.319Z"
        },
        {
          "subject": "Formulating the Onboarding Flow",
          "description": "I'm now prioritizing the implementation of a phased user onboarding sequence. The three-column layout is still a key concern, which makes a guided approach crucial. My immediate focus is to streamline the initial setup, starting with the API key entry and then guiding users through a simplified creation process to create their first task.",
          "timestamp": "2026-01-03T08:34:22.322Z"
        },
        {
          "subject": "Defining the Workflow States",
          "description": "I'm starting by establishing a clear state management system within `App.vue`. This is pivotal for controlling the navigation between panels. I'm focusing on three primary states: 'preparation,' 'creation,' and 'monitoring.' I will then use these states to guide the user through the application in a logical sequence, prioritizing a streamlined experience.",
          "timestamp": "2026-01-03T08:34:22.324Z"
        }
      ],
      "tokens": {
        "input": 47242,
        "output": 1353,
        "cached": 29865,
        "thoughts": 1702,
        "tool": 0,
        "total": 50297
      },
      "model": "gemini-2.5-pro"
    },
    {
      "id": "524bc6e7-ef39-4cf5-893a-852946ae5956",
      "timestamp": "2026-01-03T08:35:51.630Z",
      "type": "user",
      "content": "继续，开始修正"
    },
    {
      "id": "062937e2-daef-40fb-bc6b-f8f764bc6836",
      "timestamp": "2026-01-03T08:35:59.753Z",
      "type": "gemini",
      "content": "Okay, let's begin. I'll start by refactoring `App.vue` to implement the new step-by-step workflow. This will involve managing the view state and conditionally rendering the `Preparation`, `Creation`, and `Monitor` panels.",
      "thoughts": [
        {
          "subject": "Envisioning the Workflow",
          "description": "I'm now diving into modifying `App.vue`. My initial step involves introducing a `currentView` ref to manage the view state. This variable will be the linchpin for orchestrating the step-by-step workflow, making sure the user experience is smooth and intuitive. I'm focusing on the structural foundation.",
          "timestamp": "2026-01-03T08:35:59.721Z"
        },
        {
          "subject": "Structuring the Components",
          "description": "I'm now implementing the `currentView` ref within `App.vue`. This is pivotal for controlling which panel is displayed at any given time. I'm leveraging `v-if` directives to conditionally render the 'preparation', 'creation', and 'monitoring' sections based on the `currentView`'s state. I'm also planning the flow logic transitions based on API key validation and task submissions. I'm focused on a smooth user experience.",
          "timestamp": "2026-01-03T08:35:59.727Z"
        },
        {
          "subject": "Planning the Implementation",
          "description": "Now, I'm defining the implementation steps. I'll begin by introducing the `currentView` ref within `App.vue`, setting up the conditional rendering using `v-if` to manage the panel visibility. Next, I'll program the flow logic, transitioning from 'preparation' to 'creation' upon successful API key validation and then to 'monitoring' after a successful task submission. I'll also add manual navigation options for user flexibility.",
          "timestamp": "2026-01-03T08:35:59.734Z"
        }
      ],
      "tokens": {
        "input": 48599,
        "output": 66,
        "cached": 29003,
        "thoughts": 341,
        "tool": 0,
        "total": 49006
      },
      "model": "gemini-2.5-pro",
      "toolCalls": [
        {
          "id": "read_file-1767429359750-07642d6cf75e",
          "name": "read_file",
          "args": {
            "file_path": "frontend/src/App.vue"
          },
          "result": [
            {
              "functionResponse": {
                "id": "read_file-1767429359750-07642d6cf75e",
                "name": "read_file",
                "response": {
                  "output": "\nIMPORTANT: The file content has been truncated.\nStatus: Showing lines 1-2000 of 2592 total lines.\nAction: To read more of the file, you can use the 'offset' and 'limit' parameters in a subsequent 'read_file' call. For example, to read the next section of the file, use offset: 2000.\n\n--- FILE CONTENT (truncated) ---\n<template>\n  <main class=\"page\">\n    <header class=\"hero hero--minimal\">\n      <div class=\"hero-main\">\n        <div class=\"hero-title\">\n          <p class=\"hero-eyebrow\">数字人生成中心</p>\n          <h1>10 秒配置，即刻生成数字人</h1>\n          <p class=\"hero-subtitle\">Seedream 形象 · MiniMax 语音 · Infinitetalk 唇形</p>\n        </div>\n        <div class=\"hero-cta\">\n          <button type=\"button\" class=\"hero-cta__primary\" :disabled=\"submitting\" @click=\"handleHeroCreateTask\">\n            {{ submitting ? '创建中…' : '开始创建' }}\n          </button>\n          <button type=\"button\" class=\"hero-cta__ghost\" @click=\"handleHeroMonitor\">查看任务状态</button>\n          <p class=\"hero-cta__hint\">{{ heroSummaryText }}</p>\n        </div>\n      </div>\n    </header>\n\n    <div class=\"workspace\">\n      <section class=\"workspace__column workspace__column--system\">\n        <PreparationPanel\n          class=\"workspace__preparation\"\n          :is-mobile=\"isMobile\"\n          :api-key-value=\"apiKeyInput\"\n          :api-key-visible=\"apiKeyVisible\"\n          :api-key-error=\"apiKeyError\"\n          :is-api-key-valid=\"isApiKeyValid\"\n          :has-stored-key=\"Boolean(dashboardStore.apiKey)\"\n          :balance-display=\"balanceDisplay\"\n          :balance-loading=\"balanceLoading\"\n          :debug-mode=\"debugMode\"\n          :debug-hint=\"debugHint\"\n          :app-config=\"config\"\n          :error-message=\"dashboardStore.errors.apiKey\"\n          :task-error=\"dashboardStore.errors.tasks\"\n          :task-history=\"taskHistory\"\n          :current-job-id=\"currentJobId\"\n          :polling-active=\"pollingActive\"\n          :describe-status=\"describeStatus\"\n          :format-timestamp=\"formatTimestamp\"\n          @update:api-key-value=\"handleApiKeyInputChange\"\n          @update:api-key-visible=\"handleApiKeyVisibleChange\"\n          @validate-api-key=\"validateApiKey\"\n          @save-api-key=\"saveApiKeySetting\"\n          @clear-api-key=\"clearApiKeySetting\"\n          @refresh-balance=\"refreshBalance\"\n          @refresh-selected-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @select-task=\"handleTaskSelection\"\n          @remove-task=\"removeTaskFromHistory\"\n          @update:debug-mode=\"updateDebugMode\"\n        />\n      </section>\n      <section class=\"workspace__column workspace__column--input\">\n        <CreationPanel\n          ref=\"creationPanelRef\"\n          :is-mobile=\"isMobile\"\n          :form-alert=\"formAlert\"\n          :avatar-mode=\"avatarMode\"\n          :avatar-prompt=\"avatarPrompt\"\n          :avatar-file-error=\"avatarFileError\"\n          :accepted-avatar-types=\"acceptedAvatarTypes\"\n          :max-avatar-size-label=\"maxAvatarSizeLabel\"\n          :pond-label=\"pondLabel\"\n          :speech-text=\"speechText\"\n          :char-count=\"charCount\"\n          :estimated-duration=\"estimatedDuration\"\n          :estimated-cost=\"estimatedCost\"\n          :voice-id=\"voiceId\"\n          :resolution=\"resolution\"\n          :speed=\"speed\"\n          :pitch=\"pitch\"\n          :emotion=\"emotion\"\n          :seed=\"seed\"\n          :submitting=\"submitting\"\n          :characters=\"characters\"\n          :character-loading=\"characterLoading\"\n          :character-error=\"characterError\"\n          :selected-character-id=\"selectedCharacterId\"\n          :selected-character=\"selectedCharacter\"\n          :character-preview-url=\"characterPreviewUrl\"\n          :new-character-form=\"newCharacterForm\"\n          :new-character-alert=\"newCharacterAlert\"\n          :creating-character=\"creatingCharacter\"\n          :creation-sections=\"creationSections\"\n          @update:avatar-mode=\"updateAvatarMode\"\n          @update:avatar-prompt=\"updateAvatarPrompt\"\n          @update:speech-text=\"updateSpeechText\"\n          @update:voice-id=\"updateVoiceId\"\n          @update:resolution=\"updateResolution\"\n          @update:speed=\"updateSpeed\"\n          @update:pitch=\"updatePitch\"\n          @update:emotion=\"updateEmotion\"\n          @update:seed=\"updateSeed\"\n          @refresh-characters=\"refreshCharacters\"\n          @update:selected-character-id=\"updateSelectedCharacterId\"\n          @clear-character-selection=\"clearCharacterSelection\"\n          @avatar-files-change=\"handleAvatarFiles\"\n          @update:new-character-form=\"updateNewCharacterForm\"\n          @new-character-file-change=\"handleNewCharacterFile\"\n          @submit-new-character=\"submitNewCharacter\"\n          @toggle-section=\"handleCreationSectionToggle\"\n          @submit=\"handleSubmit\"\n        />\n      </section>\n      <section class=\"workspace__column workspace__column--output\">\n        <MonitorPanel\n          ref=\"monitorPanelRef\"\n          :current-job-id=\"currentJobId\"\n          :task-status=\"taskStatus\"\n          :overall-progress-percent=\"overallProgressPercent\"\n          :overall-progress-label=\"overallProgressLabel\"\n          :stage-definitions=\"stageDefinitions\"\n          :stage-status=\"stageStatus\"\n          :status-message=\"statusMessage\"\n          :status-accent=\"statusAccent\"\n          :trace-id=\"monitorTraceId\"\n          :countdown-visible=\"countdownVisible\"\n          :countdown-label=\"countdownLabel\"\n          :countdown-source=\"countdownSource\"\n          :cost-estimate-value=\"costEstimateValue\"\n          :cost-estimate-desc=\"costEstimateDesc\"\n          :avatar-url=\"avatarUrl\"\n          :audio-url=\"audioUrl\"\n          :result-video-url=\"resultVideoUrl\"\n          :total-cost=\"totalCost\"\n          :billing-summary=\"billingSummary\"\n          :error-message=\"errorMessage\"\n          :material-items=\"materialItems\"\n          :polling-active=\"pollingActive\"\n          :result-section-collapsed=\"resultSectionCollapsed\"\n          :material-warning=\"resultSectionWarning\"\n          :task-logs=\"taskLogs\"\n          @download-video=\"downloadVideo\"\n          @copy-video-link=\"copyVideoLink\"\n          @copy-local-path=\"copyLocalPath\"\n          @copy-public-link=\"copyPublicLink\"\n          @open-public-link=\"openPublicLink\"\n          @refresh-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @toggle-result-section=\"handleResultSectionToggle\"\n        />\n      </section>\n    </div>\n  </main>\n\n  <div v-if=\"isMobile\" class=\"mobile-drawer-bar\">\n    <button\n      v-for=\"btn in drawerButtons\"\n      :key=\"btn.id\"\n      type=\"button\"\n      class=\"drawer-toggle\"\n      :class=\"{ active: mobileDrawerPanel === btn.id }\"\n      @click=\"toggleMobileDrawer(btn.id)\"\n    >\n      <span class=\"drawer-icon\">{{ btn.icon }}</span>\n      <span class=\"drawer-label\">{{ btn.label }}</span>\n      <small>{{ overallProgressLabel }}</small>\n    </button>\n  </div>\n  <transition name=\"drawer-fade\">\n    <div v-if=\"drawerActive\" class=\"drawer-overlay\" @click=\"closeMobileDrawer\"></div>\n  </transition>\n  <transition name=\"drawer-slide\">\n    <section v-if=\"drawerActive\" class=\"drawer-panel\">\n      <header class=\"drawer-panel__header\">\n        <div>\n          <p class=\"drawer-panel__eyebrow\">{{ drawerPanelSubtitle }}</p>\n          <h3>{{ drawerPanelTitle }}</h3>\n        </div>\n        <button type=\"button\" class=\"drawer-close\" @click=\"closeMobileDrawer\">关闭</button>\n      </header>\n      <div class=\"drawer-panel__body\">\n        <MonitorPanel\n          v-if=\"mobileDrawerPanel === 'monitor'\"\n          :current-job-id=\"currentJobId\"\n          :task-status=\"taskStatus\"\n          :overall-progress-percent=\"overallProgressPercent\"\n          :overall-progress-label=\"overallProgressLabel\"\n          :stage-definitions=\"stageDefinitions\"\n          :stage-status=\"stageStatus\"\n          :status-message=\"statusMessage\"\n          :status-accent=\"statusAccent\"\n          :trace-id=\"monitorTraceId\"\n          :countdown-visible=\"countdownVisible\"\n          :countdown-label=\"countdownLabel\"\n          :countdown-source=\"countdownSource\"\n          :cost-estimate-value=\"costEstimateValue\"\n          :cost-estimate-desc=\"costEstimateDesc\"\n          :avatar-url=\"avatarUrl\"\n          :audio-url=\"audioUrl\"\n          :result-video-url=\"resultVideoUrl\"\n          :total-cost=\"totalCost\"\n          :billing-summary=\"billingSummary\"\n          :error-message=\"errorMessage\"\n          :material-items=\"materialItems\"\n          :polling-active=\"pollingActive\"\n          :result-section-collapsed=\"resultSectionCollapsed\"\n          :material-warning=\"resultSectionWarning\"\n          @download-video=\"downloadVideo\"\n          @copy-video-link=\"copyVideoLink\"\n          @copy-local-path=\"copyLocalPath\"\n          @copy-public-link=\"copyPublicLink\"\n          @open-public-link=\"openPublicLink\"\n          @refresh-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @toggle-result-section=\"handleResultSectionToggle\"\n        />\n      </div>\n    </section>\n  </transition>\n\n  <div v-if=\"toastMessage\" class=\"toast\">{{ toastMessage }}</div>\n\n  <div v-if=\"errorDialogVisible\" class=\"error-overlay\">\n    <div class=\"error-dialog\">\n      <h3>{{ errorDialogTitle }}</h3>\n      <p>{{ errorDialogMessage }}</p>\n      <pre>{{ errorDialogDetail }}</pre>\n      <button type=\"button\" @click=\"closeErrorDialog\">关闭</button>\n    </div>\n  </div>\n</template>\n\n\n<script setup lang=\"ts\">\nimport { computed, onBeforeUnmount, onMounted, reactive, ref, watch } from 'vue';\nimport type { ComponentPublicInstance, Ref } from 'vue';\nimport { storeToRefs } from 'pinia';\nimport { useAppConfig } from '@/composables/useAppConfig';\nimport { useMediaQuery } from '@/composables/useMediaQuery';\nimport { useAnalytics } from '@/composables/useAnalytics';\nimport CreationPanel from '@/components/panels/CreationPanel.vue';\nimport MonitorPanel from '@/components/panels/MonitorPanel.vue';\nimport PreparationPanel from '@/components/workspace/PreparationPanel.vue';\nimport { useDashboardStore } from '@/stores/dashboard';\nimport { useLayoutPrefsStore } from '@/stores/layoutPrefs';\nimport type { CreationSectionKey } from '@/stores/layoutPrefs';\nimport type { MaterialEntry, StageDefinition, StageKey, StageViewState } from '@/types/dashboard';\nimport type { CharacterRecord } from '@/types/characters';\n\ninterface BillingInfo {\n  balance_before?: number;\n  balance_after?: number;\n  actual_cost?: number;\n  currency?: string;\n  updated_at?: string;\n}\n\ninterface TaskResponse {\n  job_id?: string;\n  status: string;\n  message?: string;\n  billing?: BillingInfo;\n  avatar_url?: string;\n  audio_url?: string;\n  video_url?: string;\n  assets?: Record<string, any>;\n  cost_estimate?: number | CostEstimate;\n  cost?: number;\n  duration?: number;\n  error_code?: string;\n  trace_id?: string;\n  logs?: string[];\n}\n\ninterface CostEstimate {\n  total?: number;\n  avatar?: number;\n  speech?: number;\n  video?: number;\n}\n\nconst DEBUG_MAX_DURATION = 10;\nconst DEBUG_MAX_CHARS = DEBUG_MAX_DURATION * 5;\nconst MAX_AVATAR_SIZE = 5 * 1024 * 1024;\nconst MAX_CHARACTER_IMAGE_SIZE = 10 * 1024 * 1024;\nconst DEFAULT_CHARACTER_ID = 'char-mai';\nconst DEFAULT_VIDEO_SECONDS_PER_CHAR = 1.2;\n\nconst STAGE_PIPELINE: StageDefinition[] = [\n  { id: 'avatar', label: '头像生成', icon: '🧑‍🎨', color: '#a855f7', weight: 0.2 },\n  { id: 'speech', label: '语音生成', icon: '🎙️', color: '#0ea5e9', weight: 0.3 },\n  { id: 'video', label: '唇形视频', icon: '🎬', color: '#22c55e', weight: 0.5 }\n];\n\nconst config = useAppConfig();\nconst isMobile = useMediaQuery('(max-width: 768px)', { defaultState: false });\nconst dashboardStore = useDashboardStore();\nconst analytics = useAnalytics();\nconst layoutPrefsStore = useLayoutPrefsStore();\nconst { sortedTasks, currentTask: storeCurrentTask } = storeToRefs(dashboardStore);\nconst lastSelectionRevision = ref(0);\nconst { creationSections, resultSectionCollapsed } = storeToRefs(layoutPrefsStore);\nconst BUCKET_PUBLIC_BASE = 'https://s.linapp.fun';\nconst API_KEY_PATTERN = /^.{1,}$/;\nconst stageDefinitions = STAGE_PIPELINE;\ntype DrawerPanel = 'monitor';\nconst drawerButtons: Array<{ id: DrawerPanel; label: string; icon: string }> = [\n  { id: 'monitor', label: '监控', icon: '📊' }\n];\n\nconst creationPanelRef = ref<InstanceType<typeof CreationPanel> | null>(null);\nconst monitorPanelRef = ref<InstanceType<typeof MonitorPanel> | null>(null);\nconst apiKeyInput = ref(dashboardStore.apiKey);\nconst apiKeyVisible = ref(false);\nconst apiKeyError = ref('');\nconst isApiKeyValid = computed(() => {\n  const value = apiKeyInput.value.trim();\n  if (!value) {\n    return false;\n  }\n  return API_KEY_PATTERN.test(value);\n});\nconst balanceValue = ref<number | null>(null);\nconst balanceTimestamp = ref<number | null>(null);\nconst balanceError = ref('');\nconst balanceLoading = ref(false);\nlet balanceRefreshTimer: number | null = null;\nconst toastMessage = ref('');\nconst toastTimer = ref<number | null>(null);\nconst processedAnalytics = new Set<string>();\nlet analyticsHydrationRunning = false;\nconst latestTaskSnapshot = ref<TaskResponse | null>(null);\nconst monitorTraceId = computed(() => {\n  if (latestTaskSnapshot.value?.trace_id) {\n    return latestTaskSnapshot.value.trace_id;\n  }\n  const jobId = currentJobId.value;\n  if (!jobId) return '';\n  const entry = dashboardStore.tasks.find((task) => task.id === jobId);\n  const snapshot = entry?.snapshot as TaskResponse | undefined;\n  return snapshot?.trace_id || '';\n});\nconst taskHistory = computed(() => sortedTasks.value);\nconst heroReferenceTask = computed(() => storeCurrentTask.value || taskHistory.value[0] || null);\nconst heroSummaryText = computed(() => {\n  const task = heroReferenceTask.value;\n  if (!task) {\n    return '尚未创建任务，先在左侧完整配置一次数字人吧。';\n  }\n  const statusLabel = describeStatus(task.status);\n  const timestamp = task.updatedAt ? formatTimestamp(task.updatedAt) : '';\n  return `任务 ${task.id} · ${statusLabel}${timestamp ? ` · ${timestamp}` : ''}`;\n});\nwatch(\n  () => dashboardStore.apiKey,\n  (value, previous) => {\n    apiKeyInput.value = value;\n    if (!value) {\n      balanceValue.value = null;\n      balanceTimestamp.value = null;\n      balanceError.value = '';\n      cancelBalanceRefreshTimer();\n      return;\n    }\n    if (value !== previous) {\n      scheduleBalanceRefresh();\n    }\n  }\n);\nwatch(apiKeyInput, (value) => {\n  if (!value.trim()) {\n    apiKeyError.value = '';\n    return;\n  }\n  validateApiKey();\n});\n\nfunction cancelBalanceRefreshTimer() {\n  if (balanceRefreshTimer !== null && typeof window !== 'undefined') {\n    window.clearTimeout(balanceRefreshTimer);\n  }\n  balanceRefreshTimer = null;\n}\n\nfunction scheduleBalanceRefresh(immediate = false) {\n  if (typeof window === 'undefined') return;\n  cancelBalanceRefreshTimer();\n  const candidate = apiKeyInput.value.trim() || dashboardStore.apiKey.trim();\n  if (!candidate || !API_KEY_PATTERN.test(candidate) || balanceLoading.value) {\n    return;\n  }\n  const delay = immediate ? 0 : 600;\n  balanceRefreshTimer = window.setTimeout(() => {\n    balanceRefreshTimer = null;\n    refreshBalance();\n  }, delay);\n}\n\nfunction handleApiKeyInputChange(value: string) {\n  apiKeyInput.value = value;\n  const trimmed = value.trim();\n  dashboardStore.setApiKey(trimmed);\n  if (!trimmed) {\n    cancelBalanceRefreshTimer();\n    return;\n  }\n  if (API_KEY_PATTERN.test(trimmed)) {\n    scheduleBalanceRefresh();\n  }\n}\nfunction handleApiKeyVisibleChange(value: boolean) {\n  apiKeyVisible.value = value;\n}\nconst balanceDisplay = computed(() => {\n  if (balanceLoading.value) return '余额查询中...';\n  if (balanceError.value) return `余额：${balanceError.value}`;\n  if (balanceValue.value !== null) {\n    const time = balanceTimestamp.value\n      ? new Date(balanceTimestamp.value).toLocaleTimeString('zh-CN', {\n          hour: '2-digit',\n          minute: '2-digit',\n          hour12: false\n        })\n      : '';\n    return `余额 $${balanceValue.value.toFixed(2)}${time ? ` · ${time}` : ''}`;\n  }\n  return '余额：未查询';\n});\n\nconst avatarMode = ref<'character' | 'prompt' | 'upload'>('character');\nconst avatarPrompt = ref('一位专业的女性播音员，微笑，正面照');\nconst speechText = ref('你好啊！欢迎进入Linode+WavespeedAI数字人空间。');\nconst voiceId = ref('female-shaonv');\nconst resolution = ref<'720p' | '1080p'>('720p');\nconst speed = ref(1.0);\nconst pitch = ref(0);\nconst emotion = ref('neutral');\nconst seed = ref('');\nconst debugMode = ref(config.DEBUG);\n\nfunction bindRef<T>(target: Ref<T>) {\n  return (value: T) => {\n    target.value = value;\n  };\n}\n\nconst formAlert = reactive({ message: '', type: '' as 'info' | 'error' | '' });\nconst submitting = ref(false);\nconst avatarFileError = ref('');\nconst avatarFile = ref<File | null>(null);\n\nconst currentJobId = ref<string | null>(null);\nconst bucketBasePath = computed(() => {\n  const root = dashboardStore.bucketRoot.replace(/\\/+$/, '');\n  return `${root}/${dashboardStore.bucketUserDir}`.replace(/\\/+/g, '/');\n});\nconst currentBucketDir = computed(() =>\n  currentJobId.value ? `${bucketBasePath.value}/${currentJobId.value}` : ''\n);\nconst taskStatus = ref<'idle' | 'running' | 'finished' | 'failed'>('idle');\nconst statusMessage = ref('尚未创建任务');\nconst avatarUrl = ref('');\nconst audioUrl = ref('');\nconst stageStatus = reactive<Record<StageKey, StageViewState>>({\n  avatar: { state: 'pending', description: '等待调度' },\n  speech: { state: 'pending', description: '等待调度' },\n  video: { state: 'pending', description: '等待调度' }\n});\n\nconst costEstimateValue = ref<number | null>(null);\nconst costEstimateDesc = ref('');\nconst resultVideoUrl = ref('');\nconst totalCost = ref(0);\nconst billingInfo = ref<BillingInfo | null>(null);\nconst billingSummary = computed(() => {\n  const info = billingInfo.value;\n  if (!info) return '';\n  const hasBefore = typeof info.balance_before === 'number';\n  const hasAfter = typeof info.balance_after === 'number';\n  if (hasBefore && hasAfter) {\n    return `余额 ${formatBalance(info.balance_before)} → ${formatBalance(info.balance_after)}`;\n  }\n  if (hasAfter) {\n    return `余额剩余 ${formatBalance(info.balance_after)}`;\n  }\n  return '';\n});\nconst errorMessage = ref('');\n\nconst errorDialogVisible = ref(false);\nconst errorDialogTitle = ref('');\nconst errorDialogMessage = ref('');\nconst errorDialogDetail = ref('');\n\nconst pollTimer = ref<number | null>(null);\nconst pollingActive = computed(() => Boolean(pollTimer.value));\nconst currentJobTextLength = ref<number | null>(null);\nconst videoStageStartAt = ref<number | null>(null);\nconst videoCountdownTimer = ref<number | null>(null);\nconst videoCountdown = reactive({\n  total: 0,\n  remaining: 0,\n  source: '',\n  samples: 0,\n  active: false\n});\nconst historicalStats = reactive({ secondsPerChar: 0, sampleSize: 0 });\n\nconst characters = ref<CharacterRecord[]>([]);\nconst characterLoading = ref(false);\nconst characterError = ref('');\nconst selectedCharacterId = ref('');\nconst selectedCharacter = computed(() =>\n  characters.value.find((item) => item.id === selectedCharacterId.value) || null\n);\nconst updateAvatarMode = bindRef(avatarMode);\nconst updateAvatarPrompt = bindRef(avatarPrompt);\nconst updateSpeechText = bindRef(speechText);\nconst updateVoiceId = bindRef(voiceId);\nconst updateResolution = bindRef(resolution);\nconst updateSpeed = bindRef(speed);\nconst updatePitch = bindRef(pitch);\nconst updateEmotion = bindRef(emotion);\nconst updateSeed = bindRef(seed);\nconst updateDebugMode = bindRef(debugMode);\nconst updateSelectedCharacterId = bindRef(selectedCharacterId);\nconst characterPreviewUrl = computed(() =>\n  selectedCharacter.value ? buildCharacterImageUrl(selectedCharacter.value) : ''\n);\nconst newCharacterForm = reactive({\n  name: '',\n  appearanceZh: '',\n  appearanceEn: '',\n  voiceZh: '',\n  voicePrompt: '',\n  voiceId: ''\n});\nconst newCharacterFile = ref<File | null>(null);\nconst creatingCharacter = ref(false);\nconst newCharacterAlert = reactive({ message: '', type: '' as 'error' | 'success' | '' });\nfunction updateNewCharacterForm(value: Record<string, string>) {\n  Object.assign(newCharacterForm, value);\n}\nfunction handleCreationSectionToggle(payload: { id: CreationSectionKey; value: boolean }) {\n  layoutPrefsStore.setCreationSection(payload.id, payload.value);\n}\nfunction handleResultSectionToggle(collapsed: boolean) {\n  layoutPrefsStore.setResultSectionCollapsed(collapsed);\n  analytics.track('result_section_toggle', {\n    job_id: currentJobId.value || '',\n    collapsed\n  });\n}\nconst charCount = computed(() => speechText.value.length);\nconst estimatedDuration = computed(() => Math.ceil(charCount.value / 5) || 0);\nconst estimatedCost = computed(() => {\n  const avatarCost = 0.03;\n  const voiceCost = estimatedDuration.value / 60 * 0.02;\n  const videoCost = estimatedDuration.value * (resolution.value === '720p' ? 0.06 : 0.12);\n  return avatarCost + voiceCost + videoCost;\n});\n\nconst acceptedAvatarTypes = ['image/png', 'image/jpeg'];\nconst maxAvatarSizeLabel = '5MB';\nconst pondLabel =\n  \"拖拽或 <span class='filepond--label-action'>点击</span> 上传头像\";\n\nconst debugHint = computed(() =>\n  debugMode.value\n    ? `调试模式开启：限制 ${DEBUG_MAX_CHARS} 字以内（约 ${DEBUG_MAX_DURATION} 秒）。`\n    : '调试模式关闭：可输入最多 1000 字生成正式视频。'\n);\n\nconst statusAccent = computed(() => ({\n  success: taskStatus.value === 'finished',\n  danger: taskStatus.value === 'failed'\n}));\nconst mobileDrawerPanel = ref<DrawerPanel | ''>('');\nconst drawerActive = computed(() => Boolean(mobileDrawerPanel.value));\nconst drawerPanelTitle = computed(() => {\n  if (mobileDrawerPanel.value === 'monitor') return '任务监控';\n  return '';\n});\nconst drawerPanelSubtitle = computed(() => {\n  if (mobileDrawerPanel.value === 'monitor') {\n    if (!currentJobId.value) return '尚未创建任务';\n    return statusMessage.value || '等待最新状态';\n  }\n  return '';\n});\nwatch(isMobile, (value) => {\n  if (!value) {\n    closeMobileDrawer();\n  }\n});\nwatch(\n  () => mobileDrawerPanel.value,\n  (panel) => {\n    if (typeof document === 'undefined') return;\n    if (panel) {\n      document.body.classList.add('drawer-lock');\n    } else {\n      document.body.classList.remove('drawer-lock');\n    }\n  }\n);\n\nfunction getComponentRootEl(component: ComponentPublicInstance | null | undefined) {\n  return (component?.$el as HTMLElement | null | undefined) || null;\n}\n\nfunction scrollElementIntoView(el: HTMLElement | null | undefined) {\n  if (!el) return;\n  el.scrollIntoView({ behavior: 'smooth', block: 'start' });\n}\n\nfunction handleHeroCreateTask() {\n  analytics.track('hero_cta_click', {\n    job_id: currentJobId.value || '',\n    task_status: taskStatus.value,\n    polling_active: pollingActive.value,\n    char_count: charCount.value\n  });\n  const el = getComponentRootEl(creationPanelRef.value);\n  if (el) {\n    scrollElementIntoView(el);\n  }\n}\n\nfunction handleHeroMonitor() {\n  analytics.track('hero_monitor_click', {\n    job_id: currentJobId.value || '',\n    overall_progress: overallProgressPercent.value,\n    is_mobile: isMobile.value,\n    drawer_active: mobileDrawerPanel.value === 'monitor'\n  });\n  if (isMobile.value) {\n    toggleMobileDrawer('monitor');\n    return;\n  }\n  const el = getComponentRootEl(monitorPanelRef.value);\n  if (el) {\n    scrollElementIntoView(el);\n  }\n}\n\nfunction toggleMobileDrawer(panel: DrawerPanel) {\n  if (!isMobile.value) return;\n  mobileDrawerPanel.value = mobileDrawerPanel.value === panel ? '' : panel;\n}\n\nfunction closeMobileDrawer() {\n  if (!mobileDrawerPanel.value) return;\n  mobileDrawerPanel.value = '';\n}\n\nconst overallProgress = computed(() =>\n  stageDefinitions.reduce((total, definition) => {\n    const state = stageStatus[definition.id].state;\n    if (state === 'done') {\n      return total + definition.weight;\n    }\n    if (state === 'active') {\n      return total + definition.weight * 0.5;\n    }\n    return total;\n  }, 0)\n);\n\nconst overallProgressPercent = computed(() => Math.round(overallProgress.value * 100));\nconst overallProgressLabel = computed(() => `${overallProgressPercent.value}%`);\n\nconst countdownVisible = computed(() => videoCountdown.active && videoCountdown.remaining > 0);\nconst countdownLabel = computed(() => formatDuration(videoCountdown.remaining));\nconst countdownSource = computed(() => videoCountdown.source);\nconst resultSectionWarning = computed(() => {\n  const jobId = currentJobId.value;\n  if (!jobId || taskStatus.value !== 'finished') return false;\n  const localPath = latestTaskSnapshot.value?.assets?.local_video_url;\n  if (!localPath) return true;\n  const expectedSuffix = `/output/${jobId}/digital_human.mp4`;\n  return !localPath.endsWith(expectedSuffix);\n});\n\nconst materialItems = computed<MaterialEntry[]>(() => {\n  if (!currentJobId.value) {\n    dashboardStore.clearError('material');\n    return [];\n  }\n  const jobId = currentJobId.value;\n  const snapshot = latestTaskSnapshot.value;\n  const assets = snapshot?.assets || {};\n  const items: MaterialEntry[] = [];\n  let hasPathError = false;\n\n  if (currentBucketDir.value) {\n    items.push({\n      id: 'dir-root',\n      label: '任务目录',\n      type: 'other',\n      localPath: currentBucketDir.value,\n      publicUrl: bucketPathToPublicUrl(currentBucketDir.value),\n      description: '桶内该任务的根目录'\n    });\n  }\n\n  const pushItem = (\n    idSuffix: string,\n    label: string,\n    type: MaterialEntry['type'],\n    rawPath?: string,\n    fallback?: string,\n    description?: string\n  ) => {\n    const { localPath, publicUrl } = normalizeMaterialPath(rawPath || fallback || '', jobId);\n    if (!localPath && !publicUrl) return;\n    if (localPath && !localPath.startsWith(bucketBasePath.value)) {\n      hasPathError = true;\n      return;\n    }\n    items.push({\n      id: `${type}-${idSuffix}`,\n      label,\n      type,\n      localPath,\n      publicUrl,\n      description\n    });\n  };\n\n  pushItem('avatar', '生成头像', 'avatar', assets.avatar_local_path || assets.avatar_path, avatarUrl.value);\n  pushItem(\n    'audio',\n    '语音合成',\n    'audio',\n    assets.audio_local_path || assets.audio_path || assets.local_audio_url,\n    audioUrl.value\n  );\n  const finalVideoPath =\n    assets.local_video_url || assets.video_local_path || assets.video_path || resultVideoUrl.value;\n  pushItem('video', '唇形视频', 'video', finalVideoPath, finalVideoPath);\n  const logPath = currentBucketDir.value ? `${currentBucketDir.value}/log.txt` : '';\n  if (logPath) {\n    pushItem('log', '任务日志', 'log', logPath, logPath, '记录 trace id 与成本');\n  }\n\n  if (hasPathError) {\n    dashboardStore.setError('material', '素材路径异常，请检查桶映射');\n  } else {\n    dashboardStore.clearError('material');\n  }\n  return items;\n});\n\nconst taskLogs = computed(() => {\n  const snapshotLogs = latestTaskSnapshot.value?.logs;\n  if (Array.isArray(snapshotLogs)) {\n    return snapshotLogs;\n  }\n  const jobId = currentJobId.value;\n  if (!jobId) return [];\n  const stored = dashboardStore.tasks.find((task) => task.id === jobId);\n  const fallbackLogs = (stored?.snapshot as TaskResponse | undefined)?.logs;\n  if (Array.isArray(fallbackLogs)) {\n    return fallbackLogs;\n  }\n  return [];\n});\n\nwatch(avatarMode, (mode) => {\n  if (mode === 'prompt') {\n    clearAvatarFile();\n    avatarFileError.value = '';\n  }\n  if (mode === 'character' && !selectedCharacterId.value && characters.value.length) {\n    selectedCharacterId.value = characters.value[0].id;\n  }\n});\n\nwatch(selectedCharacterId, (id) => {\n  const character = characters.value.find((item) => item.id === id) || null;\n  if (id) {\n    avatarMode.value = 'character';\n    clearAvatarFile();\n  }\n  if (character?.voice?.voice_id) {\n    voiceId.value = character.voice.voice_id;\n  }\n});\n\nwatch(\n  () => ({\n    id: dashboardStore.selectedTaskId,\n    revision: dashboardStore.selectionRevision\n  }),\n  ({ id, revision }) => {\n    if (revision === lastSelectionRevision.value && id === currentJobId.value) {\n      return;\n    }\n    lastSelectionRevision.value = revision;\n    stopPolling();\n    if (!id) {\n      currentJobId.value = null;\n      latestTaskSnapshot.value = null;\n      resetProgress('idle');\n      return;\n    }\n    currentJobId.value = id;\n    const stored = dashboardStore.tasks.find((task) => task.id === id);\n    if (stored?.snapshot) {\n      applyTask(stored.snapshot as TaskResponse, { silent: true });\n    }\n    const status = (stored?.snapshot as TaskResponse | undefined)?.status || '';\n    if (!status || (status !== 'finished' && status !== 'failed')) {\n      fetchTaskStatus();\n      startPolling();\n    }\n  },\n  { immediate: true }\n);\n\nwatch(\n  () => currentJobId.value,\n  () => {\n    syncCurrentJobMetadata();\n  }\n);\n\nwatch(\n  taskHistory,\n  () => {\n    syncCurrentJobMetadata();\n    scheduleAnalyticsHydration();\n    recomputeHistoricalStats();\n  },\n  { deep: true }\n);\n\nwatch(\n  () => historicalStats.secondsPerChar,\n  () => {\n    if (videoCountdown.active && latestTaskSnapshot.value?.status === 'video_rendering') {\n      startVideoCountdown(latestTaskSnapshot.value);\n    }\n  }\n);\n\nonMounted(() => {\n  if (dashboardStore.apiKey) {\n    scheduleBalanceRefresh(true);\n  }\n  fetchCharacters();\n  scheduleAnalyticsHydration();\n  recomputeHistoricalStats();\n  resetCompletedTaskSelection();\n});\n\nfunction saveApiKeySetting() {\n  if (!validateApiKey()) {\n    showToast('请检查 API Key 格式');\n    return;\n  }\n  const trimmed = apiKeyInput.value.trim();\n  dashboardStore.setApiKey(trimmed);\n  scheduleBalanceRefresh(true);\n  showToast('API Key 已保存');\n}\n\nfunction clearApiKeySetting() {\n  apiKeyInput.value = '';\n  dashboardStore.clearApiKey();\n  cancelBalanceRefreshTimer();\n  showToast('API Key 已清除');\n  balanceValue.value = null;\n  balanceTimestamp.value = null;\n  balanceError.value = '';\n  apiKeyError.value = '';\n  dashboardStore.clearError('apiKey');\n}\n\nfunction validateApiKey() {\n  const trimmed = apiKeyInput.value.trim();\n  if (!trimmed) {\n    apiKeyError.value = '';\n    dashboardStore.clearError('apiKey');\n    return false;\n  }\n  if (!API_KEY_PATTERN.test(trimmed)) {\n    apiKeyError.value = 'Key 不能为空';\n    dashboardStore.setError('apiKey', apiKeyError.value);\n    return false;\n  }\n  apiKeyError.value = '';\n  dashboardStore.clearError('apiKey');\n  return true;\n}\n\nfunction handleTaskSelection(taskId: string) {\n  if (taskId) {\n    dashboardStore.selectTask(taskId);\n  }\n}\n\nfunction togglePolling() {\n  if (pollingActive.value) {\n    stopPolling();\n  } else {\n    startPolling();\n  }\n}\n\nfunction refreshSelectedTask() {\n  fetchTaskStatus();\n}\n\nasync function refreshBalance() {\n  if (balanceLoading.value) {\n    return;\n  }\n  cancelBalanceRefreshTimer();\n  const key = apiKeyInput.value.trim() || dashboardStore.apiKey.trim();\n  if (!key) {\n    showToast('请先填写 Wavespeed API Key');\n    return;\n  }\n  balanceLoading.value = true;\n  balanceError.value = '';\n  try {\n    const response = await fetch(`${config.API_BASE}/api/wavespeed/balance`, {\n      method: 'POST',\n      headers: buildRequestHeaders({ 'Content-Type': 'application/json' }),\n      body: JSON.stringify({ wavespeed_api_key: key })\n    });\n    if (!response.ok) {\n      const error = await safeJson(response);\n      throw new Error(error.detail || '查询失败');\n    }\n    const result = await response.json();\n    balanceValue.value = typeof result.balance === 'number' ? Number(result.balance) : null;\n    balanceTimestamp.value = Date.now();\n    balanceError.value = '';\n    if (!dashboardStore.apiKey && key) {\n      dashboardStore.setApiKey(key);\n    }\n    if (balanceValue.value !== null) {\n      showToast(`余额 $${balanceValue.value.toFixed(2)}`);\n    }\n  } catch (err) {\n    balanceError.value = (err as Error).message || '查询失败';\n    showToast(balanceError.value);\n    dashboardStore.setError('apiKey', balanceError.value);\n  } finally {\n    if (!balanceError.value) {\n      dashboardStore.clearError('apiKey');\n    }\n    balanceLoading.value = false;\n  }\n}\n\nfunction removeTaskFromHistory(taskId: string) {\n  dashboardStore.removeTask(taskId);\n  if (dashboardStore.selectedTaskId === taskId) {\n    resetProgress('idle');\n  }\n}\n\nfunction showToast(message: string) {\n  toastMessage.value = message;\n  if (toastTimer.value) {\n    clearTimeout(toastTimer.value);\n  }\n  toastTimer.value = window.setTimeout(() => {\n    toastMessage.value = '';\n    toastTimer.value = null;\n  }, 4000);\n}\n\nasync function copyText(value: string, successMessage: string) {\n  if (!value) return;\n  try {\n    await navigator.clipboard.writeText(value);\n    showToast(successMessage);\n  } catch {\n    const input = document.createElement('textarea');\n    input.value = value;\n    input.style.position = 'fixed';\n    input.style.opacity = '0';\n    document.body.appendChild(input);\n    input.focus();\n    input.select();\n    try {\n      document.execCommand('copy');\n      showToast(successMessage);\n    } catch {\n      showFormAlert('复制失败，请手动复制');\n    } finally {\n      document.body.removeChild(input);\n    }\n  }\n}\n\nfunction copyLocalPath(path: string) {\n  if (!path) return;\n  copyText(path, '本地路径已复制');\n}\n\nfunction copyPublicLink(link: string) {\n  if (!link) return;\n  copyText(link, '公网链接已复制');\n}\n\nfunction openPublicLink(link: string) {\n  if (!link) return;\n  window.open(link, '_blank', 'noreferrer');\n}\n\nfunction formatTimestamp(timestamp: number) {\n  if (!timestamp) return '';\n  return new Date(timestamp).toLocaleString('zh-CN', {\n    hour12: false,\n    month: '2-digit',\n    day: '2-digit',\n    hour: '2-digit',\n    minute: '2-digit',\n    second: '2-digit'\n  });\n}\n\nfunction formatDuration(seconds: number) {\n  if (!Number.isFinite(seconds) || seconds <= 0) return '不到 1 秒';\n  const value = Math.max(0, Math.round(seconds));\n  const mins = Math.floor(value / 60);\n  const secs = value % 60;\n  if (!mins) {\n    return `${secs} 秒`;\n  }\n  return `${mins} 分 ${secs.toString().padStart(2, '0')} 秒`;\n}\n\nfunction extractTextLength(task?: TaskResponse | null) {\n  if (!task) return null;\n  const raw = (task.assets || {}).text_length ?? (task.assets || {}).speech_text_length;\n  const parsed = Number(raw);\n  if (Number.isFinite(parsed) && parsed > 0) {\n    return Math.round(parsed);\n  }\n  return null;\n}\n\nfunction describeStatus(status: string) {\n  const map: Record<string, string> = {\n    finished: '已完成',\n    failed: '失败',\n    running: '执行中',\n    created: '已创建',\n    idle: '待执行',\n    pending: '排队中'\n  };\n  return map[status] || status || '未知';\n}\n\nfunction buildRequestHeaders(extra: HeadersInit = {}) {\n  const headers: HeadersInit = { ...extra };\n  if (dashboardStore.apiKey) {\n    headers['X-API-Key'] = dashboardStore.apiKey;\n  }\n  return headers;\n}\n\nasync function handleSubmit() {\n  clearFormAlert();\n\n  if (avatarMode.value === 'prompt' && !avatarPrompt.value.trim()) {\n    return showFormAlert('请输入头像描述');\n  }\n\n  if (avatarMode.value === 'character' && !selectedCharacterId.value) {\n    return showFormAlert('请选择一个预制人物');\n  }\n\n  if (avatarMode.value === 'upload') {\n    const file = getSelectedAvatarFile();\n    if (!file) {\n      return showFormAlert('请上传头像图片');\n    }\n    const validationError = validateAvatarFile(file);\n    if (validationError) {\n      avatarFileError.value = validationError;\n      return showFormAlert(validationError);\n    }\n  }\n\n  const trimmedSpeech = speechText.value.trim();\n  if (!trimmedSpeech) {\n    return showFormAlert('请输入播报文本');\n  }\n\n  if (debugMode.value && trimmedSpeech.length > DEBUG_MAX_CHARS) {\n    return showFormAlert(`调试模式下最多输入 ${DEBUG_MAX_CHARS} 个字符。`);\n  }\n\n  let avatarUploadUrl: string | null = null;\n  if (avatarMode.value === 'upload') {\n    try {\n      const file = getSelectedAvatarFile();\n      if (!file) throw new Error('未选择头像文件');\n      const validationError = validateAvatarFile(file);\n      if (validationError) {\n        avatarFileError.value = validationError;\n        throw new Error(validationError);\n      }\n      avatarUploadUrl = await uploadAvatar(file);\n    } catch (err) {\n      return showFormAlert(`上传头像失败：${(err as Error).message}`);\n    }\n  }\n\n  let parsedSeed: number | undefined;\n  if (seed.value.trim()) {\n    const seedNumber = Number(seed.value.trim());\n    if (!Number.isInteger(seedNumber)) {\n      return showFormAlert('随机种子必须为整数，例如 42 或 1001。');\n    }\n    parsedSeed = seedNumber;\n  }\n\n  const payload: Record<string, any> = {\n    avatar_mode: avatarMode.value,\n    avatar_prompt: avatarMode.value === 'prompt' ? avatarPrompt.value.trim() : null,\n    avatar_upload_url: avatarUploadUrl,\n    speech_text: trimmedSpeech,\n    voice_id: voiceId.value,\n    resolution: resolution.value,\n    speed: speed.value,\n    pitch: pitch.value,\n    emotion: emotion.value,\n    debug_mode: debugMode.value\n  };\n\n  if (typeof parsedSeed === 'number') {\n    payload.seed = parsedSeed;\n  }\n  if (avatarMode.value === 'character' && selectedCharacterId.value) {\n    payload.character_id = selectedCharacterId.value;\n  }\n\n  try {\n    submitting.value = true;\n    taskStatus.value = 'running';\n    statusMessage.value = '⏳ 正在创建任务...';\n\n    const response = await fetch(`${config.API_BASE}/api/tasks`, {\n      method: 'POST',\n      headers: buildRequestHeaders({ 'Content-Type': 'application/json' }),\n      body: JSON.stringify(payload)\n    });\n\n    if (!response.ok) {\n      const error = await safeJson(response);\n      showErrorDialog('创建任务失败', error);\n      throw new Error(error.detail || '创建任务失败');\n    }\n\n    const result = await response.json();\n    const jobId = result.job_id || result.task_id;\n    currentJobId.value = jobId;\n    dashboardStore.selectTask(jobId);\n    const now = Date.now();\n    const textLength = trimmedSpeech.length;\n    const initialSnapshot: TaskResponse = {\n      status: 'created',\n      message: '任务已创建，正在调度...',\n      cost_estimate: result.cost_estimate,\n      assets: {\n        ...(result.assets || {}),\n        text_length: textLength\n      }\n    };\n    latestTaskSnapshot.value = initialSnapshot;\n    dashboardStore.upsertTask({\n      id: jobId,\n      status: 'created',\n      message: '任务已创建，正在调度...',\n      createdAt: now,\n      updatedAt: now,\n      costEstimate: extractCostValue(result.cost_estimate),\n      assets: initialSnapshot.assets,\n      snapshot: initialSnapshot,\n      textLength\n    });\n    currentJobTextLength.value = textLength;\n    statusMessage.value = '任务已创建，正在调度...';\n    resetProgress('running');\n    updateCostEstimate(result.cost_estimate, '来自任务创建的初步估算。');\n    startPolling();\n    dashboardStore.clearError('tasks');\n  } catch (err) {\n    showFormAlert((err as Error).message || '未知错误');\n    dashboardStore.setError('tasks', (err as Error).message || '创建任务失败');\n    taskStatus.value = 'idle';\n  } finally {\n    submitting.value = false;\n  }\n}\n\nasync function uploadAvatar(file: File) {\n  const formData = new FormData();\n  formData.append('file', file);\n  const response = await fetch(`${config.API_BASE}/api/assets/upload`, {\n    method: 'POST',\n    headers: buildRequestHeaders(),\n    body: formData\n  });\n\n  if (!response.ok) {\n    const error = await safeJson(response);\n    throw new Error(error.detail || '上传失败');\n  }\n\n  const result = await response.json();\n  return result.url;\n}\n\nasync function fetchCharacters() {\n  characterLoading.value = true;\n  characterError.value = '';\n  try {\n    const response = await fetch(`${config.API_BASE}/api/characters`, {\n      headers: buildRequestHeaders()\n    });\n    if (!response.ok) {\n      const error = await safeJson(response);\n      throw new Error(error.detail || '加载角色失败');\n    }\n    characters.value = await response.json();\n    applyDefaultCharacterSelection(characters.value);\n  } catch (err) {\n    characterError.value = (err as Error).message;\n    characters.value = [];\n    selectedCharacterId.value = '';\n  } finally {\n    characterLoading.value = false;\n  }\n}\n\nfunction refreshCharacters() {\n  fetchCharacters();\n}\nfunction resetCompletedTaskSelection() {\n  const selectedId = dashboardStore.selectedTaskId;\n  if (!selectedId) return;\n  const task = dashboardStore.tasks.find((item) => item.id === selectedId);\n  if (!task || task.status === 'finished' || task.status === 'failed') {\n    dashboardStore.selectTask(null);\n  }\n}\n\nfunction clearCharacterSelection() {\n  selectedCharacterId.value = '';\n}\n\nfunction handleNewCharacterFile(event: Event) {\n  const target = event.target as HTMLInputElement;\n  const file = target.files?.[0];\n  if (!file) {\n    newCharacterFile.value = null;\n    return;\n  }\n  if (file.size > MAX_CHARACTER_IMAGE_SIZE) {\n    newCharacterAlert.message = '角色图片需小于 10MB';\n    newCharacterAlert.type = 'error';\n    newCharacterFile.value = null;\n    return;\n  }\n  newCharacterAlert.message = '';\n  newCharacterAlert.type = '';\n  newCharacterFile.value = file;\n}\n\nfunction resetNewCharacterForm() {\n  newCharacterForm.name = '';\n  newCharacterForm.appearanceZh = '';\n  newCharacterForm.appearanceEn = '';\n  newCharacterForm.voiceZh = '';\n  newCharacterForm.voicePrompt = '';\n  newCharacterForm.voiceId = '';\n  newCharacterFile.value = null;\n}\n\nasync function submitNewCharacter() {\n  if (!newCharacterForm.name.trim() || !newCharacterForm.appearanceZh.trim()) {\n    newCharacterAlert.message = '名称与中文描述为必填项';\n    newCharacterAlert.type = 'error';\n    return;\n  }\n  if (!newCharacterFile.value) {\n    newCharacterAlert.message = '请上传人物图片';\n    newCharacterAlert.type = 'error';\n    return;\n  }\n  const formData = new FormData();\n  formData.append('name', newCharacterForm.name.trim());\n  formData.append('appearance_zh', newCharacterForm.appearanceZh.trim());\n  if (newCharacterForm.appearanceEn.trim()) {\n    formData.append('appearance_en', newCharacterForm.appearanceEn.trim());\n  }\n  if (newCharacterForm.voiceZh.trim()) {\n    formData.append('voice_zh', newCharacterForm.voiceZh.trim());\n  }\n  if (newCharacterForm.voicePrompt.trim()) {\n    formData.append('voice_prompt', newCharacterForm.voicePrompt.trim());\n  }\n  if (newCharacterForm.voiceId.trim()) {\n    formData.append('voice_id', newCharacterForm.voiceId.trim());\n  }\n  formData.append('file', newCharacterFile.value);\n\n  try {\n    creatingCharacter.value = true;\n    const response = await fetch(`${config.API_BASE}/api/characters`, {\n      method: 'POST',\n      headers: buildRequestHeaders(),\n      body: formData\n    });\n    if (!response.ok) {\n      const error = await safeJson(response);\n      throw new Error(error.detail || '上传失败');\n    }\n    const record: CharacterRecord = await response.json();\n    newCharacterAlert.message = '角色上传成功';\n    newCharacterAlert.type = 'success';\n    await fetchCharacters();\n    selectedCharacterId.value = record.id;\n    resetNewCharacterForm();\n  } catch (err) {\n    newCharacterAlert.message = (err as Error).message;\n    newCharacterAlert.type = 'error';\n  } finally {\n    creatingCharacter.value = false;\n  }\n}\n\nfunction applyDefaultCharacterSelection(list: CharacterRecord[]) {\n  if (!list.length) {\n    selectedCharacterId.value = '';\n    return;\n  }\n  if (selectedCharacterId.value && list.some((item) => item.id === selectedCharacterId.value)) {\n    return;\n  }\n  const preferred = list.find((item) => item.id === DEFAULT_CHARACTER_ID);\n  selectedCharacterId.value = (preferred || list[0]).id;\n}\n\nfunction buildCharacterImageUrl(record: CharacterRecord | null): string {\n  if (!record || !record.image_url) return '';\n  if (record.image_url.startsWith('http')) return record.image_url;\n  return `${config.API_BASE}${record.image_url}`;\n}\n\nfunction startPolling() {\n  if (!currentJobId.value) return;\n  stopPolling();\n  fetchTaskStatus();\n  pollTimer.value = window.setInterval(fetchTaskStatus, config.POLL_INTERVAL);\n}\n\nfunction stopPolling() {\n  if (pollTimer.value) {\n    clearInterval(pollTimer.value);\n    pollTimer.value = null;\n  }\n}\n\nasync function fetchTaskStatus() {\n  if (!currentJobId.value) return;\n  try {\n    const response = await fetch(`${config.API_BASE}/api/tasks/${currentJobId.value}`, {\n      headers: buildRequestHeaders()\n    });\n    if (!response.ok) {\n      const error = await safeJson(response);\n      showErrorDialog('查询任务失败', error);\n      throw new Error(error.detail || '查询任务失败');\n    }\n    const task: TaskResponse = await response.json();\n    applyTask(task);\n    dashboardStore.clearError('progress');\n  } catch (err) {\n    console.error('轮询错误:', err);\n    dashboardStore.setError('progress', (err as Error).message || '轮询失败');\n  }\n}\n\nfunction applyTask(task: TaskResponse, options: { silent?: boolean } = {}) {\n  latestTaskSnapshot.value = task;\n  const jobId = task.job_id || currentJobId.value;\n  const detectedTextLength = extractTextLength(task);\n  if (detectedTextLength && jobId && jobId === currentJobId.value) {\n    currentJobTextLength.value = detectedTextLength;\n  }\n  if (task.status === 'video_rendering') {\n    startVideoCountdown(task);\n  } else {\n    stopVideoCountdown();\n  }\n  statusMessage.value = task.message || task.status || '执行中';\n  billingInfo.value = task.billing || null;\n  updateStages(task);\n  updateCostEstimate(task.cost_estimate, '执行中估算（含头像/语音/视频）。');\n  if (task.avatar_url) {\n    avatarUrl.value = task.avatar_url;\n  }\n  if (task.audio_url) {\n    audioUrl.value = task.audio_url;\n  }\n  const resolvedVideo = resolveVideoUrl(task);\n  if (resolvedVideo && task.status !== 'failed') {\n    resultVideoUrl.value = resolvedVideo;\n  }\n\n  if (!options.silent) {\n    trackTaskHistory(task);\n  }\n\n  if (task.status === 'finished' || task.status === 'failed') {\n    stopPolling();\n    handleCompletion(task);\n    if (task.status === 'finished' && jobId) {\n      void hydrateTaskAnalytics(jobId, task);\n    }\n  }\n}\n\nfunction trackTaskHistory(task: TaskResponse) {\n  if (!currentJobId.value) return;\n  const now = Date.now();\n  const existing = dashboardStore.tasks.find((item) => item.id === currentJobId.value);\n  const resolvedTextLength = extractTextLength(task) ?? existing?.textLength ?? currentJobTextLength.value ?? undefined;\n  dashboardStore.upsertTask({\n    id: currentJobId.value,\n    status: task.status || existing?.status || 'running',\n    message: task.message || existing?.message || '',\n    createdAt: existing?.createdAt || now,\n    updatedAt: now,\n    costEstimate: extractCostValue(task.cost_estimate) ?? existing?.costEstimate,\n    assets: task.assets || existing?.assets,\n    snapshot: task,\n    textLength: resolvedTextLength,\n    analytics: existing?.analytics\n  });\n}\n\nfunction updateStages(task: TaskResponse) {\n  const status = task.status || '';\n  const finished = status === 'finished';\n  const failed = status === 'failed';\n  const activeStage = inferStageFromStatus(status);\n\n  stageDefinitions.forEach((definition, index) => {\n    const current = stageStatus[definition.id];\n    const doneByAsset = isStageAssetReady(definition.id, task);\n\n    if (finished || doneByAsset) {\n      current.state = 'done';\n      current.description = '已完成';\n      return;\n    }\n\n    if (failed && activeStage === definition.id) {\n      current.state = 'failed';\n      current.description = task.message || stageActiveDescription(definition.id);\n      return;\n    }\n\n    if (activeStage) {\n      const activeIndex = stageDefinitions.findIndex((item) => item.id === activeStage);\n      if (index < activeIndex) {\n        current.state = 'done';\n        current.description = '已完成';\n      } else if (index === activeIndex) {\n        current.state = 'active';\n        current.description = stageActiveDescription(definition.id);\n      } else {\n        current.state = 'pending';\n        current.description = '等待调度';\n      }\n      return;\n    }\n\n    current.state = 'pending';\n    current.description = '等待调度';\n  });\n}\n\nfunction resolveVideoUrl(task: TaskResponse) {\n  if (task.assets?.local_video_url) {\n    return task.assets.local_video_url;\n  }\n  if (task.video_url) {\n    return task.video_url;\n  }\n  if (task.assets?.video_url) {\n    return task.assets.video_url;\n  }\n  return '';\n}\n\nfunction inferStageFromStatus(status: string | undefined | null): StageKey | null {\n  if (!status) return null;\n  if (status.includes('video')) return 'video';\n  if (status.includes('speech')) return 'speech';\n  if (status.includes('avatar')) return 'avatar';\n  return null;\n}\n\nfunction isStageAssetReady(stage: StageKey, task: TaskResponse) {\n  if (stage === 'avatar') {\n    return Boolean(task.avatar_url || task.assets?.avatar_local_path);\n  }\n  if (stage === 'speech') {\n    return Boolean(task.audio_url || task.assets?.audio_local_path || task.assets?.local_audio_url);\n  }\n  if (stage === 'video') {\n    return Boolean(resolveVideoUrl(task));\n  }\n  return false;\n}\n\nfunction stageActiveDescription(stage: StageKey) {\n  if (stage === 'avatar') return '头像生成中';\n  if (stage === 'speech') return '语音合成中';\n  return '唇形渲染中';\n}\n\nfunction normalizeMaterialPath(raw: string, jobId?: string) {\n  if (!raw) {\n    return { localPath: '', publicUrl: '' };\n  }\n  const trimmed = raw.trim();\n  if (!trimmed) {\n    return { localPath: '', publicUrl: '' };\n  }\n  if (trimmed.startsWith('http://') || trimmed.startsWith('https://')) {\n    return { localPath: '', publicUrl: trimmed };\n  }\n  if (trimmed.startsWith('/mnt/www')) {\n    return { localPath: trimmed, publicUrl: bucketPathToPublicUrl(trimmed) };\n  }\n  const normalizedJobId = jobId || currentJobId.value || '';\n  let relative = trimmed.replace(/^\\.\\/?/, '');\n  if (relative.startsWith('/')) {\n    relative = relative.slice(1);\n  }\n  if (relative.startsWith('output/')) {\n    const localPath = `${bucketBasePath.value}/${relative}`.replace(/\\\\/g, '/');\n    return { localPath, publicUrl: bucketPathToPublicUrl(localPath) };\n  }\n  const suffix = normalizedJobId ? `${normalizedJobId}/${relative}` : relative;\n  const localPath = `${bucketBasePath.value}/${suffix}`.replace(/\\\\/g, '/');\n  return { localPath, publicUrl: bucketPathToPublicUrl(localPath) };\n}\n\nfunction bucketPathToPublicUrl(localPath: string) {\n  if (!localPath) return '';\n  if (localPath.startsWith('http://') || localPath.startsWith('https://')) {\n    return localPath;\n  }\n  if (!localPath.startsWith('/mnt/www')) {\n    return '';\n  }\n  const relative = localPath.replace(/^\\/mnt\\/www\\/?/, '');\n  try {\n    const url = new URL(`${BUCKET_PUBLIC_BASE.replace(/\\/$/, '')}/${relative}`);\n    return url.toString();\n  } catch {\n    return `${BUCKET_PUBLIC_BASE}/${relative}`;\n  }\n}\n\nfunction syncCurrentJobMetadata() {\n  if (!currentJobId.value) {\n    currentJobTextLength.value = null;\n    stopVideoCountdown();\n    return;\n  }\n  const entry = dashboardStore.tasks.find((task) => task.id === currentJobId.value);\n  const snapshot = (entry?.snapshot as TaskResponse | undefined) || latestTaskSnapshot.value;\n  const length = entry?.textLength ?? extractTextLength(snapshot);\n  currentJobTextLength.value = length ?? null;\n  if (entry && length && entry.textLength !== length) {\n    dashboardStore.upsertTask({ ...entry, textLength: length, updatedAt: entry.updatedAt ?? Date.now() });\n  }\n}\n\nfunction startVideoCountdown(task?: TaskResponse | null) {\n  if (!currentJobId.value) return;\n  const textLength = currentJobTextLength.value || extractTextLength(task) || null;\n  if (!textLength) {\n    stopVideoCountdown();\n    return;\n  }\n  const secondsPerChar = resolveSecondsPerChar();\n  const estimatedTotal = Math.max(Math.round(textLength * secondsPerChar), 5);\n  const stageStart = resolveVideoStageStart(task) ?? videoStageStartAt.value ?? Date.now();\n  videoStageStartAt.value = stageStart;\n  videoCountdown.total = estimatedTotal;\n  videoCountdown.active = true;\n  videoCountdown.source =\n    historicalStats.sampleSize > 0\n      ? `基于 ${historicalStats.sampleSize} 个历史样本`\n      : '经验估算';\n  videoCountdown.samples = historicalStats.sampleSize;\n  updateVideoCountdownRemaining();\n  if (!videoCountdownTimer.value) {\n    videoCountdownTimer.value = window.setInterval(updateVideoCountdownRemaining, 1000);\n  }\n}\n\nfunction stopVideoCountdown() {\n  videoCountdown.active = false;\n  videoCountdown.remaining = 0;\n  videoStageStartAt.value = null;\n  if (videoCountdownTimer.value) {\n    clearInterval(videoCountdownTimer.value);\n    videoCountdownTimer.value = null;\n  }\n}\n\nfunction updateVideoCountdownRemaining() {\n  if (!videoCountdown.active || videoStageStartAt.value === null) {\n    videoCountdown.remaining = 0;\n    return;\n  }\n  const elapsed = (Date.now() - videoStageStartAt.value) / 1000;\n  const remaining = Math.max(videoCountdown.total - elapsed, 0);\n  videoCountdown.remaining = remaining;\n  if (remaining <= 0.1) {\n    stopVideoCountdown();\n  }\n}\n\nfunction resolveVideoStageStart(task?: TaskResponse | null) {\n  if (!task) return null;\n  const iso = (task.assets || {}).video_stage_started_at;\n  if (typeof iso === 'string') {\n    const parsed = Date.parse(iso);\n    if (!Number.isNaN(parsed)) {\n      return parsed;\n    }\n  }\n  return null;\n}\n\nfunction resolveSecondsPerChar() {\n  if (historicalStats.secondsPerChar > 0) {\n    return historicalStats.secondsPerChar;\n  }\n  return DEFAULT_VIDEO_SECONDS_PER_CHAR;\n}\n\nfunction scheduleAnalyticsHydration() {\n  void hydrateFinishedTaskAnalytics();\n}\n\nasync function hydrateFinishedTaskAnalytics() {\n  if (analyticsHydrationRunning) return;\n  analyticsHydrationRunning = true;\n  try {\n    const finished = dashboardStore.tasks.filter((task) => task.status === 'finished');\n    for (const entry of finished) {\n      await hydrateTaskAnalytics(entry.id, entry.snapshot as TaskResponse | undefined);\n    }\n    recomputeHistoricalStats();\n  } finally {\n    analyticsHydrationRunning = false;\n  }\n}\n\nasync function hydrateTaskAnalytics(jobId: string, snapshot?: TaskResponse) {\n  if (processedAnalytics.has(jobId)) return;\n  const entry = dashboardStore.tasks.find((task) => task.id === jobId);\n  if (!entry) return;\n  if (entry.analytics?.perCharSeconds && entry.textLength) {\n    processedAnalytics.add(jobId);\n    return;\n  }\n  const textLength = entry.textLength ?? extractTextLength(snapshot);\n  if (!textLength) return;\n  let seconds = snapshot?.assets?.video_stage_seconds;\n  if (seconds == null) {\n    seconds = await fetchVideoStageSecondsFromLog(jobId);\n    if (seconds == null && typeof snapshot?.duration === 'number') {\n      seconds = snapshot.duration;\n    }\n  }\n  if (seconds == null || seconds <= 0) return;\n  const analytics = {\n    textLength,\n    videoStageSeconds: seconds,\n    perCharSeconds: seconds / textLength\n  };\n  const updatedAt = entry.updatedAt || Date.now();\n  dashboardStore.upsertTask({ ...entry, analytics, textLength, updatedAt });\n  processedAnalytics.add(jobId);\n}\n\nasync function fetchVideoStageSecondsFromLog(jobId: string) {\n  if (!jobId) return null;\n  try {\n    const response = await fetch(`${config.API_BASE}/output/${jobId}/log.txt`);\n    if (!response.ok) {\n      return null;\n    }\n    const text = await response.text();\n    return parseVideoStageDuration(text);\n  } catch {\n    return null;\n  }\n}\n\nfunction parseVideoStageDuration(logText: string) {\n  if (!logText) return null;\n  const lines = logText.split(/\\r?\\n/);\n  const regex = /^\\[(?<time>[^\\]]+)\\]\\s+\\[[^\\]]+\\](?:\\s+\\[[^\\]]+\\])?\\s+(?<message>.*)$/;\n  let start: number | null = null;\n  for (const line of lines) {\n    const match = regex.exec(line.trim());\n    if (!match || !match.groups) continue;\n    const { time, message } = match.groups;\n    if (!time || !message) continue;\n    if (start === null && message.includes('正在生成数字人视频')) {\n      const parsed = Date.parse(time);\n      if (!Number.isNaN(parsed)) {\n        start = parsed;\n      }\n      continue;\n    }\n    if (start !== null && message.includes('数字人视频生成完成')) {\n      const end = Date.parse(time);\n      if (!Number.isNaN(end)) {\n        return Math.max((end - start) / 1000, 0);\n      }\n    }\n  }\n  return null;\n}\n\nfunction recomputeHistoricalStats() {\n  const samples = dashboardStore.tasks\n    .map((task) => task.analytics?.perCharSeconds)\n    .filter((value): value is number => typeof value === 'number' && Number.isFinite(value) && value > 0);\n  if (!samples.length) {\n    historicalStats.secondsPerChar = 0;\n    historicalStats.sampleSize = 0;\n    return;\n  }\n  const avg = samples.reduce((sum, item) => sum + item, 0) / samples.length;\n  historicalStats.secondsPerChar = avg;\n  historicalStats.sampleSize = samples.length;\n}\n\nfunction formatBalance(value?: number | null) {\n  if (typeof value !== 'number' || Number.isNaN(value)) {\n    return '';\n  }\n  return `$${value.toFixed(2)}`;\n}\n\nfunction handleCompletion(task: TaskResponse) {\n  if (task.status === 'finished') {\n    taskStatus.value = 'finished';\n    resultVideoUrl.value = resolveVideoUrl(task);\n    totalCost.value = resolveActualCost(task);\n    statusMessage.value = '✅ 数字人视频生成完成！';\n  } else {\n    taskStatus.value = 'failed';\n    errorMessage.value = task.message || '任务执行失败';\n    showErrorDialog('任务执行失败', task);\n  }\n}\n\nfunction resolveActualCost(task: TaskResponse) {\n  if (typeof task.billing?.actual_cost === 'number') {\n    return task.billing.actual_cost;\n  }\n  if (typeof task.cost === 'number') {\n    return task.cost;\n  }\n  const extracted = extractCostValue(task.cost_estimate);\n  if (typeof extracted === 'number') {\n    return extracted;\n  }\n  return estimatedCost.value;\n}\n\nfunction resetProgress(state: 'idle' | 'running' = 'running') {\n  stageDefinitions.forEach((definition) => {\n    stageStatus[definition.id].state = 'pending';\n    stageStatus[definition.id].description = '等待调度';\n  });\n  taskStatus.value = state;\n  avatarUrl.value = '';\n  audioUrl.value = '';\n  resultVideoUrl.value = '';\n  totalCost.value = 0;\n  billingInfo.value = null;\n  errorMessage.value = '';\n  costEstimateValue.value = null;\n  costEstimateDesc.value = '';\n  dashboardStore.clearError('progress');\n}\n\nfunction updateCostEstimate(value: TaskResponse['cost_estimate'], fallbackDesc = '') {\n  if (typeof value === 'number') {\n    costEstimateValue.value = value;\n    costEstimateDesc.value = fallbackDesc;\n    return;\n  }\n\n  if (value) {\n    const total = extractCostValue(value);\n    costEstimateValue.value = typeof total === 'number' ? Number(total) : null;\n    const parts = [\n      value.avatar ? `头像 $${value.avatar.toFixed(2)}` : null,\n      value.speech ? `语音 $${value.speech.toFixed(2)}` : null,\n      value.video ? `视频 $${value.video.toFixed(2)}` : null\n    ]\n      .filter(Boolean)\n      .join(' / ');\n    costEstimateDesc.value = parts || fallbackDesc;\n    return;\n  }\n\n  costEstimateValue.value = null;\n  costEstimateDesc.value = '';\n}\n\nfunction extractCostValue(value: TaskResponse['cost_estimate']) {\n  if (typeof value === 'number') {\n    return value;\n  }\n  if (value) {\n    return value.total ?? (value.avatar ?? 0) + (value.speech ?? 0) + (value.video ?? 0);\n  }\n  return undefined;\n}\n\nfunction stageStateIcon(stage: StageKey) {\n  const state = stageStatus[stage].state;\n  if (state === 'done') return '✅';\n  if (state === 'active') return '⚙️';\n  if (state === 'failed') return '⚠️';\n  return '⏳';\n}\n\nfunction downloadVideo() {\n  if (!resultVideoUrl.value) return;\n  const link = document.createElement('a');\n  link.href = resultVideoUrl.value;\n  link.download = `digital_human_${currentJobId.value ?? ''}.mp4`;\n  link.click();\n}\n\nasync function copyVideoLink() {\n  if (!resultVideoUrl.value) return;\n  try {\n    await navigator.clipboard.writeText(resultVideoUrl.value);\n    showFormAlert('链接已复制到剪贴板', 'info');\n  } catch {\n    showFormAlert('复制失败，请手动复制链接');\n  }\n}\n\nfunction showFormAlert(message: string, type: 'info' | 'error' = 'error') {\n  formAlert.message = message;\n  formAlert.type = type;\n}\n\nfunction clearFormAlert() {\n  formAlert.message = '';\n  formAlert.type = '';\n}\n\nfunction showErrorDialog(title: string, payload: { detail?: string; error_code?: string; trace_id?: string }) {\n  errorDialogTitle.value = title;\n  errorDialogMessage.value = payload.detail || '';\n  const meta = [\n    payload.error_code ? `错误码: ${payload.error_code}` : null,\n    payload.trace_id ? `Trace ID: ${payload.trace_id}` : null\n  ]\n    .filter(Boolean)\n    .join('\\n');\n  errorDialogDetail.value = meta || '暂无更多信息';\n  errorDialogVisible.value = true;\n}\n\nfunction closeErrorDialog() {\n  errorDialogVisible.value = false;\n  errorDialogTitle.value = '';\n  errorDialogMessage.value = '';\n  errorDialogDetail.value = '';\n}\n\nasync function safeJson(response: Response) {\n  try {\n    return await response.json();\n  } catch {\n    const status = response.status || 0;\n    const text = (response.statusText || '').trim();\n    if (status && text) {\n      return { detail: `HTTP ${status} ${text}` };\n    }\n    if (status) {\n      return { detail: `HTTP ${status}` };\n    }\n    return { detail: text || '未知错误' };\n  }\n}\n\nfunction getSelectedAvatarFile() {\n  return avatarFile.value;\n}\n\nfunction validateAvatarFile(file: File) {\n  if (!file.type.startsWith('image/')) {\n    return '仅支持 PNG/JPG 等图片格式';\n  }\n  if (file.size > MAX_AVATAR_SIZE) {\n    return '头像文件不能超过 5MB';\n  }\n  return null;\n}\n\nfunction handleAvatarFiles(files: Array<{ file?: File }>) {\n  if (!files.length) {\n    avatarFile.value = null;\n    avatarFileError.value = '';\n    return;\n  }\n  const file = files[0].file ?? null;\n  if (!file) {\n    avatarFile.value = null;\n    return;\n  }\n  const validationError = validateAvatarFile(file);\n  if (validationError) {\n    avatarFileError.value = validationError;\n    avatarFile.value = null;\n    return;\n  }\n  avatarFileError.value = '';\n  avatarFile.value = file;\n}\n\nfunction clearAvatarFile() {\n  avatarFile.value = null;\n  avatarFileError.value = '';\n  creationPanelRef.value?.clearAvatarUpload?.();\n}\n\nonBeforeUnmount(() => {\n  stopPolling();\n  if (typeof document !== 'undefined') {\n    document.body.classList.remove('drawer-lock');\n  }\n  cancelBalanceRefreshTimer();\n});\n</script>\n\n<style scoped>\n.hero {\n  background: linear-gradient(135deg, rgba(15, 23, 42, 0.95), rgba(5, 150, 105, 0.35));\n  border-radius: 32px;\n  border: 1px solid rgba(16, 185, 129, 0.25);\n  padding: 2rem;\n  display: flex;\n  flex-direction: column;\n  gap: 1.5rem;\n  box-shadow: 0 25px 50px rgba(2, 6, 23, 0.45);\n}\n\n.hero-main {\n  display: flex;\n  justify-content: space-between;\n  gap: 1.25rem;\n  flex-wrap: wrap;\n  text-align: left;\n}\n\n.hero-title h1 {\n  margin: 0.25rem 0;\n  font-size: clamp(2rem, 4vw, 2.75rem);\n}\n\n.hero-eyebrow {\n  margin: 0;\n  color: rgba(226, 232, 240, 0.8);\n  letter-spacing: 0.12em;\n  text-transform: uppercase;\n  font-size: 0.8rem;\n}\n\n.hero-subtitle {\n  margin: 0.25rem 0 0;\n  color: rgba(226, 232, 240, 0.78);\n}"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:35:59.816Z",
          "resultDisplay": "Read lines 1-2000 of 2592 from frontend/src/App.vue",
          "displayName": "ReadFile",
          "description": "Reads and returns the content of a specified file. If the file is large, the content will be truncated. The tool's response will clearly indicate if truncation has occurred and will provide details on how to read more of the file using the 'offset' and 'limit' parameters. Handles text, images (PNG, JPG, GIF, WEBP, SVG, BMP), audio files (MP3, WAV, AIFF, AAC, OGG, FLAC), and PDF files. For text files, it can read specific line ranges.",
          "renderOutputAsMarkdown": true
        }
      ]
    },
    {
      "id": "f7528728-043e-49e8-8d51-58f68590d3c0",
      "timestamp": "2026-01-03T08:36:04.691Z",
      "type": "gemini",
      "content": "",
      "toolCalls": [
        {
          "id": "read_file-1767429364669-e9be3babcd1ff",
          "name": "read_file",
          "args": {
            "file_path": "frontend/src/App.vue",
            "offset": 2000
          },
          "result": [
            {
              "functionResponse": {
                "id": "read_file-1767429364669-e9be3babcd1ff",
                "name": "read_file",
                "response": {
                  "output": "\nIMPORTANT: The file content has been truncated.\nStatus: Showing lines 2001-2592 of 2592 total lines.\nAction: To read more of the file, you can use the 'offset' and 'limit' parameters in a subsequent 'read_file' call. For example, to read the next section of the file, use offset: 2592.\n\n--- FILE CONTENT (truncated) ---\n\n.hero-cta {\n  display: flex;\n  flex-direction: column;\n  gap: 0.65rem;\n  align-items: flex-end;\n  justify-content: center;\n}\n\n.hero-cta__primary,\n.hero-cta__ghost {\n  border: none;\n  border-radius: 999px;\n  padding: 0.8rem 1.75rem;\n  font-size: 1rem;\n  font-weight: 600;\n  cursor: pointer;\n  transition: transform 0.2s ease, box-shadow 0.2s ease;\n}\n\n.hero-cta__primary {\n  background: linear-gradient(120deg, #22d3ee, #0ea5e9);\n  color: #0f172a;\n  box-shadow: 0 15px 35px rgba(14, 165, 233, 0.45);\n}\n\n.hero-cta__primary:disabled {\n  opacity: 0.6;\n  cursor: not-allowed;\n  box-shadow: none;\n}\n\n.hero-cta__ghost {\n  background: transparent;\n  color: #e2e8f0;\n  border: 1px solid rgba(226, 232, 240, 0.35);\n}\n\n.hero-cta__hint {\n  margin: 0;\n  font-size: 0.9rem;\n  color: rgba(248, 250, 252, 0.85);\n}\n\n.hero--minimal {\n  padding-bottom: 1.75rem;\n}\n\n@media (max-width: 768px) {\n  .hero {\n    padding: 1.5rem;\n  }\n\n  .hero-main {\n    flex-direction: column;\n  }\n\n  .hero-cta {\n    width: 100%;\n    align-items: stretch;\n  }\n\n  .hero-cta__primary,\n  .hero-cta__ghost {\n    width: 100%;\n    text-align: center;\n  }\n}\n\n.workspace {\n  --workspace-gap: 1.5rem;\n  --workspace-left: minmax(240px, 1fr);\n  --workspace-center: minmax(420px, 1.8fr);\n  --workspace-right: minmax(320px, 1.2fr);\n  display: grid;\n  grid-template-columns: var(--workspace-left) var(--workspace-center) var(--workspace-right);\n  gap: var(--workspace-gap);\n  align-items: start;\n  margin-top: 1.5rem;\n}\n\n.workspace__column {\n  display: flex;\n  flex-direction: column;\n  gap: var(--workspace-gap);\n}\n\n.workspace__column--output {\n  position: relative;\n}\n\n.workspace__column--system {\n  position: sticky;\n  top: 1rem;\n}\n\n@media (max-width: 1400px) {\n  .workspace {\n    grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);\n  }\n\n  .workspace__column--system {\n    grid-column: 1 / 2;\n  }\n\n  .workspace__column--input {\n    grid-column: 2 / 3;\n  }\n\n  .workspace__column--output {\n    grid-column: 1 / -1;\n  }\n}\n\n@media (max-width: 1024px) {\n  .workspace {\n    grid-template-columns: 1fr;\n  }\n\n  .workspace__column--system,\n  .workspace__column--input,\n  .workspace__column--output {\n    order: 1;\n  }\n\n  .workspace__column--input {\n    order: 2;\n  }\n\n  .workspace__column--output {\n    order: 3;\n  }\n}\n\n.status-message {\n  margin-top: 0.75rem;\n  font-size: 1rem;\n  font-weight: 600;\n  color: #0f172a;\n}\n\n.progress-headline {\n  display: flex;\n  flex-direction: column;\n  gap: 0.5rem;\n}\n\n.progress-meter {\n  position: relative;\n  width: 100%;\n  background: rgba(15, 23, 42, 0.15);\n  border-radius: 999px;\n  padding: 0.35rem;\n  overflow: hidden;\n  border: 1px solid rgba(15, 23, 42, 0.25);\n}\n\n.progress-meter__fill {\n  height: 8px;\n  border-radius: 999px;\n  background: linear-gradient(90deg, #34d399, #0ea5e9);\n  transition: width 0.3s ease;\n}\n\n.progress-meter__label {\n  position: absolute;\n  right: 0.75rem;\n  top: 50%;\n  transform: translateY(-50%);\n  font-size: 0.85rem;\n  color: #0f172a;\n  font-weight: 600;\n}\n\n.stage-pipeline {\n  list-style: none;\n  padding: 0;\n  margin: 0.5rem 0 0;\n  display: flex;\n  flex-direction: column;\n  gap: 0.85rem;\n}\n\n.stage-pipeline .stage {\n  display: flex;\n  gap: 0.75rem;\n  align-items: center;\n  padding: 0.6rem;\n  border-radius: 12px;\n  border: 1px dashed rgba(148, 163, 184, 0.3);\n  transition: border-color 0.2s ease, background-color 0.2s ease;\n}\n\n.stage-pipeline .stage.active {\n  border-color: rgba(56, 189, 248, 0.8);\n  background: rgba(14, 165, 233, 0.12);\n}\n\n.stage-pipeline .stage.done {\n  border-color: rgba(16, 185, 129, 0.5);\n  background: rgba(16, 185, 129, 0.1);\n}\n\n.stage-pipeline .stage.failed {\n  border-color: rgba(248, 113, 113, 0.7);\n  background: rgba(248, 113, 113, 0.12);\n}\n\n.stage-icon {\n  width: 48px;\n  height: 48px;\n  border-radius: 12px;\n  border: 2px solid rgba(148, 163, 184, 0.45);\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: 0.15rem;\n  padding: 0.3rem 0.4rem;\n  font-size: 1.35rem;\n}\n\n.stage-base {\n  flex: 1;\n  text-align: left;\n}\n\n.stage-state {\n  font-size: 0.95rem;\n}\n\n.stage-desc {\n  margin: 0.05rem 0 0;\n  font-size: 0.85rem;\n  color: rgba(15, 23, 42, 0.7);\n}\n\n.countdown-hint {\n  margin-top: 0.35rem;\n  font-size: 0.95rem;\n  color: #0f172a;\n  display: flex;\n  align-items: center;\n  gap: 0.35rem;\n}\n\n.countdown-hint strong {\n  font-size: 1.05rem;\n  color: #16a34a;\n}\n\n.countdown-source {\n  color: #64748b;\n  font-size: 0.85rem;\n}\n\n.api-card {\n  gap: 0.25rem;\n  padding: 0.75rem 1rem;\n  max-width: 320px;\n  width: 100%;\n  justify-self: start;\n}\n\n:global(.api-mini-row) {\n  display: flex;\n  align-items: center;\n  gap: 0.35rem;\n  min-height: 40px;\n}\n\n:global(.api-mini-row.meta) {\n  justify-content: space-between;\n  color: rgba(226, 232, 240, 0.9);\n  font-size: 0.9rem;\n}\n\n:global(.balance-label) {\n  font-weight: 600;\n  color: #cbd5f5;\n}\n\n:global(.btn-icon) {\n  border: 1px solid rgba(148, 163, 184, 0.35);\n  background: rgba(15, 23, 42, 0.7);\n  color: #e5e7eb;\n  border-radius: 10px;\n  padding: 0.35rem 0.45rem;\n  cursor: pointer;\n}\n\n:global(.btn-icon:disabled) {\n  opacity: 0.5;\n  cursor: not-allowed;\n}\n\n:global(.sr-only) {\n  position: absolute;\n  width: 1px;\n  height: 1px;\n  padding: 0;\n  margin: -1px;\n  overflow: hidden;\n  clip: rect(0, 0, 0, 0);\n  border: 0;\n}\n\n.card-header {\n  display: flex;\n  align-items: flex-start;\n  justify-content: space-between;\n  gap: 0.75rem;\n  margin-bottom: 1rem;\n}\n\n.card-subtitle {\n  margin: 0.15rem 0 0;\n  font-size: 0.9rem;\n  color: rgba(255, 255, 255, 0.65);\n}\n\n.api-input-row {\n  display: flex;\n  gap: 0.5rem;\n  align-items: center;\n}\n\n.api-input-row input {\n  flex: 1;\n}\n\n.api-actions {\n  display: flex;\n  gap: 0.75rem;\n  margin-top: 0.5rem;\n}\n\n.bucket-note,\n.bucket-path {\n  font-size: 0.9rem;\n  color: rgba(229, 231, 235, 0.8);\n}\n\n\n.form-wrapper {\n  border-top: 1px solid rgba(148, 163, 184, 0.25);\n  padding-top: 1.25rem;\n}\n\n.empty-state {\n  padding: 1rem;\n  border: 1px dashed rgba(148, 163, 184, 0.4);\n  border-radius: 12px;\n  font-size: 0.95rem;\n  color: rgba(226, 232, 240, 0.7);\n}\n\n.material-list {\n  list-style: none;\n  padding: 0;\n  margin: 1rem 0 0;\n  display: flex;\n  flex-direction: column;\n  gap: 1rem;\n}\n\n.material-list li {\n  border: 1px solid rgba(148, 163, 184, 0.25);\n  border-radius: 12px;\n  padding: 0.85rem;\n}\n\n.material-preview {\n  display: grid;\n  gap: 0.75rem;\n  margin: 0.75rem 0 0.5rem;\n}\n\n.material-preview video,\n.material-preview audio {\n  width: 100%;\n  border-radius: 12px;\n  background: rgba(15, 23, 42, 0.6);\n  border: 1px solid rgba(148, 163, 184, 0.35);\n}\n\n.material-meta {\n  display: flex;\n  align-items: center;\n  justify-content: space-between;\n  gap: 0.5rem;\n}\n\n.material-tag {\n  padding: 0.1rem 0.55rem;\n  border-radius: 999px;\n  font-size: 0.75rem;\n  text-transform: uppercase;\n  background: rgba(148, 163, 184, 0.2);\n  border: 1px solid rgba(148, 163, 184, 0.3);\n}\n\n.material-actions {\n  display: flex;\n  flex-wrap: wrap;\n  gap: 0.4rem;\n  margin-top: 0.5rem;\n}\n\n:global(.btn-text) {\n  border: none;\n  background: none;\n  color: #60a5fa;\n  cursor: pointer;\n  padding: 0.2rem 0.4rem;\n  font-size: 0.9rem;\n}\n\n:global(.btn-text.danger) {\n  color: #f87171;\n}\n\n.drawer-summary {\n  border: 1px dashed rgba(148, 163, 184, 0.35);\n  border-radius: 12px;\n  padding: 0.85rem;\n  background: rgba(15, 23, 42, 0.35);\n  color: rgba(226, 232, 240, 0.85);\n  display: flex;\n  flex-direction: column;\n  gap: 0.5rem;\n}\n\n.drawer-summary strong {\n  color: #c4b5fd;\n}\n\n.drawer-launch {\n  align-self: flex-start;\n  border: 1px solid rgba(99, 102, 241, 0.6);\n  border-radius: 999px;\n  padding: 0.35rem 0.9rem;\n  color: #c4b5fd;\n  background: rgba(30, 27, 75, 0.65);\n  cursor: pointer;\n}\n\n.mobile-drawer-bar {\n  position: fixed;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  display: grid;\n  grid-template-columns: repeat(2, 1fr);\n  gap: 0.4rem;\n  padding: 0.5rem;\n  background: rgba(2, 6, 23, 0.92);\n  border-top: 1px solid rgba(148, 163, 184, 0.15);\n  z-index: 30;\n}\n\n.drawer-toggle {\n  border: none;\n  border-radius: 14px;\n  padding: 0.65rem;\n  display: flex;\n  flex-direction: column;\n  gap: 0.1rem;\n  align-items: flex-start;\n  background: rgba(15, 23, 42, 0.65);\n  color: #e2e8f0;\n  cursor: pointer;\n  box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.2);\n}\n\n.drawer-toggle.active {\n  background: rgba(99, 102, 241, 0.25);\n  box-shadow: inset 0 0 0 1px rgba(99, 102, 241, 0.45);\n}\n\n.drawer-toggle small {\n  font-size: 0.75rem;\n  color: rgba(226, 232, 240, 0.75);\n}\n\n.drawer-icon {\n  font-size: 1.25rem;\n}\n\n.drawer-overlay {\n  position: fixed;\n  inset: 0;\n  background: rgba(15, 23, 42, 0.55);\n  z-index: 45;\n}\n\n.drawer-panel {\n  position: fixed;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  background: #020617;\n  border-radius: 24px 24px 0 0;\n  padding: 1rem 1rem 2rem;\n  z-index: 50;\n  max-height: 85vh;\n  overflow-y: auto;\n  box-shadow: 0 -12px 45px rgba(2, 6, 23, 0.85);\n}\n\n.drawer-panel__header {\n  display: flex;\n  justify-content: space-between;\n  align-items: flex-start;\n  gap: 0.75rem;\n}\n\n.drawer-panel__eyebrow {\n  margin: 0 0 0.25rem;\n  font-size: 0.85rem;\n  color: rgba(148, 163, 184, 0.9);\n}\n\n.drawer-panel__body {\n  margin-top: 1rem;\n}\n\n.drawer-close {\n  border: none;\n  background: rgba(15, 23, 42, 0.7);\n  color: #e2e8f0;\n  border-radius: 999px;\n  padding: 0.35rem 0.9rem;\n  cursor: pointer;\n}\n\n.drawer-slide-enter-active,\n.drawer-slide-leave-active {\n  transition: transform 0.25s ease, opacity 0.2s ease;\n}\n\n.drawer-slide-enter-from,\n.drawer-slide-leave-to {\n  transform: translateY(20%);\n  opacity: 0;\n}\n\n.drawer-fade-enter-active,\n.drawer-fade-leave-active {\n  transition: opacity 0.2s ease;\n}\n\n.drawer-fade-enter-from,\n.drawer-fade-leave-to {\n  opacity: 0;\n}\n\n:global(body.drawer-lock) {\n  overflow: hidden;\n}\n\n.toast {\n  position: fixed;\n  bottom: 1.5rem;\n  right: 1.5rem;\n  background: rgba(15, 118, 110, 0.9);\n  color: #fff;\n  padding: 0.75rem 1.25rem;\n  border-radius: 999px;\n  box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);\n  font-size: 0.95rem;\n}\n\n.material-path code,\n.bucket-path code,\n.bucket-note code {\n  font-size: 0.85rem;\n  color: #cbd5f5;\n}\n\n@media (max-width: 768px) {\n  .page {\n    padding-bottom: 6rem;\n  }\n\n  .task-card-actions {\n    flex-wrap: wrap;\n    justify-content: flex-end;\n  }\n}\n\n</style>\n"
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:36:04.689Z",
          "resultDisplay": "Read lines 2001-2592 of 2592 from frontend/src/App.vue",
          "displayName": "ReadFile",
          "description": "Reads and returns the content of a specified file. If the file is large, the content will be truncated. The tool's response will clearly indicate if truncation has occurred and will provide details on how to read more of the file using the 'offset' and 'limit' parameters. Handles text, images (PNG, JPG, GIF, WEBP, SVG, BMP), audio files (MP3, WAV, AIFF, AAC, OGG, FLAC), and PDF files. For text files, it can read specific line ranges.",
          "renderOutputAsMarkdown": true
        }
      ],
      "thoughts": [
        {
          "subject": "Reviewing the Content",
          "description": "I'm currently reviewing the complete content of `App.vue`. I'm meticulously scanning the remaining sections of the file to ensure I haven't missed anything crucial. My goal is absolute certainty about its contents.",
          "timestamp": "2026-01-03T08:36:04.663Z"
        }
      ],
      "model": "gemini-2.5-pro",
      "tokens": {
        "input": 66931,
        "output": 15,
        "cached": 7449,
        "thoughts": 28,
        "tool": 0,
        "total": 66974
      }
    },
    {
      "id": "21def2a3-32ea-4f63-b69c-dbff8514d756",
      "timestamp": "2026-01-03T08:36:49.457Z",
      "type": "gemini",
      "content": "I've reviewed the full `App.vue` file and am ready to implement the step-by-step workflow.\n\nFirst, I'll add a `currentView` state to manage which panel is active. I will then replace the existing hero buttons with a new tab-style navigation, allowing users to switch between \"Setup,\" \"Create,\" and \"Monitor\" views, while also guiding them automatically.",
      "thoughts": [
        {
          "subject": "Examining the Component Structure",
          "description": "I've just finished reading the entire `App.vue` file. Next, my refactoring plan kicks in. First, I'm integrating state for `currentView` and adding navigation controls within the `<template>` section. This is the first critical step to achieving a step-by-step workflow.",
          "timestamp": "2026-01-03T08:36:49.264Z"
        },
        {
          "subject": "Implementing the Navigation",
          "description": "I'm now focused on the core structure for the workflow. I'm adding `currentView` to manage the app's state, and I'm updating the template with \"Setup,\" \"Create,\" and \"Monitor\" tabs. I'll use `replace` to swap out the existing buttons. I believe this tab structure will make the workflow much smoother.",
          "timestamp": "2026-01-03T08:36:49.269Z"
        }
      ],
      "tokens": {
        "input": 71977,
        "output": 5267,
        "cached": 7491,
        "thoughts": 118,
        "tool": 0,
        "total": 77362
      },
      "model": "gemini-2.5-pro",
      "toolCalls": [
        {
          "id": "replace-1767429409435-270a79478d173",
          "name": "replace",
          "args": {
            "file_path": "/home/ren/frontend/src/App.vue",
            "instruction": "Refactor the frontend layout from a three-column \"cockpit\" view to a guided, step-by-step workflow. This involves introducing a new state variable `currentView` to manage which of the three main panels (Preparation, Creation, Monitor) is visible at any given time. The new workflow will guide the user from an initial 'setup' state, to 'creation', and finally to 'monitoring' upon task submission.\n\nTo achieve this, I will:\n1.  Add a `currentView` ref, with `'setup'` as the default state.\n2.  Replace the existing hero buttons ('Start Creating', 'View Task Status') with a new tab-like navigation component (`<div class=\"workspace-tabs\">`). This will allow users to manually switch between the 'Setup', 'Create', and 'Monitor' views.\n3.  Wrap the three main workspace columns in `v-show` directives, making their visibility dependent on the `currentView` state.\n4.  Add logic to automatically transition the user between views. For example, after a successful API key validation, the view will switch to 'creation', and after task submission, it will switch to 'monitoring'.\n5.  Update the `handleHeroCreateTask` and `handleHeroMonitor` methods to simply switch the `currentView` state, repurposing them for the new navigation tabs.",
            "old_string": "<template>\n  <main class=\"page\">\n    <header class=\"hero hero--minimal\">\n      <div class=\"hero-main\">\n        <div class=\"hero-title\">\n          <p class=\"hero-eyebrow\">数字人生成中心</p>\n          <h1>10 秒配置，即刻生成数字人</h1>\n          <p class=\"hero-subtitle\">Seedream 形象 · MiniMax 语音 · Infinitetalk 唇形</p>\n        </div>\n        <div class=\"hero-cta\">\n          <button type=\"button\" class=\"hero-cta__primary\" :disabled=\"submitting\" @click=\"handleHeroCreateTask\">\n            {{ submitting ? '创建中…' : '开始创建' }}\n          </button>\n          <button type=\"button\" class=\"hero-cta__ghost\" @click=\"handleHeroMonitor\">查看任务状态</button>\n          <p class=\"hero-cta__hint\">{{ heroSummaryText }}</p>\n        </div>\n      </div>\n    </header>\n\n    <div class=\"workspace\">\n      <section class=\"workspace__column workspace__column--system\">\n        <PreparationPanel\n          class=\"workspace__preparation\"\n          :is-mobile=\"isMobile\"\n          :api-key-value=\"apiKeyInput\"\n          :api-key-visible=\"apiKeyVisible\"\n          :api-key-error=\"apiKeyError\"\n          :is-api-key-valid=\"isApiKeyValid\"\n          :has-stored-key=\"Boolean(dashboardStore.apiKey)\"\n          :balance-display=\"balanceDisplay\"\n          :balance-loading=\"balanceLoading\"\n          :debug-mode=\"debugMode\"\n          :debug-hint=\"debugHint\"\n          :app-config=\"config\"\n          :error-message=\"dashboardStore.errors.apiKey\"\n          :task-error=\"dashboardStore.errors.tasks\"\n          :task-history=\"taskHistory\"\n          :current-job-id=\"currentJobId\"\n          :polling-active=\"pollingActive\"\n          :describe-status=\"describeStatus\"\n          :format-timestamp=\"formatTimestamp\"\n          @update:api-key-value=\"handleApiKeyInputChange\"\n          @update:api-key-visible=\"handleApiKeyVisibleChange\"\n          @validate-api-key=\"validateApiKey\"\n          @save-api-key=\"saveApiKeySetting\"\n          @clear-api-key=\"clearApiKeySetting\"\n          @refresh-balance=\"refreshBalance\"\n          @refresh-selected-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @select-task=\"handleTaskSelection\"\n          @remove-task=\"removeTaskFromHistory\"\n          @update:debug-mode=\"updateDebugMode\"\n        />\n      </section>\n      <section class=\"workspace__column workspace__column--input\">\n        <CreationPanel\n          ref=\"creationPanelRef\"\n          :is-mobile=\"isMobile\"\n          :form-alert=\"formAlert\"\n          :avatar-mode=\"avatarMode\"\n          :avatar-prompt=\"avatarPrompt\"\n          :avatar-file-error=\"avatarFileError\"\n          :accepted-avatar-types=\"acceptedAvatarTypes\"\n          :max-avatar-size-label=\"maxAvatarSizeLabel\"\n          :pond-label=\"pondLabel\"\n          :speech-text=\"speechText\"\n          :char-count=\"charCount\"\n          :estimated-duration=\"estimatedDuration\"\n          :estimated-cost=\"estimatedCost\"\n          :voice-id=\"voiceId\"\n          :resolution=\"resolution\"\n          :speed=\"speed\"\n          :pitch=\"pitch\"\n          :emotion=\"emotion\"\n          :seed=\"seed\"\n          :submitting=\"submitting\"\n          :characters=\"characters\"\n          :character-loading=\"characterLoading\"\n          :character-error=\"characterError\"\n          :selected-character-id=\"selectedCharacterId\"\n          :selected-character=\"selectedCharacter\"\n          :character-preview-url=\"characterPreviewUrl\"\n          :new-character-form=\"newCharacterForm\"\n          :new-character-alert=\"newCharacterAlert\"\n          :creating-character=\"creatingCharacter\"\n          :creation-sections=\"creationSections\"\n          @update:avatar-mode=\"updateAvatarMode\"\n          @update:avatar-prompt=\"updateAvatarPrompt\"\n          @update:speech-text=\"updateSpeechText\"\n          @update:voice-id=\"updateVoiceId\"\n          @update:resolution=\"updateResolution\"\n          @update:speed=\"updateSpeed\"\n          @update:pitch=\"updatePitch\"\n          @update:emotion=\"updateEmotion\"\n          @update:seed=\"updateSeed\"\n          @refresh-characters=\"refreshCharacters\"\n          @update:selected-character-id=\"updateSelectedCharacterId\"\n          @clear-character-selection=\"clearCharacterSelection\"\n          @avatar-files-change=\"handleAvatarFiles\"\n          @update:new-character-form=\"updateNewCharacterForm\"\n          @new-character-file-change=\"handleNewCharacterFile\"\n          @submit-new-character=\"submitNewCharacter\"\n          @toggle-section=\"handleCreationSectionToggle\"\n          @submit=\"handleSubmit\"\n        />\n      </section>\n      <section class=\"workspace__column workspace__column--output\">\n        <MonitorPanel\n          ref=\"monitorPanelRef\"\n          :current-job-id=\"currentJobId\"\n          :task-status=\"taskStatus\"\n          :overall-progress-percent=\"overallProgressPercent\"\n          :overall-progress-label=\"overallProgressLabel\"\n          :stage-definitions=\"stageDefinitions\"\n          :stage-status=\"stageStatus\"\n          :status-message=\"statusMessage\"\n          :status-accent=\"statusAccent\"\n          :trace-id=\"monitorTraceId\"\n          :countdown-visible=\"countdownVisible\"\n          :countdown-label=\"countdownLabel\"\n          :countdown-source=\"countdownSource\"\n          :cost-estimate-value=\"costEstimateValue\"\n          :cost-estimate-desc=\"costEstimateDesc\"\n          :avatar-url=\"avatarUrl\"\n          :audio-url=\"audioUrl\"\n          :result-video-url=\"resultVideoUrl\"\n          :total-cost=\"totalCost\"\n          :billing-summary=\"billingSummary\"\n          :error-message=\"errorMessage\"\n          :material-items=\"materialItems\"\n          :polling-active=\"pollingActive\"\n          :result-section-collapsed=\"resultSectionCollapsed\"\n          :material-warning=\"resultSectionWarning\"\n          :task-logs=\"taskLogs\"\n          @download-video=\"downloadVideo\"\n          @copy-video-link=\"copyVideoLink\"\n          @copy-local-path=\"copyLocalPath\"\n          @copy-public-link=\"copyPublicLink\"\n          @open-public-link=\"openPublicLink\"\n          @refresh-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @toggle-result-section=\"handleResultSectionToggle\"\n        />\n      </section>\n    </div>\n  </main>\n\n  <div v-if=\"isMobile\" class=\"mobile-drawer-bar\">\n    <button\n      v-for=\"btn in drawerButtons\"\n      :key=\"btn.id\"\n      type=\"button\"\n      class=\"drawer-toggle\"\n      :class=\"{ active: mobileDrawerPanel === btn.id }\"\n      @click=\"toggleMobileDrawer(btn.id)\"\n    >\n      <span class=\"drawer-icon\">{{ btn.icon }}</span>\n      <span class=\"drawer-label\">{{ btn.label }}</span>\n      <small>{{ overallProgressLabel }}</small>\n    </button>\n  </div>\n  <transition name=\"drawer-fade\">\n    <div v-if=\"drawerActive\" class=\"drawer-overlay\" @click=\"closeMobileDrawer\"></div>\n  </transition>\n  <transition name=\"drawer-slide\">\n    <section v-if=\"drawerActive\" class=\"drawer-panel\">\n      <header class=\"drawer-panel__header\">\n        <div>\n          <p class=\"drawer-panel__eyebrow\">{{ drawerPanelSubtitle }}</p>\n          <h3>{{ drawerPanelTitle }}</h3>\n        </div>\n        <button type=\"button\" class=\"drawer-close\" @click=\"closeMobileDrawer\">关闭</button>\n      </header>\n      <div class=\"drawer-panel__body\">\n        <MonitorPanel\n          v-if=\"mobileDrawerPanel === 'monitor'\"\n          :current-job-id=\"currentJobId\"\n          :task-status=\"taskStatus\"\n          :overall-progress-percent=\"overallProgressPercent\"\n          :overall-progress-label=\"overallProgressLabel\"\n          :stage-definitions=\"stageDefinitions\"\n          :stage-status=\"stageStatus\"\n          :status-message=\"statusMessage\"\n          :status-accent=\"statusAccent\"\n          :trace-id=\"monitorTraceId\"\n          :countdown-visible=\"countdownVisible\"\n          :countdown-label=\"countdownLabel\"\n          :countdown-source=\"countdownSource\"\n          :cost-estimate-value=\"costEstimateValue\"\n          :cost-estimate-desc=\"costEstimateDesc\"\n          :avatar-url=\"avatarUrl\"\n          :audio-url=\"audioUrl\"\n          :result-video-url=\"resultVideoUrl\"\n          :total-cost=\"totalCost\"\n          :billing-summary=\"billingSummary\"\n          :error-message=\"errorMessage\"\n          :material-items=\"materialItems\"\n          :polling-active=\"pollingActive\"\n          :result-section-collapsed=\"resultSectionCollapsed\"\n          :material-warning=\"resultSectionWarning\"\n          @download-video=\"downloadVideo\"\n          @copy-video-link=\"copyVideoLink\"\n          @copy-local-path=\"copyLocalPath\"\n          @copy-public-link=\"copyPublicLink\"\n          @open-public-link=\"openPublicLink\"\n          @refresh-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @toggle-result-section=\"handleResultSectionToggle\"\n        />\n      </div>\n    </section>\n  </transition>\n\n  <div v-if=\"toastMessage\" class=\"toast\">{{ toastMessage }}</div>\n\n  <div v-if=\"errorDialogVisible\" class=\"error-overlay\">\n    <div class=\"error-dialog\">\n      <h3>{{ errorDialogTitle }}</h3>\n      <p>{{ errorDialogMessage }}</p>\n      <pre>{{ errorDialogDetail }}</pre>\n      <button type=\"button\" @click=\"closeErrorDialog\">关闭</button>\n    </div>\n  </div>\n</template>",
            "new_string": "<template>\n  <main class=\"page\">\n    <header class=\"hero hero--minimal\">\n      <div class=\"hero-main\">\n        <div class=\"hero-title\">\n          <p class=\"hero-eyebrow\">数字人生成中心</p>\n          <h1>10 秒配置，即刻生成数字人</h1>\n          <p class=\"hero-subtitle\">Seedream 形象 · MiniMax 语音 · Infinitetalk 唇形</p>\n        </div>\n      </div>\n    </header>\n\n    <div class=\"workspace-tabs\">\n      <button\n        type=\"button\"\n        :class=\"{ active: currentView === 'setup' }\"\n        @click=\"currentView = 'setup'\"\n      >\n        <span class=\"tab-icon\">⚙️</span>\n        <span>1. 环境配置</span>\n      </button>\n      <button\n        type=\"button\"\n        :class=\"{ active: currentView === 'creation' }\"\n        @click=\"currentView = 'creation'\"\n      >\n        <span class=\"tab-icon\">🎨</span>\n        <span>2. 内容创作</span>\n      </button>\n      <button\n        type=\"button\"\n        :class=\"{ active: currentView === 'monitor' }\"\n        @click=\"currentView = 'monitor'\"\n      >\n        <span class=\"tab-icon\">📊</span>\n        <span>3. 任务监控</span>\n      </button>\n    </div>\n\n    <div class=\"workspace\">\n      <section v-show=\"currentView === 'setup'\" class=\"workspace__column workspace__column--system\">\n        <PreparationPanel\n          class=\"workspace__preparation\"\n          :is-mobile=\"isMobile\"\n          :api-key-value=\"apiKeyInput\"\n          :api-key-visible=\"apiKeyVisible\"\n          :api-key-error=\"apiKeyError\"\n          :is-api-key-valid=\"isApiKeyValid\"\n          :has-stored-key=\"Boolean(dashboardStore.apiKey)\"\n          :balance-display=\"balanceDisplay\"\n          :balance-loading=\"balanceLoading\"\n          :debug-mode=\"debugMode\"\n          :debug-hint=\"debugHint\"\n          :app-config=\"config\"\n          :error-message=\"dashboardStore.errors.apiKey\"\n          :task-error=\"dashboardStore.errors.tasks\"\n          :task-history=\"taskHistory\"\n          :current-job-id=\"currentJobId\"\n          :polling-active=\"pollingActive\"\n          :describe-status=\"describeStatus\"\n          :format-timestamp=\"formatTimestamp\"\n          @update:api-key-value=\"handleApiKeyInputChange\"\n          @update:api-key-visible=\"handleApiKeyVisibleChange\"\n          @validate-api-key=\"validateApiKey\"\n          @save-api-key=\"saveApiKeySetting\"\n          @clear-api-key=\"clearApiKeySetting\"\n          @refresh-balance=\"refreshBalance\"\n          @refresh-selected-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @select-task=\"handleTaskSelection\"\n          @remove-task=\"removeTaskFromHistory\"\n          @update:debug-mode=\"updateDebugMode\"\n        />\n      </section>\n      <section v-show=\"currentView === 'creation'\" class=\"workspace__column workspace__column--input\">\n        <CreationPanel\n          ref=\"creationPanelRef\"\n          :is-mobile=\"isMobile\"\n          :form-alert=\"formAlert\"\n          :avatar-mode=\"avatarMode\"\n          :avatar-prompt=\"avatarPrompt\"\n          :avatar-file-error=\"avatarFileError\"\n          :accepted-avatar-types=\"acceptedAvatarTypes\"\n          :max-avatar-size-label=\"maxAvatarSizeLabel\"\n          :pond-label=\"pondLabel\"\n          :speech-text=\"speechText\"\n          :char-count=\"charCount\"\n          :estimated-duration=\"estimatedDuration\"\n          :estimated-cost=\"estimatedCost\"\n          :voice-id=\"voiceId\"\n          :resolution=\"resolution\"\n          :speed=\"speed\"\n          :pitch=\"pitch\"\n          :emotion=\"emotion\"\n          :seed=\"seed\"\n          :submitting=\"submitting\"\n          :characters=\"characters\"\n          :character-loading=\"characterLoading\"\n          :character-error=\"characterError\"\n          :selected-character-id=\"selectedCharacterId\"\n          :selected-character=\"selectedCharacter\"\n          :character-preview-url=\"characterPreviewUrl\"\n          :new-character-form=\"newCharacterForm\"\n          :new-character-alert=\"newCharacterAlert\"\n          :creating-character=\"creatingCharacter\"\n          :creation-sections=\"creationSections\"\n          @update:avatar-mode=\"updateAvatarMode\"\n          @update:avatar-prompt=\"updateAvatarPrompt\"\n          @update:speech-text=\"updateSpeechText\"\n          @update:voice-id=\"updateVoiceId\"\n          @update:resolution=\"updateResolution\"\n          @update:speed=\"updateSpeed\"\n          @update:pitch=\"updatePitch\"\n          @update:emotion=\"updateEmotion\"\n          @update:seed=\"updateSeed\"\n          @refresh-characters=\"refreshCharacters\"\n          @update:selected-character-id=\"updateSelectedCharacterId\"\n          @clear-character-selection=\"clearCharacterSelection\"\n          @avatar-files-change=\"handleAvatarFiles\"\n          @update:new-character-form=\"updateNewCharacterForm\"\n          @new-character-file-change=\"handleNewCharacterFile\"\n          @submit-new-character=\"submitNewCharacter\"\n          @toggle-section=\"handleCreationSectionToggle\"\n          @submit=\"handleSubmit\"\n        />\n      </section>\n      <section v-show=\"currentView === 'monitor'\" class=\"workspace__column workspace__column--output\">\n        <MonitorPanel\n          ref=\"monitorPanelRef\"\n          :current-job-id=\"currentJobId\"\n          :task-status=\"taskStatus\"\n          :overall-progress-percent=\"overallProgressPercent\"\n          :overall-progress-label=\"overallProgressLabel\"\n          :stage-definitions=\"stageDefinitions\"\n          :stage-status=\"stageStatus\"\n          :status-message=\"statusMessage\"\n          :status-accent=\"statusAccent\"\n          :trace-id=\"monitorTraceId\"\n          :countdown-visible=\"countdownVisible\"\n          :countdown-label=\"countdownLabel\"\n          :countdown-source=\"countdownSource\"\n          :cost-estimate-value=\"costEstimateValue\"\n          :cost-estimate-desc=\"costEstimateDesc\"\n          :avatar-url=\"avatarUrl\"\n          :audio-url=\"audioUrl\"\n          :result-video-url=\"resultVideoUrl\"\n          :total-cost=\"totalCost\"\n          :billing-summary=\"billingSummary\"\n          :error-message=\"errorMessage\"\n          :material-items=\"materialItems\"\n          :polling-active=\"pollingActive\"\n          :result-section-collapsed=\"resultSectionCollapsed\"\n          :material-warning=\"resultSectionWarning\"\n          :task-logs=\"taskLogs\"\n          @download-video=\"downloadVideo\"\n          @copy-video-link=\"copyVideoLink\"\n          @copy-local-path=\"copyLocalPath\"\n          @copy-public-link=\"copyPublicLink\"\n          @open-public-link=\"openPublicLink\"\n          @refresh-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @toggle-result-section=\"handleResultSectionToggle\"\n        />\n      </section>\n    </div>\n  </main>\n\n  <div v-if=\"isMobile\" class=\"mobile-drawer-bar\">\n    <button\n      v-for=\"btn in drawerButtons\"\n      :key=\"btn.id\"\n      type=\"button\"\n      class=\"drawer-toggle\"\n      :class=\"{ active: mobileDrawerPanel === btn.id }\"\n      @click=\"toggleMobileDrawer(btn.id)\"\n    >\n      <span class=\"drawer-icon\">{{ btn.icon }}</span>\n      <span class=\"drawer-label\">{{ btn.label }}</span>\n      <small>{{ overallProgressLabel }}</small>\n    </button>\n  </div>\n  <transition name=\"drawer-fade\">\n    <div v-if=\"drawerActive\" class=\"drawer-overlay\" @click=\"closeMobileDrawer\"></div>\n  </transition>\n  <transition name=\"drawer-slide\">\n    <section v-if=\"drawerActive\" class=\"drawer-panel\">\n      <header class=\"drawer-panel__header\">\n        <div>\n          <p class=\"drawer-panel__eyebrow\">{{ drawerPanelSubtitle }}</p>\n          <h3>{{ drawerPanelTitle }}</h3>\n        </div>\n        <button type=\"button\" class=\"drawer-close\" @click=\"closeMobileDrawer\">关闭</button>\n      </header>\n      <div class=\"drawer-panel__body\">\n        <MonitorPanel\n          v-if=\"mobileDrawerPanel === 'monitor'\"\n          :current-job-id=\"currentJobId\"\n          :task-status=\"taskStatus\"\n          :overall-progress-percent=\"overallProgressPercent\"\n          :overall-progress-label=\"overallProgressLabel\"\n          :stage-definitions=\"stageDefinitions\"\n          :stage-status=\"stageStatus\"\n          :status-message=\"statusMessage\"\n          :status-accent=\"statusAccent\"\n          :trace-id=\"monitorTraceId\"\n          :countdown-visible=\"countdownVisible\"\n          :countdown-label=\"countdownLabel\"\n          :countdown-source=\"countdownSource\"\n          :cost-estimate-value=\"costEstimateValue\"\n          :cost-estimate-desc=\"costEstimateDesc\"\n          :avatar-url=\"avatarUrl\"\n          :audio-url=\"audioUrl\"\n          :result-video-url=\"resultVideoUrl\"\n          :total-cost=\"totalCost\"\n          :billing-summary=\"billingSummary\"\n          :error-message=\"errorMessage\"\n          :material-items=\"materialItems\"\n          :polling-active=\"pollingActive\"\n          :result-section-collapsed=\"resultSectionCollapsed\"\n          :material-warning=\"resultSectionWarning\"\n          @download-video=\"downloadVideo\"\n          @copy-video-link=\"copyVideoLink\"\n          @copy-local-path=\"copyLocalPath\"\n          @copy-public-link=\"copyPublicLink\"\n          @open-public-link=\"openPublicLink\"\n          @refresh-task=\"refreshSelectedTask\"\n          @toggle-polling=\"togglePolling\"\n          @toggle-result-section=\"handleResultSectionToggle\"\n        />\n      </div>\n    </section>\n  </transition>\n\n  <div v-if=\"toastMessage\" class=\"toast\">{{ toastMessage }}</div>\n\n  <div v-if=\"errorDialogVisible\" class=\"error-overlay\">\n    <div class=\"error-dialog\">\n      <h3>{{ errorDialogTitle }}</h3>\n      <p>{{ errorDialogMessage }}</p>\n      <pre>{{ errorDialogDetail }}</pre>\n      <button type=\"button\" @click=\"closeErrorDialog\">关闭</button>\n    </div>\n  </div>\n</template>",
            "expected_replacements": 1
          },
          "result": [
            {
              "functionResponse": {
                "id": "replace-1767429409435-270a79478d173",
                "name": "replace",
                "response": {
                  "output": "Successfully modified file: /home/ren/frontend/src/App.vue (1 replacements)."
                }
              }
            }
          ],
          "status": "success",
          "timestamp": "2026-01-03T08:36:49.507Z",
          "displayName": "Edit",
          "description": "Replaces text within a file. By default, replaces a single occurrence, but can replace multiple occurrences when `expected_replacements` is specified. This tool requires providing significant context around the change to ensure precise targeting. Always use the read_file tool to examine the file's current content before attempting a text replacement.\n      \n      The user has the ability to modify the `new_string` content. If modified, this will be stated in the response.\n      \n      Expectation for required parameters:\n      1. `old_string` MUST be the exact literal text to replace (including all whitespace, indentation, newlines, and surrounding code etc.).\n      2. `new_string` MUST be the exact literal text to replace `old_string` with (also including all whitespace, indentation, newlines, and surrounding code etc.). Ensure the resulting code is correct and idiomatic and that `old_string` and `new_string` are different.\n      3. `instruction` is the detailed instruction of what needs to be changed. It is important to Make it specific and detailed so developers or large language models can understand what needs to be changed and perform the changes on their own if necessary. \n      4. NEVER escape `old_string` or `new_string`, that would break the exact literal text requirement.\n      **Important:** If ANY of the above are not satisfied, the tool will fail. CRITICAL for `old_string`: Must uniquely identify the single instance to change. Include at least 3 lines of context BEFORE and AFTER the target text, matching whitespace and indentation precisely. If this string matches multiple locations, or does not match exactly, the tool will fail.\n      5. Prefer to break down complex and long changes into multiple smaller atomic calls to this tool. Always check the content of the file after changes or not finding a string to match.\n      **Multiple replacements:** Set `expected_replacements` to the number of occurrences you want to replace. The tool will replace ALL occurrences that match `old_string` exactly. Ensure the number of replacements matches your expectation.",
          "renderOutputAsMarkdown": true
        }
      ]
    }
  ]
}