# 数字人 Web 部署配置指引

本文档描述如何在 `ren.linapp.fun` 上部署新的数字人生成系统（前端 Vite/React + FastAPI 后端），并给出 Nginx、systemd、日志与冒烟验证的推荐做法。

## 1. 项目概况

| 项目 | 说明 |
|------|------|
| 名称 | WaveSpeed AI 数字人 Web |
| 域名 | `ren.linapp.fun`（HTTPS，Nginx 反代） |
| 后端端口 | `18005`（FastAPI + ad-back.py） |
| 前端 | `frontend/dist` 静态资源，由 Nginx 直接托管 |
| 关键目录 | `/home/ren`（仓库）、`/mnt/www/ren`（视频对外发布） |
| 冒烟脚本 | `./test/smoke_digital_human.sh`（10 秒） |

## 2. 架构拓扑

```
Browser ──HTTPS──> Nginx (ren.linapp.fun)
                        ├─ /      -> /home/ren/frontend/dist
                        └─ /api/  -> 127.0.0.1:18005

ad-back.py (FastAPI / uvicorn)
  ├─ py/api/routes_digital_human.py     # REST+Upload
  ├─ py/services/digital_human_service  # 三阶段编排
  ├─ py/function/task_runner.py         # 状态机 + log
  └─ output/aka-*/task.json|log.txt     # 任务产物
```

- 所有外部 API Key (.env) 仅加载在后端进程中。
- 最终视频会复制到 `/mnt/www/ren/ren_MMDDHHMM/digital_human.mp4` 并通过 CDN (`https://s.linapp.fun/ren/...`) 暴露。
- `output/` 目录只存放最近任务，可配合 `find` 定期清理。

## 3. 目录结构

```
/home/ren/
├── frontend/                # Vite 工程，npm run build -> dist/
├── py/                      # 后端模块
├── output/                  # aka-*/、smoke/ 等任务数据（git 忽略）
│   └── aka-1234/
│       ├── avatar.png
│       ├── speech.mp3
│       ├── digital_human.mp4
│       ├── task.json        # 含 trace_id、config_hash、stages、cost
│       └── log.txt          # [ISO][LEVEL][trace=xxx] message
├── temp/                    # TaskManager jobs.json、smoke 临时数据
├── venv/                    # Python 3.10 虚拟环境
└── test/smoke_digital_human.sh
```

> `log.txt` 与 `task.json` 是排障核心：trace_id 与 WaveSpeed 工单一一对应。

## 4. 环境准备

```bash
cd /home/ren
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
npm --prefix frontend ci
cp .env.example .env   # 填入 WAVESPEED_API_KEY / MINIMAX_API_KEY / STORAGE_BUCKET_URL
```

`restart_api_server.sh` 可封装 `source venv/bin/activate && python3 ad-back.py --port 18005 --config config.yaml`，systemd 将调用该脚本。

## 5. Nginx 配置

`/etc/nginx/sites-available/ren.linapp.fun`：

```nginx
server {
    listen 80;
    listen [::]:80;
    server_name ren.linapp.fun;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ren.linapp.fun;

    ssl_certificate /etc/letsencrypt/live/linapp.fun/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/linapp.fun/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;

    root /home/ren/frontend/dist;
    index index.html;

    location /api/ {
        proxy_pass http://127.0.0.1:18005/;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 600s;   # 唇同步轮询可能超过 2 分钟
        proxy_connect_timeout 60s;
    }

    location / {
        try_files $uri /index.html;
    }
}
```

检查 SSL 更新、`sudo ln -s` 到 `sites-enabled/` 并 reload Nginx。

## 6. systemd 服务

`/etc/systemd/system/ren-digital-human.service`

```ini
[Unit]
Description=Digital Human FastAPI Service
After=network.target

[Service]
Type=simple
User=ren
WorkingDirectory=/home/ren
Environment="PATH=/home/ren/venv/bin:/usr/bin"
ExecStart=/home/ren/venv/bin/python3 /home/ren/ad-back.py --port 18005
Restart=always
RestartSec=5
StandardOutput=append:/home/ren/logs/digital-human.out.log
StandardError=append:/home/ren/logs/digital-human.err.log

[Install]
WantedBy=multi-user.target
```

部署流程：

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now ren-digital-human.service
journalctl -u ren-digital-human.service -f
```

## 7. 日志与监控

- API 层：`logs/digital-human*.log`（systemd 重定向）。
- 任务级：`output/<job_id>/log.txt`，结构化字段方便追踪。
- `task.json` 中 `status/stages/cost_breakdown/trace_id/config_hash` 可直接由 `/api/tasks/<job_id>` 暴露给前端。
- 可选：将 `log.txt` 复制到 ELK 或 Loki，字段解析格式 `[timestamp][level][trace=xxx] message`。

## 8. 冒烟与回归

1. **10 秒冒烟**：

   ```bash
   cd /home/ren
   ./test/smoke_digital_human.sh --json
   ```

   - 默认输出至 `output/smoke/aka-test-*/`，脚本会提示成本与资产链接。
   - 完成后记录 `trace_id`、`video_url`，方便回归报告。

2. **自动化测试**：

   ```bash
   PYTEST_WAVESPEED_MOCK=1 ./run_tests.sh
   ```

   - 会执行 `npm run build` + `pytest`，确保状态机/异常处理未回归。

## 9. 输出清理

```bash
# 清理 7 日前的正式任务
find /home/ren/output -maxdepth 1 -type d -name 'aka-*' -mtime +7 -print -exec rm -rf {} +
# 清理 3 日前的冒烟任务
find /home/ren/output/smoke -maxdepth 1 -type d -name 'aka-*' -mtime +3 -print -exec rm -rf {} +
```

`/mnt/www/ren/ren_*` 可保留 30 天，定期同步/删除即可。

## 10. 常见问题

| 场景 | 处理 |
|------|------|
| WaveSpeed API 返回 429/5xx | `log.txt` 与 API JSON 中均会附 `trace_id`，等待 1-2 分钟再重试；必要时将 `trace_id` 报给 WaveSpeed | 
| `config_hash mismatch` | 表示 `config.yaml/user.yaml` 已修改，不支持旧任务断点；需重新创建任务 |
| `video_url` 为空 | 检查 `/mnt/www/ren/*/digital_human.mp4` 是否写入；若无则确认 `STORAGE_BUCKET_URL`/挂载权限 |
| Nginx 502/超时 | 先看后端 systemd 日志，再检查 `/api/tasks/<job_id>` 是否仍在 `video_rendering` 状态 |

---

部署完成后，请将冒烟命令、trace id、video url 记录在 `test/test-digital-human.md`，并在 PR/发布说明中同步成本与验证步骤。EOF
