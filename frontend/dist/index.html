<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>ren2 æ•°å­—äºº Â· æç®€ä¸‰æ </title>
    <script src="/config.js"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;600&display=swap");

      :root {
        --bg: #030915;
        --card: rgba(12, 20, 38, 0.82);
        --card-border: rgba(255, 255, 255, 0.06);
        --accent: #5de0e6;
        --accent-2: #2f8dff;
        --text: #eaf3ff;
        --muted: #93a6c6;
        --error: #ff6b6b;
        --success: #4ade80;
        --shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
      }

      * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
      }

      body {
        font-family: "Space Grotesk", "Noto Sans SC", "Helvetica Neue", Arial, sans-serif;
        background: radial-gradient(circle at 12% 18%, rgba(47, 141, 255, 0.22), transparent 26%),
          radial-gradient(circle at 82% 8%, rgba(93, 224, 230, 0.2), transparent 22%),
          linear-gradient(140deg, #020611 0%, #050c1d 45%, #0c1732 100%);
        color: var(--text);
        min-height: 100vh;
        padding: 30px 18px 46px;
        letter-spacing: 0.01em;
      }

      .page {
        max-width: 1180px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 18px;
      }

      header.hero {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .hero h1 {
        font-size: 30px;
        font-weight: 600;
        line-height: 1.2;
      }

      .hero p {
        color: var(--muted);
        font-size: 15px;
        max-width: 860px;
      }

      main.grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 14px;
      }

      .panel {
        background: var(--card);
        border: 1px solid var(--card-border);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--shadow);
        backdrop-filter: blur(10px);
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 100%;
      }

      .panel h3 {
        font-size: 18px;
      }

      .eyebrow {
        font-size: 12px;
        color: var(--muted);
        letter-spacing: 0.08em;
      }

      .muted {
        color: var(--muted);
        font-size: 14px;
        line-height: 1.5;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
        color: var(--text);
        font-size: 14px;
      }

      .field input,
      .field textarea,
      .field select {
        width: 100%;
        padding: 10px 12px;
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.12);
        background: rgba(255, 255, 255, 0.04);
        color: var(--text);
        outline: none;
        transition: border 0.2s ease, background 0.2s ease;
      }

      .field input:focus,
      .field textarea:focus,
      .field select:focus {
        border-color: var(--accent);
        background: rgba(255, 255, 255, 0.06);
      }

      textarea {
        resize: vertical;
        min-height: 96px;
      }

      .row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        width: 100%;
      }

      .divider {
        text-align: center;
        color: var(--muted);
        font-size: 12px;
        letter-spacing: 0.1em;
        margin-top: 2px;
      }

      button {
        border: none;
        cursor: pointer;
        transition: transform 0.12s ease, box-shadow 0.18s ease, background 0.2s ease;
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .primary-btn {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #031225;
        padding: 12px 14px;
        border-radius: 12px;
        width: 100%;
        font-size: 15px;
        box-shadow: 0 10px 30px rgba(47, 141, 255, 0.32);
      }

      .primary-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .primary-btn:hover:not(:disabled) {
        transform: translateY(-1px);
      }

      .ghost-btn {
        background: rgba(255, 255, 255, 0.06);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        font-size: 14px;
      }

      .ghost-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      .status-panel .status {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .status-chip {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        width: fit-content;
        padding: 8px 12px;
        border-radius: 999px;
        font-size: 13px;
        border: 1px solid rgba(255, 255, 255, 0.12);
      }

      .status-chip.idle {
        color: var(--muted);
      }

      .status-chip.pending {
        color: #facc15;
        border-color: rgba(250, 204, 21, 0.3);
      }

      .status-chip.running {
        color: var(--accent);
        border-color: rgba(93, 224, 230, 0.3);
      }

      .status-chip.success {
        color: var(--success);
        border-color: rgba(74, 222, 128, 0.3);
      }

      .status-chip.error {
        color: var(--error);
        border-color: rgba(255, 107, 107, 0.35);
      }

      .status-body {
        display: grid;
        grid-template-columns: 1fr;
        gap: 6px;
        font-size: 14px;
        color: var(--muted);
      }

      .status-body code {
        background: rgba(255, 255, 255, 0.06);
        padding: 4px 6px;
        border-radius: 8px;
        color: var(--text);
      }

      .link {
        color: var(--accent);
        text-decoration: none;
        font-weight: 600;
      }

      .link:hover {
        text-decoration: underline;
      }

      .error-box {
        background: rgba(255, 107, 107, 0.12);
        color: #ffc7c7;
        border: 1px solid rgba(255, 107, 107, 0.35);
        padding: 10px 12px;
        border-radius: 10px;
        font-size: 14px;
      }

      .history-toggle {
        position: fixed;
        right: 16px;
        bottom: 16px;
        z-index: 21;
        border-radius: 999px;
        background: rgba(3, 9, 21, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.14);
        color: var(--text);
        padding: 10px 14px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
        display: inline-flex;
        gap: 10px;
        align-items: center;
      }

      .history-toggle__count {
        min-width: 28px;
        height: 28px;
        border-radius: 999px;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #031225;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 13px;
        box-shadow: 0 8px 20px rgba(47, 141, 255, 0.25);
      }

      .history-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 8, 20, 0.4);
        backdrop-filter: blur(2px);
        z-index: 18;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.18s ease;
      }

      .history-overlay.is-open {
        opacity: 1;
        pointer-events: auto;
      }

      .history-panel {
        position: fixed;
        right: 16px;
        bottom: 72px;
        width: min(440px, calc(100% - 32px));
        background: rgba(3, 9, 21, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 18px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.45);
        padding: 14px 16px;
        backdrop-filter: blur(14px);
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 20;
        opacity: 0;
        pointer-events: none;
        transform: translateY(12px);
        transition: opacity 0.18s ease, transform 0.18s ease;
        max-height: min(70vh, 420px);
      }

      .history-panel.is-open {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
      }

      .history-header {
        font-size: 14px;
        font-weight: 600;
        color: var(--text);
      }

      .history-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 200px;
        overflow-y: auto;
      }

      .history-list li {
        display: flex;
        flex-direction: column;
        gap: 4px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.04);
        border-radius: 10px;
        padding: 8px 10px;
      }

      .history-list a {
        color: var(--accent);
        text-decoration: none;
        font-size: 13px;
        font-weight: 600;
        word-break: break-all;
      }

      .history-list a:hover {
        text-decoration: underline;
      }

      .history-list time {
        font-size: 12px;
        color: var(--muted);
      }

      .history-empty {
        font-size: 12px;
        color: var(--muted);
        text-align: center;
      }

      /* API é…ç½®é¢æ¿æ ·å¼ */
      .api-panel {
        border: 2px solid rgba(93, 224, 230, 0.3);
        background: rgba(93, 224, 230, 0.05);
      }

      .api-panel h3 {
        color: var(--accent);
      }

      @media (max-width: 640px) {
        .history-panel {
          left: 12px;
          right: 12px;
          width: auto;
          bottom: 76px;
        }

        .history-toggle {
          right: 12px;
          bottom: 12px;
        }
      }

      @media (max-width: 1060px) {
        main.grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }

      @media (max-width: 720px) {
        body {
          padding: 22px 14px 32px;
        }

        main.grid {
          grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .hero h1 {
          font-size: 24px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="hero">
        <h1>ä¸€é”®ç”Ÿæˆæ•°å­—äºº</h1>
        <p>ç”¨ Linode + WaveSpeedAIï¼Œè¿é€šå›¾åƒã€å£°éŸ³ä¸å”‡å½¢ï¼Œä¸€ç«™å¼å®Œæˆç”Ÿæˆæµç¨‹ã€‚</p>
      </header>

      <main class="grid">
        <!-- API é…ç½®é¢æ¿ -->
        <section class="panel api-panel">
          <p class="eyebrow">API é…ç½®</p>
          <h3>Wavespeed API Key</h3>
          <p class="muted">è¾“å…¥ä½ çš„ Wavespeed API å¯†é’¥ï¼Œç”¨äºè°ƒç”¨å›¾åƒã€è¯­éŸ³å’Œè§†é¢‘æœåŠ¡</p>

          <label class="field">
            <span>API Key</span>
            <input
              id="apiKeyInput"
              type="password"
              placeholder="è¾“å…¥ Wavespeed API Keyï¼ˆè‡³å°‘10ä¸ªå­—ç¬¦ï¼‰"
              autocomplete="off"
            />
          </label>

          <div class="row">
            <button class="ghost-btn" id="toggleApiKeyBtn" type="button">ğŸ‘ï¸ æ˜¾ç¤º/éšè—</button>
            <button class="ghost-btn" id="checkBalanceBtn" type="button">ğŸ’° æŸ¥è¯¢ä½™é¢</button>
          </div>

          <div id="balanceDisplay" class="status-chip idle" hidden>
            ä½™é¢ï¼š<span id="balanceAmount">--</span>
          </div>

          <p class="muted" style="font-size: 12px; margin-top: 8px;">
            ğŸ’¡ å¯†é’¥ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ï¼Œä¸ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨
          </p>
        </section>

        <section class="panel">
          <p class="eyebrow">STEP 1</p>
          <h3>å‡†å¤‡å½¢è±¡</h3>
          <p class="muted">ä¸Šä¼ å¤´åƒ (png/jpg â‰¤5MB) æˆ–è¾“å…¥äººç‰©æç¤ºè¯ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©åˆé€‚æ¨¡å¼ã€‚</p>
          <label class="field">
            <span>ä¸Šä¼ å¤´åƒæ–‡ä»¶</span>
            <input id="avatarFile" type="file" accept="image/png,image/jpeg" />
          </label>
          <div class="divider">æˆ–</div>
          <label class="field">
            <span>å½¢è±¡æç¤ºè¯</span>
            <textarea
              id="avatarPrompt"
              rows="4"
              placeholder="ç¤ºä¾‹ï¼šä¸“ä¸šå•†åŠ¡å¥³æ€§ï¼Œæ·±è“è¥¿è£…ï¼ŒæŸ”å’Œç¯å…‰ï¼Œè‚©è†€ä»¥ä¸ŠåŠèº«ï¼Œæœå‘é•œå¤´"
            ></textarea>
          </label>
          <button class="ghost-btn" id="fillPrompt" type="button">å¡«å…¥ç¤ºä¾‹æç¤ºè¯</button>
        </section>

        <section class="panel">
          <p class="eyebrow">STEP 2</p>
          <h3>è„šæœ¬ä¸éŸ³è‰²</h3>
          <p class="muted">ç²˜è´´æ’­æŠ¥æ–‡æœ¬ï¼Œé€‰æ‹©éŸ³è‰²å’Œåˆ†è¾¨ç‡å³å¯ï¼Œå…¶ä»–å‚æ•°é»˜è®¤ä¿æŒç²¾ç®€ã€‚</p>
          <label class="field">
            <span>æ’­æŠ¥æ–‡æœ¬</span>
            <textarea
              id="speechText"
              rows="6"
              placeholder="è¯·è¾“å…¥æ•°å­—äººè¦è¯´çš„è¯ï¼Œä¾‹å¦‚ï¼šæ¬¢è¿æ¥åˆ°æ•°å­—äººç”Ÿæˆå¹³å°ï¼Œæˆ‘ä»¬å°†ä¸ºä½ å¿«é€Ÿç”Ÿæˆè®²è§£è§†é¢‘ã€‚"
            ></textarea>
          </label>
          <div class="row">
            <label class="field">
              <span>éŸ³è‰²</span>
              <select id="voiceId">
                <option value="Chinese (Mandarin)_Reliable_Executive">æ™®é€šè¯ Â· ç¨³é‡é«˜ç®¡ç”·å£°</option>
                <option value="Chinese (Mandarin)_News_Anchor">æ™®é€šè¯ Â· æ–°é—»å¥³ä¸»æ’­</option>
                <option value="Chinese (Mandarin)_Warm_Bestie">æ™®é€šè¯ Â· æ¸©æš–é—ºèœœ</option>
                <option value="Chinese (Mandarin)_Gentleman">æ™®é€šè¯ Â· ç»…å£«ç”·å£°</option>
                <option value="Chinese (Mandarin)_Warm_Girl">æ™®é€šè¯ Â· æš–å¿ƒå¥³å£°</option>
                <option value="Chinese (Mandarin)_Male_Announcer">æ™®é€šè¯ Â· ç”·æ’­éŸ³å‘˜</option>
                <option value="Chinese (Mandarin)_Gentle_Youth">æ™®é€šè¯ Â· æ¸©æŸ”é’å¹´</option>
                <option value="Chinese (Mandarin)_Cute_Spirit">æ™®é€šè¯ Â· å¯çˆ±ç²¾çµ</option>
                <option value="Cantonese_GentleLady">ç²¤è¯­ Â· æ¸©æŸ”å¥³å£«</option>
                <option value="Cantonese_Narrator">ç²¤è¯­ Â· å™è¿°ç”·å£°</option>
                <option value="English_magnetic_voiced_man">English Â· Magnetic Male</option>
                <option value="English_radiant_girl">English Â· Radiant Girl</option>
                <option value="English_captivating_female1">English Â· Captivating Female</option>
                <option value="English_Upbeat_Woman">English Â· Upbeat Woman</option>
                <option value="English_Trustworth_Man">English Â· Trustworthy Male</option>
                <option value="English_CalmWoman">English Â· Calm Woman</option>
              </select>
            </label>
            <label class="field">
              <span>åˆ†è¾¨ç‡</span>
              <select id="resolution">
                <option value="720p">720p</option>
                <option value="1080p">1080p</option>
              </select>
            </label>
          </div>
        </section>

        <section class="panel status-panel">
          <p class="eyebrow">STEP 3</p>
          <h3>ä¸€é”®ç”Ÿæˆ</h3>
          <p class="muted">ç‚¹å‡»ç”Ÿæˆåè‡ªåŠ¨è½®è¯¢ä»»åŠ¡ï¼Œè§†é¢‘å°±ç»ªåç»™å‡ºæœ¬åœ°è·¯å¾„ä¸å…¬ç½‘é“¾æ¥ã€‚</p>
          <button class="primary-btn" id="submitBtn" type="button">å¼€å§‹ç”Ÿæˆ</button>
          <div class="status">
            <div id="statusChip" class="status-chip idle">å¾…å¯åŠ¨</div>
            <div class="status-body">
              <p>ä»»åŠ¡ IDï¼š<code id="jobId">--</code></p>
              <p>çŠ¶æ€ï¼š<span id="statusText">å°šæœªæäº¤</span></p>
              <p>è¿›åº¦ï¼š<span id="progressText">--</span></p>
              <p>æç¤ºï¼š<span id="messageText">å‡†å¤‡ä¸­</span></p>
              <p>Traceï¼š<span id="traceText">--</span></p>
            </div>
            <a id="videoLink" class="link" href="#" target="_blank" rel="noopener" hidden>æ’­æ”¾ / ä¸‹è½½æ•°å­—äººè§†é¢‘</a>
            <div id="errorBox" class="error-box" hidden></div>
          </div>
        </section>
      </main>
    </div>

    <button class="history-toggle" id="historyToggle" type="button" aria-expanded="false">
      <span>å†å²è§†é¢‘</span>
      <span class="history-toggle__count" id="historyCount">0</span>
    </button>
    <div class="history-overlay" id="historyOverlay" hidden></div>

    <aside class="history-panel" id="historyPanel" aria-label="å†å²è§†é¢‘">
      <div class="history-header">å†å²è§†é¢‘</div>
      <ul class="history-list" id="historyList"></ul>
      <p class="history-empty" id="historyEmpty">æš‚æ— ç”Ÿæˆè®°å½•</p>
    </aside>

    <script>
      (() => {
        const apiBase = (window.APP_CONFIG?.API_BASE || window.location.origin || "").replace(/\/$/, "");

        // API Key ç›¸å…³å…ƒç´ 
        const apiKeyInput = document.getElementById("apiKeyInput");
        const toggleApiKeyBtn = document.getElementById("toggleApiKeyBtn");
        const checkBalanceBtn = document.getElementById("checkBalanceBtn");
        const balanceDisplay = document.getElementById("balanceDisplay");
        const balanceAmount = document.getElementById("balanceAmount");

        // åŸæœ‰å…ƒç´ 
        const avatarFile = document.getElementById("avatarFile");
        const avatarPrompt = document.getElementById("avatarPrompt");
        const speechText = document.getElementById("speechText");
        const voiceId = document.getElementById("voiceId");
        const resolution = document.getElementById("resolution");
        const submitBtn = document.getElementById("submitBtn");
        const statusChip = document.getElementById("statusChip");
        const jobIdEl = document.getElementById("jobId");
        const statusText = document.getElementById("statusText");
        const progressText = document.getElementById("progressText");
        const messageText = document.getElementById("messageText");
        const traceText = document.getElementById("traceText");
        const videoLink = document.getElementById("videoLink");
        const errorBox = document.getElementById("errorBox");
        const historyList = document.getElementById("historyList");
        const historyEmpty = document.getElementById("historyEmpty");
        const historyToggle = document.getElementById("historyToggle");
        const historyOverlay = document.getElementById("historyOverlay");
        const historyPanel = document.getElementById("historyPanel");
        const historyCount = document.getElementById("historyCount");

        const defaults = {
          speed: 1,
          pitch: 0,
          emotion: "neutral",
          seed: 42,
        };

        const state = {
          pollTimer: null,
          currentJobId: null,
        };

        let historyRecords = [];
        let historyLoading = false;
        let historyOpen = false;

        // ==================== API Key ç›¸å…³å‡½æ•° ====================

        // ä» localStorage åŠ è½½ä¿å­˜çš„ API Key
        function loadApiKey() {
          const saved = localStorage.getItem("wavespeed_api_key");
          if (saved) {
            apiKeyInput.value = saved;
            checkBalance(); // è‡ªåŠ¨æŸ¥è¯¢ä½™é¢
          }
        }

        // ä¿å­˜ API Key åˆ° localStorage
        function saveApiKey() {
          const key = (apiKeyInput.value || "").trim();
          if (key) {
            localStorage.setItem("wavespeed_api_key", key);
          }
        }

        // åˆ‡æ¢ API Key æ˜¾ç¤º/éšè—
        function toggleApiKeyVisibility() {
          if (apiKeyInput.type === "password") {
            apiKeyInput.type = "text";
          } else {
            apiKeyInput.type = "password";
          }
        }

        // æŸ¥è¯¢ä½™é¢
        async function checkBalance() {
          const apiKey = (apiKeyInput.value || "").trim();
          if (!apiKey || apiKey.length < 10) {
            setError("è¯·å…ˆè¾“å…¥æœ‰æ•ˆçš„ Wavespeed API Keyï¼ˆè‡³å°‘10ä¸ªå­—ç¬¦ï¼‰");
            balanceDisplay.hidden = true;
            return;
          }

          try {
            const resp = await fetch(api("/api/wavespeed/balance"), {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ wavespeed_api_key: apiKey })
            });

            if (!resp.ok) {
              const payload = await resp.json().catch(() => ({}));
              throw new Error(payload.detail || "ä½™é¢æŸ¥è¯¢å¤±è´¥");
            }

            const data = await resp.json();
            balanceAmount.textContent = `$${data.balance.toFixed(2)}`;
            balanceDisplay.hidden = false;
            balanceDisplay.className = "status-chip success";
            saveApiKey(); // æŸ¥è¯¢æˆåŠŸåä¿å­˜ API Key
            setError(""); // æ¸…é™¤é”™è¯¯
          } catch (err) {
            setError(err.message || "ä½™é¢æŸ¥è¯¢å¤±è´¥");
            balanceDisplay.hidden = true;
          }
        }

        // ==================== å†å²è®°å½•ç›¸å…³ ====================

        function setHistoryOpen(open) {
          historyOpen = Boolean(open);
          if (historyPanel) {
            historyPanel.classList.toggle("is-open", historyOpen);
          }
          if (historyOverlay) {
            historyOverlay.classList.toggle("is-open", historyOpen);
            if (historyOpen) {
              historyOverlay.removeAttribute("hidden");
            } else {
              historyOverlay.setAttribute("hidden", "");
            }
          }
          if (historyToggle) {
            historyToggle.setAttribute("aria-expanded", historyOpen ? "true" : "false");
          }
        }

        setHistoryOpen(false);
        renderHistory();
        fetchHistory();
        historyToggle?.addEventListener("click", () => setHistoryOpen(!historyOpen));
        historyOverlay?.addEventListener("click", () => setHistoryOpen(false));
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") {
            setHistoryOpen(false);
          }
        });

        function setStatusChip(kind, label) {
          statusChip.className = `status-chip ${kind}`;
          statusChip.textContent = label;
        }

        function setError(message) {
          if (!message) {
            errorBox.hidden = true;
            errorBox.textContent = "";
            return;
          }
          errorBox.hidden = false;
          errorBox.textContent = message;
        }

        function setLoading(loading) {
          submitBtn.disabled = loading;
          submitBtn.textContent = loading ? "æäº¤ä¸­..." : "å¼€å§‹ç”Ÿæˆ";
        }

        function api(path) {
          return `${apiBase}${path}`;
        }

        function renderHistory() {
          if (!historyRecords.length) {
            historyEmpty.hidden = false;
            historyList.innerHTML = "";
            if (historyCount) {
              historyCount.textContent = "0";
            }
            return;
          }
          historyEmpty.hidden = true;
          historyList.innerHTML = "";
          if (historyCount) {
            historyCount.textContent = historyRecords.length.toString();
          }
          const sorted = [...historyRecords].sort((a, b) => {
            const aTime = a.timestamp || Date.parse(a.modified_at || "") || 0;
            const bTime = b.timestamp || Date.parse(b.modified_at || "") || 0;
            return bTime - aTime;
          });
          sorted.forEach((record) => {
            const href = resolveHistoryUrl(record);
            if (!href) {
              return;
            }
            const li = document.createElement("li");
            const link = document.createElement("a");
            link.href = href;
            link.target = "_blank";
            link.rel = "noopener";
            link.textContent = record.job_id || record.slug || href;
            const time = document.createElement("time");
            const dateValue = record.timestamp || Date.parse(record.modified_at || "") || Date.now();
            const date = new Date(dateValue);
            time.dateTime = Number.isNaN(date.getTime()) ? "" : date.toISOString();
            time.textContent = Number.isNaN(date.getTime())
              ? "--"
              : date.toLocaleString("zh-CN", { hour12: false });
            li.appendChild(link);
            li.appendChild(time);
            historyList.appendChild(li);
          });
        }

        function resolveHistoryUrl(record) {
          const candidates = [record.web_url, record.relative_url, record.video_url];
          for (const entry of candidates) {
            if (!entry) {
              continue;
            }
            if (entry.startsWith("http")) {
              return entry;
            }
            if (entry.startsWith("/")) {
              try {
                return new URL(entry, window.location.origin).href;
              } catch (err) {
                console.warn("invalid history URL", entry, err);
              }
            }
          }
          return null;
        }

        async function fetchHistory() {
          if (historyLoading) {
            return;
          }
          historyLoading = true;
          try {
            const resp = await fetch(api("/api/history/videos?limit=200"));
            if (!resp.ok) {
              throw new Error("å†å²è®°å½•è·å–å¤±è´¥");
            }
            const payload = await resp.json();
            const items = Array.isArray(payload.items) ? payload.items : [];
            historyRecords = items;
            renderHistory();
          } catch (err) {
            console.warn(err);
          } finally {
            historyLoading = false;
          }
        }

        function refreshHistorySoon() {
          if (historyLoading) {
            return;
          }
          fetchHistory();
        }

        async function uploadAvatar(file) {
          const formData = new FormData();
          formData.append("file", file);
          const resp = await fetch(api("/api/assets/upload"), {
            method: "POST",
            body: formData,
          });
          if (!resp.ok) {
            const payload = await resp.json().catch(() => ({}));
            throw new Error(payload.detail || "å¤´åƒä¸Šä¼ å¤±è´¥");
          }
          return resp.json();
        }

        async function createTask(payload) {
          const resp = await fetch(api("/api/tasks"), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          if (!resp.ok) {
            const payloadErr = await resp.json().catch(() => ({}));
            throw new Error(payloadErr.detail || "åˆ›å»ºä»»åŠ¡å¤±è´¥");
          }
          return resp.json();
        }

        async function fetchTask(jobId) {
          const resp = await fetch(api(`/api/tasks/${jobId}`));
          if (!resp.ok) {
            const payloadErr = await resp.json().catch(() => ({}));
            throw new Error(payloadErr.detail || "æŸ¥è¯¢ä»»åŠ¡å¤±è´¥");
          }
          return resp.json();
        }

        function updateTaskUI(task) {
          statusText.textContent = task.status || "unknown";
          messageText.textContent = task.message || "å¤„ç†ä¸­...";
          traceText.textContent = task.trace_id || "--";

          const stages = task.stages || {};
          const stageSummary = Object.entries(stages)
            .map(([k, v]) => `${k}:${v?.status || "..."}`)
            .join(" Â· ");
          progressText.textContent = stageSummary || "ç­‰å¾…é˜¶æ®µæ›´æ–°";

          const status = (task.status || "").toLowerCase();
          const videoUrl = task.assets?.local_video_url || task.video_url;
          if (status === "finished" && videoUrl) {
            videoLink.href = videoUrl;
            videoLink.hidden = false;
          } else {
            videoLink.hidden = true;
          }

          const jobId = task.job_id || task.jobId;
          if (jobId) {
            jobIdEl.textContent = jobId;
          }

          if (status === "finished") {
            setStatusChip("success", "å·²å®Œæˆ");
            refreshHistorySoon();
          } else if (status === "failed") {
            setStatusChip("error", "ç”Ÿæˆå¤±è´¥");
          } else if (status === "running") {
            setStatusChip("running", "ç”Ÿæˆä¸­");
          } else if (status === "pending") {
            setStatusChip("pending", "æ’é˜Ÿä¸­");
          } else {
            setStatusChip("idle", "å¾…å¯åŠ¨");
          }
        }

        function stopPolling() {
          if (state.pollTimer) {
            clearInterval(state.pollTimer);
            state.pollTimer = null;
          }
        }

        async function pollTask(jobId) {
          try {
            const task = await fetchTask(jobId);
            updateTaskUI(task);
            const status = (task.status || "").toLowerCase();
            if (["finished", "failed"].includes(status)) {
              stopPolling();
              setLoading(false);
            }
          } catch (err) {
            setError(err.message || "ä»»åŠ¡æŸ¥è¯¢å¤±è´¥");
            stopPolling();
            setLoading(false);
          }
        }

        async function handleSubmit() {
          setError("");
          stopPolling();
          videoLink.hidden = true;

          // éªŒè¯ API Key
          const apiKey = (apiKeyInput.value || "").trim();
          if (!apiKey || apiKey.length < 10) {
            setError("è¯·å…ˆè¾“å…¥ Wavespeed API Key");
            apiKeyInput.focus();
            return;
          }

          const script = (speechText.value || "").trim();
          const prompt = (avatarPrompt.value || "").trim();
          const file = avatarFile.files[0];

          if (!script) {
            setError("è¯·å¡«å†™æ’­æŠ¥æ–‡æœ¬");
            return;
          }

          if (!file && !prompt) {
            setError("è¯·ä¸Šä¼ å¤´åƒæˆ–å¡«å†™å½¢è±¡æç¤ºè¯");
            return;
          }

          setLoading(true);
          setStatusChip("pending", "æäº¤ä¸­");
          statusText.textContent = "æäº¤ä»»åŠ¡...";
          messageText.textContent = "æ­£åœ¨å‘é€è¯·æ±‚";

          try {
            let avatarMode = "prompt";
            let avatarUploadUrl = "";
            let avatarPromptValue = prompt;

            if (file) {
              avatarMode = "upload";
              const uploadResp = await uploadAvatar(file);
              avatarUploadUrl = uploadResp.url || uploadResp.path;
            }

            const payload = {
              avatar_mode: avatarMode,
              avatar_prompt: avatarMode === "prompt" ? avatarPromptValue : null,
              avatar_upload_url: avatarMode === "upload" ? avatarUploadUrl : null,
              speech_text: script,
              voice_id: voiceId.value,
              resolution: resolution.value,
              speed: defaults.speed,
              pitch: defaults.pitch,
              emotion: defaults.emotion,
              seed: defaults.seed,
              wavespeed_api_key: apiKey  // æ·»åŠ  API Key
            };

            const taskResp = await createTask(payload);
            state.currentJobId = taskResp.job_id;
            jobIdEl.textContent = taskResp.job_id || "--";
            messageText.textContent = taskResp.message || "ä»»åŠ¡å·²åˆ›å»º";
            setStatusChip("running", "ç”Ÿæˆä¸­");
            statusText.textContent = "ä»»åŠ¡å·²åˆ›å»º";

            await pollTask(taskResp.job_id);
            state.pollTimer = setInterval(() => pollTask(taskResp.job_id), 2000);
          } catch (err) {
            setError(err.message || "æäº¤å¤±è´¥");
            setStatusChip("error", "æäº¤å¤±è´¥");
            setLoading(false);
          }
        }

        // ==================== äº‹ä»¶ç›‘å¬ ====================

        // é¡µé¢åŠ è½½æ—¶ä» localStorage æ¢å¤ API Key
        loadApiKey();

        // API Key è¾“å…¥æ¡†å¤±ç„¦æ—¶ä¿å­˜
        apiKeyInput?.addEventListener("blur", saveApiKey);

        // åˆ‡æ¢æ˜¾ç¤º/éšè—æŒ‰é’®
        toggleApiKeyBtn?.addEventListener("click", toggleApiKeyVisibility);

        // æŸ¥è¯¢ä½™é¢æŒ‰é’®
        checkBalanceBtn?.addEventListener("click", checkBalance);

        // å¡«å…¥ç¤ºä¾‹æç¤ºè¯
        document.getElementById("fillPrompt").addEventListener("click", () => {
          avatarPrompt.value =
            "å•†åŠ¡é£æ•°å­—äººï¼Œæ·±è“è¥¿è£…ï¼Œå¹²ç»ƒçŸ­å‘ï¼ŒæŸ”å’Œå…‰çº¿ï¼Œçº¯è‰²èƒŒæ™¯ï¼Œæ­£é¢é•œå¤´ï¼Œå¾®ç¬‘";
        });

        // æäº¤æŒ‰é’®
        submitBtn.addEventListener("click", handleSubmit);
      })();
    </script>
  </body>
</html>
