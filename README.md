# AI故事化视频生成系统 v2.0

基于 DeepSeek 和 WavespeedAI 的智能视频制作工具

## 📋 项目概述

本项目使用AI技术自动生成**任意主题**的故事化短视频，支持多种视觉风格，通过以下流程：

1. **用户交互配置** - 选择主题、风格、镜头数、时长、分辨率
2. **DeepSeek API** - 生成故事大纲（起承转合）+ 连贯分镜脚本
3. **WavespeedAI API** - 并发生成图像 + 串行生成视频片段
4. **整条旁白一次生成** - 大模型生成整片旁白（每镜头一句），TTS 输出单条音频，按“全片时长-2秒”目标整体倍速（≤1.8x），字幕随 TTS 时间轴同步缩放
5. **FFmpeg/MoviePy** - 拼接静音视频 → 叠加整条旁白 → 叠加整条字幕 → 可选 BGM → 最终成片

## 🎯 功能特性

### 核心功能 ✨
- ✅ **交互式配置向导** - 友好的用户界面选择所有参数
- ✅ **10+视觉风格** - 科技、仙侠、赛博朋克、动画、3D、水墨、蒸汽朋克、太空、魔法、电影等
- ✅ **故事化生成** - 起承转合结构，镜头连贯流畅
- ✅ **两阶段创作** - 先生成故事大纲/框架，再生成详细分镜
- ✅ **整条旁白单轨** - 大模型一次生成整片旁白，TTS 单条音轨，字幕按 TTS 时间轴同步（倍速 ≤1.8x，目标时长=全片-2s）
- ✅ **灵活配置** - 自由设置镜头数（1-10个）和时长（3-5秒/镜头）
- ✅ **分辨率选择** - 支持480p/720p/1080p三种分辨率

### 性能优化 ⚡
- ✅ **并发图像生成** - 2线程并发，提升效率
- ✅ **断点续传** - 支持中断恢复，避免重复生成
- ✅ **智能重试** - 指数退避策略，自动处理网络错误
- ✅ **配置验证** - 启动时验证API密钥和环境
- ✅ **模块化服务** - `services/voice_service`(TTS)、`services/subtitle_service`(字幕)、`services/video_composer`(合成)、`services/music_service`(BGM选择，含智能匹配)；`services/rate_limiter` 控制 API 频率

### 用户体验 🎨
- ✅ **实时进度显示** - 倒计时和进度条
- ✅ **完整日志系统** - 控制台+文件双重记录
- ✅ **成本透明** - 实时显示预估费用

## 📁 项目结构

```
wavespeed/
├── README.md              # 项目说明文档
├── md/
│   ├── need.md           # 需求文档 v2.0
│   ├── design.md         # 详细设计文档 v2.0
│   └── plan.md           # 任务计划文档（TDD）
├── .env                  # API密钥配置（不提交到git）
├── py/
│   ├── ad-aka.py        # 主脚本（含10种风格+故事生成）
│   └── services/        # 语音/字幕/合成/音乐/限流/音频匹配模块
├── py1/                 # 独立工具脚本（批量合成、结果下载、Logo处理等）
├── akamAI/              # 工作目录（自动创建）
│   ├── story_outline.json  # 故事大纲（起承转合）
│   ├── shots_script.json   # 分镜脚本（连贯描述）
│   ├── checkpoint.json     # 断点续传检查点
│   ├── shot_1_image.png    # 镜头1关键帧（I2V模式）
│   ├── shot_1.mp4          # 镜头1视频
│   ├── shot_2.mp4          # 镜头2视频
│   ├── shot_3.mp4          # 镜头3视频
│   ├── final_video.mp4     # 最终合成视频
│   └── log.txt             # 运行日志
├── music/              # 背景音乐工具脚本与 README（下载/预处理/校验）
└── venv/                # Python虚拟环境

```

## 🚀 快速开始

### 1. 环境准备

```bash
# 创建虚拟环境
python3 -m venv venv

# 激活虚拟环境
source venv/bin/activate  # macOS/Linux
# 或
venv\Scripts\activate     # Windows

# 安装依赖
pip install requests python-dotenv moviepy openai
```

### 2. 配置说明

#### 配置文件层级
- **`.env`**：仅存放 `DeepSeek_API_KEY`、`Wavespeed_API_KEY` 等敏感密钥，不提交。
- **`config.yaml`**：系统默认/限流/路径与模型参数的全局配置，不写用户私参。
- **`user.yaml`**：用户运行参数（主题、镜头数、分辨率、LLM/模型选择、角色/Logo、并发等）覆盖 `config.yaml`，缺省回落全局默认。

#### 模型配置（数字映射，开箱即用）⭐

系统支持**多 LLM 和多模态模型**选择，只需在 `user.yaml` 中修改数字即可切换：

**LLM 配置（故事生成）**
```yaml
llm:
  provider: 1  # 1-DeepSeek（推荐，最便宜）
```

**图像生成模型（1-6）**
```yaml
models:
  image: 4  # 1-flux(便宜) 2-seedream-v4(推荐) 3-seedream-v4.5(4K)
            # 4-kling(参考图) 5-vidu(多参考) 6-nano-banana(Google 4K)
```

**视频生成模型（1-5）**
```yaml
models:
  video: 1  # 1-wan2.5(性价比) 2-wan2.6(音频) 3-wan2.6-t2v(快速)
            # 4-hailuo(高质量) 5-veo3.1(Google顶级)
```

详细模型列表和价格请参见下方「[模型选择指南](#-模型选择指南)」。

### 3. 配置API密钥

编辑 `.env` 文件，填入DeepSeek API密钥：

```env
DeepSeek_API_KEY=your_deepseek_api_key
# Wavespeed_API_KEY=不需要后端配置，通过前端网页输入并记住
```

**注意**: Wavespeed API密钥**不需要在`.env`文件中配置**，而是通过前端网页界面输入，浏览器会自动记住（localStorage），提供更好的用户体验和安全性。

### 3. 运行脚本

> 新入口：`python3 py/ad.py`（异步重构版）；`py/ad-aka.py` 保留兼容，会自动转发。

**智能模式（推荐）** - 自动检测未完成任务:

```bash
# 直接运行，系统会自动检测上一个任务是否完成
python3 py/ad.py
```

**系统行为**:
- ✅ 如果上一个任务完整 → 自动创建新任务
- ⚠️ 如果上一个任务未完成 → 显示完成度，询问是否继续
- ✨ 如果没有历史任务 → 创建新任务

**手动模式**:

```bash
# 强制创建新任务（禁用自动检测）
python3 py/ad.py --no-auto-resume

# 手动指定恢复目录
python3 py/ad.py --resume aka-12221430

# 查看帮助
python3 py/ad.py --help

# 内部占位测试样例
PYTHONPATH=. source venv/bin/activate && python -m pytest .test
```

### 5. 背景音乐工具（可选）

全部脚本位于 `music/` 目录：

```bash
# YouTube 批量下载（需先填 music/music-urls.txt）
python3 music/1-download-yt-music.py

# Incompetech 免费曲库直链（可调数量/按标题过滤）
python3 music/2-download-incompetech.py --count 20 --filter cinematic

# Freesound API 下载（需 FREESOUND_API_KEY，可切换快节奏模式）
python3 music/3-download-freesound.py --style technology --count 15
python3 music/3-download-freesound.py --mode epic --bpm-min 120 --count 20

# 生成智能选曲缓存 / 校验文件 / 提取高潮
python3 music/4-preprocess_music.py
python3 music/5-check-music.py
python3 music/6-extract-music-climax.py
```

### 4. 智能断点继续

**自动检测示例**:

当你运行 `python3 py/ad-aka.py` 时，如果检测到未完成任务：

```
📂 检测到未完成的任务: aka-12221430
────────────────────────────────────────────────────────────
   ✓ 故事脚本已生成
   ✓ 图像: 5/5 已完成
   ⚠️  视频: 3/5 已完成
   ✗ 最终视频未生成
────────────────────────────────────────────────────────────

是否从断点继续？(y/n) [默认: y]:
```

**断点恢复特性**:
- ✅ **零配置** - 自动检测，无需记住目录名
- ✅ **完成度展示** - 清晰显示各阶段进度
- ✅ **智能跳过** - 自动跳过已完成的故事、图像、视频
- ✅ **成本节省** - 只生成缺失部分，避免重复工作

## 📊 运行流程

脚本会执行以下流程：

### 阶段0：配置验证与用户交互
1. **验证配置** - 检查API密钥、FFmpeg、目录权限
2. **交互式配置** - 用户选择：
   - 输入视频主题（如"Akamai推出AI推理云"）
   - 选择视觉风格（10选1）
   - 设置镜头数量（默认3个，范围1-10）
   - 设置每镜头时长（默认5秒，范围3-5秒）
   - 选择分辨率（480p/720p/1080p）
3. **确认配置** - 显示完整配置，用户确认

### 阶段1：故事生成（约10-20秒）
1. **生成故事大纲** - DeepSeek生成起承转合结构
   - 保存到 `story_outline.json`
2. **生成分镜脚本** - 基于大纲生成连贯的镜头描述
   - 保存到 `shots_script.json`
   - 每个镜头包含前后连接信息

### 阶段2a：并发生成图像（I2V模式，约1-2分钟）
- 2线程并发调用 WavespeedAI
- 为每个镜头生成关键帧图像
- 保存为 `shot_X_image.png`

### 阶段2b：串行生成视频（约2-3分钟/镜头）
- 遍历每个镜头（支持断点续传）
- I2V模式：图像→视频
- T2V模式：文本→视频（可选）
- 实时显示进度和倒计时

### 阶段3：合成最终视频（约10-30秒）
- 使用FFmpeg拼接所有镜头
- 每个镜头截取指定时长（默认3秒）
- 输出最终视频到 `final_video.mp4`

## 📈 输出示例

运行时的控制台输出：

```
============================================================
🚀 AI故事化视频生成系统 v2.0
============================================================

╔══════════════════════════════════════════════════════════╗
║          欢迎使用 AI 视频生成系统 v2.0                    ║
╚══════════════════════════════════════════════════════════╝

请输入视频主题（如：Akamai推出AI推理云）: 太空探索的未来

🎨 请选择视觉风格：
────────────────────────────────────────────────────────────
1. 科技/未来风    - 全息投影、数据流、芯片、未来城市
2. 仙侠/东方奇幻  - 飞剑、云海、仙山、法术光效
3. 赛博朋克      - 霓虹灯、雨夜都市、机械义体
4. 动画/卡通      - 扁平设计、Q版角色、明亮色彩
5. 3D写实        - 真实光影、细腻材质、电影级渲染
6. 水墨画风      - 留白意境、墨色晕染、山水写意
7. 蒸汽朋克      - 齿轮机械、蒸汽动力、维多利亚
8. 科幻太空      - 星云、飞船、外星文明、宇宙探索
9. 奇幻魔法      - 魔法阵、元素特效、史诗场景
10. 电影写实     - 电影质感、景深虚化、自然光影

请输入选项 (1-10) [默认: 1]: 8

📹 镜头数量 (1-10) [默认: 3]: 5

⏱️  每镜头时长(秒) (3-5) [默认: 5]: 5

📺 请选择视频分辨率：
────────────────────────────────────────────────────────────
1. 480p  - 低成本快速预览
2. 720p  - 平衡质量与成本（推荐）
3. 1080p - 高清质量

请输入选项 (1-3) [默认: 2]: 2

📋 配置确认
────────────────────────────────────────────────────────────
主题: 太空探索的未来
风格: 科幻太空
镜头数: 5个
时长: 每镜头5秒（最终视频15秒）
分辨率: 720p
────────────────────────────────────────────────────────────
确认开始生成？(y/n) [默认: y]: y

开始时间: 2025-12-20 14:30:00
工作目录: /Users/xxx/wavespeed/akamAI
日志文件: /Users/xxx/wavespeed/akamAI/log.txt

📖 阶段 1/4: 生成故事大纲
------------------------------------------------------------
🤖 正在生成故事大纲...
✅ 故事大纲已生成
   标题: 《星际征途》
   结构: 起-承-承转-转-合
   主题: 人类探索未知宇宙的勇气与梦想

📝 阶段 1/4: 生成分镜脚本
------------------------------------------------------------
🎬 正在生成5个连贯镜头的详细描述...
✅ 分镜脚本已生成：akamAI/shots_script.json

🎨 阶段 2a/4: 并发生成图像
------------------------------------------------------------
🖼️  使用2线程并发生成5个镜头的关键帧...
✅ 镜头 1 图像生成完成 (1/5)
✅ 镜头 2 图像生成完成 (2/5)
✅ 镜头 3 图像生成完成 (3/5)
✅ 镜头 4 图像生成完成 (4/5)
✅ 镜头 5 图像生成完成 (5/5)

🎬 阶段 2b/4: 串行生成视频
------------------------------------------------------------
使用方案1：性价比方案（I2V）
需要生成 5 个镜头
图像模型: WAN 2.5 ($0.15/个)
视频模型: WAN 2.5 I2V ($0.15/个)
单镜头成本: $0.300
总成本: $1.50

🎬 正在生成镜头 1/5...
   📤 提交生成任务...
   ✓ 任务已提交，ID: task_abc123
   ⏳ 等待视频生成完成...
   ⏱️  处理中... (45s / 180s) | 状态: processing
   ✅ 生成完成！用时 2分05秒
✅ 镜头 1/5 视频已生成：akamAI/shot_1.mp4
   💾 检查点已保存
📊 总体进度: 1/5 (20%)

[继续处理镜头2-5...]

🎞️  阶段 3/4: 合成最终视频
------------------------------------------------------------
🔗 正在拼接5个镜头...
💾 正在导出最终视频...
✅ 最终视频已生成：akamAI/final_video.mp4
   时长: 15 秒
   分辨率: 720p

============================================================
🎉 视频制作完成！
============================================================
✓ 输出文件: akamAI/final_video.mp4
✓ 日志文件: akamAI/log.txt
✓ 总耗时: 12分30秒
✓ 完成时间: 2025-12-20 14:42:30
============================================================
```

## 📄 输出文件说明

| 文件 | 说明 |
|------|------|
| `story_outline.json` | 故事大纲（包含起承转合结构） |
| `shots_script.json` | 分镜脚本（包含连贯描述和视觉连续性） |
| `checkpoint.json` | 断点续传检查点（记录已完成镜头） |
| `shot_X_image.png` | 镜头X的关键帧图像（I2V模式） |
| `shot_X.mp4` | 镜头X视频片段（5秒，可选分辨率） |
| `final_video.mp4` | **最终视频**（总时长=镜头数×3秒） |
| `log.txt` | 完整运行日志（带时间戳） |

## 💰 成本估算

### 方案1：I2V模式（推荐，性价比高）

**示例：3镜头 × 720p**

| 项目 | 单价 | 数量 | 小计 |
|------|------|------|------|
| DeepSeek API调用（故事+脚本） | ~$0.002 | 2次 | $0.004 |
| WAN 2.5 文本生成图像 | $0.15 | 3次 | $0.45 |
| WAN 2.5 图像生成视频 (I2V) | $0.15 | 3次 | $0.45 |
| **总计** | | | **≈$0.90** (约¥6.5) |

**不同分辨率价格对比：**

| 分辨率 | 3镜头成本 | 5镜头成本 | 10镜头成本 |
|--------|----------|----------|-----------|
| 480p   | ~$0.60   | ~$1.00   | ~$2.00    |
| 720p   | ~$0.90   | ~$1.50   | ~$3.00    |
| 1080p  | ~$1.50   | ~$2.50   | ~$5.00    |

*注：实际费用可能因API调用次数、时长等略有差异*

## 🛠️ 工具脚本

### 网络测试工具

测试与 WavespeedAI API 的连接：

```bash
./venv/bin/python3 py/test_network.py
```

输出示例：
```
🔍 WavespeedAI API 网络连接测试
============================================================
📡 测试1: 检查基本连接...
✓ 连接成功！延迟: 1.20秒

📡 测试2: 测试WAN 2.5 API端点...
✓ API响应成功！延迟: 0.73秒
✓ 任务ID: abc123
```

## 🎨 10种视觉风格说明

| 风格 | 描述 | 典型元素 | 适用场景 |
|------|------|---------|---------|
| **科技/未来风** | 未来科技感，数据可视化 | 全息投影、数据流、芯片 | 科技产品、AI、云计算 |
| **仙侠/东方奇幻** | 中国风仙侠，飘逸灵动 | 飞剑、云海、仙山、法术 | 游戏、文化、传统题材 |
| **赛博朋克** | 霓虹都市，反乌托邦 | 霓虹灯、雨夜、机械义体 | 科幻、游戏、时尚 |
| **动画/卡通** | 扁平设计，明亮色彩 | Q版角色、夸张表现 | 儿童、教育、轻松内容 |
| **3D写实** | 电影级渲染，真实光影 | 细腻材质、写实场景 | 建筑、产品、广告 |
| **水墨画风** | 留白意境，墨色晕染 | 山水、写意、传统 | 文化、艺术、禅意 |
| **蒸汽朋克** | 维多利亚+机械美学 | 齿轮、蒸汽、复古 | 复古、奇幻、工业 |
| **科幻太空** | 宇宙探索，星际文明 | 星云、飞船、外星 | 科幻、探索、未来 |
| **奇幻魔法** | 魔法世界，史诗感 | 魔法阵、元素、奇幻 | 游戏、奇幻、冒险 |
| **电影写实** | 电影质感，自然光影 | 景深虚化、自然色调 | 纪录片、广告、写实 |

## 🔧 常见问题

### Q: 网络连接超时怎么办？

**A:** 脚本已内置智能重试机制（指数退避策略）。如果仍然失败：
1. 检查网络连接
2. 尝试使用VPN
3. 查看 `akamAI/log.txt` 日志详情

### Q: 如何查看详细日志？

**A:** 所有日志自动保存到 `akamAI/log.txt`，可以实时查看：

```bash
tail -f akamAI/log.txt
```

### Q: 生成中断了怎么办？

**A:** 系统支持**智能断点续传**，零配置自动恢复！

**推荐方式** - 自动检测（无需记住目录名）:

```bash
# 直接运行，系统会自动检测未完成任务并询问
python3 py/ad-aka.py
```

系统会显示：
```
📂 检测到未完成的任务: aka-12221430
   ✓ 故事脚本已生成
   ⚠️  视频: 3/5 已完成
   ...
是否从断点继续？(y/n) [默认: y]:
```

**手动方式** - 指定目录:

```bash
# 1. 查找中断的工作目录
ls output/

# 2. 手动指定恢复
python3 py/ad-aka.py --resume aka-12221430
```

**智能恢复特性**:
- ✅ **自动检测** - 每次运行自动检查未完成任务
- ✅ **完成度展示** - 清晰显示各阶段进度
- ✅ **智能跳过** - 已有故事/图像/视频全部跳过
- ✅ **成本节省** - 只生成缺失部分
- ✅ **用户可控** - 可选择继续或新建

### Q: 如何修改已生成的故事？

**A:** 可以手动编辑中间文件：
1. 编辑 `akamAI/story_outline.json` - 修改故事大纲
2. 编辑 `akamAI/shots_script.json` - 修改分镜描述
3. 删除 `checkpoint.json` 和对应的 `shot_X.mp4`
4. 重新运行脚本（会跳过故事生成阶段）

### Q: 不同风格的视频效果有什么区别？

**A:** 每种风格都有独特的：
- **视觉元素** - 如科技风的全息效果 vs 水墨风的留白意境
- **色彩方案** - 如赛博朋克的霓虹色 vs 仙侠的金绿色
- **镜头运动** - 如动画风的夸张运镜 vs 电影风的平稳推拉
- 建议先用 **480p** 低成本测试不同风格

### Q: 如何控制成本？

**A:** 成本控制建议：
1. **预览阶段** - 使用480p + 1镜头（约$0.30，快速测试）或3镜头（约$0.60）
2. **正式制作** - 使用720p + 5镜头（约$1.50）
3. **高质量** - 使用1080p + 7镜头（约$3.50）
4. 利用断点续传避免重复生成
5. 先生成故事大纲确认后再继续

## 🌐 在线访问

本项目已部署到生产环境，可直接通过浏览器访问：

- **前端界面**: https://wave.linapp.fun/
- **API 文档**: https://wave.linapp.fun/docs
- **健康检查**: https://wave.linapp.fun/health

详细部署配置请参考 [部署配置文档](doc/部署配置.md)。

## 📚 相关文档

- [需求文档 v2.0](md/need.md) - 故事化增强版需求
- [设计文档 v2.0](md/design.md) - 详细技术设计
- [任务计划](md/plan.md) - TDD开发计划
- [部署配置](doc/部署配置.md) - 生产环境部署指南
- [CLAUDE.md](CLAUDE.md) - 项目开发指南

## 🔍 测试结果

根据 `test/test-wave.md` 的测试数据：

| 指标 | 数值 |
|------|------|
| **文本生成图像** | 平均 19.97秒 |
| **图像生成视频** | 平均 114.34秒（<2分钟）⭐ |
| **成功率** | 100% (6/6) ✅ |
| **总费用** | $0.858 (¥6.18) |

性能评级：
- 🚀 **图像生成视频性能优秀** - 符合官方<2分钟标准
- ⚡ **稳定性优秀** - 100%成功率

## 🚧 注意事项

1. **API密钥安全**
   - 不要将 `.env` 文件提交到 git
   - 不要在代码中硬编码密钥
   - 定期轮换密钥

2. **成本控制**
   - 每次运行约消耗 $0.90
   - 建议先小规模测试
   - 使用较低分辨率进行预览

3. **网络要求**
   - 需要稳定的国际网络连接
   - 视频下载需要较大带宽
   - 建议在网络良好时运行

## 📞 技术支持

- **DeepSeek API文档**: https://platform.deepseek.com/docs
- **WavespeedAI API文档**: https://wavespeed.ai/docs
- **MoviePy文档**: https://zulko.github.io/moviepy/

## 📝 开发日志

### v1.0.0 (2025-12-20)

✅ 完成功能：
- 实现完整的TDD开发流程
- DeepSeek API集成
- WavespeedAI API集成（WAN 2.5模型）
- 视频自动合成
- 日志系统
- 网络重试机制
- 进度显示
- 成本估算

📊 测试结果：
- 所有测试通过（100%成功率）
- 平均单镜头生成时间：2-3分钟
- 完整流程耗时：6-10分钟

## 🎬 示例视频

最终生成的广告视频特点：
- **风格**：科技感/未来风
- **时长**：9秒（3个镜头 × 3秒）
- **分辨率**：1280×720 (720p)
- **帧率**：30fps
- **视觉元素**：
  - 蓝色、紫色、霓虹色调
  - 全息投影效果
  - 数据流动画
  - 服务器机架
  - AI芯片特写

## 🙏 致谢

- DeepSeek - 提供强大的AI文本生成能力
- WavespeedAI - 提供高质量的视频生成服务
- MoviePy - 提供简单易用的视频处理库

---

**项目创建时间**: 2025-12-20
**最后更新**: 2025-12-20
**版本**: v1.0.0
**作者**: Claude Code
**许可**: MIT License
