# plan-UI

## 项目背景与目标
- 本项目正在构建数字人生成 Web 前端，需要在保持现有 Vite + Vue3 架构与状态管理优势的前提下，吸收 /home/wave 项目在 API Key 管理、任务面板、进度与素材展示上的成熟 UI 经验，但不照搬其单体架构和流程编排。
- 核心目标是打造一个可在桌面端和移动端自适应的多卡片仪表盘式界面，集中呈现 API Key 配置、任务创建/管理、实时进度、播放器及素材目录映射，确保 `/mnt/www/ren` 目录内的本地与挂载网盘素材组织有序。
- `/mnt/www` 是统一的桶目录，`ren` 为桶中子目录，所有输入与生成素材都必须存放在该桶内并维持清晰结构。
- 桶内任意文件都能通过 `https://s.linapp.fun/<目录>/<文件名>` 访问，因此前端需要在 UI 中同时支持本地路径与公网可访问链接的展示和复制。
- 该界面需与既有后端轮询协议、日志体系保持兼容，同时支持未来数字人阶段扩展，避免重复实现工作流。

## 总体设计
1. **多卡片仪表盘布局**：在单页应用主视图中引入栅格系统，将 API Key、任务管理、进度与素材四大区域封装为独立卡片组件。宽屏下采用双列布局，窄屏自动堆叠并允许折叠/抽屉交互。
2. **状态管理策略**：利用现有的 store（Pinia/Vuex）集中维护 API Key、任务列表、当前任务进度、素材路径映射等状态，卡片组件通过 store action/subscribe 同步，避免跨组件耦合。
3. **API Key 安全策略**：提供显隐切换、localStorage 持久化与失效提示；调用后端接口前由服务层注入，不将 key 直接下传给播放器等与安全无关模块。
4. **任务/进度联动**：任务卡片负责创建、筛选、切换当前任务，进度卡片订阅当前任务 ID，将后端轮询结果实时展示为可视化进度条、阶段提示与日志链接。
5. **素材卡片与目录映射**：素材卡片按照 `/mnt/www/ren/<job_id>/...` 结构展示输入素材、生成中间件和最终成片，提供一键复制本地路径与 `https://s.linapp.fun/...` 公网地址，并支持打开播放器或下载。
6. **移动端适配**：统一使用 CSS 变量与媒体查询，卡片在移动端变为纵向流程，API Key 与任务卡片置顶，进度与素材卡片提供折叠/滑出面板，保证操作路径短。
7. **可扩展性**: 卡片组件遵循统一接口（props/events/store keys），未来新增数字人阶段（如脚本编排、语音微调）可复用卡片位或新增卡片，不破坏整体布局。

## 任务清单
- [x] 分析现有 `frontend/src/App.vue` 和 `/home/wave` 前端的布局差异，列出现状文档。
- [x] 梳理 `/home/wave` 中 API Key、任务管理、进度条相关组件的交互和状态依赖。
- [x] 评估当前项目的状态管理方案（Pinia 或 Vuex）与 store 结构，确认是否需要扩展模块。
- [x] 设计多卡片仪表盘的栅格布局草图（桌面端/移动端）。
- [x] 定义多卡片布局在 Vite + Vue3 中的组件层级结构图。
- [x] 确定卡片组件公共 props、事件和 store 映射规范并写入设计说明。
- [x] 编写 API Key 卡片的 UI 原型稿与交互流程。
- [x] 编写任务管理卡片的 UI 原型稿与交互流程。
- [x] 编写进度与日志卡片的 UI 原型稿与交互流程。
- [x] 编写素材目录卡片的 UI 原型稿与交互流程。
- [x] 制定 `/mnt/www/ren` 目录映射到前端展示的数据模型（如 job_id、分类字段）。
- [x] 定义 store 中 API Key 的 state、getter、action，含 localStorage 持久化策略。
- [x] 定义任务列表 state 与任务选择 action，支持过滤与分页。
- [x] 设计进度数据结构（阶段、百分比、日志链接）并与后端轮询响应对齐。
- [x] 设计素材数据结构（输入、生成中间件、最终成片路径）与接口字段映射。
- [x] 定义素材 URL 映射规则，将 `/mnt/www/ren/...` 路径转化为 `https://s.linapp.fun/ren/...` 供前端使用。
- [x] 在 `frontend/src/layout/` 下创建卡片容器与基础栅格组件。
- [x] 实现响应式布局 CSS（桌面双列、移动单列），验证在主要分辨率运作正常。
- [x] 开发 API Key 卡片组件：输入框、显隐切换、保存与清除按钮。
- [x] 接入 API Key 卡片与 store，完成 localStorage 自动加载。
- [x] 为 API Key 卡片增加校验与错误提示（为空、格式不合法）。
- [x] 开发任务管理卡片组件：任务列表、创建按钮、过滤条件、搜索框。
- [x] 实现任务卡片与 store 的数据绑定以及任务切换事件。
- [x] 在任务卡片内集成轮询控制按钮（开始/暂停/刷新）。
- [x] 开发进度卡片组件：进度条、阶段标签、状态文案、日志链接。
- [x] 将进度卡片与轮询 API 绑定，支持实时更新当前任务进度。
- [x] 为进度卡片添加阶段性提示图标或颜色（形象→语音→唇形）。
- [x] 开发素材卡片组件：目录树/列表、播放/下载按钮、路径复制。
- [x] 实现素材卡片对 `/mnt/www/ren/<job_id>/` 的数据映射与懒加载。
- [x] 在素材卡片中同时显示本地路径与公网可访问链接，并提供复制/打开操作。
- [x] 为素材卡片添加播放器预览，支持本地视频与音频切换。
- [x] 集成前端播放器组件，确保 `TaskResponse.assets.local_video_url` 优先播放。
- [x] 为所有卡片添加折叠/展开功能，移动端默认折叠低优先级卡片。
- [x] 编写全局 Loading/空状态组件，供各卡片复用。
- [x] 在全局样式中定义卡片主题色、阴影、圆角等统一视觉规范。
- [x] 实现卡片之间的状态联动，例如任务切换自动刷新进度与素材卡片。
- [x] 添加全局通知/Toast，提示 API Key 保存成功或任务创建失败。
- [x] 编写素材目录与本地文件系统路径的校验逻辑，防止路径异常。
- [x] 在 store 中加入错误状态记录，供卡片展示统一错误信息。
- [x] 为卡片组件补充单元测试，覆盖关键交互（输入、折叠、按钮点击）。
- [x] 编写端到端测试脚本，验证任务创建→进度更新→素材展示的流程。
- [x] 更新 `doc/frontent_task_flow.md` 或相关文档，记录新的 UI 交互。
- [x] 更新 `doc/工作流.md`，说明前端界面调整对整体流程的影响。
- [x] 在 README 或前端专属文档中添加仪表盘使用指南。
- [x] 将 `/home/wave` 对比结论总结到 `doc/ui.md`，突出差异化设计。
- [] 组织一次设计评审（线上/线下），收集团队反馈并记录。
- [] 根据评审反馈迭代 UI 原型和组件实现。
- [] 在开发环境中演示移动端适配效果，收集问题列表。
- [] 优化移动端交互（滑出/抽屉），确保单手可操作。
- [] 与后端确认素材路径与 API 返回字段的一致性，必要时更新接口。
- [] 完成整体自测，记录 bug list 并修复。
- [] 准备上线 checklist（构建、测试、回滚预案）。
- [x] 在 `doc/plan-UI.md` 中维护任务进展，标记完成情况。
- [] 上线后监控用户反馈与使用数据，规划下一轮迭代。
- [x] 缩减 API Key 卡片尺寸，保持两行迷你布局以适配移动端与仪表盘。
- [x] 接入 Wavespeed 余额查询，前端调用 `/api/wavespeed/balance` 并展示查询时间。
