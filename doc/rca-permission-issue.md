# RCA: 权限问题根因分析

## 问题描述
后端服务启动失败，MoviePy 导入时报错：`PermissionError: [Errno 13] Permission denied: '/home/wave/.env'`

## 环境信息
- 工作目录: `/home/wave` (所有者: wave:shared)
- 当前执行用户: `ccp` (uid=1037, gid=1037)
- 用户组: ccp, docker, dir

## 发现的问题

### 1. 配置文件权限不一致
| 文件 | 权限 | 所有者 | 问题 |
|------|------|--------|------|
| `.env` | 644 | ccp:shared | ✓ 已修复 (原600) |
| `config.yaml` | 644 | ccp:shared | ✓ 正确 |
| `user.yaml` | 600 | ccp:shared | ⚠️ 过于严格，其他用户无法读取 |
| `.claude.json` | 640 | wave:shared | ⚠️ 组用户有执行权限但无意义 |

### 2. Python文件权限混乱
- `ad-aka.py`: 775 (rwxrwxr-x) - ccp:shared
- `ad-back.py`: 775 (rwxrwxr-x) - wave:shared
- `api_server.py`: 660 (rw-rwx---) - wave:shared
- `music_service.py`: 660 (rw-rwx---) - wave:shared

### 3. 文件所有者不一致
- 部分文件属于 `wave:shared`
- 部分文件属于 `ccp:shared`
- 在多用户环境下可能导致访问冲突

## 根本原因分析

### 直接原因
1. `.env` 文件权限设置为 600，仅所有者 ccp 可读
2. MoviePy 库初始化时需要读取 `.env` 获取 FFMPEG 配置
3. 后端服务运行在 ccp 用户下，理论上应该可以读取，但实际失败

### 深层原因
1. **权限设计不统一**: 没有明确的文件权限标准
2. **文件所有权混乱**: wave 和 ccp 用户创建的文件交错
3. **共享组未充分利用**: shared 组存在但权限未正确配置
4. **缺少权限验证**: 启动前未检查关键文件可读性

## 影响范围

### 已发生的问题
- ✗ 后端服务无法启动
- ✗ MoviePy 无法导入

### 潜在风险
- ⚠️ `user.yaml` (600) 可能在其他场景下无法被读取
- ⚠️ 不同用户运行时可能遇到不同的权限错误
- ⚠️ 输出目录 (`output/`) 权限可能限制文件访问

## 修复方案

### 立即修复 (已完成)
- [x] `.env`: 600 → 644

### 系统性修复 (待执行)
1. **统一配置文件权限**
   - 所有配置文件 (.env, config.yaml, user.yaml): 644
   - JSON配置 (.claude.json): 644

2. **统一Python文件权限**
   - 可执行脚本 (ad-*.py): 755
   - 模块文件 (其他.py): 644

3. **统一文件所有权**
   - 关键文件: ccp:shared (当前运行用户)
   - 或全部: wave:shared + 正确组权限

4. **标准化目录权限**
   - 工作目录: 755
   - 输出目录: 775 (允许组写入)

## 预防措施

### 短期
1. 添加启动前权限检查脚本
2. 文档化标准权限设置

### 长期
1. 使用配置管理工具统一权限
2. 添加权限单元测试
3. CI/CD 中集成权限验证

## 验证计划
1. 检查所有配置文件可读性
2. 以不同用户身份测试启动
3. 验证输出目录写入权限
4. 运行完整的视频生成流程

## 时间线
- 2025-12-27 16:35: 发现 `.env` 权限问题并修复
- 2025-12-27 16:38: 启动全面权限审查
- 待定: 完成系统性修复

## 责任人
- 发现者: Claude Code
- 修复者: Claude Code
- 审核者: 待定
