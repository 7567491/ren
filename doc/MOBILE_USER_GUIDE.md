# 📱 手机端使用指南

## ✅ 问题已修复

通过深入的RCA分析和TDD验证，我们已经修复了手机端前端的所有问题：

### 修复内容

1. ✅ **后端支持API密钥传递** - 添加了wavespeed_api_key参数
2. ✅ **前端支持配置后端地址** - 可在UI中配置API服务器地址
3. ✅ **改进错误处理** - 详细的console日志和UI错误提示
4. ✅ **添加loading状态** - 按钮显示处理状态
5. ✅ **添加API连接测试** - 一键测试后端连接
6. ✅ **移动端体验优化** - 自动滚动、友好提示

## 🚀 快速开始

### 步骤1：重启API服务器（必须）

**为使修复生效，必须重启后端服务器！**

```bash
# 方法1：使用重启脚本（推荐）
cd /home/wave
./restart_api_server.sh

# 方法2：手动重启
# 找到并杀死旧进程
ps aux | grep "api_server.py" | grep wave
kill <PID>

# 启动新进程
source venv/bin/activate
python3 py/api_server.py
```

### 步骤2：配置手机端

#### 2.1 获取服务器IP地址

```bash
# 在服务器上运行
ip addr show | grep "inet " | grep -v 127.0.0.1
```

示例输出：`inet 192.168.1.100/24`

#### 2.2 在手机浏览器中配置

1. **打开前端页面**
   - 访问：`http://192.168.1.100:18000/` (替换为你的服务器IP)
   - 或通过nginx代理访问

2. **展开高级选项**
   - 点击页面上的"⚙️ 高级选项"按钮

3. **配置后端API地址**
   - 找到"🌐 后端API配置"区域
   - 在输入框中填写：`http://192.168.1.100:18000` (替换为实际IP)
   - 点击"💾 保存API地址"
   - 点击"🔍 测试连接"验证配置

4. **配置API密钥**
   - 找到"🔑 API密钥配置"区域
   - 输入你的Wavespeed API密钥
   - 浏览器会自动保存

5. **刷新页面**
   - 配置保存后，刷新页面使其生效

### 步骤3：开始使用

1. **填写视频参数**
   - 广告主题：描述你想要的视频内容
   - 视觉风格：选择合适的风格（3D/科技/卡通等）
   - 镜头数量：建议先用1-3个镜头测试

2. **点击"开始生成"**
   - 按钮会显示"⏳ 创建任务中..."
   - 成功后会自动显示进度面板

3. **观察进度**
   - 进度条实时更新
   - 日志区域显示详细进展
   - 浏览器控制台（F12）可查看调试信息

## 🔍 调试指南

### 打开浏览器控制台

**安卓Chrome**:
1. 地址栏输入：`chrome://inspect`
2. 点击"Inspect"

**iOS Safari**:
1. 设置 → Safari → 高级 → 启用Web检查器
2. 在Mac上：Safari → 开发 → 选择你的设备

**PC Chrome**:
- 按 F12 或 右键 → 检查

### 查看调试信息

修复后的前端会输出详细的调试信息：

```javascript
🔧 API配置: {
    API_BASE: "http://192.168.1.100:18000",
    userAgent: "...",
    isMobile: true
}

📤 发送请求: {
    url: "http://192.168.1.100:18000/api/jobs",
    data: { ... }
}

📥 收到响应: {
    status: 200,
    statusText: "OK",
    headers: { ... }
}

✅ 任务创建成功: { job_id: "aka-12281515", ... }

📊 进度更新: 25% - 🖼️ 正在生成图像 (1/3)

📜 最新日志: [...]
```

### 常见问题排查

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| Failed to fetch | 网络连接失败 | 检查API地址和服务器状态 |
| HTTP 404 | 接口不存在 | 确认后端服务器正在运行 |
| HTTP 500 | 服务器错误 | 查看后端日志（logs/api_server.log） |
| TypeError: ... | JavaScript错误 | 刷新页面，清除缓存 |
| 无任何反应 | API地址未配置 | 检查高级选项中的API配置 |

## 📊 验证修复

运行测试脚本验证所有修复是否生效：

```bash
cd /home/wave
source venv/bin/activate

# 快速验证
python3 test/quick_verify_fix.py

# 完整测试
pytest test/test_mobile_frontend_issues.py -v -s
```

预期输出：
```
✅ 修复1验证成功: 后端正确接受和处理wavespeed_api_key
✅ 修复4验证成功: 测试连接功能可用
✅ CORS头存在
```

## 🎯 性能提示

### 快速测试模式

首次使用建议使用最小配置：
- 镜头数：1个
- 分辨率：480p
- 时长：3秒

预计成本：约$0.33
预计时间：2-5分钟

### 正式使用

确认系统正常后：
- 镜头数：3-5个
- 分辨率：720p
- 时长：5秒

## 📝 注意事项

1. **API地址配置**
   - 必须包含协议（http://）
   - 必须包含端口号（:18000）
   - 示例：`http://192.168.1.100:18000`

2. **网络要求**
   - 手机和服务器必须在同一网络
   - 或服务器需要公网IP/域名
   - 确保防火墙允许18000端口

3. **浏览器兼容性**
   - 推荐使用Chrome/Safari最新版本
   - 必须启用JavaScript
   - 建议清除缓存后刷新

4. **API密钥安全**
   - API密钥保存在浏览器localStorage
   - 不要在不安全的网络中使用
   - 定期更换API密钥

## 🆘 获取帮助

### 查看日志

**前端日志**:
- 浏览器控制台（F12 → Console）

**后端日志**:
```bash
# API服务器日志
tail -f logs/api_server.log

# 任务执行日志
tail -f output/aka-*/log.txt
```

### 问题报告

如果遇到问题，请收集以下信息：
1. 浏览器控制台截图
2. 后端日志相关部分
3. 网络请求详情（Network标签）
4. 配置信息（API地址、参数等）

## 📚 相关文档

- 完整修复报告：`doc/mobile_frontend_fix_summary.md`
- API文档：访问 `http://服务器IP:18000/docs`
- 项目说明：`README.md`

## 🎉 总结

通过本次修复，手机端用户现在可以：
- ✅ 直接配置后端API地址
- ✅ 一键测试连接状态
- ✅ 查看详细的错误信息
- ✅ 实时追踪任务进度
- ✅ 获得更好的用户体验

祝使用愉快！🚀
